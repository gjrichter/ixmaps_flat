var themeStyleTranslateA=[{style:"opacity",obj:"nOpacity"},{style:"fillopacity",obj:"fillOpacity"},{style:"autoopacity",obj:"autoOpacity"},{style:"shadow",obj:"fOrigShadow"},{style:"blur",obj:"nBlur"},{style:"filter",obj:"szFilter"},{style:"dfilter",obj:"nDeltaFilter"},{style:"filterfield",obj:"szFilterField"},{style:"visible",obj:"fVisible"},{style:"dbtable",obj:"coTable"},{style:"dbtableUrl",obj:"coTableUrl"},{style:"dbtableType",obj:"coTableType"},{style:"dbtableExt",obj:"coTableExt"},{style:"dbtableProcess",obj:"coTableProcess"},{style:"dbtableQuery",obj:"coTableQuery"},{style:"datacache",obj:"fDataCache"},{style:"itemfield",obj:"szItemField"},{style:"lookupfield",obj:"szSelectionField"},{style:"lookuptoupper",obj:"fSelectionFieldToUpper"},{style:"lookupsuffix",obj:"szSelectionFieldSuffix"},{style:"lookupdigits",obj:"nSelectionFieldDigits"},{style:"lookuptonumber",obj:"fSelectionFieldToNumber"},{style:"lookupfield2",obj:"szSelectionField2"},{style:"showdata",obj:"fShowData"},{style:"datafields",obj:"szDataFieldsA",type:"array"},{style:"userdraw",obj:"userDraw"},{style:"child",obj:"fChild"},{style:"crsdatum",obj:"szCRSDatum"},{style:"crsutmzone",obj:"szCRSUTMZone"},{style:"server",obj:"szServer"},{style:"ranges",obj:"szRangesA",type:"array"},{style:"rangecentervalue",obj:"nRangeCenterValue"},{style:"symbols",obj:"szSymbolsA",type:"array"},{style:"values",obj:"szValuesA",type:"array",delimiter:"|"},{style:"colorvalues",obj:"szColorValuesA",type:"array",delimiter:"|"},{style:"symbolvalues",obj:"szSymbolValuesA",type:"array",delimiter:"|"},{style:"label",obj:"szOrigLabelA",type:"array",delimiter:"|"},{style:"valuemap",obj:"valueMap",type:"object"},{style:"xaxis",obj:"szXaxisA",type:"array"},{style:"units",obj:"szUnits"},{style:"labelunits",obj:"szLabelUnits"},{style:"titleunits",obj:"szTitleUnits"},{style:"units100",obj:"szUnits100"},{style:"sizevalueunits",obj:"szSizeValueUnits"},{style:"alphavalueunits",obj:"szAlphaValueUnits"},{style:"legendunits",obj:"szLegendUnits"},{style:"weights",obj:"szWeights"},{style:"align",obj:"szAlign"},{style:"offsetx",obj:"nOffsetX"},{style:"offsety",obj:"nOffsetY"},{style:"rotation",obj:"nRotation"},{style:"refreshtimeout",obj:"nRefreshTimeout"},{style:"normalsizevalue",obj:"nNormalSizeValue"},{style:"normalsizescale",obj:"szNormalSizeScale"},{style:"scale",obj:"nScale"},{style:"rangescale",obj:"nRangeScale"},{style:"sizepow",obj:"nSizePow"},{style:"outlierscale",obj:"nOutlierScale"},{style:"colorfield",obj:"szColorField"},{style:"symbolfield",obj:"szSymbolField"},{style:"valuefield",obj:"szValueField"},{style:"labelfield",obj:"szLabelField"},{style:"sizefield",obj:"szSizeField"},{style:"timefield",obj:"szTimeField"},{style:"alphafield",obj:"szAlphaField"},{style:"alphafield100",obj:"szAlphaField100"},{style:"xfield",obj:"szXField"},{style:"yfield",obj:"szYField"},{style:"dopacitypow",obj:"nDopacityPow"},{style:"dopacityramp",obj:"szDopacityRamp"},{style:"dopacityscale",obj:"nDopacityScale"},{style:"brightness",obj:"nBrightness"},{style:"buffersize",obj:"nBufferSize"},{style:"bufferstep",obj:"nBufferSizeStep"},{style:"field100min",obj:"nField100Min"},{style:"fractionscale",obj:"nFractionScale"},{style:"minvalue",obj:"nMinValue"},{style:"maxvalue",obj:"nMaxValue"},{style:"lowvalue",obj:"nLowValue"},{style:"highvalue",obj:"nHighValue"},{style:"textfont",obj:"szTextFont"},{style:"textcolor",obj:"szTextColor"},{style:"textscale",obj:"nTextScale"},{style:"linecolor",obj:"szLineColor"},{style:"linecolor",obj:"szLineColorA",type:"array"},{style:"linewidth",obj:"nLineWidth"},{style:"markersize",obj:"nMarkerSize"},{style:"gapsize",obj:"nGapSize"},{style:"bordercolor",obj:"szBorderColor"},{style:"borderstyle",obj:"szBorderStyle"},{style:"borderwidth",obj:"szBorderWidth"},{style:"borderradius",obj:"nBorderRadius"},{style:"boxcolor",obj:"szBoxColor"},{style:"boxopacity",obj:"nBoxOpacity"},{style:"boxmargin",obj:"nBoxMargin"},{style:"textplacement",obj:"szTextPlacement"},{style:"infotitle",obj:"szInfoTitle"},{style:"titlefield",obj:"szTitleField"},{style:"snippetfield",obj:"szSnippetField"},{style:"exclude",obj:"szExcludeA",type:"array"},{style:"nodatacolor",obj:"szNoDataColor"},{style:"titleupper",obj:"szTitleUpper"},{style:"titlelower",obj:"szTitleLower"},{style:"labelupper",obj:"szLabelUpper"},{style:"labellower",obj:"szLabelLower"},{style:"valueupper",obj:"szValueUpper"},{style:"valuelower",obj:"szValueLower"},{style:"glowupper",obj:"szGlowUpper"},{style:"glowlower",obj:"szGlowLower"},{style:"chartupper",obj:"szChartUpper"},{style:"chartlower",obj:"szChartLower"},{style:"layerupper",obj:"szLayerUpper"},{style:"layerlower",obj:"szLayerLower"},{style:"featureupper",obj:"szFeatureUpper"},{style:"featurelower",obj:"szFeatureLower"},{style:"boxupper",obj:"szBoxUpper"},{style:"boxlower",obj:"szBoxLower"},{style:"shadowupper",obj:"szShadowUpper"},{style:"shadowlower",obj:"szShadowLower"},{style:"declutterupper",obj:"szDeclutterUpper"},{style:"valuescale",obj:"nValueScale"},{style:"valuecolor",obj:"szValueColor"},{style:"minvaluesize",obj:"nValueSizeMin"},{style:"minvaluevalue",obj:"nValueValueMin"},{style:"valuedecimals",obj:"nValueDecimals"},{style:"fadevaluepow",obj:"szFadeValuePow"},{style:"fadenegative",obj:"nFadeNegative"},{style:"centerpart",obj:"szCenterPart"},{style:"clipframes",obj:"nClipFrames"},{style:"clipframerate",obj:"nClipFrameRate"},{style:"cliplegend",obj:"nClipColorLegend"},{style:"clipparts",obj:"nClipParts"},{style:"minchartsize",obj:"nChartSizeMin"},{style:"maxcharts",obj:"nMaxCharts"},{style:"showparts",obj:"szShowParts"},{style:"gridx",obj:"nGridX"},{style:"gridwidth",obj:"nGridWidth"},{style:"gridmatrix",obj:"nGridMatrix"},{style:"gridwidthpx",obj:"nGridWidthPx"},{style:"gridoffsetx",obj:"nGridOffsetX"},{style:"gridoffsety",obj:"nGridOffsetY"},{style:"aggregationfield",obj:"szAggregationField"},{style:"aggregationscale",obj:"szAggregationFieldA",type:"array"},{style:"aggregation",obj:"szAggregation"},{style:"minaggregation",obj:"szMinAggregation"},{style:"aggregationupper",obj:"szAggregationUpper"},{style:"aggregationlower",obj:"szAggregationLower"},{style:"clipupper",obj:"szClipUpper"},{style:"cliplower",obj:"szClipLower"},{style:"dominantfilter",obj:"szDominantFilter"},{style:"dominantdfilter",obj:"nDominantDFilter"},{style:"overviewchart",obj:"szOverviewChart"},{style:"evidence",obj:"evidenceMode"},{style:"markclass",obj:"markedClass"},{style:"markclasses",obj:"markedClassesA",type:"array"},{style:"name",obj:"szName"},{style:"title",obj:"szTitle"},{style:"snippet",obj:"szSnippet"},{style:"splash",obj:"szSplash"},{style:"description",obj:"szDescription"},{style:"tooltip",obj:"szTooltip"}];function __maptheme_getOneStyleProperty(e,t,i,a){if(a=a||",",void 0!==e&&null!=e){if(!i||void 0===i)return t+":"+String(e)+";";if("array"==i&&e&&e.length&&"object"==typeof e)return t+":"+e.join(a)+";";if("object"==i&&e)return t+":"+JSON.stringify(e)+";"}return""}function __maptheme_getStyleString(e){for(var t=map.Themes.getMapThemeDefinitionObj(e.szId),i="",a=0;a<themeStyleTranslateA.length;a++)i+=__maptheme_getOneStyleProperty(t.style[themeStyleTranslateA[a].style],themeStyleTranslateA[a].style,themeStyleTranslateA[a].type,themeStyleTranslateA[a].delimiter);return i.replace(/\"/gi,'\\"')}function __maptheme_getStyleObj(e){for(var t={},i=0;i<themeStyleTranslateA.length;i++)null!=e[themeStyleTranslateA[i].obj]&&"undefined"!=e[themeStyleTranslateA[i].obj]&&(t[themeStyleTranslateA[i].style]=e[themeStyleTranslateA[i].obj]);return t}function __isdef(e){return void 0!==e&&null!=e}if(ixMap.Themes=function(){this.themesA=[],this.themeNodesA=[],this.themeNodesPosA=[],this.themeNodesBoxA=[],this.themeNodes=0,this.activeTheme=null,this.activeBuffer=null,this.switchedLayerA=[],this.enableChartOffset=!1,this.enableMultiChoropleth=!1,this.enableSubThemes=!0,this.szChoroplethInfoStyle="histogram|",this.nMaxThemeCharts=1e6,this.nMaxShadowCharts=1e3,this.nflushPaintShape=5e3,this.nflushChartDraw=1e3,this.nColorSchemeMaxHeight=120,this.allwaysShowValues=!1,this.autoHideInfoTools=!1,this.themeDataCacheA=[]},ixMap.Themes.prototype=new Map,"string"==typeof thisversion&&map.checkVersion(thisversion)){map.Themes=new ixMap.Themes;try{HTMLWindow.ixmaps.htmlgui_onInitThemes()}catch(e){}}else alert("ixMap.Themes incompatible !");ixMap.Themes.prototype.addTheme=function(e){if(this.themesA[this.themesA.length]=e,!e.szFlag.match(/selection/i))try{HTMLWindow.ixmaps.htmlgui_onNewTheme(e.szId)}catch(e){}},ixMap.Themes.prototype.getThemeCount=function(){return this.themesA.length},ixMap.Themes.prototype.getAllThemes=function(){return this.themesA},ixMap.Themes.prototype.getThemes=function(){return this.themesA},ixMap.Themes.prototype.isTheme=function(e){for(var t=0;t<this.themesA.length;t++)if(this.themesA[t].szIdStr&&this.themesA[t].szIdStr==e)return this.themesA[t];return!1},ixMap.Themes.prototype.isIdle=function(){for(var e=0;e<this.themesA.length;e++)if(!this.themesA[e].fRealizeDone)return!1;return!0},ixMap.Themes.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},ixMap.Themes.prototype.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},ixMap.Themes.prototype.toArray=function(e){if(this.isObject(e)){var t=[];for(var i in e)t.push(i),t.push(e[i]);return t}return this.isArray(e)?e:String(e).match(/\|/)||String(e).match(/\RGB/)?String(e).split("|"):String(e).split(",")},ixMap.Themes.prototype.toString=function(e){return this.isArray(e)?e.join("|"):e},ixMap.Themes.prototype.newTheme=function(e,t,i,a,s,n){var l=null,h=a.split("style=");(l=h&&h.length>1?__getStyleObj(h[1]):__getStyleObj(a)).label=n&&"undefined"!=n?n.split("|"):l.label||null,l.szTitle=s;return this.newThemeByObj({layer:e,field:t,field100:i,style:l})},ixMap.Themes.prototype.newThemeByObj=function(themeObj,szFlag){if(_TRACE("newThemeByObj =====>"),!map.isIdle())return themeObj&&(this.newThemeObjA=this.newThemeObjA||[],this.newThemeObjA.push(themeObj)),_TRACE("ixmaps not idle ! --- retry later ! ---"),void setTimeout((function(){map.Themes.newThemeByObj()}),100);if(this.newThemeObjA&&this.newThemeObjA.length&&(themeObj&&this.newThemeObjA.push(themeObj),themeObj=this.newThemeObjA.shift()),themeObj){var szIdStr=JSON.stringify(themeObj);if(this.isTheme(szIdStr)&&themeObj.style.type.match(/TOGGLE/))return _TRACE("identic theme -> remove it"),this.removeTheme(null,this.isTheme(szIdStr).szId),null;var mapTheme=null,styleObj=themeObj.style,szLabelA,szLabel;if(!styleObj)return null;this.isArray(styleObj.label)?(szLabelA=styleObj.label,szLabel=styleObj.label.join("|")):(szLabel=styleObj.label,szLabelA=szLabel&&"undefined"!=szLabel?szLabel.split("|"):null);var colorSchemeA=new Array(5,"white","blue");return styleObj.colorscheme&&(colorSchemeA=this.toArray(styleObj.colorscheme)),themeObj.layer=this.toString(themeObj.layer),themeObj.field=this.toString(themeObj.field),styleObj.type.match(/\bEXACT\b/)&&!styleObj.type.match(/\bCATEGORICAL\b/)&&(styleObj.type+="|CATEGORICAL"),mapTheme=new MapTheme(themeObj.layer,themeObj.field,themeObj.field100,styleObj.type,colorSchemeA,styleObj.title,szLabelA),mapTheme.nOrder=this.getThemeCount(),mapTheme.szIdStr=szIdStr,mapTheme.origDef=themeObj,this.parseStyle(mapTheme,styleObj),this.allwaysShowValues&&(mapTheme.szFlag+="|VALUES"),mapTheme.parent=this,this.addTheme(mapTheme),mapTheme.fRealize=!0,mapTheme.szFlag.match(/CHOROPLETH||BUFFER/)||mapTheme.createChartGroup(map.Layer.objectGroup),map.Event.doDefaultZoom(),!1===mapTheme.fDataCache&&mapTheme.coTable&&eval("delete "+mapTheme.coTable),szFlag&&szFlag.match(/fast|silent|direct/)?map.Themes.execute():executeWithMessage("map.Themes.execute()","... processing ..."),mapTheme}},ixMap.Themes.prototype.parseStyle=function(e,t){if(e&&t){if(__isdef(t.classes)){if(isNaN(Number(e.origColorScheme[0]))){var i=e.origColorScheme[e.origColorScheme.length-1];e.origColorScheme[1]=e.origColorScheme[0],e.origColorScheme[2]=i}e.origColorScheme[0]=Number(t.classes)}if(__isdef(t.colorstyle)&&"spectrum"==e.origColorScheme[1]&&(e.origColorScheme[2]=t.colorstyle),__isdef(t.dominantdfilter)&&(e.nDominantDFilter=Number(t.dominantdfilter)),__isdef(t.dominantfilter)&&(e.szDominantFilter=String(t.dominantfilter)),__isdef(t.filter)&&(e.szFilter=String(t.filter)),__isdef(t.filterfield)&&(e.szFilterField=String(t.filterfield)),__isdef(t.filtervalue)&&(e.szFilterValue=String(t.filtervalue)),__isdef(t.overviewchart)&&(e.szOverviewChart=t.overviewchart),__isdef(t.evidence)&&(e.evidenceMode=t.evidence),__isdef(t.markclass)&&(e.markedClass=t.markclass,e.markedClasses||(e.markedClasses=[],e.markedClasses[e.markedClass]=!0,e.markedClassesA=[e.markedClass])),__isdef(t.markclasses)&&(e.markedClassesA=this.toArray(t.markclasses),e.markedClasses=[],e.markedClassesA.forEach((function(t,i){t.length&&(e.markedClasses[t]=!0,e.markedClass=t)}))),__isdef(t.fillopacity)&&("auto"==t.fillopacity?(e.autoOpacity=!0,e.fillOpacity=0):e.fillOpacity=Number(t.fillopacity)),__isdef(t.opacity)&&("auto"==t.opacity?(e.autoOpacity=!0,e.fillOpacity=0):e.nOpacity=Number(t.opacity)),__isdef(t.autoopacity)&&(e.autoOpacity=!0,e.fillOpacity=0),__isdef(t.shadow)?e.fShadow=e.fOrigShadow=JSON.parse(t.shadow):e.fShadow=e.fOrigShadow=!1,__isdef(t.maxshadow)&&(e.nMaxShadowCharts=Number(t.maxshadow)),__isdef(t.blur)&&(e.nBlur=Number(t.blur)),__isdef(t.dbtable)){var a=t.dbtable.split(" ");e.coTable=a[0],2==a.length&&(e.coTableType="jsonDB",e.coTableUrl=a[1].split("(")[1].split(")")[0]),3==a.length&&(e.coTableType=a[1],e.coTableUrl=a[2].split("(")[1].split(")")[0]),4==a.length&&(e.coTableType=a[1],e.coTableUrl=a[2].split("(")[1].split(")")[0],e.coTableExt=a[3].split("(")[1].split(")")[0])}if(__isdef(t.dbtableType)&&(e.coTableType=t.dbtableType),__isdef(t.dbtableUrl)&&(e.coTableUrl=t.dbtableUrl),__isdef(t.dbtableExt)&&(e.coTableExt=t.dbtableExt),__isdef(t.dbtableProcess)&&(e.coTableProcess=t.dbtableProcess),__isdef(t.dbtableQuery)&&(e.coTableQuery=t.dbtableQuery),__isdef(t.lookupfield)&&(e.szSelectionField=e.szItemField=t.lookupfield),__isdef(t.lookupfield2)&&(e.szSelectionField2=t.lookupfield2),__isdef(t.lookuptoupper)&&(e.fSelectionFieldToUpper=JSON.parse(t.lookuptoupper)),__isdef(t.lookupsuffix)&&(e.szSelectionFieldSuffix=t.lookupsuffix),__isdef(t.lookupprefix)&&(e.szSelectionFieldPrefix=t.lookupprefix),__isdef(t.lookupdigits)&&(e.nSelectionFieldDigits=Number(t.lookupdigits)),__isdef(t.lookuptonumber)&&(e.fSelectionFieldToNumber=JSON.parse(t.lookuptonumber)),__isdef(t.crsutmzone)&&(e.szCRSUTMZone=t.crsutmzone),__isdef(t.crsdatum)&&(e.szCRSDatum=t.crsdatum),__isdef(t.server)&&(e.szServer=t.server),__isdef(t.itemfield)&&(e.szItemField=t.itemfield),__isdef(t.ranges)&&(e.szRangesA=this.toArray(t.ranges),e.szRanges=this.toString(t.ranges)),__isdef(t.symbols)&&(e.szSymbolsA=this.toArray(t.symbols)),__isdef(t.values)&&(e.szValuesA=this.toArray(t.values),t.type.match(/CATEGORICAL/)&&e.szValuesA.length))for(var s=0;s<e.szValuesA.length;s++)e.getStringValueIndex(e.szValuesA[s],"set");__isdef(t.colorvalues)&&(e.szColorValuesA=this.toArray(t.colorvalues)),__isdef(t.symbolvalues)&&(e.szSymbolValuesA=this.toArray(t.symbolvalues)),__isdef(t.align)&&(e.szAlign=t.align),__isdef(t.offsetx)&&(e.nOffsetX=Number(t.offsetx)||0),__isdef(t.offsety)&&(e.nOffsetY=Number(t.offsety)||0),__isdef(t.rotation)&&(e.nRotation=Number(t.rotation)||0),__isdef(t.units)&&(e.szUnits=t.units),__isdef(t.units100)&&(e.szUnits100=t.units100),__isdef(t.sizevalueunits)&&(e.szSizeValueUnits=" "+t.sizevalueunits),__isdef(t.alphavalueunits)&&(e.szAlphaValueUnits=" "+t.alphavalueunits),__isdef(t.legendunits)&&(e.szLegendUnits=" "+t.legendunits),__isdef(t.labelunits)&&(e.szLabelUnits=" "+t.labelunits),__isdef(t.titleunits)&&(e.szTitleUnits=" "+t.titleunits),__isdef(t.xaxis)&&(e.szXaxisA=this.toArray(t.xaxis)),__isdef(t.id)&&(e.szId=unescape(t.id)),__isdef(t.name)&&(e.szId=e.szName=unescape(t.name)),__isdef(t.title)&&(e.szTitle=unescape(t.title)),__isdef(t.snippet)&&(e.szSnippet=unescape(t.snippet)),__isdef(t.splash)&&(e.szSplash=unescape(t.splash)),__isdef(t.description)&&(e.szDescription=unescape(t.description)),__isdef(t.tooltip)&&(e.szTooltip=unescape(t.tooltip)),__isdef(t.label)&&(e.szLabelA=e.szOrigLabelA=this.toArray(t.label)),__isdef(t.weights)&&(e.szWeightsA=this.toArray(t.weights),e.szWeights=this.toString(t.weights)),__isdef(t.weight)&&(e.szWeightsA=[t.weights],e.szWeights=t.weight),__isdef(t.scale)&&(e.nScale=Number(t.scale)),__isdef(t.colorfield)&&(e.szColorField=t.colorfield),__isdef(t.symbolfield)&&(e.szSymbolField=t.symbolfield),__isdef(t.valuefield)&&(e.szValueField=t.valuefield),__isdef(t.labelfield)&&(e.szLabelField=t.labelfield),__isdef(t.titlefield)&&(e.szTitleField=t.titlefield),__isdef(t.snippetfield)&&(e.szSnippetField=t.snippetfield),__isdef(t.sizefield)&&(e.szSizeField=t.sizefield),__isdef(t.timefield)&&(e.szTimeField=t.timefield),__isdef(t.alphafield)&&(e.szAlphaField=t.alphafield),__isdef(t.alphafield100)&&(e.szAlphaField100=t.alphafield100),__isdef(t.xfield)&&(e.szXField=t.xfield),__isdef(t.yfield)&&(e.szYField=t.yfield),__isdef(t.refresh)&&(e.nRefreshTimeout=1e3*Number(t.refresh)),__isdef(t.refreshtimeout)&&(e.nRefreshTimeout=Number(t.refreshtimeout)),__isdef(t.buffersize)&&(e.nBufferSize=t.buffersize),__isdef(t.bufferstep)&&(e.nBufferSizeStep=t.bufferstep),__isdef(t.field100min)&&(e.nField100Min=t.field100min),__isdef(t.fractionscale)&&(e.nFractionScale=t.fractionscale),__isdef(t.minvalue)&&(e.nMinValue=t.minvalue),__isdef(t.maxvalue)&&(e.nMaxValue=t.maxvalue),__isdef(t.lowvalue)&&(e.nLowValue=t.lowvalue),__isdef(t.highvalue)&&(e.nHighValue=t.highvalue),__isdef(t.showdata)&&(e.fShowData=JSON.parse(t.showdata)),__isdef(t.datacache)&&(e.fDataCache=JSON.parse(t.datacache)),__isdef(t.editor)&&(e.fEditor=JSON.parse(t.editor)),__isdef(t.datafields)&&(e.szDataFieldsA=this.toArray(t.datafields)),__isdef(t.textcolor)&&(e.szTextColor=t.textcolor),__isdef(t.textfont)&&(e.szTextFont=t.textfont),__isdef(t.textscale)&&(e.nTextScale=Number(t.textscale)),__isdef(t.linecolor)&&(e.szLineColorA=this.toArray(t.linecolor),e.szLineColor=e.szLineColorA[e.szLineColorA.length-1]),__isdef(t.linewidth)&&(e.nLineWidth=t.linewidth),__isdef(t.markersize)&&(e.nMarkerSize=t.markersize),__isdef(t.gapsize)&&(e.nGapSize=t.gapsize),__isdef(t.bordercolor)&&(e.szBorderColor=t.bordercolor),__isdef(t.borderstyle)&&(e.szBorderStyle=t.borderstyle),__isdef(t.borderwidth)&&(e.szBorderWidth=t.borderwidth),__isdef(t.borderradius)&&(e.nBorderRadius=Number(t.borderradius)),__isdef(t.boxcolor)&&(e.szBoxColor=t.boxcolor),__isdef(t.boxopacity)&&(e.nBoxOpacity=t.boxopacity),__isdef(t.boxmargin)&&(e.nBoxMargin=t.boxmargin),__isdef(t.textplacement)&&(e.szTextPlacement=t.textplacement),__isdef(t.infotitle)&&(e.szInfoTitle=t.infotitle),__isdef(t.exclude)&&(e.szExcludeA=this.toArray(t.exclude)),__isdef(t.aggregation)&&(e.szAggregation=t.aggregation),__isdef(t.rangecentervalue)&&(e.nRangeCenterValue=Number(t.rangecentervalue)),__isdef(t.rangescale)&&(e.nRangeScale=t.rangescale),__isdef(t.normalsizevalue)&&(e.nNormalSizeValue=t.normalsizevalue),__isdef(t.normalsizescale)&&(e.szNormalSizeScale=t.normalsizescale,e.nNormalSizeScale=__scanScaleValue(e.szNormalSizeScale)),__isdef(t.nodatacolor)&&(e.szNoDataColor=__getSaveColor(t.nodatacolor)),__isdef(t.boxupper)&&(e.szBoxUpper=t.boxupper,e.nBoxUpper=__scanScaleValue(e.szBoxUpper)),__isdef(t.boxlower)&&(e.szBoxLower=t.boxlower,e.nBoxLower=__scanScaleValue(e.szBoxLower)),__isdef(t.titleupper)&&(e.szTitleUpper=t.titleupper,e.nTitleUpper=__scanScaleValue(e.szTitleUpper)),__isdef(t.titlelower)&&(e.szTitleLower=t.titlelower,e.nTitleLower=__scanScaleValue(e.szTitleLower)),__isdef(t.labelupper)&&(e.szLabelUpper=t.labelupper,e.nLabelUpper=__scanScaleValue(e.szLabelUpper)),__isdef(t.labellower)&&(e.szLabelLower=t.labelupper,e.nLabelLower=__scanScaleValue(e.szLabelLower)),__isdef(t.valueupper)&&(e.szValueUpper=t.valueupper,e.nValueUpper=__scanScaleValue(e.szValueUpper)),__isdef(t.valuesupper)&&(e.szValueUpper=t.valuesupper,e.nValueUpper=__scanScaleValue(e.szValueUpper)),__isdef(t.valuelower)&&(e.szValueLower=t.valuelower,e.nValueLower=__scanScaleValue(e.szValueLower)),__isdef(t.valueslower)&&(e.szValueLower=t.valueslower,e.nValueLower=__scanScaleValue(e.szValueLower)),__isdef(t.glowupper)&&(e.szGlowUpper=t.glowupper,e.nGlowUpper=__scanScaleValue(e.szGlowUpper)),__isdef(t.glowlower)&&(e.szGlowLower=t.glowlower,e.nGlowLower=__scanScaleValue(e.szGlowLower)),__isdef(t.chartupper)&&(e.szChartUpper=t.chartupper,e.nChartUpper=__scanScaleValue(e.szChartUpper)),__isdef(t.chartlower)&&(e.szChartLower=t.chartlower,e.nChartLower=__scanScaleValue(e.szChartLower)),__isdef(t.layerupper)&&(e.szLayerUpper=t.layerupper,e.nLayerUpper=__scanScaleValue(e.szLayerUpper)),__isdef(t.layerlower)&&(e.szLayerLower=t.layerlower,e.nLayerLower=__scanScaleValue(e.szLayerLower)),__isdef(t.featureupper)&&(e.szFeatureUpper=t.featureupper,e.nFeatureUpper=__scanScaleValue(e.szFeatureUpper)),__isdef(t.featurelower)&&(e.szFeatureLower=t.featurelower,e.nFeatureLower=__scanScaleValue(e.szFeatureLower)),__isdef(t.shadowupper)&&(e.szShadowUpper=t.shadowupper,e.nShadowUpper=__scanScaleValue(e.szShadowUpper)),__isdef(t.shadowlower)&&(e.szShadowLower=t.shadowlower,e.nShadowLower=__scanScaleValue(e.szShadowLower)),__isdef(t.declutterupper)&&(e.szDeclutterUpper=t.declutterupper,e.nDeclutterUpper=__scanScaleValue(e.szDeclutterUpper)),__isdef(t.valuecolor)&&(e.szValueColor=t.valuecolor),__isdef(t.valuescale)&&(e.nValueScale=Number(t.valuescale)),__isdef(t.clipframes)&&(e.nClipFrames=t.clipframes),__isdef(t.clipframerate)&&(e.nClipFrameRate=t.clipframerate,e.nClipTimeout=1/Number(t.clipframerate)*1e3),__isdef(t.cliplegend)&&(e.nClipColorLegend=Number(t.cliplegend)),__isdef(t.clipvaluesize)&&(e.nValueSizeMin=Number(t.clipvaluesize)),__isdef(t.minvaluesize)&&(e.nValueSizeMin=Number(t.minvaluesize)),__isdef(t.minvaluevalue)&&(e.nValueValueMin=Number(t.minvaluevalue)),__isdef(t.valuedecimals)&&(e.nValueDecimals=t.valuedecimals),__isdef(t.fadevaluepow)&&(e.szFadeValuePow=t.fadevaluepow),__isdef(t.dopacityscale)&&(e.nDopacityScale=t.dopacityscale),__isdef(t.dopacityramp)&&(e.szDopacityRamp=t.dopacityramp),__isdef(t.dopacitypow)&&(e.nDopacityPow=t.dopacitypow),__isdef(t.fadenegative)&&(e.nFadeNegative=Number(t.fadenegative)||.5),__isdef(t.brightness)&&(e.nBrightness=t.brightness),__isdef(t.clipparts)&&(e.nClipParts=Number(t.clipparts)||0),__isdef(t.minsize)&&(e.nChartSizeMin=Number(t.minsize)||0),__isdef(t.minchartsize)&&(e.nChartSizeMin=Number(t.minchartsize)||0),__isdef(t.maxcharts)&&(e.nMaxCharts=Math.round(Number(t.maxcharts))||0),__isdef(t.clipsize)&&(e.nChartSizeMin=Number(t.clipsize)||0),__isdef(t.sizepow)&&(e.nSizePow=t.sizepow),__isdef(t.outlierscale)&&(e.nOutlierScale=t.outlierscale),__isdef(t.showparts)&&(e.szShowParts=this.toString(t.showparts),e.szShowPartsA=this.toArray(t.showparts)),__isdef(t.gridx)&&(e.nGridX=Number(t.gridx)||1),__isdef(t.gridwidth)&&(String(t.gridwidth).match(/px/)&&(e.nGridWidthPx=parseFloat(t.gridwidth)||50,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add")),e.nGridWidth=Number(t.gridwidth)||0),__isdef(t.gridmatrix)&&(e.nGridMatrix=Number(t.gridmatrix)||20,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add")),__isdef(t.gridwidthpx)&&(e.nGridWidthPx=Number(t.gridwidthpx)||50,map.Themes.doChangeThemeStyle(e.szId,"AUTOGRID","add")),__isdef(t.gridoffsetx)&&(e.nGridOffsetX=Number(t.gridoffsetx)||0),__isdef(t.gridoffsety)&&(e.nGridOffsetY=Number(t.gridoffsety)||0),__isdef(t.aggregationfield)&&(e.szAggregationField=t.aggregationfield),__isdef(t.aggregationscale)&&(e.szAggregationFieldA=this.toArray(t.aggregationscale)),__isdef(t.aggregation)&&(e.szAggregationFieldA=this.toArray(t.aggregation)),__isdef(t.minaggregation)&&(e.szMinAggregation=t.minaggregation,e.nMinAggregation=Number(t.minaggregation)||0),__isdef(t.aggregationupper)&&(e.szAggregationUpper=t.aggregationupper,e.nAggregationUpper=__scanScaleValue(e.szAggregationUpper)),__isdef(t.aggregationlower)&&(e.szAggregationLower=t.aggregationlower,e.nAggregationLower=__scanScaleValue(e.szAggregationLower)),__isdef(t.clipupper)&&(e.szClipUpper=t.clipupper,e.nClipUpper=__scanScaleValue(e.szClipUpper)),__isdef(t.cliplower)&&(e.szClipLower=t.cliplower,e.nClipLower=__scanScaleValue(e.szClipLower)),__isdef(t.userdraw)&&(e.userDraw=t.userdraw),__isdef(t.centerpart)&&(e.szCenterPart=this.toString(t.centerpart)),__isdef(t.child)&&(e.fChild=!0),__isdef(t.valuemap)&&(e.valueMap=t.valuemap),__isdef(t.visible)&&(e.fVisible=JSON.parse(t.visible))}},ixMap.Themes.prototype.getAllThemeDefinitionStrings=function(){for(var e=[],t=0;t<this.themesA.length;t++)e.push(this.getThemeDefinitionString(this.themesA[t]));return e};var __toRGB=function(e){return"RGB("+parseInt(e.substr(1,2),16)+","+parseInt(e.substr(3,2),16)+","+parseInt(e.substr(5,2),16)+")"},__getSaveColor=function(e){try{if("#"==e.charAt(0))return __toRGB(e)}catch(e){}return e},__getSaveColorScheme=function(e){for(var t=0;t<e.length;t++)e[t]=__getSaveColor(e[t]);return e.join("|")},__scanScaleValue=function(e){return String(e).match(/:/)?Number(e.split(":")[1]):Number(e)};function __calcNewValue(e,t,i){return e=Number(e)||0,t=Number(t)||0,i&&i.match(/pow/)?Math.pow(e,t):i&&i.match(/factor/)?e*t:i&&(i.match(/add/)||i.match(/delta/))?e+t:t}function __calcFactor(e,t,i){return e=e||0,t=t||0,i&&i.match(/factor/)?t:i&&i.match(/add/)?(e+t)/e:t/e}function ObjTheme(e,t,i,a,s){this.szName=e,this.coTable=i,this.szSelectionField=a,this.szItemField=s,this.nIndex=t,this.nFieldIndexA=[],this.nField100IndexA=[],this.nFieldSelectionIndex=-1,this.nFieldSelectionIndexA=[],this.nFieldItemIndex=-1,this.nValueFieldIndex=-1,this.nLabelFieldIndex=-1,this.leadOffset=!1}function MapTheme(e,t,i,a,s,n,l){var h;for(this.fDone=!1,this.nMin=Number.MAX_VALUE,this.nMax=-Number.MAX_VALUE,this.nSum=0,this.nCount=0,this.nNoData=0,this.szThemes=e||"",this.szThemesA=this.szThemes.split("|"),this.checkTheme(),this.objThemesA=[],this.szFields=t||"$item$",this.szFieldsA=this.szFields.split("|"),this.szField100=i||"",this.szField100A=i?i.split("|"):null,this.nFieldsA=[],this.nFields100A=[],this.nFieldsSelectionA=[],this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nMeanA=[],this.nMedianA=[],this.nDeviationA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],h=0;h<this.szFieldsA.length;h++)this.nMinA[h]=Number.MAX_VALUE,this.nMaxA[h]=-Number.MAX_VALUE,this.nSumA[h]=0,this.nOrigMinA[h]=Number.MAX_VALUE,this.nOrigMaxA[h]=-Number.MAX_VALUE,this.nOrigSumA[h]=0,this.nMedianA[h]=0,this.nMeanA[h]=0;if(this.nMin100=Number.MAX_VALUE,this.nMax100=-Number.MAX_VALUE,this.nSum100=0,this.nMinSize=Number.MAX_VALUE,this.nMaxSize=-Number.MAX_VALUE,this.nSumSize=0,this.nMinAlpha=Number.MAX_VALUE,this.nMaxAlpha=-Number.MAX_VALUE,this.nSumAlpha=0,this.nMinX=Number.MAX_VALUE,this.nMaxX=-Number.MAX_VALUE,this.nSumX=0,this.nMinY=Number.MAX_VALUE,this.nMaxY=-Number.MAX_VALUE,this.nSumY=0,this.szDominantFilter=null,this.nDominantDFilter=null,this.nFilterA=[],this.dbTableA=[],this.dbFieldsA=[],this.dbRecordsA=[],s)for(h in this.origColorScheme=[],s)this.origColorScheme[h]=s[h];else this.origColorScheme=null;this.defaultColorScheme=new Array("#008888","#00aaaa","#00cccc","#00eeee","#00ffff"),this.szTitle=n||e+" ["+t+"]",this.szTitle=map.Dictionary.getLocalText(this.szTitle),this.szTitle=this.szTitle.length>60?this.szTitle.slice(0,50)+" ...":this.szTitle,this.szUnits="",this.szSizeValueUnits=null,this.szAlphaValueUnits=null,this.szXaxisA=null,this.szLabelA=l,this.szOrigLabelA=l,this.szLegendLabelA=[],this.szLegendStyle="",this.evidenceMode="isolate",this.szAggregation="sum",this.nValuesA=[],this.szValuesA=null,this.szRangesA=null,this.szExactA=null,this.itemA=[],this.fVisible=!0,this.fDataCache=!0,this.fEditor=!1,this.fNullIsValue=!0,this.fNegativeValuePossible=!0,this.fUndefinedValuePossible=!0,this.fCheckRecordLength=!1,this.nStringToValue=1,this.nStringToValueA=[],this.szFlag=a||"CHOROPLETH",this.szOrigFlag=this.szFlag,this.nScale=1,this.nValueScale=1,this.nRefreshTimeout=0,this.szId="theme"+String(Math.random()),this.szShapeType="polygon";var o=map.Layer.getLayerObj(this.szThemesA[0]);o&&(this.szShapeType=o.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+="+buffer")),this.hiddenLayerA=[],_TRACE("new MapTheme("+e+","+t+","+i+","+a+","+s+")"),this.szFlag.match(/CHART/)||(this.szFlag.match(/PIE/)?this.szOverviewChart="PIE":this.szFlag.match(/DONUT/)&&(this.szOverviewChart="DONUT")),this.szFlag.match(/ZEROISNOTVALUE/)&&(this.fNullIsValue=!1),this.szFlag.match(/ZEROISVALUE/)&&(this.fNullIsValue=!0),this.szFlag.match(/NEGATIVEISNOTVALUE/)&&(this.fNegativeValuePossible=!1),this.szFlag.match(/NEGATIVEISVALUE/)&&(this.fNegativeValuePossible=!0),this.szFlag.match(/UNDEFINEDISVALUE/)&&(this.fUndefinedValuePossible=!0),this.szFlag.match(/UNDEFINEDISNOTVALUE/)&&(this.fUndefinedValuePossible=!1),this.szFlag.match(/CHECKRECORDLENGTH/)&&(this.fCheckRecordLength=!0),this.szFlag.match(/SUM/)&&(this.szAggregation="sum"),this.szFlag.match(/MEAN/)&&(this.szAggregation="mean"),this.szFlag.match(/MAX/)&&(this.szAggregation="max"),this.szFlag.match(/CHART/)&&((this.szFlag.match(/CATEGORICAL/)||this.szFieldsA.length>1)&&(this.fNullIsValue=!0),this.szFlag.match(/BUFFER/)||(this.fShadow=this.fOrigShadow=!0)),this.szFlag.match(/CATEGORICAL/)&&!this.szFlag.match(/AGGREGATE/)&&(this.fNegativeValuePossible=!1),this.szFlag.match(/CATEGORICAL/)&&!this.szLabelA&&(this.szLabelA=[]),this.fClipCharts=!0,this.fSortBeforeDraw=!0,this.fGrayNoMember=!0,this.nClipTimeout=1e3,this.paintedShapeNodesA=[],this.szChoroplethInfoStyle=map.Themes.szChoroplethInfoStyle,this.nMaxThemeCharts=map.Themes.nMaxThemeCharts,this.nMaxShadowCharts=map.Themes.nMaxShadowCharts,this.nflushPaintShape=map.Themes.nflushPaintShape,this.nflushChartDraw=map.Themes.nflushChartDraw,this.themeNodesPosA=this.szFlag.match(/AGGREGATE|GROUP/)?[]:map.Themes.themeNodesPosA,this.style={theme:this},this.setProperties=function(e){this.szFields=e.field||e.fields||this.szFields,this.szField100=e.field100||this.szField100,this.szFieldsA=t.split("|"),this.szField100A=i.split("|"),this.style.setProperties(e)},this.style.setProperties=function(e){map.Themes.parseStyle(this.theme,e)}}ixMap.Themes.prototype.cleanUpThemeObj=function(e,t){e.field=t.field,e.style.values=t.style.values,e.style.label=t.style.label,e.style.xaxis=t.style.xaxis;var i=e.style,a=null;if(i.colorscheme){for(var s in a=i.colorscheme[0],i.colorscheme)if(i.colorscheme[s]!=a){a=null;break}a&&(i.colorscheme.length=1)}if(i.symbols){for(var s in a=i.symbols[0],i.symbols)if(i.symbols[s]!=a){a=null;break}a&&(i.symbols.length=1)}return i.aggregationscale?(i.aggregationfield=null,i.gridwidth=null,i.gridwidthpx=null):i.aggregationfield?(i.gridwidth=null,i.gridwidthpx=null):i.gridwidthpx&&(i.gridwidth=null),i.evidence&&"isolate"==i.evidence&&(i.evidence=null),i.aggregation&&(i.aggregation=null),i.type.match(/DOMINANT/)||i.type.match(/PERCENTOFMEAN/)||i.type.match(/OFFSETMEAN/)||i.type.match(/PERCENTOFMEAN/)||i.type.match(/DEVIATION/)||(i.dominantfilter=null,i.dominantdfilter=null),i.itemfield&&i.lookupfield&&i.itemfield==i.lookupfield&&(i.itemfield=null),e},ixMap.Themes.prototype.getThemeDefinitionString=function(e){return'map.Api.newMapTheme("'+e.szThemes+'","'+(e.szFields||"")+'","'+(e.szField100||"")+'","type:'+e.szFlag+";colorscheme:"+__getSaveColorScheme(e.origColorScheme)+";"+__maptheme_getStyleString(e)+';child:true;");'},ixMap.Themes.prototype.getMapThemeStyleString=function(e){var t=this.getTheme(e)||this.activeTheme;return t&&t.colorScheme?"type:"+t.szFlag+";colorscheme:"+t.colorScheme+";"+__maptheme_getStyleString(t):null},ixMap.Themes.prototype.getMapThemeDefinitionObj=function(e){var t=this.getTheme(e)||this.activeTheme,i={};if(i.layer=t.szThemes,i.field=t.szFields||"",i.field100=t.szField100||"",t.szFlag.match(/\bWMS|IMAGE\b/)){var a={type:t.szFlag,server:t.szServer,opacity:t.nOpacity,title:t.szTitle,name:t.szName};return i.style=a,i}t.szFlag.match(/\bCATEGORICAL\b/)&&t.colorScheme&&t.colorScheme.length>3&&(!t.szValuesA||!t.szValuesA.length)&&t.szLabelA&&t.szLabelA.length&&t.szLabelA.length<=100&&(t.szValuesA=t.szLabelA.slice(0));a={type:t.szFlag,colorscheme:t.origColorScheme};var s=__maptheme_getStyleObj(t);for(var n in s)a[n]=s[n];return i.style=a,this.cleanUpThemeObj(i,t.origDef)},ixMap.Themes.prototype.getTheme=function(e){if(!e||"string"!=typeof e)return this.activeTheme;e=e.split(":")[0];for(var t=0;t<this.themesA.length;t++){if(this.themesA[t].szId==e)return this.themesA[t];if(this.themesA[t].szName==e)return this.themesA[t]}return!isNaN(Number(e))&&Number(e)<this.themesA.length?this.themesA[Number(e)]:this.activeTheme},ixMap.Themes.prototype.getThemeIndex=function(e){for(var t=0;t<this.themesA.length;t++)if(this.themesA[t].szId==e)return t},ixMap.Themes.prototype.refreshTheme=function(e){var t=this.getTheme(e);if(t){if(t.initValues(),t.szValuesA=null,t.szFlag.match(/RANGES/)||(t.szRangesA=null),t.szExactA=null,t.fRealize=!0,t.fRedraw=!0,!fAllIncluded&&t.coTable)return void this.loadExternalData(t.coTable,!0,t);t.animateTimeout&&clearTimeout(t.animateTimeout),executeWithMessage("map.Themes.execute()","... processing ...")}},ixMap.Themes.prototype.resetTheme=function(e){var t=map.Themes.getTheme(e);if(t){var i=t.chartGroup,a=map.Themes.getMapThemeDefinitionObj(e);map.Themes.themesA.splice(map.Themes.getThemeIndex[e],1),a.style.datacache=!1,(t=map.Themes.newThemeByObj(a)).chartGroup=i}},ixMap.Themes.prototype.nextClipFrame=function(e){var t=this.getTheme(e);t&&t.realizeNextClipFrame()},ixMap.Themes.prototype.setClipFrame=function(e,t){var i=e?this.getTheme(e):this.activeTheme;i&&i.setClipFrame(t)},ixMap.Themes.prototype.pauseClip=function(e){var t=this.getTheme(e);t&&t.pauseClip()},ixMap.Themes.prototype.startClip=function(e){var t=this.getTheme(e);t&&t.startClip()},ixMap.Themes.prototype.loadExternalData=function(szData,fRefresh,themeObj){if(this.coTableExt||(this.coTableExt=[]),_TRACE("... load external data ...:"+szData),szData){var szMessage=map.Dictionary.getLocalText("... creating theme ...");fRefresh&&("undefined"!=eval("typeof("+szData+")")&&eval(szData+".table = null"),szMessage=map.Dictionary.getLocalText("... refreshing theme ...")),this.__test=null;try{eval("this.__test = "+szData+".table")}catch(e){try{eval("this.__test = "+szData+"_table")}catch(e){}}var fCached=themeObj.fEditor||!(themeObj.coTableUrl&&themeObj.coTableExt)||!1;if(this.themeDataCacheA[szData]&&((this.themeDataCacheA[szData].coTableUrl||themeObj.coTableUrl)&&this.themeDataCacheA[szData].coTableUrl!=themeObj.coTableUrl||(this.themeDataCacheA[szData].coTableExt||themeObj.coTableExt)&&this.themeDataCacheA[szData].coTableExt!=themeObj.coTableExt||(fCached=!0)),this.__test&&fCached&&!0===themeObj.fDataCache)return this.fWaitforData=!1,themeObj.fWaitingforData=!1,_TRACE("data is already loaded, then make the theme"),executeWithMessage("map.Themes.execute()",szMessage),void(themeObj&&themeObj.coTableExt&&(themeObj.coTableExt=this.coTableExt[themeObj.coTable]));if(themeObj&&(themeObj.coTableUrl||themeObj.coTableExt||"ext"==themeObj.coTableType))try{return this.themeDataCacheA[szData]={coTableUrl:themeObj.coTableUrl,coTableExt:themeObj.coTableExt},this.fWaitforData=!0,themeObj.fWaitingforData=!0,HTMLWindow.ixmaps.htmlgui_loadExternalData(themeObj.coTableUrl,{theme:themeObj,type:themeObj.coTableType,name:themeObj.coTable,ext:themeObj.coTableExt}),void(this.coTableExt[themeObj.coTable]=themeObj.coTableExt)}catch(e){}fLocalHost?this.loadExternalDataDefault(szData,fRefresh,szMessage):this.loadExternalDataZipped(szData,fRefresh,szMessage)}},ixMap.Themes.prototype.loadExternalDataZipped=function(e,t,i){this.fWaitforData=!0,displayMessage(map.Dictionary.getLocalText("... loading data ...")),_TRACE("... loading data ...");var a=new JSLoader;a.finishedCallback="map.Themes.loadExternalDataFinish('"+i+"')",a.errorCallback="map.Themes.loadExternalDataDefault('"+e+"',"+t+",'"+i+"')",a.szMessage=map.Dictionary.getLocalText("... loading data ..."),a.loadScript(map.mapRoot+e+".js.gz",t)},ixMap.Themes.prototype.loadExternalDataDefault=function(e,t,i){this.fWaitforData=!0,displayMessage(map.Dictionary.getLocalText("... loading data ...")),_TRACE("... loading data ...");var a=new JSLoader;a.finishedCallback="map.Themes.loadExternalDataFinish('"+i+"')",a.errorCallback="map.Themes.loadExternalDataFinish('"+i+"')",a.szMessage=map.Dictionary.getLocalText("... loading data ..."),a.loadScript(map.mapRoot+e+".js",t)},ixMap.Themes.prototype.loadExternalDataFinish=function(e){this.fWaitforData=!1,executeWithMessage("map.Themes.execute()",e)},ixMap.Themes.prototype.setExternalData=function(szThemeId,dataObj,szDataName){dataObj&&(this._dataObj=dataObj,eval(szDataName+" = this._dataObj")),this.fWaitforData=!1;var themesA=this.getAllThemes();for(var i in themesA)themesA[i].coTable==szDataName&&(themesA[i].fWaitingforData=!1);this.execute()},ixMap.Themes.prototype.activateTheme=function(e,t){var i=this.getTheme(t);i&&(i.fRedraw=!0,executeWithMessage("map.Themes.execute()","... processing ...")),e.stopPropagation(),e.preventDefault()},ixMap.Themes.prototype.showTheme=function(e,t){var i=this.getTheme(t);i&&(i.fShow=!0,executeWithMessage("map.Themes.execute()","... processing ...")),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.hideTheme=function(e,t){var i=this.getTheme(t);i&&(i.fHide=!0,executeWithMessage("map.Themes.execute()","... processing ...")),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.toggleTheme=function(e,t){var i=this.getTheme(t);i&&(i.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ...")),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.removeTheme=function(e,t){for(var i=0;i<this.themesA.length;i++)if(this.themesA[i].szId==t||this.themesA[i].szName==t){var a=this.themesA[i];if(a.szFlag.match(/LOCKED/))continue;a.szFlag.match(/CHART/)&&(a.fToggle=!0),a.fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.removeAll=function(e){for(var t=0;t<this.themesA.length;t++)this.themesA[t].szFlag.match(/LOCKED/)||(this.themesA[t].fRemove=!this.themesA[t].fRealize||this.themesA[t].fOutOfScale);setTimeout((function(){map.Themes.execute()}),100),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.removeAllCharts=function(e){for(var t=0;t<this.themesA.length;t++)this.themesA[t].szFlag.match(/CHART/)&&!this.themesA[t].szFlag.match(/LOCKED/)&&(this.themesA[t].fRemove=!0);this.fWaitforData=!0,map.Themes.execute(),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.removeAllChoropleth=function(e){for(var t=0;t<this.themesA.length;t++)this.themesA[t].szFlag.match(/CHOROPLETH/)&&!this.themesA[t].szFlag.match(/LOCKED/)&&(this.themesA[t].fRemove=!this.themesA[t].fRealize);this.fWaitforData=!0,executeWithMessage("map.Themes.execute()","... processing ..."),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.removeAllSelections=function(e){for(var t=0;t<this.themesA.length;t++)this.themesA[t].szFlag.match(/SELECTION/)&&(this.themesA[t].fRemove=!0,executeWithMessage("map.Themes.execute()","... processing ..."));e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.redrawInfoAll=function(e){for(var t=0;t<this.themesA.length;t++)this.themesA[t].fRedrawInfo=!0;map.Themes.execute(),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.reformat=function(e){this.minX=0,this.minY=0;for(var t=0;t<this.themesA.length;t++)this.themesA[t].fRepositionInfo=!0,this.themesA[t].fRedrawInfo=!0;map.Themes.execute(),e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.execute=function(){_TRACE("ixMap.Themes.execute() =====>");var szDisableType=null,szDisableThemes=null,i=0;if(map.isIdle()){if(!this.fWaitforData){if(map.Tiles.isLoading())return setTimeout((function(){map.Themes.execute()}),250),void(this.fExecuteDelayed=!0);if(this.fExecuteDelayed)return this.fExecuteDelayed=!1,void executeWithMessage("map.Themes.execute()"," ... ");for(i=0;i<this.themesA.length;i++)(this.themesA[i].fRealize||this.themesA[i].fRedraw||this.themesA[i].fToFront)&&this.themesA[i].szFlag.match(/CHOROPLETH/)&&!this.themesA[i].szFlag.match(/SUBTHEME/)&&(szDisableType=this.themesA[i].szShapeType,szDisableThemes=this.themesA[i].szThemes,_TRACE("Disable =====>"));if(szDisableType&&this.enableMultiChoropleth)for(_TRACE("do Disable =====>"),i=0;i<this.themesA.length;i++)this.themesA[i].szFlag&&this.themesA[i].szFlag.match(/CHOROPLETH/)&&this.themesA[i].szShapeType==szDisableType&&(this.themesA[i].disable(),this.themesA[i].isVisible=!1,this.themesA[i].fRedrawInfo=!1);if(szDisableType&&!this.enableMultiChoropleth)for(_TRACE("remove old CHOROPLETH =====>"),i=0;i<this.themesA.length;i++)this.themesA[i].szFlag&&this.themesA[i].szFlag.match(/CHOROPLETH/)&&this.themesA[i].szShapeType==szDisableType&&this.themesA[i].szThemes==szDisableThemes&&(this.themesA[i].fRealize||this.themesA[i].fRedraw||this.themesA[i].fToFront||(_TRACE("do Remove old CHOROPLETH theme"+this.themesA[i].szId+"=====>"),this.themesA[i].fRemove=!0));for(i=0;i<this.themesA.length;i++){if(this.themesA[i].fWaitingforData)return;if(this.themesA[i].fShow&&this.themesA[i].fDone){_TRACE("Show =====>"),this.themesA[i].toggle(!0),this.themesA[i].fShow=!1;break}if(this.themesA[i].fHide&&this.themesA[i].fDone){_TRACE("Hide =====>"),this.themesA[i].toggle(!1),this.themesA[i].fHide=!1;break}if(this.themesA[i].fToggle&&this.themesA[i].fDone){_TRACE("Toggle =====>"),this.themesA[i].toggle(),this.themesA[i].fToggle=!1,this.execute();break}if(this.themesA[i].fRemove){_TRACE("Remove =====> "+this.themesA[i].szId),this.themesA.length>1&&!this.themesA[i].szFlag.match(/SELECTION/)&&!this.themesA[i].szFlag.match(/CHART/)&&this.activateNextPaint(this.themesA[i]),this.themesA[i].removeElements(),this.remove(this.themesA[i]),this.reformat(),this.execute();break}if(this.themesA[i].fRealize){if(this.themesA[i].nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.themesA[i].nChartUpper||this.themesA[i].nChartLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.themesA[i].nChartLower){this.themesA[i].chartGroup&&this.themesA[i].chartGroup.style.setProperty("display","none",""),this.themesA[i].fOutOfScale=!0;continue}this.themesA[i].fOutOfScale=!1,_TRACE("realize "+this.themesA[i].szId),this.themesA[i].fEnableProgressBar=!0,this.themesA[i].fRealize=!1,this.themesA[i].realize()}else if(this.themesA[i].fRedraw){if(_TRACE("Redraw =====> "+this.themesA[i].szId),this.themesA[i].fRedraw=!1,this.themesA[i].fActualize=!1,this.themesA[i].checkHiddenLayerState&&this.themesA[i].checkHiddenLayerState()){this.themesA[i].fRealize=!0,this.themesA[i].fRedraw=!1,this.themesA[i].fReload=!1,this.themesA[i].unpaintMap(),map.Themes.execute();continue}this.themesA[i].fEnableProgressBar=!0,this.themesA[i].szFlag.match(/FEATURE/)||this.themesA[i].unpaintMap(),this.themesA[i].redraw(!1)}else if(this.themesA[i].fActualize){if(_TRACE("Actualize =====> "+this.themesA[i].szId),this.themesA[i].fActualize=!1,this.themesA[i].checkHiddenLayerState&&this.themesA[i].checkHiddenLayerState()){this.themesA[i].fRealize=!0,this.themesA[i].fRedraw=!1,this.themesA[i].fReload=!1,this.themesA[i].unpaintMap(),map.Themes.execute();continue}this.themesA[i].fEnableProgressBar=!0,this.themesA[i].redraw(!1)}else if(this.themesA[i].fToFront)_TRACE("ToFront =====> "+this.themesA[i].szId),this.themesA[i].fEnableProgressBar=!1,this.themesA[i].toFront(),this.themesA[i].fToFront=!1;else if(this.themesA[i].fResize)_TRACE("Resize =====> "+this.themesA[i].szId),this.themesA[i].resize(this.themesA[i].fResize),this.themesA[i].fResize=!1;else if(this.themesA[i].fOpacity)_TRACE("Opacity =====> "+this.themesA[i].szId),this.themesA[i].opacity(this.themesA[i].fOpacity),this.themesA[i].fOpacity=!1;else if(this.themesA[i].fBlur)_TRACE("Blur =====> "+this.themesA[i].szId),this.themesA[i].blur(this.themesA[i].nBlur),this.themesA[i].fBlur=!1;else if(this.themesA[i].fOffset)_TRACE("Offset =====> "+this.themesA[i].szId),this.themesA[i].offset(this.themesA[i].fOffset),this.themesA[i].fOffset=!1;else if(this.themesA[i].fRedrawInfo)_TRACE("Redraw Info =====> "+this.themesA[i].szId),this.themesA[i].widgetNode&&this.themesA[i].showInfo(),this.themesA[i].fRedrawInfo=!1;else if(this.themesA[i].fResort){_TRACE("Resort =====> "+this.themesA[i].szId);try{this.themesA[i].sortChartObjects()}catch(e){}this.themesA[i].fResort=!1}else if(this.themesA[i].fDeclutter){_TRACE("Declutter =====> "+this.themesA[i].szId);try{this.themesA[i].declutterCharts()}catch(e){}this.themesA[i].fDeclutter=!1}else;}this.executeCallback&&(_TRACE("Callback =====> "),eval(this.executeCallback),this.executeCallback=null),clearMessage(),clearMessage(1e3),_TRACE("== ixMap.Themes.execute done")}}else setTimeout((function(){map.Themes.execute()}),100)},ixMap.Themes.prototype.executeContinue=function(){for(var e=0;e<this.themesA.length;e++)this.themesA[e].fAnalyze?(this.themesA[e].fAnalyze=!1,this.themesA[e].realize_analyze()):this.themesA[e].fDraw?(this.themesA[e].fDraw=!1,this.themesA[e].realize_draw()):this.themesA[e].fContinue?(this.themesA[e].fContinue=!1,this.themesA[e].realizeContinue(this.themesA[e].continueIndex)):this.themesA[e].fContinueLoadAndAggregate&&(this.themesA[e].fContinueLoadAndAggregate=!1,this.themesA[e].loadAndAggregateValuesOfTheme(this.themesA[e].szThemeLayer,this.themesA[e].continueIndex))},ixMap.Themes.prototype.realizeDone=function(e){for(var t=0;t<this.themesA.length;t++)this.themesA[t].szFlag.match(/SELECTION/)&&(this.themesA[t].fRealize=!0);e.fRealizeDone=!0,e.szFlag.match(/BUFFER/)?this.activeBuffer=e:this.activeTheme=e;try{HTMLWindow.ixmaps.htmlgui_setActualTheme(e.szId)}catch(e){}try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(e.szId)}catch(e){}e.szFlag.match(/TEXTONLY/)&&setTimeout((function(){map.Layer.adaptLabel()}),10),e.szFlag.match(/ANIMATEPOSITION/)&&(e.animateTimeout&&clearTimeout(e.animateTimeout),e.animateTimeout=setTimeout((function(){map.Themes.animateChartPosition(null,e.szId)}),100)),e.userChartDrawError&&e.userChartDrawError==e.nDoneCount&&displayMessage("User draw function error! ",5e3),this.isIdle()&&clearMessage(),setTimeout("map.Themes.execute()",100)},ixMap.Themes.prototype.showProgressBar=function(){for(var e=0;e<this.themesA.length;e++)(this.themesA[e].fRealize||this.themesA[e].fContinue||this.themesA[e].fAnalyze||this.themesA[e].fDraw)&&this.themesA[e].nCount/this.themesA[e].nDoneCount>2&&this.themesA[e].mapSleep?this.themesA[e].mapSleep.fShowProgressBar=!0:(this.themesA[e].fRealize||this.themesA[e].fContinue||this.themesA[e].fAnalyze||this.themesA[e].fDraw)&&setTimeout((function(){map.Themes.showProgressBar()}),1e3)},ixMap.Themes.prototype.remove=function(e){e==this.activeTheme&&(this.activeTheme=null),e==this.activeBuffer&&(this.activeBuffer=null);for(var t=0;t<this.themesA.length;t++)if(this.themesA[t]==e){for(;t<this.themesA.length-1;t++)this.themesA[t]=this.themesA[t+1];this.themesA.length--}e.removeValues()},ixMap.Themes.prototype.cancelExecute=function(){this.activeTheme.fCancel=!0},ixMap.Themes.prototype.sequence=function(){this.sequenceNr=0,this.sequenceNext()},ixMap.Themes.prototype.sequenceNext=function(){this.sequenceNr<this.themesA.length&&(this.themesA[this.sequenceNr].fRedraw=!0,map.Themes.executeCallback="setTimeout('map.Themes.sequenceNext()',500)",map.Themes.execute(),this.sequenceNr++)},ixMap.Themes.prototype.activateNextPaint=function(e){for(var t=this.getThemeIndex(e.szId),i=t-1;i!=t;i--){if(i<0&&(i=this.themesA.length-1),i==t)return!1;if(this.themesA[i].isChecked&&!this.themesA[i].szFlag.match(/CHART/))return this.themesA[i].fRedraw=!0,this.themesA[i].fRedrawInfo=!1,!0}return!1},ixMap.Themes.prototype.toggleThemeValues=function(e,t){this.toggleValueDisplay(e,this.activeTheme.szId,!this.activeTheme.szFlag.match(/VALUES/))},ixMap.Themes.prototype.toggleThemeLegends=function(e,t){SVGThemeGroup.style.setProperty("display",t?"inline":"none","")},ixMap.Themes.prototype.minimizeThemeLegends=function(e){this.fMinimizedLegends=!0;for(var t=0;t<this.themesA.length;t++)this.minimizeInfo(e,this.themesA[t].szId)},ixMap.Themes.prototype.changeAllChartScaling=function(e,t){for(var i=0;i<this.themesA.length;i++)this.themesA[i].fResize=999,executeWithMessage("map.Themes.execute()","... processing ...");e.stopPropagation(),e.preventDefault()},ixMap.Themes.prototype.changeChartScaling=function(e,t,i){var a=this.getTheme(t);a&&(a.fResize=i,executeWithMessage("map.Themes.execute()","... processing ...")),e.stopPropagation(),e.preventDefault()},ixMap.Themes.prototype.changeChartOpacity=function(e,t,i){var a=this.getTheme(t);a&&(a.fOpacity=i,executeWithMessage("map.Themes.execute()","... processing ...")),e.stopPropagation(),e.preventDefault()},ixMap.Themes.prototype.changeChartOffset=function(e,t,i){var a=this.getTheme(t);if(a&&a.leadOffset){var s=SVGDocument.getElementById(i);if(s){s.fu=new Methods(s);var n=s.fu.getPosition(),l=s.fu.getGroupScale();a.fOffset=new point(n.x-a.leadOffset.x,n.y-a.leadOffset.y),s.fu.setPosition(a.leadOffset.x,a.leadOffset.y),a.fOffset.x/=map.Zoom.nZoom/l.x,a.fOffset.y/=map.Zoom.nZoom/l.y,a.offset(a.fOffset),a.fOffset=!1,a.leadOffset=!1}}},ixMap.Themes.prototype.tellChartOffset=function(e,t,i){var a=this.getTheme(t);if(a&&!a.leadOffset&&this.enableChartOffset){var s=SVGDocument.getElementById(i);s&&(s.fu=new Methods(s),a.leadOffset=s.fu.getPosition(),_TRACE("ixMap.Themes.tellChartOffset((): "+a.leadOffset.x+","+a.leadOffset.y))}},ixMap.Themes.prototype.initChartOffset=function(e,t,i){if(this.getTheme(t)){var a=SVGDocument.getElementById(i);a&&(a.origPosition||(a.origPosition=a.fu.getPosition()),a.onMouseMove=function(e){a.actualPosition=a.fu.getPosition(),map.Themes.makeChartOffsetPointer(a)},a.widgetObj=new Widget(a,a))}},ixMap.Themes.prototype.endChartOffset=function(e,t,i){if(this.getTheme(t)){var a=SVGDocument.getElementById(i);a&&a.widgetObj.remove()}},ixMap.Themes.prototype.makeChartOffsetPointer=function(e,t){t=t||1;if(e.pointerObj?(map.Dom.clearGroup(e.pointerObj),map.Dom.clearGroup(e.pointShObj)):(e.pointerObj=map.Dom.newGroup(e),e.pointShObj=map.Dom.newGroup(e),e.pointerObj.parentNode.insertBefore(e.pointerObj,e.pointerObj.parentNode.firstChild),e.pointShObj.parentNode.insertBefore(e.pointShObj,e.pointShObj.parentNode.firstChild)),e.origPosition||e.actualPosition){var i=new box(0,0,100,75),a=new point(e.actualPosition.x-e.origPosition.x,e.actualPosition.y-e.origPosition.y),s=map.Scale.normalX(15),n=map.Scale.normalX(5),l=map.Scale.normalX(10);map.Scale.normalX(5);n=a.y+i.height/2,s=a.x+i.width/2,Math.abs(n)+i.width/2-i.height/2>Math.abs(s)?(i.width/3>l&&(a.x>-i.width/3&&(s-=i.width/3),a.x<-i.width/3*2&&(s+=i.width/3)),n>0?(map.Dom.newShape("path",e.pointShObj,"M"+-a.x+","+-a.y+" l "+(s-map.Scale.normalX(5/t))+","+(a.y+map.Scale.normalX(1/t))+" "+map.Scale.normalX(4/t)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-a.x+","+-a.y+" l "+(s-map.Scale.normalX(5/t))+","+(a.y+map.Scale.normalX(1/t))+" "+map.Scale.normalX(3/t)+",0 z","fill:white")):(map.Dom.newShape("path",e.pointShObj,"M"+-a.x+","+-a.y+" l "+(s-map.Scale.normalX(4/t))+","+(a.y+i.height)+" "+map.Scale.normalX(4/t)+",0 z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-a.x+","+-a.y+" l "+(s-map.Scale.normalX(4/t))+","+(a.y+i.height)+" "+map.Scale.normalX(3/t)+",0 z","fill:white"))):(i.height/5>l&&(a.y>-i.height/3&&(n-=i.height/3),a.y<-i.height/3*2&&(n+=i.height/3)),s>0?(map.Dom.newShape("path",e.pointShObj,"M"+-a.x+","+-a.y+" l "+(a.x-i.width)+","+(n-map.Scale.normalX(4/t))+" 0,"+map.Scale.normalX(4/t)+" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-a.x+","+-a.y+" l "+(a.x-i.width)+","+(n-map.Scale.normalX(4/t))+" 0,"+map.Scale.normalX(3/t)+" z","fill:white")):(map.Dom.newShape("path",e.pointShObj,"M"+-a.x+","+-a.y+" l "+(a.x+i.width)+","+(n-map.Scale.normalX(4/t))+" 0,"+map.Scale.normalX(4/t)+" z","fill:black;fill-opacity:0.5"),map.Dom.newShape("path",e.pointerObj,"M"+-a.x+","+-a.y+" l "+(a.x+i.width)+","+(n-map.Scale.normalX(4/t))+" 0,"+map.Scale.normalX(3/t)+" z","fill:white")))}},ixMap.Themes.prototype.animateChartPosition=function(e,t){var a=this.getTheme(t);if(a){var s=a.chartGroup.childNodes;for(i=0;i<s.length;i++){var n=s[i].fu.getPosition(),l=new point(s[i].getAttributeNS(szMapNs,"xEnd"),s[i].getAttributeNS(szMapNs,"yEnd")),h=s[i].getAttributeNS(szMapNs,"dur");dx=(l.x-n.x)/h,dy=(l.y-n.y)/h,s[i].fu.setPosition(n.x+dx,n.y+dy),s[i].setAttributeNS(szMapNs,"dur",--h)}a.animateTimeout&&clearTimeout(a.animateTimeout),a.animateTimeout=setTimeout((function(){map.Themes.animateChartPosition(null,a.szId)}),100)}},MapTheme.prototype.declutterCharts=function(){if(!(this.szDeclutterUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nDeclutterUpper)){var e=this.chartGroup.childNodes;for(a=0;a<e.length;a++)e[a].actualPosition&&(e[a].fu.setPosition(e[a].origPosition.x,e[a].origPosition.y),e[a].origPosition=null,e[a].actualPosition=null,e[a].pointerObj&&(map.Dom.clearGroup(e[a].pointerObj),map.Dom.clearGroup(e[a].pointShObj)),e[a].pointerObj=null,e[a].pointShObj=null);if(!e[0].actualPosition){for(var t=e[0].fu.getBox(),i=(map.Zoom.getBox(),[]),a=0;a<e.length;a++){var s=!1,n=e[a].fu.getPosition(),l=e[a].fu.getBox();for(var h in l.x+=n.x,l.y+=n.y,i)for(var o in i[h])if(!(l.y+l.height<i[h][o].box.y-.3*i[h][o].box.height||l.y>i[h][o].box.y+1.3*i[h][o].box.height||l.x+l.width<i[h][o].box.x-i[h][o].box.width||l.x>i[h][o].box.x+2*i[h][o].box.width)){i[h].push({node:e[a],y:e[a].fu.getPosition().x,box:l}),s=!0;break}s||i.push([{node:e[a],y:e[a].fu.getPosition().x,box:l}])}for(h=0;h<i.length;h++){var r=i[h];if(r.sort(this.sortUpChartObjectsCompare),r.length>1&&r.length<5){var m=r[0].node.fu.getPosition();for(a=0;a<r.length;a++){(n=r[a].node.fu.getPosition()).y<m.y&&(m.x=n.x,m.y=n.y)}m.y-=map.Scale.normalX(50)*map.Scale.nZoomScale;for(n=r[0].node.fu.getPosition(),a=0;a<r.length;a++){r[a].node.origPosition=r[a].node.fu.getPosition(),r[a].node.fu.setPosition(n.x+1.2*t.width*a,m.y),r[a].node.actualPosition=new point(n.x+1.2*t.width*a,m.y);var p=r[a].node.fu.getScale().x;r[a].node.actualPosition.x=r[a].node.origPosition.x-(r[a].node.origPosition.x-r[a].node.actualPosition.x)/p,r[a].node.actualPosition.y=r[a].node.origPosition.y-(r[a].node.origPosition.y-r[a].node.actualPosition.y)/p,map.Themes.makeChartOffsetPointer(r[a].node,this.nScale)}}}}}},MapTheme.prototype.animateCharts=function(e){var t=this.chartGroup.childNodes;if("scale"==e)for(i=0;i<t.length;i++){(a=t[i].firstChild).setAttributeNS(null,"transform","scale(1 1)");map.Dom.constructNode("animateTransform",a,{attributeName:"transform",type:"scale",from:"0 0",to:"1 1",begin:String(.2*Math.random())+"s",dur:"2s",repeatCount:"1"})}if("fire"==e)for(i=0;i<t.length;i++){var a;(a=t[i].firstChild).setAttributeNS(null,"transform","scale(1 1)");map.Dom.constructNode("animateTransform",a,{attributeName:"transform",type:"scale",from:"0 0",to:"1 1",begin:String(1*Math.random())+"s",dur:"0.5s",repeatCount:"3"})}},ixMap.Themes.prototype.toggleValueDisplay=function(e,t,i){var a=this.getTheme(t);if(a){for(var s="",n=a.szFlag.split("|"),l=0;l<n.length;l++)"VALUES"!=n[l]&&(s+=(s.length?"|":"")+n[l]);i&&(s+="|VALUES"),executeWithMessage("map.Themes.doChangeThemeStyle('"+a.szId+"','type:"+s+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.toggleDopacity=function(e,t,i){var a=this.getTheme(t);if(a){for(var s="",n=a.szFlag.split("|"),l=0;l<n.length;l++)n[l].match(/DOPACITY/)||(s+=(s.length?"|":"")+n[l]);i&&(s+="|DOPACITYMAX"),executeWithMessage("map.Themes.doChangeThemeStyle('"+a.szId+"','type:"+s+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.changeDopacityAlphaRamp=function(e,t,i){var a=this.getTheme(t);if(a){var s=a.szFlag;a.nDopacityScale=a.nDopacityScale||1,a.nDopacityScale*=i,executeWithMessage("map.Themes.doChangeThemeStyle('"+a.szId+"','type:"+s+"')","... processing ...")}e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.toggleChartDisplay=function(e,t,i){var a=this.getTheme(t);a&&(a.fToggle=!0,executeWithMessage("map.Themes.execute()","... processing ...")),e.stopPropagation(),e.preventDefault()},ixMap.Themes.prototype.zoomTo=function(e,t){var i=this.getTheme(t)||this.activeTheme;i&&i.zoomTo()},ixMap.Themes.prototype.zoomToClass=function(e,t,i,a){setTimeout((function(){map.Themes.doZoomToClass(t,i,a)}),100)},ixMap.Themes.prototype.markClass=function(e,t,i,a){var s=this.getTheme(t);if(s&&s.isVisible&&!s.showInfoMore){if(void 0!==s.markedClass&&s.markedClass==i||void 0!==s.markedClasses&&s.markedClasses[i])return void this.unmarkClass(e,t,i);s.fMarkEnable=!0,s.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),displayMessage("...",500,!0),this.markTimeout=setTimeout((function(){map.Themes.doMarkClass(t,i,a)}),50)}},ixMap.Themes.prototype.unmarkClass=function(e,t,i){var a=this.getTheme(t);a&&a.isVisible&&!a.showInfoMore&&(displayMessage("...",500,!0),this.unmarkTimeout=setTimeout((function(){map.Themes.doUnmarkClass(t,i)}),50),a.fUnmarkEnable=!0,a.fMarkEnable=!1)},ixMap.Themes.prototype.doZoomToClass=function(e,t,i){var a=this.getTheme(e);a&&a.zoomToClass(Number(t),Number(i))},ixMap.Themes.prototype.doMarkClass=function(e,t,i){var a=this.getTheme(e);if(a){for(var s in a.markedClass=t,a.markedClasses=a.markedClasses||[],a.markedClasses[t]=!0,a.markedClassesA=[],a.markedClasses)!0===a.markedClasses[s]&&a.markedClassesA.push(s);a.markClass(Number(t),Number(i));try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(a.szId)}catch(e){}}},ixMap.Themes.prototype.doUnmarkClass=function(e,t){var i=this.getTheme(e);if(i){if(i.markedClass=null,i.markedClasses){for(var a in i.markedClasses[t]=!1,i.markedClassesA=[],i.markedClasses)!0===i.markedClasses[a]&&i.markedClassesA.push(a);if(i.markedClassesA.length){displayMessage("...",500,!0),i.fMarkEnable=!0,i.markClass(i.markedClassesA[0],1),i.fMarkEnable=!1;try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(i.szId)}catch(e){}return}delete i.markedClassesA,delete i.markedClasses}i.unmarkClass();try{HTMLWindow.ixmaps.htmlgui_onDrawTheme(i.szId)}catch(e){}}},ixMap.Themes.prototype.hideClass=function(e,t,i,a){var s=this.getTheme(t);s&&s.isVisible&&s.showClass(Number(i),Number(a),!1)},ixMap.Themes.prototype.showClass=function(e,t,i,a){var s=this.getTheme(t);s&&s.isVisible&&s.showClass(Number(i),Number(a),!0)},ixMap.Themes.prototype.classesToRanges=function(e,t){var i=this.getTheme(t);i&&i.isVisible&&i.classesToRanges()},ixMap.Themes.prototype.filterItems=function(e,t,i,a){var s=t?this.getTheme(t):this.activeTheme;s&&s.isVisible&&!s.showInfoMore&&(s.fMarkEnable=!0,s.fUnmarkEnable=!1,this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.opt=a,this.markTimeout=setTimeout((function(){map.Themes.doFilterItems(t,i)}),500))},ixMap.Themes.prototype.doFilterItems=function(e,t){executeWithMessage("map.Themes.doFilterItemsGo('"+e+"','"+t+"')","applying filter ...")},ixMap.Themes.prototype.doFilterItemsGo=function(e,t){clearMessage();var i=this.getTheme(e||null);i&&(i.filterItems(t,this.opt),this.activeTheme=i)},ixMap.Themes.prototype.selectFilterItems=function(e,t){var i=this.getTheme(t);i&&i.selectFilterItems()},ixMap.Themes.prototype.highlightItems=function(e,t,i,a){var s=t?this.getTheme(t):this.activeTheme;s&&s.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),this.highlightTimeout=setTimeout((function(){map.Themes.doHighlightItems(t,i,a)}),500))},ixMap.Themes.prototype.doHighlightItems=function(e,t,i){var a=e?this.getTheme(e):this.activeTheme;a&&a.highlightItems(t,i)},ixMap.Themes.prototype.clearHighlightItems=function(e,t){var i=t?this.getTheme(t):this.activeTheme;i&&i.isVisible&&(this.highlightTimeout&&clearTimeout(this.highlightTimeout),i.clearHighlightItems())},ixMap.Themes.prototype.setTimeFrame=function(e,t,i,a){var s=this.getTheme(t);s&&s.isVisible&&!s.showInfoMore&&(this.markTimeout&&clearTimeout(this.markTimeout),this.unmarkTimeout&&clearTimeout(this.unmarkTimeout),this.markTimeout=setTimeout((function(){map.Themes.doSetTimeFrame(t,i,a)}),1))},ixMap.Themes.prototype.doSetTimeFrame=function(e,t,i){if(null!=e){var a=this.getTheme(e);a&&a.setTimeFrame(t,i)}else{var s=this.getThemes();for(var n in s)s[n].setTimeFrame(t,i)}},ixMap.Themes.prototype.changeThemeStyle=function(e,t,i,a){if(null!=t)_TRACE("changeThemeStyle: '"+t+"' , '"+i.replace(/'/g,"\\'")+"' , '"+a+"'"),a&&a.match(/fast|silent|direct/)?map.Themes.doChangeThemeStyle(t,i.replace(/'/g,"\\'"),a):executeWithMessage("map.Themes.doChangeThemeStyle('"+t+"','"+i.replace(/'/g,"\\'")+"','"+a+"')","... processing ..."),e&&(e.stopPropagation(),e.preventDefault());else for(var s in themesA=this.getThemes(),themesA)themesA[s].szFlag.match(/FEATURE/)||this.changeThemeStyle(e,themesA[s].szId,i,a)},ixMap.Themes.prototype.doChangeThemeStyle=function(szId,szStyle,szFlag){var mapTheme=this.getTheme(szId);if(mapTheme){var styleObj=__getStyleObj(szStyle);if(styleObj){if(styleObj.type){if(styleObj.origType=styleObj.type,szFlag&&szFlag.match(/add/)){var styleA=styleObj.type.split("|");this.szTempStyle=mapTheme.szFlag;for(var i=0;i<styleA.length;i++)eval("this.szTempStyle.match(/"+styleA[i]+"/)")||(this.szTempStyle+="|"+styleA[i]);styleObj.type=this.szTempStyle}else if(szFlag&&szFlag.match(/remove/)){for(var styleA=mapTheme.szFlag.split("|"),szTempStyle="",i=0;i<styleA.length;i++)styleA[i]!=styleObj.type&&(szTempStyle+=(szTempStyle.length?"|":"")+styleA[i]);styleObj.type=szTempStyle}else if(szFlag&&szFlag.match(/toggle/)){for(var styleA=mapTheme.szFlag.split("|"),szTempStyle="",found=!1,i=0;i<styleA.length;i++)styleA[i]!=styleObj.type?szTempStyle+=(szTempStyle.length?"|":"")+styleA[i]:found=!0;styleObj.type=szTempStyle+(found?"":"|"+styleObj.type)}else mapTheme.szFlag.match(/FRACTION/)&&(styleObj.type+="|FRACTION"),mapTheme.szFlag.match(/PERMILLE/)&&(styleObj.type+="|PERMILLE"),mapTheme.szFlag.match(/CALCVAL/)&&(styleObj.type+="|CALCVAL"),mapTheme.szFlag.match(/CALC100/)&&(styleObj.type+="|CALC100"),mapTheme.szFlag.match(/PRODUCT/)&&(styleObj.type+="|PRODUCT"),mapTheme.szFlag.match(/RELATIVE/)&&(styleObj.type+="|RELATIVE"),mapTheme.szFlag.match(/INVERT/)&&(styleObj.type+="|INVERT"),mapTheme.szFlag.match(/INVERTSIZE/)&&(styleObj.type+="|INVERTSIZE"),mapTheme.szFlag.match(/DENSITY/)&&(styleObj.type+="|DENSITY"),mapTheme.szFlag.match(/SUM/)&&(styleObj.type+="|SUM"),mapTheme.szFlag.match(/CALCMEAN/)&&(styleObj.type+="|CALCMEAN"),mapTheme.szFlag.match(/AUTO100/)&&(styleObj.type+="|AUTO100");if(styleObj.type.match(/LOCKED/)&&(mapTheme.fRedrawInfo=!0,map.Themes.execute()),(styleObj.type.match(/CHART/)&&!mapTheme.szFlag.match(/CHART/)||styleObj.type.match(/CHOROPLETH/)&&!mapTheme.szFlag.match(/CHOROPLETH/))&&(mapTheme.unpaintMap(),this.activateNextPaint(mapTheme)),!styleObj.type.match(/CATEGORICAL/)&&(styleObj.type.match(/EQUIDISTANT/)||styleObj.type.match(/POW2/)||styleObj.type.match(/POW3/)||styleObj.type.match(/LOG/)||styleObj.type.match(/QUANTILE/))&&(mapTheme.szOldRanges=mapTheme.szRanges?mapTheme.szRanges:mapTheme.szOldRanges,mapTheme.szRanges=null,mapTheme.szOldLabelA=mapTheme.szLabelA?mapTheme.szLabelA:mapTheme.szOldLabelA,mapTheme.szLabelA=null,mapTheme.fRealize=!0),styleObj.type.match(/RANGES/)&&styleObj.ranges&&(mapTheme.szRanges=mapTheme.szOldRanges?mapTheme.szOldRanges:mapTheme.szRanges,mapTheme.szRangesA=styleObj.ranges.split(styleObj.ranges.match(/\|/)?"|":","),mapTheme.szLabelA=mapTheme.szOldLabelA?mapTheme.szOldLabelA:mapTheme.szLabelA,Number(mapTheme.origColorScheme[0])&&mapTheme.szRanges&&(mapTheme.origColorScheme[0]=mapTheme.szRangesA.length-1),mapTheme.fRealize=!0),styleObj.type.match(/RANGES/)&&!styleObj.ranges)for(var a in mapTheme.szRangesA=[mapTheme.partsA[0].min],mapTheme.partsA)mapTheme.szRangesA.push(mapTheme.partsA[a].max);var oldFlag=mapTheme.szFlag;mapTheme.szFlag=styleObj.type,!mapTheme.szFlag.match(/CHART/)||mapTheme.szFlag.match(/BUFFER/)||oldFlag.match(/CHART/)||(mapTheme.fShadow=mapTheme.fOrigShadow=!0),styleObj.origType.match(/AGGREGATE/)||styleObj.origType.match(/GROUP/)||styleObj.origType.match(/\bRECT\b/)||styleObj.origType.match(/RELOCATE/)?(mapTheme.fRealize=!0,mapTheme.fRedraw=!1,mapTheme.unpaintMap(),mapTheme.themeNodesPosA=[]):(mapTheme.fRedraw=!0,mapTheme.fRedrawInfo=!0),styleObj.type.match(/VALUES/)!=oldFlag.match(/VALUES/)&&(mapTheme.fRedraw=!0),styleObj.type.match(/DTEXT/)!=oldFlag.match(/DTEXT/)&&mapTheme.unlabelMap(),styleObj.type.match(/AUTO100/)!=oldFlag.match(/AUTO100/)&&(mapTheme.fRealize=!0,mapTheme.fRedraw=!1,mapTheme.unpaintMap()),styleObj.type.match(/DIFFERENCE/)!=oldFlag.match(/DIFFERENCE/)&&(mapTheme.fRealize=!0,mapTheme.fRedraw=!1,mapTheme.unpaintMap()),styleObj.type.match(/NOOUTLIER/)!=oldFlag.match(/NOOUTLIER/)&&(mapTheme.fRealize=!0,mapTheme.fRedraw=!1,mapTheme.unpaintMap()),styleObj.type.match(/OUTLIER/)!=oldFlag.match(/OUTLIER/)&&(mapTheme.fRealize=!0,mapTheme.fRedraw=!1,mapTheme.unpaintMap()),styleObj.type.match(/NEGATIVEISNOTVALUE/)!=oldFlag.match(/NEGATIVEISNOTVALUE/)&&(mapTheme.fNegativeValuePossible=!styleObj.type.match(/NEGATIVEISNOTVALUE/),mapTheme.fRealize=!0,mapTheme.fRedraw=!0,mapTheme.unpaintMap())}else if(szFlag&&szFlag.match(/remove/)){for(var p in styleObj)for(var s in themeStyleTranslateA)themeStyleTranslateA[s].style==p&&(mapTheme[themeStyleTranslateA[s].obj]=null);return mapTheme.fReload=!0,mapTheme.fRealize=!0,mapTheme.unpaintMap(),void executeWithMessage("map.Themes.execute()","... processing ...")}if(__isdef(styleObj.field)&&(mapTheme.szFields=styleObj.field,mapTheme.szFieldsA=mapTheme.szFields.split("|"),mapTheme.fRealize=!0),__isdef(styleObj.classes)){if(isNaN(Number(mapTheme.origColorScheme[0]))){mapTheme.origColorScheme[3]=mapTheme.origColorScheme[mapTheme.origColorScheme.length/2],mapTheme.origColorScheme[4]="2colors";var xxx=mapTheme.origColorScheme[mapTheme.origColorScheme.length-1];mapTheme.origColorScheme[1]=mapTheme.origColorScheme[0],mapTheme.origColorScheme[2]=xxx}mapTheme.origColorScheme[0]=Number(styleObj.classes),mapTheme.szFlag.match(/CHART/)&&mapTheme.unpaintMap(),mapTheme.szOldRanges=mapTheme.szRanges,mapTheme.szRanges=null,mapTheme.fRealize=!0}if(__isdef(styleObj.ranges)&&(mapTheme.szRanges=styleObj.ranges,mapTheme.szRangesA=styleObj.ranges.split(styleObj.ranges.match(/\|/)?"|":","),mapTheme.fRealize=!0),__isdef(styleObj.colorstyle)&&"spectrum"==mapTheme.origColorScheme[1]&&(mapTheme.origColorScheme[2]=styleObj.colorstyle,mapTheme.szFlag.match(/CHART/)&&mapTheme.unpaintMap(),mapTheme.fRealize=!0),__isdef(styleObj.colordef)&&(mapTheme.origColorScheme=styleObj.colordef.match(/\|/)?styleObj.colordef.split("|"):styleObj.colordef.split(","),mapTheme.colorScheme=mapTheme.origColorScheme,mapTheme.fRedraw=!0,mapTheme.szFlag.match(/CHART/)||(mapTheme.fRealize=!0),mapTheme.fRedrawInfo=!0,mapTheme.showInfo()),__isdef(styleObj.colorscheme)){var argA=styleObj.colorscheme.match(/\|/)?styleObj.colorscheme.split("|"):styleObj.colorscheme.split(",");if(argA&&argA.length){isNaN(Number(mapTheme.origColorScheme[0]))&&(mapTheme.origColorScheme[0]=mapTheme.origColorScheme.length),mapTheme.origColorScheme.length=1;for(var i=0;i<5;i++)i<argA.length?mapTheme.origColorScheme[i+1]=argA[i]:mapTheme.origColorScheme[i+1]=null;try{mapTheme.colorScheme=ColorScheme.createColorScheme(mapTheme.origColorScheme[1],mapTheme.origColorScheme[2],mapTheme.origColorScheme[0],mapTheme.origColorScheme[3],mapTheme.origColorScheme[4])}catch(e){mapTheme.colorScheme=mapTheme.defaultColorScheme}mapTheme.fRealize=!0,mapTheme.szFlag.match(/CHART/),mapTheme.unpaintMap(),mapTheme.fRedrawInfo=!0,mapTheme.showInfo()}}if(__isdef(styleObj.colorschemegeneration)&&!isNaN(Number(mapTheme.origColorScheme[0]))){switch(styleObj.colorschemegeneration){case"warm":mapTheme.origColorScheme[4]="#FFFDD8";break;case"cold":mapTheme.origColorScheme[4]="#FFFFFF";break;default:mapTheme.origColorScheme[4]=styleObj.colorschemegeneration;break}mapTheme.szFlag.match(/CHART/)&&mapTheme.unpaintMap();try{mapTheme.colorScheme=ColorScheme.createColorScheme(mapTheme.origColorScheme[1],mapTheme.origColorScheme[2],mapTheme.origColorScheme[0],mapTheme.origColorScheme[3],mapTheme.origColorScheme[4])}catch(e){mapTheme.colorScheme=mapTheme.defaultColorScheme}mapTheme.fRedraw=!0,mapTheme.fRedrawInfo=!0}if(__isdef(styleObj.symbols)&&(mapTheme.szSymbolsA=styleObj.symbols.split(styleObj.symbols.match(/\|/)?"|":","),mapTheme.fRealize=!0),__isdef(styleObj.values)){var szValuesA=this.toArray(styleObj.values);if(szValuesA.length)for(var i=0;i<szValuesA.length;i++)mapTheme.getStringValueIndex(szValuesA[i],"set");for(i in mapTheme.szValuesA=[],mapTheme.szLabelA=[],mapTheme.nStringToValueA)mapTheme.szValuesA.push(i),mapTheme.szLabelA.push(i);mapTheme.fRealize=!0}__isdef(styleObj.dominantdfilter)&&(mapTheme.nDominantDFilter=Number(styleObj.dominantdfilter),mapTheme.fRealize=!0),__isdef(styleObj.dominantfilter)&&(mapTheme.szDominantFilter=String(styleObj.dominantfilter),mapTheme.fRealize=!0),__isdef(styleObj.filter)&&(szFlag&&szFlag.match(/remove/)?mapTheme.szFilter="":mapTheme.szFilter=String(styleObj.filter),mapTheme.fRealize=!0,mapTheme.unpaintMap(),mapTheme.szFlag.match(/FEATURE/)&&map.Dom.clearGroup(mapTheme.chartGroup)),__isdef(styleObj.filterfield)&&(mapTheme.szFilterField=String(styleObj.filterfield),mapTheme.fRealize=!0),__isdef(styleObj.markclasses)&&(mapTheme.markedClassesA=this.toArray(styleObj.markclasses),mapTheme.markedClasses=[],mapTheme.unmarkClass(),mapTheme.markedClassesA.forEach((function(e,t){e>=0&&(mapTheme.markedClasses[e]=!0)})),mapTheme.markClass()),__isdef(styleObj.field100min)&&(mapTheme.nField100Min=styleObj.field100min,mapTheme.fRealize=!0),__isdef(styleObj.overviewchart)&&(mapTheme.szFlag.match(/CHART/)||(mapTheme.szOverviewChart=styleObj.overviewchart,mapTheme.fRedrawInfo=!0)),__isdef(styleObj.evidence)&&(mapTheme.evidenceMode=styleObj.evidence),__isdef(styleObj.aggregation)&&(mapTheme.szAggregation=styleObj.aggregation),__isdef(styleObj.opacity)&&(mapTheme.fOpacity=__calcNewValue(mapTheme.fOpacity,Number(styleObj.opacity),szFlag),mapTheme.autoOpacity=!1,mapTheme.fRedraw=!0),__isdef(styleObj.fillopacity)&&(mapTheme.fillOpacity=__calcNewValue(mapTheme.fillOpacity||(Number(styleObj.fillopacity)<1?1:0),Number(styleObj.fillopacity),szFlag),mapTheme.autoOpacity=!1,mapTheme.fillOpacity=Math.min(Math.max(mapTheme.fillOpacity,.001),1),mapTheme.unpaintMap(),mapTheme.fRedraw=!0),__isdef(styleObj.shadow)&&("toggle"==styleObj.shadow?mapTheme.fShadow=mapTheme.fOrigShadow=!mapTheme.fOrigShadow:mapTheme.fShadow=mapTheme.fOrigShadow=styleObj.shadow,mapTheme.fRedraw=!0),__isdef(styleObj.showdata)&&("toggle"==styleObj.showdata?mapTheme.fShowData=!mapTheme.fShowData:mapTheme.fShowData=JSON.parse(styleObj.showdata),mapTheme.fRedraw=!0),__isdef(styleObj.blur)&&("toggle"==styleObj.blur?mapTheme.nBlur?(mapTheme.nOldBlur=mapTheme.nBlur,mapTheme.nBlur=0):mapTheme.nBlur=mapTheme.nOldBlur||1:mapTheme.nBlur=__calcNewValue(mapTheme.nBlur,Number(styleObj.blur),szFlag),mapTheme.fBlur=!0),__isdef(styleObj.scale)&&(mapTheme.fResize=__calcFactor(mapTheme.nScale,Number(styleObj.scale),szFlag)),__isdef(styleObj.dopacityscale)&&(mapTheme.nDopacityScale=__calcNewValue(mapTheme.nDopacityScale,Number(styleObj.dopacityscale),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.d_dopacityscale)&&(mapTheme.nDopacityScale=mapTheme.nDopacityScale*Number(styleObj.d_dopacityscale),mapTheme.fRedraw=!0),__isdef(styleObj.alphafield)&&(mapTheme.szAlphaField=String(styleObj.alphafield),mapTheme.fRealize=!0),__isdef(styleObj.alphafield100)&&(mapTheme.szAlphaField100=String(styleObj.alphafield100),mapTheme.fRealize=!0),__isdef(styleObj.dopacityramp)&&(mapTheme.szDopacityRamp=styleObj.dopacityramp,mapTheme.fRealize=!0),__isdef(styleObj.dopacitypow)&&(mapTheme.nDopacityPow=__calcNewValue(mapTheme.nDopacityPow,Number(styleObj.dopacitypow),szFlag),mapTheme.fRealize=!0),__isdef(styleObj.brightness)&&(mapTheme.nBrightness=__calcNewValue(mapTheme.nBrightness||1,Number(styleObj.brightness),szFlag),mapTheme.fRealize=!0),__isdef(styleObj.rangescale)&&(mapTheme.nRangeScale=__calcNewValue(mapTheme.nRangeScale||1,Number(styleObj.rangescale),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.sizefield)&&(mapTheme.szSizeField=String(styleObj.sizefield),mapTheme.fRealize=!0),__isdef(styleObj.timefield)&&(mapTheme.szTimeField=String(styleObj.timefield),mapTheme.fRealize=!0),__isdef(styleObj.xfield)&&(mapTheme.szXField=String(styleObj.xfield),mapTheme.fRealize=!0),__isdef(styleObj.yfield)&&(mapTheme.szYField=String(styleObj.yfield),mapTheme.fRealize=!0),__isdef(styleObj.labelfield)&&(mapTheme.szLabelField=String(styleObj.labelfield),mapTheme.fRealize=!0),__isdef(styleObj.colorfield)&&(mapTheme.szColorField=String(styleObj.colorfield),mapTheme.fRealize=!0),__isdef(styleObj.symbolfield)&&(mapTheme.szSymbolField=String(styleObj.symbolfield),mapTheme.fRealize=!0),__isdef(styleObj.valuefield)&&(mapTheme.szValueField=String(styleObj.valuefield),mapTheme.fRealize=!0),__isdef(styleObj.normalsizevalue)&&(mapTheme.nNormalSizeValue||(mapTheme.nNormalSizeValue=mapTheme.szSizeField?mapTheme.nMaxSize:mapTheme.nMax),mapTheme.nNormalSizeValue=__calcNewValue(mapTheme.nNormalSizeValue,Number(styleObj.normalsizevalue),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.minvalue)&&(mapTheme.nMinValue=__calcNewValue(mapTheme.nMinValue||1,Number(styleObj.minvalue),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.valuedecimals)&&(mapTheme.nValueDecimals=styleObj.valuedecimals,mapTheme.fRedraw=!0),__isdef(styleObj.valuescale)&&(mapTheme.nValueScale=__calcNewValue(mapTheme.nValueScale,Number(styleObj.valuescale),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.linewidth)&&(mapTheme.nLineWidth=__calcNewValue(mapTheme.nLineWidth,Number(styleObj.linewidth),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.markersize)&&(mapTheme.nMarkerSize=__calcNewValue(mapTheme.nMarkerSize,Number(styleObj.markersize),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.gapsize)&&(mapTheme.nGapSize=__calcNewValue(mapTheme.nGapSize,Number(styleObj.gapsize),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.offsetx)&&(mapTheme.nOffsetX=__calcNewValue(mapTheme.nOffsetX,Number(styleObj.offsetx),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.offsety)&&(mapTheme.nOffsetY=__calcNewValue(mapTheme.nOffsetY,Number(styleObj.offsety),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.rotation)&&(mapTheme.nRotation=__calcNewValue(mapTheme.nRotation,Number(styleObj.rotation),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.align)&&(mapTheme.szAlign=String(styleObj.align),mapTheme.fRedraw=!0),__isdef(styleObj.linecolor)&&(mapTheme.szLineColor=String(styleObj.linecolor),mapTheme.fRedraw=!0),__isdef(styleObj.valueupper)&&(mapTheme.szValueUpper=styleObj.valueupper,mapTheme.nValueUpper=__scanScaleValue(mapTheme.szValueUpper),mapTheme.fRedraw=!0),__isdef(styleObj.valuelower)&&(mapTheme.szValueLower=styleObj.valuelower,mapTheme.nValueLower=__scanScaleValue(mapTheme.szValueLower),mapTheme.fRedraw=!0),__isdef(styleObj.titleupper)&&(mapTheme.szTitleUpper=styleObj.titleupper,mapTheme.nTitleUpper=__scanScaleValue(mapTheme.szTitleUpper),mapTheme.fRedraw=!0),__isdef(styleObj.titlelower)&&(mapTheme.szTitleLower=styleObj.titlelower,mapTheme.nTitleLower=__scanScaleValue(mapTheme.szTitleLower),mapTheme.fRedraw=!0),__isdef(styleObj.boxupper)&&(mapTheme.szBoxUpper=styleObj.boxupper,mapTheme.nBoxUpper=__scanScaleValue(mapTheme.szBoxUpper),mapTheme.fRedraw=!0),__isdef(styleObj.boxlower)&&(mapTheme.szBoxLower=styleObj.boxlower,mapTheme.nBoxLower=__scanScaleValue(mapTheme.szBoxLower),mapTheme.fRedraw=!0),__isdef(styleObj.shadowupper)&&(mapTheme.szShadowUpper=styleObj.shadowupper,mapTheme.nShadowUpper=__scanScaleValue(mapTheme.szShadowUpper),mapTheme.fRedraw=!0),__isdef(styleObj.shadowlower)&&(mapTheme.szShadowLower=styleObj.shadowlower,mapTheme.nShadowLower=__scanScaleValue(mapTheme.szShadowLower),mapTheme.fRedraw=!0),__isdef(styleObj.declutterupper)&&(mapTheme.szDeclutterUpper=styleObj.declutterupper,mapTheme.nDeclutterUpper=__scanScaleValue(mapTheme.szdeclutterUpper),mapTheme.fRedraw=!0),__isdef(styleObj.aggregationupper)&&(mapTheme.szAggregationUpper=styleObj.aggregationupper,mapTheme.nAggregationUpper=__scanScaleValue(mapTheme.szAggregationUpper),mapTheme.fRedraw=!0),__isdef(styleObj.aggregationlower)&&(mapTheme.szAggregationLower=styleObj.aggregationlower,mapTheme.nAggregationLower=__scanScaleValue(mapTheme.szAggregationLower),mapTheme.fRedraw=!0),__isdef(styleObj.clipupper)&&(mapTheme.szClipUpper=styleObj.clipupper,mapTheme.nClipUpper=__scanScaleValue(mapTheme.szClipUpper),mapTheme.fRedraw=!0),__isdef(styleObj.cliplower)&&(mapTheme.szClipLower=styleObj.cliplower,mapTheme.nClipLower=__scanScaleValue(mapTheme.szClipLower),mapTheme.fRedraw=!0),__isdef(styleObj.minvaluesize)&&(mapTheme.nValueSizeMin=__calcNewValue(mapTheme.nValueSizeMin,Number(styleObj.minvaluesize),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.minvaluevalue)&&(mapTheme.nValueValueMin=__calcNewValue(mapTheme.nValuevalueMin,Number(styleObj.minvaluevalue),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.clipvaluesize)&&(mapTheme.nValueSizeMin=__calcNewValue(mapTheme.nValueSizeMin,Number(styleObj.clipvaluesize),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.minsize)&&(mapTheme.nChartSizeMin=__calcNewValue(mapTheme.nChartSizeMin,Number(styleObj.minsize),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.minchartsize)&&(mapTheme.nChartSizeMin=__calcNewValue(mapTheme.nChartSizeMin,Number(styleObj.minchartsize),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.maxcharts)&&(mapTheme.nMaxCharts=__calcNewValue(mapTheme.nMaxCharts,Number(styleObj.maxcharts),szFlag),mapTheme.nMaxCharts=Math.max(1,Math.round(mapTheme.nMaxCharts)),mapTheme.unpaintMap(),mapTheme.fRedraw=!0),__isdef(styleObj.sizepow)&&(mapTheme.nSizePow=__calcNewValue(mapTheme.nSizePow,Number(styleObj.sizepow),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.outlierscale)&&(mapTheme.nOutlierScale=__calcNewValue(mapTheme.nOutlierScale,Number(styleObj.outlierscale),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.clipsize)&&(mapTheme.nChartSizeMin=__calcNewValue(mapTheme.nChartSizeMin,Number(styleObj.clipsize),szFlag),mapTheme.fRedraw=!0),__isdef(styleObj.clipparts)&&(mapTheme.nClipParts=Number(styleObj.clipparts),mapTheme.fRedraw=!0),__isdef(styleObj.showparts)&&(mapTheme.szShowParts=styleObj.showparts,mapTheme.szShowPartsA=styleObj.showparts.split(styleObj.showparts.match(/\|/)?"|":","),map.Themes.unmarkClass(null,szId),mapTheme.fRedraw=!0),__isdef(styleObj.clipframerate)&&(mapTheme.nClipFrameRate=__calcNewValue(mapTheme.nClipFrameRate||1,Number(styleObj.clipframerate),szFlag),mapTheme.nClipTimeout=1/mapTheme.nClipFrameRate*1e3,mapTheme.fRedraw=!0),__isdef(styleObj.refresh)&&(mapTheme.nRefreshTimeout=1e3*Number(styleObj.refresh),mapTheme.fRealize=!0),__isdef(styleObj.refreshtimeout)&&(mapTheme.nRefreshTimeout=Number(styleObj.refreshtimeout),mapTheme.fRealize=!0),__isdef(styleObj.gridx)&&(mapTheme.nGridX=Number(styleObj.gridx)||7,mapTheme.fRedraw=!0),__isdef(styleObj.gridwidth)&&(mapTheme.szAggregationField=null,"auto"==styleObj.gridwidth?mapTheme.nGridWidthPx=mapTheme.nGridWidthPx||50:String(styleObj.gridwidth).match(/px/)?mapTheme.nGridWidthPx=__calcNewValue(mapTheme.nGridWidthPx||1,Number(styleObj.gridwidth),szFlag):"factor"==szFlag?__isdef(mapTheme.nGridWidthPx)?mapTheme.nGridWidthPx=__calcNewValue(mapTheme.nGridWidthPx||1,Number(styleObj.gridwidth),szFlag):mapTheme.nGridWidth=__calcNewValue(mapTheme.nGridWidth||1e3,Number(styleObj.gridwidth),szFlag):(mapTheme.nGridWidthPx=null,mapTheme.nGridWidth=__calcNewValue(mapTheme.nGridWidth||1,Number(styleObj.gridwidth),szFlag)),mapTheme.fRealize=!0,mapTheme.fRedraw=!0,mapTheme.fSuppressAggregationScale=!0,mapTheme.themeNodesPosA=[],mapTheme.unpaintMap()),__isdef(styleObj.gridmatrix)&&(mapTheme.szAggregationField=null,mapTheme.nGridMatrix=__calcNewValue(mapTheme.nGridMatrix||1,Number(styleObj.gridmatrix),szFlag),mapTheme.fRealize=!0,mapTheme.fRedraw=!0,mapTheme.fSuppressAggregationScale=!0,mapTheme.unpaintMap(),mapTheme.themeNodesPosA=[]),__isdef(styleObj.gridwidthpx)&&(mapTheme.szAggregationField=null,mapTheme.nGridWidthPx=__calcNewValue(mapTheme.nGridWidthPx||50,Number(styleObj.gridwidthpx),szFlag),mapTheme.fRealize=!0,mapTheme.fRedraw=!0,mapTheme.fSuppressAggregationScale=!0,mapTheme.unpaintMap(),mapTheme.themeNodesPosA=[]),__isdef(styleObj.gridoffsetx)&&(mapTheme.nGridOffsetX=__calcNewValue(mapTheme.nGridOffsetX||0,Number(styleObj.gridoffsetx),szFlag),mapTheme.fRealize=!0,mapTheme.fRedraw=!0,mapTheme.fSuppressAggregationScale=!0,mapTheme.unpaintMap(),mapTheme.themeNodesPosA=[]),__isdef(styleObj.gridoffsety)&&(mapTheme.nGridOffsetY=__calcNewValue(mapTheme.nGridOffsetY||0,Number(styleObj.gridoffsety),szFlag),mapTheme.fRealize=!0,mapTheme.fRedraw=!0,mapTheme.fSuppressAggregationScale=!0,mapTheme.unpaintMap(),mapTheme.themeNodesPosA=[]),__isdef(styleObj.aggregationfield)&&(mapTheme.szAggregationField=styleObj.aggregationfield,mapTheme.fRealize=!0,mapTheme.fRedraw=!0,mapTheme.fSuppressAggregationScale=!0,mapTheme.unpaintMap(),mapTheme.themeNodesPosA=[]),__isdef(styleObj.snippet)&&(mapTheme.szSnippet=unescape(styleObj.snippet),mapTheme.fRealize=!0),__isdef(styleObj.title)&&(mapTheme.szTitle=unescape(styleObj.title),mapTheme.fRealize=!0),__isdef(styleObj.units)&&(mapTheme.szUnits=unescape(styleObj.units),mapTheme.fRealize=!0),__isdef(styleObj.child)&&(mapTheme.fChild=!0)}mapTheme.fRedrawInfo=!0,map.Themes.execute()}},ixMap.Themes.prototype.getThemeLayerList=function(){for(var e,t=[],i=0;i<this.themesA.length;i++)if(this.themesA[i].objThemesA&&!this.themesA[i].fRemove)for(e in this.themesA[i].objThemesA)t[t.length]=e;return t},ixMap.Themes.prototype.isThemeLayerUsed=function(e){for(var t=this.getThemeLayerList(),i=0;i<t.length;i++)if(e==t[i])return!0;return!1},ixMap.Themes.prototype.isNodePartOfAnyTheme=function(e){var t=map.Layer.getLayerObjOfNode(e);if(t)for(var i=map.Themes.getThemeLayerList(),a=0;a<i.length;a++)if(t.szName==i[a])return!0;return!1},ixMap.Themes.prototype.resetThemeNodesCache=function(){this.themeNodesA=[],this.themeNodes=0},ixMap.Themes.prototype.addToThemeNodesCache=function(e){for(var t=0,i=e.getElementsByTagName("g"),a=0;a<i.length;a++){var s=String(map.Tiles.getMasterId(i.item(a).getAttributeNS(null,"id")));s&&(map.Themes.themeNodesA[s]||(map.Themes.themeNodesA[s]=[]),map.Themes.themeNodesA[s].push(i.item(a)),map.Themes.themeNodes++,t++)}_TRACE("Tiling: -------------------------------------------------------------- "+t+" added to NodesCache")},ixMap.Themes.prototype.removeFromThemeNodesCache=function(e){for(var t=0,i=e.getElementsByTagName("g"),a=0;a<i.length;a++){var s=String(map.Tiles.getMasterId(i.item(a).getAttributeNS(null,"id")));if(s&&map.Themes.themeNodesA[s]){var n=map.Themes.themeNodesA[s].indexOf(i.item(a));n>-1&&(map.Themes.themeNodesA[s].splice(n,1),t++)}}_TRACE("Tiling: -------------------------------------------------------------- "+t+" removed from NodesCache")},ixMap.Themes.prototype.setActive=function(e){this.activeTheme=e},ixMap.Themes.prototype.minimizeInfo=function(e,t){var i=this.getTheme(t);if(i){var a=i.widgetNode.firstChild;if(a){var s=Number(a.getAttributeNS(szMapNs,"titleheight"));s<=0&&(s=420);for(var n=a.childNodes,l=0;l<n.length;l++){var h=n.item(l),o=h.getAttributeNS(null,"id");o.match(/body/)&&h.style.setProperty("display","none",""),o.match(/footer/)&&h.style.setProperty("display","none",""),o.match(/backgroundrect/)&&(h.setAttributeNS(szMapNs,"maxheight",h.getAttributeNS(null,"height")),h.setAttributeNS(null,"height",s)),o.match(/shadowrect/)&&(h.setAttributeNS(szMapNs,"maxheight",h.getAttributeNS(null,"height")),h.setAttributeNS(null,"height",String(s-100))),o.match(/minimizebutton/)&&h.style.setProperty("display","none","")}i.minimizebutton.nodeObj.style.setProperty("display","none",""),i.morebutton.nodeObj.style.setProperty("display","none",""),i.addDefinitionToFlag("MINIMIZED")}}},ixMap.Themes.prototype.maximizeInfo=function(e,t){var i=this.getTheme(t);if(i){var a=i.widgetNode.firstChild;if(a){for(var s=a.childNodes,n=0;n<s.length;n++){var l=s.item(n),h=l.getAttributeNS(null,"id");h.match(/body/)&&l.style.setProperty("display","inline",""),h.match(/footer/)&&l.style.setProperty("display","inline",""),h.match(/backgroundrect/)&&l.setAttributeNS(null,"height",l.getAttributeNS(szMapNs,"maxheight")),h.match(/shadowrect/)&&l.setAttributeNS(null,"height",l.getAttributeNS(szMapNs,"maxheight")),h.match(/minimizebutton/)&&l.style.setProperty("display","inline","")}i.minimizebutton.nodeObj.style.setProperty("display","inline",""),i.morebutton.nodeObj.style.setProperty("display","inline",""),i.removeDefinitionFromFlag("MINIMIZED")}}},ixMap.Themes.prototype.getChartAll=function(e,t,i){for(var a=t.getAttributeNS(null,"id"),s=0,n=0;n<this.themesA.length;n++){var l=map.Dom.newGroup(t,a+":C1");if(this.getChart(e,l,i,this.themesA[n]),(h=map.Dom.getBox(l)).width<0&&(h=new box(0,0,0,0)),l.fu.setPosition(0,s),s+=h.height+map.Scale.normalY(10),this.themesA[n].szFlag.match(/AGGREGATE/)){var h,o=e.split("::")[0]+"::"+this.themesA[n].getNodePosition(e).x+","+this.themesA[n].getNodePosition(e).y;this.getChart(o,l,i,this.themesA[n]),(h=map.Dom.getBox(l)).width<0&&(h=new box(0,0,0,0)),l.fu.setPosition(0,s),s+=h.height+map.Scale.normalY(10)}}},ixMap.Themes.prototype.getChart=function(e,t,i,a){if(a||(a=this.activeTheme),!a)return null;if(e&&":paint"==e.substr(e.length-6,6)&&(e=e.substr(0,e.length-6)),a.szFlag.match(/CHOROPLETH/)&&a.szFlag.match(/DOMINANT|COMPOSE/)){var s=30;a.nOrigSumA.length>2&&(s=15*a.nOrigSumA.length/Math.log(a.nOrigSumA.length));var n=map.Dom.newGroup(t,t.getAttributeNS(null,"id")+":1");if(a.szFlag.match(/PERCENTOFMEAN/)||a.szFlag.match(/PERCENTOFMEDIAN/)||a.szFlag.match(/DEVIATION/)){a.drawChart(n,e,s,"CHART|BAR|VALUES|ZOOM",e&&a.itemA[e]?a.itemA[e].nDominant:null);var l=map.Dom.getBox(n);l.width<0&&(l=new box(0,0,0,0)),n=map.Dom.newGroup(t,t.getAttributeNS(null,"id")+":2");var h=a.szUnit;a.szUnit="";a.drawChart(n,e,s,"VALUES|ZOOM|XAXIS");a.szUnit=h;var o=map.Dom.getBox(n),r=a.nOrigSumA.length>1?l.width/o.width*1.015:o.width/o.height,m=o.x-l.x;n.fu.setPosition(m,l.height+l.y+Math.min(map.Scale.normalY(200),Math.max(map.Scale.normalY(10),-o.y+map.Scale.normalY(6)))),n.fu.scale(r,1);var p=a.szFlag.match(/PERCENTOFMEDIAN/)?"median":"mean",c=o.width;map.Dom.newText(n,c,map.Scale.normalY(.9),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText(p)),map.Dom.newText(n,c,map.Scale.normalY(5.5),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("-")),map.Dom.newText(n,c,map.Scale.normalY(-3.7),"font-family:arial;font-size:"+map.Scale.normalY(4)+"px;fill:#808080",map.Dictionary.getLocalText("+"))}else{var u="CHART|BAR|SPACED|VALUES|ZOOM";a.szFlag.match(/3D/)&&(u+="|3D"),a.szFlag.match(/\bSORT\b/)&&(u+="|SORT"),a.szFlag.match(/HORZ/)&&(u+="|HORZ|AXIS"),a.drawChart(n,e,s,u,null)}return new point(0,map.Scale.normalY(30))}if(a.szFlag.match(/BUFFER/)&&a.szFlag.match(/CHART/))return null;if(a.szFlag.match(/CHOROPLETH/)&&a.itemA[e]){var d=a.itemA[e].nValuesA[a.nActualFrame||0],A=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,1);if(a.szFlag.match(/CATEGORICAL/)&&a.szLabelA&&a.szLabelA.length)var S=a.szLabelA[d-1];else{var g=a.nMax-a.nMin<10?2:0;S=a.formatValue(d,a.nValueDecimals||g)+a.szUnit}a.szFlag.match(/\bCLIP\b/)&&a.szXaxisA&&map.Dom.newText(t,-40,-280,__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8)+";font-weight:normal;fill:#888888",a.szXaxisA[a.nActualFrame]),map.Dom.newText(t,-40,0,A+";font-weight:normal;stroke:#ffffff;stroke-width:20;stroke-opacity:0.3",S),map.Dom.newText(t,-40,0,A+";font-weight:normal;fill:#444444",S);A=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.8),a.itemA[e].szTitle;if(!a.szFlag.match(/CATEGORICAL/)&&(a.szChoroplethInfoStyle.match(/HISTOGRAM/)||a.szChoroplethInfoStyle.match(/histogram/)||a.szChoroplethInfoStyle.match(/CLASSES/)||a.szChoroplethInfoStyle.match(/classes/))){var z=a.szChoroplethInfoStyle.match(/HISTOGRAM/)||a.szChoroplethInfoStyle.match(/histogram/);n=map.Dom.newGroup(t,t.getAttributeNS(null,"id")+":histogram");this.getHistogram(e,n,z?"DISTRIBUTION":"CLASSES",a),n.fu.setPosition(0,map.Scale.normalY(4))}return new point(0,0)}if(a.szFlag.match(/INFOSIZE/))return a.drawChart(t,e,30,i);s=30;return a.szFlag.match(/SEQUENCE/)&&(s=25),a.szFlag.match(/BAR/)&&(s=a.szFlag.match(/STACKED/)?300:a.nOrigSumA.length<=2?30:(a.szFlag.match(/\bUP\b/)||a.szFlag.match(/CENTER/)||a.szFlag.match(/SEQUENCE/),15*a.nOrigSumA.length/Math.log(a.nOrigSumA.length))),a.drawChart(t,e,s,i)},ixMap.Themes.prototype.getSummary=function(e,t){if(t||(t=this.activeTheme),!t||!e)return null;if(!t.itemA[e]){var i=e.split("::");i.length>1&&(e=i[0]+"::"+String(i[1]).toUpperCase())}if(!t.itemA[e])return null;for(var a=t.itemA[e].nOrigValuesA,s=0,n=0;n<a.length;n++)isNaN(a[n])&&(a[n]=0),s+=a[n];if(t.szFlag.match(/DIFFERENCE/)&&(s=a[a.length-1]),t.itemA[e].nValue100A[0]){if(t.szUnits100=t.szUnits100||"",t.szFlag.match(/RELATIVE/)||t.szFlag.match(/DIFFERENCE/))return map.Dictionary.getLocalText("Relative to")+": "+String(t.formatValue(t.itemA[e].nValue100A[0],t.nValueDecimals||0))+" "+(t.szUnits100||"");if(t.itemA[e].nSize){if(t.szAggregation.match(/sum/))return map.Dictionary.getLocalText("Counted")+": "+String(t.formatValue(t.itemA[e].nSize,t.nValueDecimals||0))+" "+(t.szUnits100||"")}else if(s!=t.itemA[e].nValue100A[0])return String(__formatValue(s,2))+" / "+String(t.formatValue(t.itemA[e].nValue100A[0],t.nValueDecimals||0))+" "+(t.szUnits100||"")}else if(t.itemA[e].nSize){if(t.szFlag.match(/CATEGORICAL/)&&1==t.itemA[e].nValuesA.length&&t.szValueField)return t.szLabelA[t.itemA[e].nValuesA[0]-1]}else{if(t.itemA[e].nAlpha)return map.Dictionary.getLocalText("Alpha value")+": "+String(t.formatValue(t.itemA[e].nAlpha,t.nValueDecimals||0))+" "+(t.szAlphaValueUnits||"");t.szFlag.match(/SUM/)&&!t.szFlag.match(/SEQUENCE/)&&t.szFlag.match(/\bCLIP\b/)}return null},ixMap.Themes.prototype.getValueComment=function(e,t){if(t||(t=this.activeTheme),!t||!e)return null;if(!t.itemA[e]){var i=e.split("::");i.length>1&&(e=i[0]+"::"+String(i[1]).toUpperCase())}if(!t.itemA[e])return null;for(var a=t.itemA[e].nOrigValuesA,s=0;s<a.length;s++)isNaN(a[s])&&(a[s]=0),a[s];return t.szFlag.match(/DIFFERENCE/)&&a[a.length-1],t.szFlag.match(/OFFSETMEAN/)?map.Dictionary.getLocalText("value")+": "+String(__formatValue(t.itemA[e].nValuesA[0],2))+" "+map.Dictionary.getLocalText("mean")+": "+String(__formatValue(t.nMeanA[0],2)):null},ixMap.Themes.prototype.getTitle=function(e,t){if(t||(t=this.activeTheme),!t||!e)return null;if(e=String(map.Tiles.getMasterId(e)),!t.itemA[e]){var i=e.split("::");i.length>1&&(e=i[0]+"::"+String(i[1]).toUpperCase())}return t.itemA[e]&&t.itemA[e].szTitle||null},ixMap.Themes.prototype.getLabel=function(e,t){if(t||(t=this.activeTheme),!t||!e)return null;if(!t.itemA[e]){var i=e.split("::");i.length>1&&(e=i[0]+"::"+String(i[1]).toUpperCase())}return t.itemA[e]&&t.itemA[e].szLabel||null},ixMap.Themes.prototype.getTextObjects=function(){for(var e=[],t=0;t<this.themesA.length;t++)if(this.themesA[t].szFlag.match(/TEXTONLY/)&&this.themesA[t].chartGroup)if(void 0!==this.themesA[t].markedClass&&null!=this.themesA[t].markedClass)for(var i=this.themesA[t].markedClass,a=this.themesA[t].chartGroup.getElementsByTagName("text"),s=0;s<a.length;s++)a.item(s).firstChild.nodeValue.length>0&&Number(a.item(s).getAttributeNS(szMapNs,"class"))==i&&e.push(a.item(s));else for(a=this.themesA[t].chartGroup.getElementsByTagName("text"),s=0;s<a.length;s++)a.item(s).firstChild.nodeValue.length>0&&e.push(a.item(s));return e},ixMap.Themes.prototype.getMaxValue=function(e,t){if(t||(t=this.activeTheme),!t||!e)return null;for(var i=0,a=t.itemA[e].nValuesA,s=0;s<a.length;s++)isNaN(a[s])&&(a[s]=0),i=Math.max(i,a[s]);return i},ixMap.Themes.prototype.getDataRow=function(e,t){if(t||(t=this.activeTheme),!t||!e)return null;if(!t.itemA[e]){var i=e.split("::");i&&i.length>1&&(e=i[0]+"::"+String(i[1]).toUpperCase())}if(!t.itemA[e])return null;var a=t.szThemesA[0],s=t.objThemesA[a],n=(s.dbFields,[]);if(t.szDataFieldsA)for(var l=0;l<t.szDataFieldsA.length;l++)for(var h=0;h<s.dbFields.length;h++)t.szDataFieldsA[l]==s.dbFields[h].id&&n.push(h);else for(h=0;h<s.dbFields.length;h++)n.push(h);var o=[];if(s.dbRecords){if(void 0!==t.itemA[e].dbIndexA&&t.itemA[e].dbIndexA.length){for(var r in t.itemA[e].dbIndexA){r>0&&o.push("--------------------");for(h=0;h<n.length;h++)o.push(s.dbFields[n[h]].id)}for(var r in t.itemA[e].dbIndexA){r>0&&o.push("--------------------");for(l=t.itemA[e].dbIndexA[r],h=0;h<n.length;h++)o.push(s.dbRecords[l][n[h]])}return o}if(void 0!==t.itemA[e].dbIndex){for(l=t.itemA[e].dbIndex,h=0;h<n.length;h++)o.push(s.dbFields[n[h]].id);for(h=0;h<n.length;h++)o.push(s.dbRecords[l][n[h]]);return o}e=e.split("::")[1];for(l=0;l<s.dbRecords.length;l++)if(s.dbRecords[l]&&s.dbRecords[l][s.nFieldSelectionIndex]&&String(s.dbRecords[l][s.nFieldSelectionIndex]).toUpperCase()==String(e).toUpperCase()){for(h=0;h<s.dbFields.length;h++)o.push(s.dbFields[h].id);for(h=0;h<s.dbFields.length;h++)o.push(s.dbRecords[l][h]);return o}}return o},ixMap.Themes.prototype.getFieldIndexArray=function(e){if(e||(e=this.activeTheme),!e)return[];if(e.szDataFieldsA)return[];e.fieldIndexArray=[];for(var t=0;t<e.objThemesA[e.szThemesA[0]].nFieldIndexA.length;t++)e.fieldIndexArray.push(e.objThemesA[e.szThemesA[0]].nFieldIndexA[t]);for(t=0;t<e.objThemesA[e.szThemesA[0]].nField100IndexA.length;t++)e.fieldIndexArray.push(e.objThemesA[e.szThemesA[0]].nField100IndexA[t]);return e.fieldIndexArray},ixMap.Themes.prototype.getScatterArray=function(e,t,i){e||(e=this.activeTheme);var a,s=0,n=e.nMin,l=e.nMax,h=0;_TRACE("nMin:"+n+" nMax:"+l),i.match(/LOG/)?(h=1-n,n=Math.log(n+h),l=Math.log(l+h)):i.match(/POW2/)&&(h=1-n,n=Math.pow(n+h,.5),l=Math.pow(l+h,.5)),i.match(/POW3/)&&(h=1-n,n=Math.pow(n+h,1/3),l=Math.pow(l+h,1/3)),_TRACE("nMin:"+n+" nMax:"+l);for(var o=(l-n)/t,r=[],m=0;m<t+1;m++)r[m]=0;for(a in e.itemA){var p=e.itemA[a].nValuesA[0];if("number"==typeof p){i.match(/LOG/)?p=Math.log(p+h):i.match(/POW2/)?p=Math.pow(p+h,.5):i.match(/POW3/)&&(p=Math.pow(p+h,1/3));var c=Math.max(0,Math.min(t-1,Math.floor((p-n)/o)));r[c]++,s=Math.max(s,r[c])}}return _TRACE("nTicks:"+t),_TRACE("nPop:"+o+" nMax:"+l),_TRACE("nCountMax:"+s),r},ixMap.Themes.prototype.getResolutionQualityOfArray=function(e){for(var t=e.length,i=-1e6,a=0;a<t;a++)i=Math.max(i,e[a]);var s=0;for(a=0;a<t;a++)e[a]>i/10&&s++;return s/t*100},ixMap.Themes.prototype.getDeviationOfArray=function(e){_TRACE("getDeviationOfArray ---\x3e");for(var t,i=e.length,a=-1e6,s=0,n=0,l=0,h=0;h<i;h++)a=Math.max(a,e[h]),e[h]==a&&(s=h),n+=e[h];n/=i,_TRACE("nCountMax: "+a),_TRACE("nTickMax: "+s),_TRACE("nMean: "+n);for(h=0;h<i;h++)l+=(e[h]-n)*(e[h]-n);return l/=i,t=Math.sqrt(l),_TRACE("nVarianz: "+l),_TRACE("nDeviation: "+t),t},ixMap.Themes.prototype.getHistogram=function(e,t,i,a){if(_TRACE("map.Themes.getHistogram ---\x3e"),!t)return null;if(a||(a=this.activeTheme),!a)return null;if(a.nMin==a.nMax)return null;if(e){if(!a.itemA[e]){var s=e.split("::");s.length>1&&(e=s[0]+"::"+String(s[1]).toUpperCase())}if(!a.itemA[e])return null}this.histGroup=map.Dom.newGroup(t,t.getAttributeNS(null,"id")+":group"),this.histFlag=i,this.histTheme=a;var n=map.Scale.normalX(70),l=map.Scale.normalY(20);map.Dom.newShape("rect",this.histGroup,0,0,n-map.Scale.normalX(.5),l,"fill:none;stroke:none;"),e?(map.Themes.makeHistogram(e),setTimeout((function(){map.Themes.makeHistogram(e)}),100)):setTimeout((function(){map.Themes.makeHistogram()}),100)},ixMap.Themes.prototype.makeHistogram=function(e){_TRACE("map.Themes.makeHistogram ---\x3e");var t=this.histGroup,i=this.histFlag,a=this.histTheme;if(i.match("CLASSES")){for(var s=map.Scale.normalX(50),n=map.Scale.normalY(5),l=s/a.colorScheme.length,h=0,o=0,r=e?a.itemA[e].nValuesA[0]:0,m=0,p=0;p<a.partsA.length;p++){l=s/a.nCount*a.partsA[p].nCount,(w=map.Dom.newShape("rect",t,h,o,l,n,"fill:"+a.colorScheme[p]+";stroke:black;stroke-width:1;"))&&w.setAttributeNS(szMapNs,"tooltip",a.szLegendLabelA[p]+" ("+a.formatValue(a.partsA[p].nCount)+" "+map.Dictionary.getLocalText("members")+")"),h+=l,r>a.partsA[p].max?m+=l:r>a.partsA[p].min&&(m+=l/(a.partsA[p].max-a.partsA[p].min)*(r-a.partsA[p].min))}map.Dom.newShape("circle",t,m,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#444444;stroke:none;")}else if(i.match("DISTRIBUTION")){if(!isFinite(a.nMin)||!isFinite(a.nMax))return t;var c=Math.min(140,Math.max(20,a.nCount/5));c=Math.min(500,Math.max(20,a.nCount/5)),s=map.Scale.normalX(70),n=map.Scale.normalY(12);if(i.match("INTERACTIVE"))n=map.Scale.normalY(20);var u=s/c,d=(h=0,o=0,r=e?a.itemA[e].nValuesA[0]:0,m=0,0),A=a.nMin,S=a.nMax,g=0,z=this.getScatterArray(a,c,""),f=this.getDeviationOfArray(z),T=this.getScatterArray(a,c,"LOG"),x=this.getDeviationOfArray(T),y=!1,b=(S-A)/c;_TRACE("nDeviation:"+f+" <> nDeviationLog:"+x),x&&x<f&&(z=T,g=1-A,A=Math.log(A+g),S=Math.log(S+g),r=Math.log(r+g),b=(S-A)/c,y=!0);for(p=0;p<c;p++)d=Math.max(d,z[p]);h=-20,o=0,a.histogram=new ixMap.Histogram(a),a.histogram.fDoLog=y,a.histogram.dValue=g,a.histogram.nWidth=s,a.histogram.nMin=A,a.histogram.nMax=S;var M=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.4),F=0;for(p=0;p<a.partsA.length;p++){if(y)var C=s/(S-A)*(Math.min(S,Math.log(a.partsA[p].max+g))-A);else C=s/(S-A)*(Math.min(S,a.partsA[p].max)-A);l=C-h;var w,N=1;if(a.szFlag.match(/DOPACITY/)){var O=a.partsA[p].min+(a.partsA[p].max-a.partsA[p].min)/2,R=1/(a.nDopacityPow||1);N=a.szFlag.match(/DOPACITYMINMAX/)?O>=a.nMedianA[0]?Math.pow(Math.abs(O-a.nMedianA[0]),R)/Math.pow(a.nMax-a.nMedianA[0],R)*(a.fillOpacity||1)*(a.nDopacityScale||1):Math.pow(Math.abs(O-a.nMedianA[0]),R)/Math.pow(a.nMedianA[0]-a.nMin,R)*(a.fillOpacity||1)*(a.nDopacityScale||1):a.szFlag.match(/DOPACITYMIN/)?Math.pow(a.nMax-O,R)/Math.pow(a.nMax-a.nMin,R)*(a.fillOpacity||1)*(a.nDopacityScale||1):a.szFlag.match(/DOPACITYMAX/)?Math.pow(O-a.nMin,R)/Math.pow(a.nMax-a.nMin,R)*(a.fillOpacity||1)*(a.nDopacityScale||1):a.szFlag.match(/DOPACITYLOG/)?Math.log(O-a.nMin)/Math.log(a.nMedianA[0]-a.nMin)*.5*(a.fillOpacity||1)*(a.nDopacityScale||1):a.szFlag.match(/DOPACITY/)?(O-a.nMin)/(a.nMedianA[0]-a.nMin)*.5*(a.fillOpacity||1)*(a.nDopacityScale||1):(p+c/10)/c}if((w=map.Dom.newShape("rect",t,h,o,l,n,"fill:"+a.colorScheme[p]+";fill-opacity:"+N+";stroke:black;stroke-width:"+map.Scale.normalX(.2)+";stroke-opacity:0.1"))&&(w.setAttributeNS(szMapNs,"tooltip",a.szLegendLabelA[p]+" ("+a.formatValue(a.partsA[p].nCount)+" "+map.Dictionary.getLocalText("members")+")"),w.setAttributeNS(szMapNs,"onoverstyle","fill:"+a.colorScheme[p]+";stroke:black;stroke-width:"+map.Scale.normalX(.5)+";"),w.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+a.szId+"','"+p+"','1')"),w.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+a.szId+"')")),a.histogram.classRectA[p]=w,a.histogram.classRectXA[p]=h,a.histogram.classRectWidthA[p]=l,a.histogram.classRectMaxA[p]=a.partsA[p].max,i.match("INTERACTIVE")){var I=map.Dom.newGroup(t,""),V=null;if(p>0){map.Dom.newShape("line",I,h,o-map.Scale.normalY(2),h,o+n,"stroke:black;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.5");var P=map.Dom.newShape("rect",I,h-map.Scale.normalY(1.5),o-map.Scale.normalY(6),map.Scale.normalX(3),map.Scale.normalY(5),"fill:"+a.colorScheme[p]+";stroke:black;styroke-width(1);");P&&(P.setAttributeNS(null,"rx",map.Scale.normalX(2)),P.setAttributeNS(null,"ry",map.Scale.normalY(1.5))),V=map.Dom.newText(I,h,o-map.Scale.normalY(7),M+"display:none;font-weight:normal;text-anchor:middle",a.formatValue(a.partsA[p-1].max,1))}var E=new Slider(I,new box(-F,0,F+l,0));E.setId(String(p)),E.parent=a.histogram,E.textObj=V,F=l}h+=l}h=u/3,o=0;var v=.9,_=this.getResolutionQualityOfArray(z);_TRACE(_+"%"),_<10&&(v=10-_);for(p=0;p<c;p++){var D=z[p]/d*n*v,L=y?Math.exp(A+p*b)-g:A+p*b,G=y?Math.exp(A+(p+1)*b)-g:A+(p+1)*b,k="black";D=D&&!isNaN(D)?Math.min(n,Math.max(map.Scale.normalY(.5),D)):0,(ne=map.Dom.newShape("line",t,h,o+n,h,o+n-D,"stroke:"+k+";stroke-width:"+u+";"))&&(ne.setAttributeNS(szMapNs,"tooltip",a.formatValue(L,2)+" ... "+a.formatValue(G,2)+a.szUnit+" ("+z[p]+" members)"),ne.setAttributeNS(szMapNs,"onoverstyle","stroke:yellow;stroke-width:"+Math.max(map.Scale.normalX(1),u)+";")),h+=u}map.Dom.newShape("line",t,-map.Scale.normalX(.5),n+1,s-map.Scale.normalX(.5),n+1,"stroke:black;stroke-width:"+map.Scale.normalX(.1)+";");var j=-map.Scale.normalX(.5),X=s-map.Scale.normalX(.5),U=map.Scale.normalX(2);map.Dom.newShape("line",t,j,n,j,n+U,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newShape("line",t,X,n,X,n+U,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";");var B=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.4),W=.4*map.Scale.tStyle.Summary.nFontHeight,Y=n+U+.8*W,H=a.formatValue(a.nMin,0),Z=a.formatValue(a.nMax,0);if(map.Dom.newText(t,j-10,Y,B+";font-weight:normal;text-anchor:start",H),a.nMin<0&&a.nMax>0){m=(0-A)/b*u;map.Dom.newShape("line",t,m,n,m,n+U,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(t,m,Y,B+";font-weight:normal;text-anchor:start","0")}var q=0;for(p=10;p<a.nMax;p*=10)for(var $=1;$<9&&!(p*$>a.nMax||p*$<a.nMin);$++){m=((y?Math.log(p*$+g):p*$)-A)/b*u;var Q=a.formatValue(p*$,0);m>q+Q.length*W*3/8?(map.Dom.newShape("line",t,m,n,m,n+U,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";"),map.Dom.newText(t,m,Y,B+";font-weight:normal;text-anchor:middle",Q),q=m+Q.length*W*3/8):map.Dom.newShape("line",t,m,n,m,n+U/2,"stroke:black;stroke-width:"+map.Scale.normalX(.2)+";")}X>q+Z.length*W*3/8&&map.Dom.newText(t,X,Y,B+";font-weight:normal;text-anchor:middle;",Z),e&&!i.match("INTERACTIVE")&&(m=(r-A)/b*u,map.Dom.newShape("circle",t,m,-map.Scale.normalX(.1),map.Scale.normalX(1),"fill:#dd0000;stroke:none;"),map.Dom.newShape("line",t,-10,-5,m-10,-5,"stroke:#000000;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3"))}else{s=map.Scale.normalX(70),n=map.Scale.normalY(12),l=s/700,h=0,o=0,r=e?a.itemA[e].nValuesA[0]:0,m=0,d=0,A=a.nMin,S=a.nMax;var K,J=n/S,ee=Math.max(1,Math.ceil(a.nCount/700)),te=[],ie=0,ae=[];for(K in a.itemA)ae.push(a.itemA[K].nValuesA[0]);for(K in ae.sort(a.sortUp),ae)ie%ee?te[te.length-1]+=ae[K]/ee:te[te.length]=ae[K]/ee,ie++;te.sort(a.sortUp);for(p=0;p<te.length;p++){O=te[p],D=te[p]*J*.9,k="black";for(var se=0;se<a.partsA.length;se++)if(te[p]<a.partsA[se].max){k=a.colorScheme[se];break}var ne;(ne=map.Dom.newShape("line",t,h,o,h,n,"stroke:"+k+";stroke-width:"+l+";")).setAttributeNS(szMapNs,"tooltip",a.formatValue(O,2)+a.szUnit),isNaN(D)&&(D=0),(ne=map.Dom.newShape("line",t,h,o+n,h,o+n-D,"stroke:#000000;stroke-width:"+l+";")).setAttributeNS(szMapNs,"tooltip",a.formatValue(O,2)+a.szUnit),h+=l}if(1){H=a.formatValue(a.nMin,0),Z=a.formatValue(a.nMax,0),B=__scaleStyleString(map.Scale.tStyle.Summary.szStyle,.4);map.Dom.newText(t,h+map.Scale.normalX(1),o+n,B+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",H),map.Dom.newText(t,h+map.Scale.normalX(1),o+map.Scale.normalY(3.5),B+";font-weight:normal;text-anchor:start;stroke-opacity:0.8;",Z)}t&&t.fu.scale(s/h,1)}return t},ixMap.Histogram=function(e){this.mapTheme=e,this.fDoLog=!1,this.dValue=0,this.classRectA=[],this.classRectXA=[],this.classRectWidthA=[],this.classRectMaxA=[]},ixMap.Histogram.prototype=new Map,ixMap.Histogram.prototype.onMouseOver=function(e,t,i){i.textObj&&i.textObj.style.setProperty("display","inline","")},ixMap.Histogram.prototype.onMouseOut=function(e,t,i){i.textObj&&i.textObj.style.setProperty("display","none","")},ixMap.Histogram.prototype.onMouseMove=function(e,t,i){var a;if(_TRACE(t+" - "+i.value.x),(a=this.classRectA[Number(t)])&&(a.setAttributeNS(null,"x",this.classRectXA[Number(t)]+i.value.x),a.setAttributeNS(null,"width",this.classRectWidthA[Number(t)]-i.value.x)),a=this.classRectA[Number(t)-1]){a.setAttributeNS(null,"width",this.classRectWidthA[Number(t)-1]+i.value.x);var s=this.classRectXA[Number(t)]+i.value.x,n=(this.nMax-this.nMin)/this.nWidth,l=this.nMin+s*n;l=this.fDoLog?Math.exp(l)-this.dValue:l,this.classRectMaxA[Number(t)-1]=l}i.textObj&&(i.textObj.firstChild.nodeValue=__formatValue(l,1))},ixMap.Histogram.prototype.onMouseUp=function(e,t,i){var a=this.classRectA[Number(t)-1];a&&(this.classRectWidthA[Number(t)-1]=a.getAttributeNS(null,"width"));for(var s="ranges:"+String(this.nMin),n=0;n<this.classRectMaxA.length;n++)s+=","+String(this.classRectMaxA[n]);map.Themes.changeThemeStyle(e,this.mapTheme.szId,s)},ixMap.Themes.prototype.showErrorInfo=function(e,t){var i=this.getTheme(t);i&&i.showErrorInfo()},ixMap.Themes.prototype.redraw=function(e){return this.actualize(e)},ixMap.Themes.prototype.actualizeActiveTheme=function(e){return this.actualize(e)},ixMap.Themes.prototype.actualize=function(e){_TRACE("A C T U A L I Z E");for(var t=0;t<this.themesA.length;t++)if(e&&1!=e&&this.themesA[t].szFlag.match(/FEATURE/)&&(this.themesA[t].nFeatureUpper||this.themesA[t].nFeatureLower)&&(this.themesA[t].fDone||(this.themesA[t].fRealize=!this.themesA[t].fDone),setTimeout("map.Themes.execute()",100)),this.themesA[t].fDone)if(this.themesA[t].szFlag.match(/WMS/))this.themesA[t].fRealize=!0,executeWithMessage("map.Themes.execute()","...",100);else if(this.themesA[t].szFlag.match(/FEATURE/)&&this.themesA[t].szFlag.match(/CLIPTOGEOBOUNDS|CLIPTOVIEW/))this.themesA[t].fRealize=!0,executeWithMessage("map.Themes.execute()","...",100);else{if(this.themesA[t].szFlag.match(/CHART/)&&(this.themesA[t].__fClipToGeoBounds&&(this.themesA[t].fRealize=!0),e&&1!=e&&this.themesA[t].szFlag.match(/DYNAMICSCALE/)&&(this.themesA[t].nScale*=Math.sqrt(e),this.themesA[t].fRealize=!0),e&&1!=e&&this.themesA[t].szFlag.match(/BEZIER/)&&(this.themesA[t].fRedraw=!0),this.themesA[t].szFlag.match(/DECLUTTER/)&&(this.themesA[t].fDeclutter=!0,map.Themes.execute()),e&&1!=e)){if(this.themesA[t].fRealizeDone){if(this.themesA[t].szAggregationFieldA){for(var i=this.themesA[t].nGridWidth,a=this.themesA[t].szAggregationField,s=0;s<this.themesA[t].szAggregationFieldA.length;s++){var n=Number(this.themesA[t].szAggregationFieldA[s].split(":")[1]);n&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>n&&(isNaN(parseFloat(this.themesA[t].szAggregationFieldA[s+1]))?this.themesA[t].szAggregationField=this.themesA[t].szAggregationFieldA[s+1]:(this.themesA[t].szAggregationFieldA[s+1].match(/px/)?this.themesA[t].nGridWidthPx=parseFloat(this.themesA[t].szAggregationFieldA[s+1]):(this.themesA[t].nGridWidth=parseFloat(this.themesA[t].szAggregationFieldA[s+1]),this.themesA[t].nGridWidthPx=0),this.themesA[t].szAggregationField=null)),s++}this.themesA[t].szAggregationField!=a||this.themesA[t].nGridWidth!=i?(this.themesA[t].fRealize=!0,this.themesA[t].themeNodesPosA=[]):this.themesA[t].fRedraw=!0}if(this.themesA[t].nGridWidthPx){var l=map.Scale.getDistanceInMeter(1e3,1e3,1e3+map.Scale.normalX(this.themesA[t].nGridWidthPx),1e3);this.themesA[t].nGridWidth=l/map.Scale.nZoomScale,this.themesA[t].fRealize=!0,this.themesA[t].themeNodesPosA=[]}else if(this.themesA[t].nGridMatrix){var h=map.Zoom.getBox();l=map.Scale.getDistanceInMeter(1e3,1e3,1e3+h.width,1e3);this.themesA[t].nGridWidth=l/(this.themesA[t].nGridMatrix||20)/map.Scale.nZoomScale,this.themesA[t].fRealize=!0,this.themesA[t].themeNodesPosA=[]}(this.themesA[t].szAggregationUpper||this.themesA[t].szAggregationLower)&&(this.themesA[t].szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.themesA[t].nAggregationUpper||this.themesA[t].szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.themesA[t].nAggregationLower?this.themesA[t].fRealize=0!=this.themesA[t].__fAggregate:this.themesA[t].fRealize=0==this.themesA[t].__fAggregate)}this.themesA[t].autoOpacity&&(this.themesA[t].fRedraw=!0),(this.themesA[t].nValueUpper||this.themesA[t].nValueLower||this.themesA[t].nChartUpper||this.themesA[t].nChartLower||this.themesA[t].nBoxUpper||this.themesA[t].nBoxLower||this.themesA[t].nTitleUpper||this.themesA[t].nTitleLower||this.themesA[t].nLabelUpper||this.themesA[t].nLabelLower||this.themesA[t].nMaxCharts)&&(this.themesA[t].fRedraw=!0)}this.themesA[t].fRealize?(this.themesA[t].fRedraw=!1,this.themesA[t].fActualize=!1):this.themesA[t].fRedraw?this.themesA[t].fActualize=!1:this.themesA[t].fActualize=!0,this.themesA[t].timeAggregating}return executeWithMessage("map.Themes.execute()","working ...",100),null},ixMap.Themes.prototype.resortCharts=function(e){var t=!1;if(this.themesA.length){for(var i=0;i<this.themesA.length;i++)this.themesA[i].fDone&&(this.themesA[i].fResort=!0,t=!0);t&&map.Themes.execute()}e&&(e.stopPropagation(),e.preventDefault())},ixMap.Themes.prototype.clear=function(){this.themesA.length=0},ObjTheme.prototype.getFields=function(){for(var i in this.szFields=this.theme.szFields,this.szFieldsA=this.theme.szFields.split("|"),this.szFieldsA)this.szFieldsA[i]=this.szFieldsA[i].trim();var i,j,k;this.theme.szFieldsA=this.szFieldsA,this.szField100A=this.theme.szField100A,this.szColorField=this.theme.szColorField,this.szSymbolField=this.theme.szSymbolField,this.szValueField=this.theme.szValueField,this.szLabelField=this.theme.szLabelField,this.szTitleField=this.theme.szTitleField,this.szSnippetField=this.theme.szSnippetField,this.szSizeField=this.theme.szSizeField,this.szAlphaField=this.theme.szAlphaField,this.szAlphaField100=this.theme.szAlphaField100,this.szXField=this.theme.szXField,this.szYField=this.theme.szYField,this.szTimeField=this.theme.szTimeField,this.szFilterField=this.theme.szFilterField,this.szAggregationField=this.theme.szAggregationField,this.szSelectionFieldsA=(this.theme.szSelectionField||"").split("|"),this.nFieldIndexA[0]=-1,this.nFieldSelectionIndexA[0]=-1,this.theme.szSelectionField2&&(this.szSelectionField2=this.theme.szSelectionField2||null,this.szSelectionFields2A=(this.theme.szSelectionField2||"").split("|"),this.nFieldSelection2IndexA=[-1]);var szTableName=this.coTable?this.coTable:this.szName;if(!this.szFields||""===this.szFields)return!0;try{eval("this.dbTable = "+szTableName+".table")}catch(e){try{eval("this.dbTable = "+szTableName+"_table")}catch(e){}}if(this.coTable&&!this.dbTable)return displayMessage("Data not loaded!",1e3,!0),!1;if(this.dbTable){try{eval("this.dbFields = "+szTableName+".fields")}catch(e){try{eval("this.dbFields = "+szTableName+"_fields")}catch(e){}}try{this.szSelectionField||(this.szSelectionField=map.Layer.getLayerObj(this.szName).szSelection)}catch(e){return alert("no selection field found !!"),!1}for(j=0;j<this.dbTable.fields;j++)if(!this.dbFields||0===this.dbFields.length||!this.dbFields[j])return alert("ERROR: theme '"+this.szName+"' - table '"+szTableName+"' - object 'fields' incorrect !"),!1;if("$table$"==this.szFields){for(this.szFieldsA=[],j=0;j<this.dbFields.length;j++)this.dbFields[j].id!=this.szSelectionField&&"Total"!=this.dbFields[j].id&&this.szFieldsA.push(this.dbFields[j].id);this.theme.szFields=this.szFieldsA.join("|"),this.theme.szFieldsA=this.szFieldsA,this.theme.szLabelA=this.szFieldsA}for(j=0;j<this.dbFields.length;j++){if(void 0!==this.szItemField&&String(this.dbFields[j].id).toLowerCase()==String(this.szItemField).toLowerCase()&&(_TRACE("'"+this.dbFields[j].id+"' found [item] at "+j),this.nFieldItemIndex=j),void 0!==this.szSelectionField&&String(this.dbFields[j].id).toLowerCase()==String(this.szSelectionField).toLowerCase()&&(_TRACE("'"+this.dbFields[j].id+"' found [selection] at "+j),this.nFieldSelectionIndex=j),void 0!==this.szSelectionField2)for(String(this.dbFields[j].id).toLowerCase()==String(this.szSelectionField2).toLowerCase()&&(_TRACE("'"+this.dbFields[j].id+"' found [selection] at "+j),this.nFieldSelection2Index=j),k=0;k<this.szSelectionFields2A.length;k++)this.dbFields[j].id==this.szSelectionFields2A[k]&&(_TRACE("'"+this.dbFields[j].id+"' found at "+j),this.nFieldSelection2IndexA[k]=j);for(k=0;k<this.szSelectionFieldsA.length;k++)this.dbFields[j].id==this.szSelectionFieldsA[k]&&(_TRACE("'"+this.dbFields[j].id+"' found at "+j),this.nFieldSelectionIndexA[k]=j);for(k=0;k<this.szFieldsA.length;k++)"!"==this.szFieldsA[k].substr(0,1)?this.dbFields[j].id==this.szFieldsA[k].substr(1,this.szFieldsA[k].length-1)&&(_TRACE("'"+this.dbFields[j].id+"' found at "+j),this.nFieldIndexA[k]=j):this.dbFields[j].id==this.szFieldsA[k]&&(_TRACE("'"+this.dbFields[j].id+"' found at "+j),this.nFieldIndexA[k]=j);if(this.szField100A)for(k=0;k<this.szField100A.length;k++)this.dbFields[j].id==this.szField100A[k]&&(_TRACE("'"+this.dbFields[j].id+"' found at "+j),this.nField100IndexA[k]=j);this.szColorField&&this.dbFields[j].id==this.szColorField&&(_TRACE("'"+this.dbFields[j].id+"' found [color] at "+j),this.nColorFieldIndex=j),this.szSymbolField&&this.dbFields[j].id==this.szSymbolField&&(_TRACE("'"+this.dbFields[j].id+"' found [symbol] at "+j),this.nSymbolFieldIndex=j),this.szValueField&&this.dbFields[j].id==this.szValueField&&(_TRACE("'"+this.dbFields[j].id+"' found [label] at "+j),this.nValueFieldIndex=j),this.szLabelField&&this.dbFields[j].id==this.szLabelField&&(_TRACE("'"+this.dbFields[j].id+"' found [label] at "+j),this.nLabelFieldIndex=j),this.szTitleField&&this.dbFields[j].id==this.szTitleField&&(_TRACE("'"+this.dbFields[j].id+"' found [title] at "+j),this.nTitleFieldIndex=j),this.szSnippetField&&this.dbFields[j].id==this.szSnippetField&&(_TRACE("'"+this.dbFields[j].id+"' found [snippet] at "+j),this.nSnippetFieldIndex=j),this.szSizeField&&this.dbFields[j].id==this.szSizeField&&(_TRACE("'"+this.dbFields[j].id+"' found [size] at "+j),this.nSizeFieldIndex=j),this.szTimeField&&this.dbFields[j].id==this.szTimeField&&(_TRACE("'"+this.dbFields[j].id+"' found [time] at "+j),this.nTimeFieldIndex=j),this.szXField&&this.dbFields[j].id==this.szXField&&(_TRACE("'"+this.dbFields[j].id+"' found [xfield] at "+j),this.nXFieldIndex=j),this.szYField&&this.dbFields[j].id==this.szYField&&(_TRACE("'"+this.dbFields[j].id+"' found [yfield] at "+j),this.nYFieldIndex=j),this.szAlphaField&&this.dbFields[j].id==this.szAlphaField&&(_TRACE("'"+this.dbFields[j].id+"' found [alpha] at "+j),this.nAlphaFieldIndex=j),this.szAlphaField100&&this.dbFields[j].id==this.szAlphaField100&&(_TRACE("'"+this.dbFields[j].id+"' found [alpha100] at "+j),this.nAlphaField100Index=j),this.szFilterField&&this.dbFields[j].id==this.szFilterField&&(_TRACE("'"+this.dbFields[j].id+"' found [filter] at "+j),this.nFilterFieldIndex=j),this.szAggregationField&&this.dbFields[j].id==this.szAggregationField&&(_TRACE("'"+this.dbFields[j].id+"' found [title] at "+j),this.nAggregationFieldIndex=j)}for(-1==this.nFieldSelectionIndex&&-1==this.nFieldSelectionIndexA[0]&&(this.szSelectionField&&this.szSelectionField.length?_ERROR("ERROR on load theme data: selection field '"+this.szSelectionField+"' not found !"):_ERROR("ERROR on load theme data: selection not defined !")),k=0;k<this.szFieldsA.length;k++)if(void 0===this.nFieldIndexA[k])return _ERROR("ERROR on load theme data: value field '"+this.szFieldsA[k]+"' not found !"),!1;if(this.szField100A)for(k=0;k<this.szField100A.length;k++)if(void 0===this.nField100IndexA[k])return _ERROR("ERROR on load theme data: value 100 field '"+this.szFieldsA[k]+"' not found !"),!1;this.szColorField&&!this.szColorField.match(/\$/)&&void 0===this.nColorFieldIndex&&_ERROR("ERROR on load theme data: colorfield: '"+this.szColorField+"' not found !"),this.szSymbolField&&!this.szSymbolField.match(/\$/)&&void 0===this.nSymbolFieldIndex&&_ERROR("ERROR on load theme data: symbolfield: '"+this.szSymbolField+"' not found !"),this.szValueField&&!this.szValueField.match(/\$/)&&void 0===this.nValueFieldIndex&&_ERROR("ERROR on load theme data: valuefield: '"+this.szValueField+"' not found !"),this.szLabelField&&!this.szLabelField.match(/\$/)&&void 0===this.nLabelFieldIndex&&_ERROR("ERROR on load theme data: labelfield '"+this.szLabelField+"' not found !"),this.szTitleField&&!this.szTitleField.match(/\$/)&&void 0===this.nTitleFieldIndex&&_ERROR("ERROR on load theme data: titlefield '"+this.szTitleField+"' not found !"),this.szSnippetField&&!this.szSnippetField.match(/\$/)&&void 0===this.nSnippetFieldIndex&&_ERROR("ERROR on load theme data: snippetfield '"+this.szSnippetField+"' not found !"),this.szSizeField&&!this.szSizeField.match(/\$/)&&void 0===this.nSizeFieldIndex&&_ERROR("ERROR on load theme data: sizefield '"+this.szSizeField+"' not found !"),this.szTimeField&&!this.szTimeField.match(/\$/)&&void 0===this.nTimeFieldIndex&&_ERROR("ERROR on load theme data: timefield '"+this.szTimeField+"' not found !"),this.szXField&&!this.szXField.match(/\$/)&&void 0===this.nXFieldIndex&&_ERROR("ERROR on load theme data: xfield '"+this.szXField+"' not found !"),this.szYField&&!this.szYField.match(/\$/)&&void 0===this.nYFieldIndex&&_ERROR("ERROR on load theme data: yfield '"+this.szYField+"' not found !"),this.szAlphaField&&!this.szAlphaField.match(/\$/)&&void 0===this.nAlphaFieldIndex&&_ERROR("ERROR on load theme data: alphafield '"+this.szAlphaField+"' not found !"),this.szAlphaField100&&!this.szAlphaField100.match(/\$/)&&void 0===this.nAlphaField100Index&&_ERROR("ERROR on load theme data: alpha100field '"+this.szAlphaField100+"' not found !"),this.szFilterField&&!this.szFilterField.match(/\$/)&&void 0===this.nFilterFieldIndex&&_ERROR("ERROR on load theme data: filterfield '"+this.szFilterField+"' not found !"),this.szAggregationField&&!this.szAggregationField.match(/\$/)&&void 0===this.nAggregationFieldIndex&&_ERROR("ERROR on load theme data: aggregationfield '"+this.szAggregationField+"' not found !"),!this.szItemField||this.szItemField==this.szSelectionField||this.szItemField.match(/\$/)||void 0!==this.nFieldItemIndex&&-1!=this.nFieldItemIndex||alert("ERROR on load theme data: itemfield '"+this.szItemField+"' not found !")}else{var themeNode=SVGDocument.getElementById(this.szName);if(null==themeNode){var themeNodesA=map.Tiles.getTileNodes(this.szName);themeNodesA&&(themeNode=themeNodesA[0])}if(!themeNode)return _TRACE(this.szName+"- not found"),this.szName="",!1;var szFields=themeNode.getAttributeNS(szMapNs,"info");if(null==szFields||""===szFields)return this.szName="",!1;var szFieldsA=szFields.split("|");for(j=0;j<szFieldsA.length;j++){for(k=0;k<this.szFieldsA.length;k++)"!"==this.szFieldsA[k].substr(0,1)?szFieldsA[j]==this.szFieldsA[k].substr(1,this.szFieldsA[k].length-1)&&(_TRACE("'"+szFieldsA[j]+"' found at "+j),this.nFieldIndexA[k]=j):szFieldsA[j]==this.szFieldsA[k]&&(_TRACE("'"+szFieldsA[j]+"' found at "+j),this.nFieldIndexA[k]=j);for(k=0;k<this.szField100A.length;k++)szFieldsA[j]==this.szField100A[k]&&(_TRACE("'"+szFieldsA[j]+"' found at "+j),this.nField100IndexA[k]=j);this.szColorField&&szFieldsA[j]==this.szColorField&&(_TRACE("'"+szFieldsA[j]+"' found [color] at "+j),this.nColorFieldIndex=j),this.szSymbolField&&szFieldsA[j]==this.szSymbolField&&(_TRACE("'"+szFieldsA[j]+"' found [symbol] at "+j),this.nSymbolFieldIndex=j),this.szValueField&&szFieldsA[j]==this.szValueField&&(_TRACE("'"+szFieldsA[j]+"' found [label] at "+j),this.nValueFieldIndex=j),this.szLabelField&&szFieldsA[j]==this.szLabelField&&(_TRACE("'"+szFieldsA[j]+"' found [label] at "+j),this.nLabelFieldIndex=j),this.szTimeField&&szFieldsA[j]==this.szTimeField&&(_TRACE("'"+szFieldsA[j]+"' found [size] at "+j),this.nTimeFieldIndex=j),this.szSizeField&&szFieldsA[j]==this.szSizeField&&(_TRACE("'"+szFieldsA[j]+"' found [size] at "+j),this.nSizeFieldIndex=j),this.szXField&&szFieldsA[j]==this.szXField&&(_TRACE("'"+szFieldsA[j]+"' found [size] at "+j),this.nXFieldIndex=j),this.szYField&&szFieldsA[j]==this.szXField&&(_TRACE("'"+szFieldsA[j]+"' found [size] at "+j),this.nYFieldIndex=j),this.szAlphaField&&szFieldsA[j]==this.szAlphaField&&(_TRACE("'"+szFieldsA[j]+"' found [alpha] at "+j),this.nAlphaFieldIndex=j),this.szAlphaField100&&szFieldsA[j]==this.szAlphaField100&&(_TRACE("'"+szFieldsA[j]+"' found [alpha100] at "+j),this.nAlphaField100Index=j)}}for(k=0;k<this.szFieldsA.length;k++)this.nFieldIndexA[k]<0&&("$item$"!=this.szFieldsA[k]&&"$index$"!=this.szFieldsA[k]&&_ERROR("ERROR on load theme data: '"+this.szFieldsA[k]+"' not found !"),this.szName="");return!0},MapTheme.prototype.checkTheme=function(){if(!this.szThemesA)return!1;for(var e=0;e<this.szThemesA.length;e++)if("generic"==this.szThemesA[e]||map.Layer.isLoaded(this.szThemesA[e]))return!0;return this.ErrorMessage="theme layer not loaded ! zoom in ?",!1},MapTheme.prototype.def=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)},MapTheme.prototype.getDefinitionObject=function(){return map.Themes.getMapThemeDefinitionObj(this.szId)},MapTheme.prototype.set=function(e){map.Themes.parseStyle(this,e)},MapTheme.prototype.setDefinitionObject=function(e){map.Themes.parseStyle(this,e)},MapTheme.prototype.initValues=function(){this.nMin=Number.MAX_VALUE,this.nMax=-Number.MAX_VALUE,this.nSum=0,this.nCount=0,this.nNoData=0;for(var e=0;e<this.szFieldsA.length;e++)this.nMinA[e]=Number.MAX_VALUE,this.nMaxA[e]=-Number.MAX_VALUE,this.nSumA[e]=0,this.nOrigMinA[e]=Number.MAX_VALUE,this.nOrigMaxA[e]=-Number.MAX_VALUE,this.nOrigSumA[e]=0,this.nMedianA[e]=0,this.nMeanA[e]=0,this.nDeviationA[e]=0;if(this.nMin100=Number.MAX_VALUE,this.nMax100=-Number.MAX_VALUE,this.nSum100=0,this.itemA=[],this.posItemA=[],this.chartPosA=[],this.exactCountA=[],this.exactSizeA=[],this.quantileA=[],this.szAggregation||(this.szField100?this.szAggregation="mean":this.szAggregation="sum"),this.szAggregationFieldA&&!this.fSuppressAggregationScale)for(var t=0;t<this.szAggregationFieldA.length;t++){var i=Number(this.szAggregationFieldA[t].split(":")[1]);i&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>i&&(isNaN(parseFloat(this.szAggregationFieldA[t+1]))?this.szAggregationField=this.szAggregationFieldA[t+1]:(this.szAggregationFieldA[t+1].match(/px/)?this.nGridWidthPx=parseFloat(this.szAggregationFieldA[t+1]):(this.nGridWidth=parseFloat(this.szAggregationFieldA[t+1]),this.nGridWidthPx=0),this.szAggregationField=null)),t++}this.fSuppressAggregationScale=!1,this.nWrongRecordLengthCount=0,this.missedA=[],this.coTable&&"genericTable"!=this.coTable||this.loadTableFromMap()&&(this.coTable="genericTable")},MapTheme.prototype.removeValues=function(){this.itemA=null,this.posItemA=null,this.chartPosA=null,this.exactCountA=null,this.exactSizeA=null,this.quantileA=null,this.missedA=null},MapTheme.prototype.getMeanMedianQuantile=function(){if(!this.quantileA||!this.quantileA.length)for(var e=0;e<this.nMaxA.length;e++){var t=[],i=0;for(var a in this.itemA)t.push(this.itemA[a].nValuesA[e]),i+=this.itemA[a].nValuesA[e];this.szFieldsA[e]&&"$item$"!=this.szFieldsA[e]&&t.sort(this.sortUp);var s=Math.round(t.length/2);this.nMedianA[e]=t[s],this.nMeanA[e]=i/t.length,this.quantileA[e]=t}},MapTheme.prototype.getHeadTail=function(){var e={mean:function(e){var t=e.length;return e.reduce((function(e,t){return e+t}),0)/t},headTail:function(e){var t=Math.min.apply(null,e),i=this.mean(e),a=[t];for(a.push(i);e.length>1;)e=e.filter((function(e){return e>i})),i=this.mean(e),a.push(i);return a}},t=[];for(var i in this.itemA)t.push(this.itemA[i].nValuesA[0]);return e.headTail(t)},MapTheme.prototype.realize=function(){if(_TRACE(" "),_TRACE("========================> "),_TRACE("== MapTheme.realize() ==> "),_TRACE("========================> "),_TRACE(this.szFlag),_TRACE(" "),_LOG("theme realize start - "+this.szId+this.szFlag),this.szFlag.match(/WMS/)){this.chartGroup||(this.chartGroup=map.Dom.newGroup(map.Layer.layerNode,this.szThemesA[0]),map.Layer.listA[this.szThemesA[0]]=new ixMap.Layer.Item(null),map.Layer.listA[this.szThemesA[0]].szName=this.szThemesA[0],this.fDone=!0,this.isChecked=!0);var mapGeoBounds=map.Zoom.getBoundsOfMapInGeoBounds(),width=map.Scale.viewBox.width/map.Zoom.nZoomX,height=map.Scale.viewBox.height/map.Zoom.nZoomY,imageWidth=map.Scale.bBox.width/20,imageHeight=map.Scale.bBox.height/20;if(this.nLayerLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nLayerLower)return void this.clearWMS();if(this.nLayerUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nLayerUpper)return void this.clearWMS();var newShape=map.Dom.constructNode("image",this.chartGroup,{"xlink:href":this.szServer+"?f=image&transparent=true&bbox="+mapGeoBounds[0].x+","+mapGeoBounds[0].y+","+mapGeoBounds[1].x+","+mapGeoBounds[1].y+"&bboxSR=4326&size="+imageWidth+","+imageHeight,x:-map.Scale.mapCenter.x/map.Zoom.nZoomX-width/2,y:-map.Scale.mapCenter.y/map.Zoom.nZoomY-height/2,style:"width:"+width+";height:"+height+";opacity:"+(this.nOpacity||.8)+";pointer-events:none;",onload:'map.Themes.getTheme("'+this.szId+'").cleanWMS();'});this.fDone=!0}else if(!this.szFlag.match(/FEATURE/)||!(this.nFeatureLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nFeatureLower||this.nFeatureUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nFeatureUpper)){if(this.szFlag.match(/CHART|CHOROPLETH/)&&(!this.nChartLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartLower)&&(!this.nChartUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartUpper)){var themes=map.Themes.getAllThemes();for(var i in themes)if(themes[i]!=this&&themes[i].szFlag.match(/FEATURE/)&&themes[i].szThemesA[0]==this.szThemesA[0]&&!themes[i].fDone)return this.fRealize=!0,void setTimeout("map.Themes.execute()",500)}if(this.coTable){this.__test=null;try{eval("this.__test = "+this.coTable+".table")}catch(e){try{eval("this.__test = "+this.coTable+"_table")}catch(e){}}if(!this.__test)return map.Themes.loadExternalData(this.coTable,this.nRefreshTimeout,this),void(this.fRealize=!0)}var x=new Date;if(this.fShowProgressBar=!0,this.initValues(),this.getFields())if(this.loadValues()){if(this.szFlag.match(/\bPOSITION\b/)){_LOG("start");var szTheme=this.szThemesA[0],objTheme=this.objThemesA[szTheme],itemIndex=objTheme.nFieldItemIndex,latIndex=objTheme.nFieldSelectionIndexA[0],lonIndex=objTheme.nFieldSelectionIndexA[1];for(var i in objTheme.dbRecords)map.Themes.themeNodesPosA[szTheme+"::"+objTheme.dbRecords[i][itemIndex]]=map.Scale.getMapPositionOfLatLon(Number(objTheme.dbRecords[i][latIndex].replace(",",".")),Number(objTheme.dbRecords[i][lonIndex].replace(",",".")));return _LOG("stop"),this.fAnalyze=!1,this.fDraw=!1,void(this.fDone=!0)}this.fDone=!1,this.timeLoading=new Date-x,(this.timeLoading>1e3||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();",this.szFlag.match(/AGGREGATE/)?"aggregating":"parsing data"):map.Themes.executeContinue()}else this.fRemove=!0;else this.fRemove=!0}},MapTheme.prototype.cleanWMS=function(){this.chartGroup.childNodes.length>1&&this.chartGroup.removeChild(this.chartGroup.firstChild)},MapTheme.prototype.clearWMS=function(){map.Dom.clearGroup(this.chartGroup)},MapTheme.prototype.realize_analyze=function(){_TRACE("=============================>"),_TRACE("  MapTheme.realize_analyze()"),_TRACE("=============================>");var e=new Date;_TRACE("distributeValues ----\x3e"),this.fDraw=this.distributeValues(),_TRACE("---\x3e done"),this.fDraw||this.realizeDone(),this.timeAggregating=new Date-e,(this.timeLoading>1e3||this.szFlag.match(/VERBOSE/))&&!this.szFlag.match(/SILENT/)?executeWithMessage("map.Themes.executeContinue();","drawing"):map.Themes.executeContinue()},MapTheme.prototype.realize_draw=function(){var e=map.Layer.getLayerObj(this.szThemesA[0]);e&&(this.szShapeType=e.szType,"line"==this.szShapeType&&this.szOrigFlag.match(/BUFFER/)&&(this.szShapeType+="+buffer")),this.szOrigFlag.match(/FEATURE/)&&this.szOrigFlag.match(/LINES/)&&(this.szShapeType="line"),_TRACE("===========================> "),_TRACE("  MapTheme.realize_draw() "),_TRACE("===========================> "),_TRACE(this.szFlag),_LOG("theme draw start - "+this.szId),this.timeStart=new Date,_TRACE("get shapes in cache ----\x3e"),_TRACE("---\x3e done"),this.nDoneCount=0,this.nSkipCount=0,this.nRealizedCount=0,this.nZeroValueCount=0,this.nMissingRangeCount=0,this.nActualFrame=0;var t=this.szFlag.match(/VERBOSE/)?"drawing":"";this.mapSleep=new ixMap.Sleep("map.Themes.executeContinue",this.nflushPaintShape,map.Dictionary.getLocalText(t)),this.mapSleep.nCount=this.nCount,this.mapSleep.szCancel="map.Themes.cancelExecute()",this.szFlag.match(/\bCLIP\b/)&&(this.mapSleep=null,this.nClipIncr=1),this.szFlag.match(/FEATURE/)?(this.mapSleep=null,this.unpaintMap(),this.chartMap()):this.szFlag.match(/CHART/)?(this.mapSleep&&(this.mapSleep.initCheckSleep(this.nflushChartDraw,t),this.mapSleep.fShowProgressBar=!0),this.chartMap()):(this.unlabelMap(),this.paintMap(),this.makeVisible()),this.isChecked=!0,!this.szFlag.match(/CHART/)||this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/)||this.szFlag.match(/BAR/)&&this.colorScheme&&this.nOrigSumA&&this.nOrigSumA.length!=this.colorScheme.length?this.isMarkable=!0:this.isMarkable=!1},MapTheme.prototype.realizeContinue=function(e){_TRACE("realizeContinue"),this.fMakeLabel?this.labelMap(e):this.szFlag.match(/CHART/)?this.chartMap(e):this.paintMap(e)},MapTheme.prototype.realizeNextClipFrame=function(){if(_TRACE("realizeNextFrame"),this.szFlag.match(/\bCLIP\b/)&&!this.fClipPause){var e=this.szId;if(this.nActualFrame+=this.nClipIncr,this.nActualFrame>=this.nClipFrames)return this.szFlag.match(/BACK/)?(this.nClipIncr=-this.nClipIncr,void(this.clipTimeout=setTimeout((function(){map.Themes.nextClipFrame(e)}),1e3))):this.szFlag.match(/LOOP/)?(this.nActualFrame=-1,void(this.clipTimeout=setTimeout((function(){map.Themes.nextClipFrame(e)}),1e3))):(this.nActualFrame=this.nClipFrames-1,void this.pauseClip());if(this.nActualFrame<0)return this.szFlag.match(/BACK/)?(this.nClipIncr=-this.nClipIncr,void(this.clipTimeout=setTimeout((function(){map.Themes.nextClipFrame(e)}),10))):(this.nActualFrame=0,void this.pauseClip());this.mapSleep=null,this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.fDone=!1,this.fRedraw=!0,this.chartMap()):this.paintMap(),this.fRedrawInfo=!0}},MapTheme.prototype.setClipFrame=function(e){_TRACE("setClipFrame: "+e),this.fClipPause=!0,this.nActualFrame=Math.min(e,this.nClipFrames),this.mapSleep=null,this.szFlag.match(/CHART/)?(this.chartPosA=[],this.posItemA=[],this.fDone=!1,this.chartMap()):this.paintMap(),this.fRedrawInfo=!0},MapTheme.prototype.startClip=function(e){_TRACE("startClip");var t=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");t&&t.style.setProperty("display","inline","");var i=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button");i&&i.style.setProperty("display","none",""),this.fClipPause=!1,this.nActualFrame=e||this.nActualFrame,this.realizeNextClipFrame()},MapTheme.prototype.pauseClip=function(){_TRACE("pauseClip");var e=SVGDocument.getElementById(this.szId+":display:widget:clippausebutton:button");e&&e.style.setProperty("display","none","");var t=SVGDocument.getElementById(this.szId+":display:widget:clipstartbutton:button");t&&t.style.setProperty("display","inline",""),this.clipTimeout&&clearTimeout(this.clipTimeout),this.fClipPause=!0},MapTheme.prototype.realizeDone=function(){var e=this.szId;if(this.nRefreshTimeout&&(this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout((function(){map.Themes.refreshTheme(e)}),this.nRefreshTimeout)),this.szFlag.match(/\bCLIP\b/)){if(this.szFlag.match(/\bPAUSE\b/)&&(this.removeDefinitionFromFlag("PAUSE"),this.fClipPause=!0),this.szFlag.match(/\bLAST\b/)){this.removeDefinitionFromFlag("LAST");var t=this.nClipFrames-1;setTimeout((function(){map.Themes.setClipFrame(e,t)}),10)}this.clipTimeout&&clearTimeout(this.clipTimeout),this.clipTimeout=setTimeout((function(){map.Themes.nextClipFrame(e)}),this.nActualFrame?this.nClipTimeout:1e3)}this.nWrongRecordLengthCount&&fDebug&&displayMessage("Data Error:  "+this.nWrongRecordLengthCount+" items have wrong record length",1e4,"notify"),this.fRedraw=!1,this.fRealize=!1,this.fDone=!0,this.timeRealizing=new Date-this.timeStart,_TRACE("<== realize done == "),_TRACE(this.szFlag),_TRACE(" "),_LOG("theme done - "+this.szId),this.szFlag.match(/SHOW/)&&(this.removeDefinitionFromFlag("SHOW"),this.zoomTo()),this.szFlag.match(/ZOOMTO/)&&(this.removeDefinitionFromFlag("ZOOMTO"),this.zoomTo()),map.Themes.realizeDone(this)},MapTheme.prototype.beginDraw=function(){},MapTheme.prototype.endDraw=function(){},MapTheme.prototype.redraw=function(e){if(_TRACE("MapTheme.redraw() =====>"),!this.szFlag.match(/FEATURE/))if(this.clipTimeout&&clearTimeout(this.clipTimeout),this.fDataIncomplete&&this.__themeNodes!=map.Themes.themeNodes&&(_TRACE("here we load again!"),this.fDataIncomplete=!1,this.initValues(),this.loadValues(),this.distributeValues()),this.szFlag.match(/CHART/))(this.fClipCharts||this.fRedraw)&&(_TRACE("skip="+this.nSkipCount),this.nSkipCount=0,this.nDoneCount=0,this.nRealizedCount=0,this.nZeroValueCount=0,this.nMissingRangeCount=0,this.nMissingPositionCount=0,this.chartMap()),e&&this.enable();else{if(this.isChecked){if(this.partsA)for(var t=0;t<this.partsA.length;t++)this.partsA[t].nCount=0,this.partsA[t].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map"),this.makeVisible(),this.paintMap()}e&&this.enable()}},MapTheme.prototype.toFront=function(){if(_TRACE("toFront !!!!! "+this.szId),this.szFlag.match(/CHART/)){this.chartGroup.parentNode.appendChild(this.chartGroup);var e=getMatrix(this.chartGroup);e&&setMatrix(this.chartGroup,e),this.enable()}else if(this.isChecked){for(var t=0;t<this.partsA.length;t++)this.partsA[t].nCount=0,this.partsA[t].nSum=0;this.mapSleep&&this.mapSleep.initCheckSleep(this.nflushPaintShape,"painting map"),this.paintMap()}else this.enable()},MapTheme.prototype.getFields=function(){_TRACE("== MapTheme.getFields() ===> ");for(var e=0;e<this.szThemesA.length;e++){var t=this.szThemesA[e];if(this.objThemesA[t]=new ObjTheme(t,e,this.coTable,this.szSelectionField,this.szItemField),this.objThemesA[t].theme=this,!this.objThemesA[t].getFields()){try{HTMLWindow.ixmaps.htmlgui_onErrorTheme(t)}catch(e){}return!1}}return _TRACE("== done === "),!0},MapTheme.prototype.addItemValues=function(e,t,i,a,s){if(!this.szFlag.match(/RAW/)||i|a|s){if(this.szExcludeA)for(l=0;l<this.szExcludeA.length;l++)if(e.split("::")[1]==this.szExcludeA[l])return;if(!(this.nField100Min&&i&&i[0]&&i[0]<this.nField100Min)){if(this.nMinValue&&t&&!i){for(var n=!1,l=t.length-1;l>=0;l--)t[l]>=this.nMinValue&&(n=!0);if(!n)return}var h=1;if(!this.__fDensity&&!this.__fDensityAlpha||(h=this.getNodeArea(e))||!this.__fTiledLayer){if(this.szWeights)for(l=0;l<t.length;l++)t[l]*=this.szWeightsA[l]||this.szWeightsA[0];if(this.__fAuto100){let e=0;for(l=0;l<t.length;l++)e+=t[l]||0;for(l=0;l<t.length;l++)i[l]=e;this.fField100=!0}this.itemA[e]={nOrigValuesA:[],nValuesA:t,nValue100A:i,nValueSum:0};for(l=0;l<t.length;l++){if(this.itemA[e].nOrigValuesA[l]=isNaN(t[l])?0:t[l],this.itemA[e].nValueSum+=t[l]||0,this.fField100)if(i){var o=t[l];0!==o||this.szFlag.match(/ZEROISVALUE/)?"!"==this.szFieldsA[l].substr(0,1)?(o=i[l]-o,this.itemA[e].nOrigValuesA[l]=o):this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)?(o=i[l]?Math.round(o*i[l]/100):o,this.itemA[e].nOrigValuesA[l]=o):this.szFlag.match(/PRODUCT/)?o=i[l]?o*i[l]:o:this.szFlag.match(/DIFFERENCE/)&&1==t.length&&!this.szFlag.match(/RELATIVE/)?(i[l]=l>0?t[l-1]:this.itemA[e].nValue100A[l],o-=i[l]):(o=i[l]?o/i[l]:1,this.szFlag.match(/FRACTION/)?o*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?o*=1e3:(o*=100)>0&&this.szFlag.match(/RELATIVE/)?o-=100:o>0&&this.szFlag.match(/INVERT/)&&(o=100-o)):o=0,t[l]=o}else t[l]=0;this.__fDensity&&(t[l]=h?t[l]/h:null)}if(this.__fDifference&&t.length>1){for(l=0;l<t.length;l++)if(l<t.length-1){var r=t[l];t[l]=t[l+1]-t[l],this.szFlag.match(/RELATIVE/)&&(t[l]=r?100/r*t[l]:t[l]?100:0)}else this.szFlag.match(/STACKED/)||(t[l]=0);t.pop()}for(l=0;l<t.length;l++){if(!this.nSumA)return;!isNaN(t[l])&&isFinite(t[l])&&(this.nMin=Math.min(this.nMin,t[l]),this.nMax=Math.max(this.nMax,t[l]),this.nSum+=t[l],this.nMinA[l]=Math.min(this.nMinA[l],t[l]),this.nMaxA[l]=Math.max(this.nMaxA[l],t[l]),this.nSumA[l]+=t[l],this.nOrigMinA[l]=Math.min(this.nOrigMinA[l],this.itemA[e].nOrigValuesA[l]),this.nOrigMaxA[l]=Math.max(this.nOrigMaxA[l],this.itemA[e].nOrigValuesA[l]),this.nOrigSumA[l]+=this.itemA[e].nOrigValuesA[l]),t[l]<0&&(this.fNegativeValues=!0)}if(!isNaN(i[0])&&isFinite(i[0])&&(this.nMin100=Math.min(this.nMin100,i[0]),this.nMax100=Math.max(this.nMax100,i[0]),this.nSum100+=i[0]),this.szSizeField&&(!isNaN(a)&&isFinite(a)?(this.itemA[e].nSize=a,this.nMinSize=Math.min(this.nMinSize,a),this.nMaxSize=Math.max(this.nMaxSize,a),this.nSumSize+=a):this.itemA[e].nSize=0),this.szAlphaField&&null!=s&&!isNaN(s)&&isFinite(s)&&(this.__fDensityAlpha&&(h?s/=h:s=0),this.itemA[e].nAlpha=s,this.nMinAlpha=Math.min(this.nMinAlpha,s),this.nMaxAlpha=Math.max(this.nMaxAlpha,s),this.nSumAlpha+=s),this.__fExact&&this.exactCountA)for(l=0;l<t.length;l++)t[l]&&(this.exactCountA[t[l]-1]?(this.exactCountA[t[l]-1]++,this.exactSizeA[t[l]-1]+=this.itemA[e].nSize||1):(this.exactCountA[t[l]-1]=1,this.exactSizeA[t[l]-1]=this.itemA[e].nSize||1));this.nCount++}else this.fDataIncomplete=!0}}else{for(this.itemA[e]={nOrigValuesA:[],nValuesA:t,nValue100A:i,nValueSum:0},l=0;l<t.length;l++){if(!this.nSumA)return;isNaN(t[l])||(this.nMin=Math.min(this.nMin,t[l]),this.nMax=Math.max(this.nMax,t[l]),this.nSum+=t[l]),t[l]<0&&(this.fNegativeValues=!0),this.__fExact&&this.exactCountA&&t[l]&&(this.exactCountA[t[l]-1]?(this.exactCountA[t[l]-1]++,this.exactSizeA[t[l]-1]+=this.itemA[e].nSize||1):(this.exactCountA[t[l]-1]=1,this.exactSizeA[t[l]-1]=this.itemA[e].nSize||1))}this.nCount++}},MapTheme.prototype.getStringValueIndex=function(e,t){if(0===e.length||" "==e){if(!this.szFlag.match(/UNDEFINEDISVALUE/))return-1;e="undefined"}return this.szFlag.match(/IGNORECASE/)&&(e=e.toUpperCase()),e=e.trim(),void 0!==this.nStringToValueA[e]||this.szValuesA&&this.szValuesA.length&&"set"!=t||(this.szLabelA=this.szLabelA||[],this.szExactA=this.szExactA||[],this.nStringToValueA[e]=this.nStringToValue,this.szLabelA[this.nStringToValue-1]=this.szLabelA[this.nStringToValue-1]||e,this.szExactA.push(this.nStringToValue),this.nStringToValue++),this.nStringToValueA[e]},MapTheme.prototype.checkHiddenLayerState=function(){for(var e=0;e<this.szThemesA.length;e++)if(map.Layer.isScaleDependentLayer(this.szThemesA[e])){if(this.hiddenLayerA[this.szThemesA[e]]&&map.Layer.isScaleDependentLayerOn(this.szThemesA[e]))return!0;if(!this.hiddenLayerA[this.szThemesA[e]]&&!map.Layer.isScaleDependentLayerOn(this.szThemesA[e]))return!0}return!1};var __scanValue=function(e){return String(e).match(/,/)?parseFloat(String(e).replace(/\./gi,"").replace(/,/gi,".")):parseFloat(String(e).replace(/ /gi,""))};MapTheme.prototype.loadValues=function(){_TRACE("== MapTheme.loadValues() ===> "),this.nMissingLookupCount=0,this.__fExact=this.szFlag.match(/CATEGORICAL/),this.__fMax=this.szFlag.match(/\bMAX\b/),this.__fDifference=this.szFlag.match(/DIFFERENCE/),this.__fFilter=this.szFilter&&this.szFilter.length,this.__fDensity=this.szFlag.match(/DENSITY/),this.__fDensityAlpha=!this.szFlag.match(/CHART/)&&this.szAlphaField100&&this.szAlphaField100.match(/\$density\$/i),this.__fAggregate=this.szFlag.match(/AGGREGATE/),this.__fAuto100=this.szFlag.match(/AUTO100/)&&!this.szFlag.match(/AGGREGATE/),this.__fTiledLayer=!!map.Layer.getLayerObj(this.szThemesA[0])&&map.Layer.getLayerObj(this.szThemesA[0]).szFlag.match(/tiled/),this.__themeNodes=map.Themes.themeNodes;for(var e=0;e<this.szThemesA.length;e++)if(!map.Layer.isScaleDependentLayer(this.szThemesA[e])||map.Layer.isScaleDependentLayerOn(this.szThemesA[e])){if(this.hiddenLayerA[this.szThemesA[e]]=!1,!this.loadValuesOfTheme(this.szThemesA[e]))return!1}else this.hiddenLayerA[this.szThemesA[e]]=!0,this.fRealize=!0;return!0},MapTheme.prototype.filterValues=function(j){if(this.szFilter.match(/WHERE/)){if(!this.objTheme.filterQueryA){for(var szTokenA=this.szFilter.split("WHERE ")[1].split(" "),ii=0;ii<szTokenA.length;ii++)if(szTokenA[ii].length){if('"'==szTokenA[ii][0]&&'"'!=szTokenA[ii][szTokenA[ii].length-1])do{szTokenA[ii]=szTokenA[ii]+" "+szTokenA[ii+1],szTokenA.splice(ii+1,1)}while('"'!=szTokenA[ii][szTokenA[ii].length-1]);if("("==szTokenA[ii][0]&&")"!=szTokenA[ii][szTokenA[ii].length-1])do{szTokenA[ii]=szTokenA[ii]+" "+szTokenA[ii+1],szTokenA.splice(ii+1,1)}while(")"!=szTokenA[ii][szTokenA[ii].length-1])}else szTokenA.splice(ii,1),ii--;this.objTheme.filterQueryA=[];var filterObj={};do{var nToken=0;if(szTokenA.length>=3&&(filterObj={},filterObj.szFilterField=szTokenA[0].replace(/("|)/g,""),filterObj.szFilterOp=szTokenA[1],filterObj.szFilterValue=szTokenA[2].replace(/("|)/g,""),nToken=3),"BETWEEN"==filterObj.szFilterOp&&szTokenA.length>=5&&"AND"==szTokenA[3]&&(filterObj.szFilterValue2=szTokenA[4].replace(/("|)/g,""),nToken=5),!nToken){alert("ixmaps - filter error - incomplete query!\nquery: "+this.szFilter);break}if("*"==filterObj.szFilterField)filterObj.nFilterFieldIndex=-1;else for(var ii=0;ii<this.objTheme.dbFields.length;ii++)this.objTheme.dbFields[ii].id==filterObj.szFilterField&&(filterObj.nFilterFieldIndex=ii),"$"+this.objTheme.dbFields[ii].id+"$"==filterObj.szFilterValue&&(filterObj.nFilterValueIndex=ii);if(this.objTheme.filterQueryA.push(filterObj),szTokenA.splice(0,nToken),!szTokenA.length||"AND"!=szTokenA[0])break;szTokenA.splice(0,1)}while(szTokenA.length)}for(var i in this.objTheme.filterQueryA){-1==this.objTheme.filterQueryA[i].nFilterFieldIndex?this.__szValue=this.objTheme.dbRecords[j].join("|"):this.__szValue=String(this.objTheme.dbRecords[j][this.objTheme.filterQueryA[i].nFilterFieldIndex]),this.__szFilterOp=this.objTheme.filterQueryA[i].szFilterOp.toUpperCase(),this.__szFilterValue=this.objTheme.filterQueryA[i].szFilterValue,this.__szFilterValue2=this.objTheme.filterQueryA[i].szFilterValue2,null!=this.objTheme.filterQueryA[i].nFilterValueIndex&&(this.__szFilterValue=String(this.objTheme.dbRecords[j][this.objTheme.filterQueryA[i].nFilterValueIndex]));var result=!0,nValue=__scanValue(this.__szValue);if(result="="==this.__szFilterOp?this.__szValue==this.__szFilterValue||nValue==Number(this.__szFilterValue):"!="==this.__szFilterOp||"<>"==this.__szFilterOp?!(this.__szValue==this.__szFilterValue||nValue==Number(this.__szFilterValue)):">"==this.__szFilterOp?nValue>Number(this.__szFilterValue):"<"==this.__szFilterOp?nValue<Number(this.__szFilterValue):">="==this.__szFilterOp?nValue>=Number(this.__szFilterValue):"<="==this.__szFilterOp?nValue<=Number(this.__szFilterValue):"LIKE"==this.__szFilterOp?"*"==this.__szFilterValue?this.__szValue.length:eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"NOT"==this.__szFilterOp?eval("!this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"):"IN"==this.__szFilterOp?eval("this.__szFilterValue.match(/\\("+this.__szValue.replace(/\//gi,"\\/")+"\\)/)")||eval("this.__szFilterValue.match(/\\("+this.__szValue.replace(/\//gi,"\\/")+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue.replace(/\//gi,"\\/")+"\\,/)")||eval("this.__szFilterValue.match(/\\,"+this.__szValue.replace(/\//gi,"\\/")+"\\)/)"):"BETWEEN"==this.__szFilterOp?nValue>=Number(this.__szFilterValue)&&nValue<=Number(this.__szFilterValue2):eval("this.__szValue.match(/"+this.__szFilterValue.replace(/\//gi,"\\/")+"/i)"),!result)return!1}}else if(this.__szValue=this.objTheme.dbRecords[j].join(" "),!eval("this.__szValue.match(/"+this.szFilter+"/i)"))return!1;return!0},MapTheme.prototype.getSelectionId=function(e,t){if(!this.fSelection){if(this.fSelection="lookup",this.objTheme.nFieldSelectionIndexA&&this.objTheme.nFieldSelectionIndexA.length>1)this.fSelection=this.szCRSDatum?"UTM":"LatLon",this.nSelection_0=this.objTheme.nFieldSelectionIndexA[0],this.nSelection_1=this.objTheme.nFieldSelectionIndexA[1];else if(this.objTheme.nFieldSelectionIndex>=0){var i=__mpap_decode_utf8(String(this.objTheme.dbRecords[t][this.objTheme.nFieldSelectionIndex]));i.match(/MultiPoint/)||i.match(/Point/i)?this.fSelection="MultiPoint":i.match(/LineString/)?this.fSelection="LineString":i.match(/MultiLineString/)?this.fSelection="MultiLineString":(i.match(/Polygon/)||i.match(/MultiPolygon/))&&(this.fSelection="MultiPolygon")}if(this.objTheme.nFieldSelection2IndexA&&this.objTheme.nFieldSelection2IndexA.length>1)this.fSelection2=this.szCRSDatum?"UTM":"LatLon",this.nSelection2_0=this.objTheme.nFieldSelection2IndexA[0],this.nSelection2_1=this.objTheme.nFieldSelection2IndexA[1];else if(void 0!==this.objTheme.nFieldSelection2Index){var a=__mpap_decode_utf8(String(this.objTheme.dbRecords[t][this.objTheme.nFieldSelection2Index]));a.match(/MultiPoint/)||a.match(/Point/)?this.fSelection2="MultiPoint":this.fSelection2="mapshape"}}if("LatLon"==this.fSelection||"UTM"==this.fSelection)return e+"::"+String(this.objTheme.dbRecords[t][this.nSelection_0]).replace(/,/g,".")+","+String(this.objTheme.dbRecords[t][this.nSelection_1]).replace(/,/g,".")+(this.szSelectionFieldSuffix||"").replace(/,/g,".");if("Point"==this.fSelection||"MultiPoint"==this.fSelection){var s;return(s=(i=this.objTheme.dbRecords[t][this.objTheme.nFieldSelectionIndex]).match(positionRegExp))?e+"::"+s[2]+","+s[1]+(this.szSelectionFieldSuffix||""):null}return"LineString"==this.fSelection||"MultiLineString"==this.fSelection||"Polygon"==this.fSelection||"MultiPolygon"==this.fSelection?e+"::"+String(t)+(this.szSelectionFieldSuffix||""):this.objTheme.nFieldSelectionIndex>=0?(i=__mpap_decode_utf8(String(this.objTheme.dbRecords[t][this.objTheme.nFieldSelectionIndex])),this.nSelectionFieldDigits&&(i=("000000000000000"+i).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToNumber&&(i=String(Number(i))),this.fSelectionFieldToUpper&&(i=String(i).toUpperCase()),e+"::"+i+(this.szSelectionFieldSuffix||"")):null},MapTheme.prototype.loadValuesOfTheme=function(szThemeLayer){if(this.szFlag.match(/FAST/)||this.szFlag.match(/VECTOR/)||this.szFlag.match(/BEZIER/)||void 0!==this.szSelectionField2||this.szFlag.match(/AGGREGATE/)&&!this.szFlag.match(/COMPATIBLE|PERCENTOFMEAN/))return this.__fAggregateOnLoad=!0,_LOG("loadAndAggregateValuesOfTheme ===>"),this.loadAndAggregateValuesOfTheme(szThemeLayer);var i,j,k,szId,szSelectionId,nValueA,nValue100A,nvalueA;_TRACE("MapTheme.loadValuesOfTheme() ---\x3e "),this.fField100=!1,this.fNegativeValues=!1,this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||"");var fDone=!0;if(this.objTheme=this.objThemesA[szThemeLayer],this.objTheme.nField100IndexA[0]&&this.objTheme.nField100IndexA[0]>0&&(this.fField100=!0),this.objTheme.dbTable&&szThemeLayer&&szThemeLayer.length){if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(e){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+this.coTable+" could not be loaded!",2e3,!0),!1}else try{eval("this.objTheme.dbRecords = "+szThemeLayer+".records")}catch(e){eval("this.objTheme.dbRecords = "+szThemeLayer+"_records")}if(_TRACE("coTable: "+this.objTheme.dbRecords.length+" records"),this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA,"$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/)){var maxTest=Math.min(40,this.objTheme.dbRecords.length);for(j=0;j<maxTest;j++)if(this.objTheme.dbRecords[j])for(k=0;k<this.szFieldsA.length;k++){var nValue=this.objTheme.dbRecords[j][this.objTheme.nFieldIndexA[k]];if(__scanValue(nValue)!=parseFloat(nValue)){this.__fScanValue=!0,_TRACE("this.__fScanValue = "+this.__fScanValue),j=maxTest;break}}}for(j=0;j<this.objTheme.dbRecords.length;j++)if(!this.objTheme.dbRecords[j]||this.fCheckRecordLength&&this.objTheme.dbRecords[j].length<this.objTheme.dbFields.length)this.nWrongRecordLengthCount++;else if(!this.__fFilter||this.filterValues(j)){if(nValueA=[],"$item$"==this.szFieldsA[0])nValueA[0]=1;else if("$index$"==this.szFieldsA[0])nValueA[0]=j+1;else for(k=0;k<this.szFieldsA.length;k++){var nValue=this.objTheme.dbRecords[j][this.objTheme.nFieldIndexA[k]];if(this.__fExact?(nValue=this.valueMap?this.valueMap[String(nValue)]:nValue,nValue=this.getStringValueIndex(String(nValue))):nValue=this.__fScanValue?__scanValue(nValue):parseFloat(nValue),isNaN(nValue)){if(!this.fUndefinedValuePossible)continue;nValue=0}(0!==nValue||this.fNullIsValue)&&(nValue<0&&!this.fNegativeValuePossible||(nValueA[k]=nValue))}if(nValueA.length=this.szFieldsA.length,nValue100A=[],this.szField100A&&this.szField100A.length){if("$item$"==this.szField100A[0])nValue100A[0]=1;else for(k=0;k<this.szField100A.length;k++){var nValue=__scanValue(this.objTheme.dbRecords[j][this.objTheme.nField100IndexA[k]]);(0!==nValue||this.fNullIsValue)&&(nValue<0&&!this.fNegativeValuePossible||(nValue100A[k]=nValue))}if(nValue100A.length>0){let e=nValue100A[nValue100A.length-1];for(;nValue100A.length<this.szFieldsA.length;)nValue100A.push(e)}}var nValueSize=null;if(this.szSizeField&&"$item$"!=this.szSizeField){if(nValueSize=this.objTheme.dbRecords[j][this.objTheme.nSizeFieldIndex],nValueSize=this.valueMap&&this.valueMap[String(nValueSize)]||__scanValue(nValueSize),nValueSize=isFinite(nValueSize)&&!isNaN(nValueSize)?nValueSize:0,0===nValueSize)continue;if(nValueSize<0)continue}else nValueSize=1;var nValueAlpha=null;if(this.szAlphaField&&(nValueAlpha=__scanValue(this.objTheme.dbRecords[j][this.objTheme.nAlphaFieldIndex]),isNaN(nValueAlpha)&&(nValueAlpha=0)),this.szAlphaField100&&this.objTheme.nAlphaField100Index&&(nValueAlpha=100/__scanValue(this.objTheme.dbRecords[j][this.objTheme.nAlphaField100Index])*nValueAlpha,isNaN(nValueAlpha)&&(nValueAlpha=0)),szSelectionId=szId=this.getSelectionId(szThemeLayer,j),szSelectionId){if(this.objTheme.nFieldItemIndex>=0&&this.objTheme.nFieldItemIndex!=this.objTheme.nFieldSelectionIndex&&(szId=__mpap_decode_utf8(String(this.objTheme.dbRecords[j][this.objTheme.nFieldItemIndex])),this.fSelectionFieldToUpper&&(szId=String(szId).toUpperCase()),szId=szThemeLayer+"::"+szId),this.itemA[szId]){if(this.szFlag.match(/\bDOT\b/))continue;if(szId+="*"+Math.random(),this.itemA[szId])continue}this.addItemValues(szId,nValueA,nValue100A,nValueSize,nValueAlpha),this.itemA[szId]&&(this.szColorField&&(this.itemA[szId].szColor="$index$"==this.szColorField?j+1:__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nColorFieldIndex])),this.szSymbolField&&(this.itemA[szId].szSymbol="$index$"==this.szSymbolField?j+1:__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nSymbolFieldIndex])),this.szValueField&&(this.itemA[szId].szValue="$index$"==this.szValueField?j+1:__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nValueFieldIndex])),this.szTimeField&&(this.itemA[szId].szTime="$index$"==this.szTimeField?j+1:__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nTimeFieldIndex]),isNaN(this.itemA[szId].szTime)&&(this.itemA[szId].szTime=this.itemA[szId].szTime.replace(/ - /g,""))),this.szLabelField&&(this.itemA[szId].szLabel="$index$"==this.szLabelField?j+1:__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nLabelFieldIndex])),this.szTitleField&&(this.itemA[szId].szTitle=__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nTitleFieldIndex])),this.szSnippetField&&(this.itemA[szId].szSnippet=__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nSnippetFieldIndex])),this.itemA[szId].szSelectionId=szSelectionId||szId,this.szAggregationField&&(this.itemA[szId].szAggregation=__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nAggregationFieldIndex])),this.szXField&&(this.itemA[szId].nX=__scanValue(this.objTheme.dbRecords[j][this.objTheme.nXFieldIndex]),isNaN(this.itemA[szId].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[szId].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[szId].nX),this.nSumX+=this.itemA[szId].nXField)),this.szYField&&(this.itemA[szId].nY=__scanValue(this.objTheme.dbRecords[j][this.objTheme.nYFieldIndex]),isNaN(this.itemA[szId].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[szId].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[szId].nY),this.nSumY+=this.itemA[szId].nYField)),this.itemA[szId].dbIndex=j)}else this.nMissingLookupCount++}}else fDone=!1;return fDone?(_TRACE("coTable: "+this.nMissingLookupCount+" lookups missing"),_TRACE("coTable: "+(100-this.nMissingLookupCount/this.objTheme.dbRecords.length*100).toFixed(2)+" % mapped"),_TRACE("== done with js data loaded === "),this.fAnalyze=!0,!0):void 0},MapTheme.prototype.loadAndAggregateValuesOfTheme=function(szThemeLayer,nContinue){var a,i,j,k,szId,szSelectionId,szSelectionId2,nValueA,nValue100,nCountA;if(!nContinue){if(_TRACE("MapTheme.loadValuesOfTheme() ---\x3e "),this.fField100=!1,this.fNegativeValues=!1,this.__fMultiParts=this.szFlag.match(/CATEGORICAL/)&&!(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/COMPOSECOLOR/)||this.szFlag.match(/\bUSER\b/)||this.szFlag.match(/WAFFLE/)),this.__fClipToGeoBounds=!1,this.szFlag.match(/CLIPTOGEOBOUNDS/)&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<(this.nClipUpper||1e9)&&(this.__fClipToGeoBounds=!0),this.szUnit=(this.szUnits?"."==this.szUnits.substr(0,1)?"":" ":"")+(this.szUnits||""),this.objTheme=this.objThemesA[szThemeLayer],this.objTheme.nField100IndexA[0]&&this.objTheme.nField100IndexA[0]>0&&(this.fField100=!0),!(this.objTheme.dbTable&&szThemeLayer&&szThemeLayer.length))return!1;if(this.coTable){try{eval("this.objTheme.dbRecords = "+this.coTable+".records")}catch(e){eval("this.objTheme.dbRecords = "+this.coTable+"_records")}if(!this.objTheme.dbRecords)return displayMessage("Data "+this.coTable+" could not be loaded!",2e3,!0),!1}else try{eval("this.objTheme.dbRecords = "+szThemeLayer+".records")}catch(e){eval("this.objTheme.dbRecords = "+szThemeLayer+"_records")}if(_TRACE("coTable: "+this.objTheme.dbRecords.length+" records"),this.objTheme.nFieldSelectionIndexA.length||delete this.objTheme.nFieldSelectionIndexA,this.szFlag.match(/ZOOMTO/)){for(this.getSelectionId(szThemeLayer,0),j=0;j<this.objTheme.dbRecords.length;j++){if("UTM"==this.fSelection)ptPos=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone);else if("LatLon"==this.fSelection)ptPos=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_1]).replace(/\,/g,".")));else if("Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection){szId=this.objTheme.dbRecords[j][this.objTheme.nFieldSelectionIndex];var szMA=szId.match(positionRegExp);ptPos=map.Scale.getMapPositionOfLatLon(parseFloat(szMA[2]),parseFloat(szMA[1]))}else szId=this.objTheme.dbRecords[j][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&(szId=String(szId).toUpperCase()),ptPos=this.getNodePosition(szThemeLayer+"::"+szId);ptPos&&(this.itemA[szThemeLayer+"::"+String(ptPos.x)+","+String(ptPos.y)]={ptPos:ptPos})}this.zoomTo(),this.itemA=[],this.removeDefinitionFromFlag("ZOOMTO")}if(this.createChartGroup(map.Layer.objectGroup),"$item$"!=this.szFieldsA[0]&&!this.szFlag.match(/CATEGORICAL/)){var maxTest=Math.min(40,this.objTheme.dbRecords.length);for(j=0;j<maxTest;j++)if(this.objTheme.dbRecords[j])for(k=0;k<this.szFieldsA.length;k++){var nValue=this.objTheme.dbRecords[j][this.objTheme.nFieldIndexA[k]];if(__scanValue(nValue)!=parseFloat(nValue)){this.__fScanValue=!0,_TRACE("this.__fScanValue = "+this.__fScanValue),j=maxTest;break}}}if("$item$"==this.szSizeField&&(this.oldSizefield=this.szSizeField,this.szSizeField=null),this.nGridWidthPx){var maxDist=map.Scale.getDistanceInMeter(1e3,1e3,1e3+map.Scale.normalX(this.nGridWidthPx),1e3);this.nGridWidth=maxDist}if(this.nGridMatrix){var mapArea=map.Zoom.getBox(),maxDist=map.Scale.getDistanceInMeter(1e3,1e3,1e3+mapArea.width,1e3);this.nGridWidth=maxDist/(this.nGridMatrix||20)/map.Scale.nZoomScale}if(this.nGridWidthMap=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0,this.nGridWidth&&!this.nGridWidthMap&&(this.nGridWidthMap=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)*map.Scale.nZoomScale:0),!this.nGridWidthPx){this.nGridWidthMap=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)*map.Scale.nZoomScale:0;var nClip=Math.pow(10,Math.floor(Math.log10(1/map.Scale.nZoomScale)));this.nGridWidthMap=Math.round(this.nGridWidthMap*nClip)/nClip}if(this.dX=0,this.dY=0,this.szFlag.match(/FIXGRID/)&&(this.dX=map.Scale.mapCenter.x*map.Scale.nZoomScale,this.dY=map.Scale.mapCenter.y*map.Scale.nZoomScale),this.nGridOffsetX&&(this.dX-=this.nGridWidthMap/100*this.nGridOffsetX),this.nGridOffsetY&&(this.dY+=this.nGridWidthMap/100*this.nGridOffsetY),this.nHexaWidth=1.15*this.nGridWidthMap,this.nHexaHalf=1.15*this.nGridWidthMap/2,this.nHexa4th=this.nGridWidthMap/4,this.getSelectionId(szThemeLayer,0),this.aggregationCount=0,this.nMin=Number.MAX_VALUE,this.nMax=-Number.MAX_VALUE,this.nMinSize=Number.MAX_VALUE,this.nMaxSize=-Number.MAX_VALUE,this.nSumSize=0,this.nMinAlpha=Number.MAX_VALUE,this.nMaxAlpha=-Number.MAX_VALUE,this.nSumAlpha=0,this.__fExact)this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[];else for(i=0;i<this.szFieldsA.length;i++)this.nMinA[i]=Number.MAX_VALUE,this.nMaxA[i]=-Number.MAX_VALUE,this.nSumA[i]=0,this.nOrigMinA[i]=Number.MAX_VALUE,this.nOrigMaxA[i]=-Number.MAX_VALUE,this.nOrigSumA[i]=0,this.nMedianA[i]=0,this.nMeanA[i]=0;for(var v in this.nEmptyValuesA=[],this.szValuesA)this.nEmptyValuesA.push(0);if(this.szFlag.match(/DUMP/)&&(fObjectScaling?this.nChartGroupScale=(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:this.nChartGroupScale=(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,this.chartGroup=map.Dom.newGroup(map.Layer.objectGroup,this.szId+":chartgroup")),this.szWeightsA){if(this.szWeightsA.length&&this.szWeightsA.length!=this.szFieldsA.length){var lastWeight=this.szWeightsA[this.szWeightsA.length-1];for(i=this.szWeightsA.length;i<this.szFieldsA.length;i++)this.szWeightsA.push(lastWeight)}}else for(this.szWeightsA=[],i=0;i<this.szFieldsA.length;i++)this.szWeightsA.push(1)}(this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)&&(this.__fAggregate=!1);var mapGeoBounds=map.Zoom.getBoundsOfMapInGeoBounds(),zoomBox=map.Zoom.getBox(),__fVerbose=this.objTheme.dbRecords.length>2e5;for(j=nContinue||0;j<this.objTheme.dbRecords.length;j++){if(this.fCancel)return void displayMessage("Canceled by user",1e3,!0);if(__fVerbose&&j>(nContinue||0)&&j%5e4==0)return _TRACE(j),this.fContinueLoadAndAggregate=!0,this.continueIndex=j,this.szThemeLayer=szThemeLayer,displayMessage(__formatValue(j/this.objTheme.dbRecords.length*100,0)+"% "+map.Dictionary.getLocalText("aggregated")),displayProgressBar(j,this.objTheme.dbRecords.length,""),setTimeout((function(){map.Themes.executeContinue()}),10),!0;if(!this.objTheme.dbRecords[j]||this.fCheckRecordLength&&this.objTheme.dbRecords[j].length<this.objTheme.dbFields.length){this.nWrongRecordLengthCount++;continue}if(this.__fFilter&&!this.filterValues(j))continue;if(this.__fClipToGeoBounds&&"LatLon"==this.fSelection){var y=parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_0]).replace(/\,/g,".")),x=parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_1]).replace(/\,/g,"."));if(x<mapGeoBounds[0].x||x>mapGeoBounds[1].x||y<mapGeoBounds[0].y||y>mapGeoBounds[1].y)continue}var ptPos=null,newPos=null;if("UTM"==this.fSelection)ptPos=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[j][this.nSelection_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone),szId=ptPos?String(ptPos.x)+","+String(ptPos.y):"";else if("LatLon"==this.fSelection)szId=String(this.objTheme.dbRecords[j][this.nSelection_0]).replace(/\,/g,".")+","+String(this.objTheme.dbRecords[j][this.nSelection_1]).replace(/\,/g,"."),ptPos=this.getNodePosition(szThemeLayer+"::"+szId);else if("Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection){szId=this.objTheme.dbRecords[j][this.objTheme.nFieldSelectionIndex];var szMA=String(szId).match(positionRegExp);szMA&&(ptPos=map.Scale.getMapPositionOfLatLon(parseFloat(szMA[2]),parseFloat(szMA[1])))}else szId=this.objTheme.dbRecords[j][this.objTheme.nFieldSelectionIndex],this.fSelectionFieldToUpper&&(szId=String(szId).toUpperCase()),this.nSelectionFieldDigits&&(szId=("000000000000000"+szId).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToNumber&&(szId=String(Number(szId))),ptPos=this.getNodePosition(szThemeLayer+"::"+szId);if(this.szFlag.match(/DUMP/)){var shapeGroup=map.Dom.newGroup(this.chartGroup,this.szId+":"+szId+":chart");shapeGroup.fu.setMatrix([this.nChartGroupScale,0,0,this.nChartGroupScale,ptPos.x,ptPos.y]),map.Dom.newShape("circle",shapeGroup,0,0,map.Scale.normalX(3),"fill:blue;fill-opacity:0.2;stroke:none;")}if(!ptPos||isNaN(ptPos.x)||isNaN(ptPos.y)){this.fDataIncomplete=!0;continue}var ptOrigPos=ptPos,ptPos2=null,szId2=null;if(this.fSelection2){if("UTM"==this.fSelection2)ptPos2=map.Scale.getMapPositionOfUTM(parseFloat(String(this.objTheme.dbRecords[j][this.nSelection2_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[j][this.nSelection2_1]).replace(/\,/g,".")),this.szCRSDatum,this.szCRSUTMZone),szId2=ptPos2?String(ptPos2.x)+","+String(ptPos2.y):"";else if("LatLon"==this.fSelection2)ptPos2=map.Scale.getMapPositionOfLatLon(parseFloat(String(this.objTheme.dbRecords[j][this.nSelection2_0]).replace(/\,/g,".")),parseFloat(String(this.objTheme.dbRecords[j][this.nSelection2_1]).replace(/\,/g,"."))),szId2=ptPos?String(ptPos.x)+","+String(ptPos.y):"";else if("Point"==this.fSelection||"MultiPoint"==this.fSelection||"LineString"==this.fSelection||"MultiLineString"==this.fSelection){szId2=this.objTheme.dbRecords[j][this.objTheme.nFieldSelection2Index];var szMA=szId.match(positionRegExp);ptPos2=map.Scale.getMapPositionOfLatLon(parseFloat(szMA[2]),parseFloat(szMA[1]))}else{szId2=this.objTheme.dbRecords[j][this.objTheme.nFieldSelection2Index],this.nSelectionFieldDigits&&(szId2=("000000000000000"+szId).slice(-this.nSelectionFieldDigits)),this.fSelectionFieldToUpper&&(szId2=String(szId2).toUpperCase());for(var i=0;i<this.szThemesA.length;i++)ptPos2=ptPos2||this.getNodePosition(this.szThemesA[i]+"::"+szId2)}szId2=__mpap_decode_utf8(String(this.objTheme.dbRecords[j][this.objTheme.nFieldSelection2Index])),this.fSelectionFieldToUpper&&(szId2=String(szId2).toUpperCase()),szSelectionId2=szId2,szId2=szThemeLayer+"::"+szId2,this.themeNodesPosA[szId2]=ptPos2}if(this.__fClipToGeoBounds&&(ptPos.x<zoomBox.x||ptPos.x>zoomBox.x+zoomBox.width||ptPos.y<zoomBox.y||ptPos.y>zoomBox.y+zoomBox.height))continue;const e=e=>parseFloat(e.toString().replace(/\s/g,"")),t=(e,t)=>__scanValue(e[t]),a=(e,t,i,a)=>isNaN(e)?!!t&&0:!(0===e&&!a)&&!(e<0&&!i);let s=!1,n=new Array(this.szFieldsA.length).fill(null);if("$item$"===this.szFieldsA[0])n[0]=1;else if("$index$"===this.szFieldsA[0])n[0]=j+1;else for(k=0;k<this.szFieldsA.length;k++){var nValue=this.objTheme.dbRecords[j][this.objTheme.nFieldIndexA[k]];if(nValue=this.valueMap&&this.valueMap[String(nValue)]||nValue,this.__fExact?(nValue=this.getStringValueIndex(String(nValue)),this.exactCountA[nValue-1]=(this.exactCountA[nValue-1]||0)+1):nValue=this.__fScanValue?__scanValue(nValue)*(this.szWeightsA[k]||1):parseFloat(nValue)*(this.szWeightsA[k]||1),isNaN(nValue)){if(!this.fUndefinedValuePossible){s=!0;continue}nValue=0}0!==nValue||this.fNullIsValue?nValue<0&&!this.fNegativeValuePossible?s=!0:n[k]=nValue:s=!0}let l=this.szField100A?new Array(this.szField100A.length).fill(null):[];if(this.szField100A&&this.szField100A.length)if("$item$"===this.szField100A[0])l[0]=1;else if("$index$"===this.szField100A[0])l[0]=j+1;else{for(let e=0;e<this.szField100A.length;e++){const i=t(this.objTheme.dbRecords[j],this.objTheme.nField100IndexA[e]);if(!a(i,!1,!1,!1)){s=!0;break}l[e]=i}if(l.length>0){let e=l[l.length-1];for(;l.length<this.szFieldsA.length;)l.push(e)}}let h=this.szSizeField&&"$item$"!==this.szSizeField?__scanValue(this.objTheme.dbRecords[j][this.objTheme.nSizeFieldIndex]):1;a(h,!1,this.fNegativeValuePossible,this.fNullIsValue)||(s=!0);const o=this.szAlphaField?__scanValue(this.objTheme.dbRecords[j][this.objTheme.nAlphaFieldIndex]):null;let r=this.szTitleField?this.objTheme.dbRecords[j][this.objTheme.nTitleFieldIndex]:null;const m=this.szColorField?"$index$"===this.szColorField?j+1:__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nColorFieldIndex]):null,p=this.szTimeField?"$index$"===this.szTimeField?j+1:__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nTimeFieldIndex]).replace(/ - /g," "):null,c=this.szXField?__scanValue(this.objTheme.dbRecords[j][this.objTheme.nXFieldIndex]):null,u=this.szYField?__scanValue(this.objTheme.dbRecords[j][this.objTheme.nYFieldIndex]):null,d=this.szValueField?this.objTheme.dbRecords[j][this.objTheme.nValueFieldIndex]:null;if(this.__fAggregate&&this.nGridWidthMap){const e=this.szFlag.match(/\bRECT\b/),t=this.dX||this.dY;if(e)ptPos=new point(Math.round((ptPos.x+(t?this.dX:0))/this.nGridWidthMap)*this.nGridWidthMap-(t?this.dX:0),Math.round((ptPos.y+(t?this.dY:0))/this.nGridWidthMap)*this.nGridWidthMap-(t?this.dY:0));else{if(this.szFlag.match(/PLOTY/)){var yr=Math.round(ptPos.y/this.nGridWidthMap),dx=yr%2?this.nHexaHalf:0;newPos=new point(Math.round((ptPos.x+dx)/this.nHexaWidth)*this.nHexaWidth-dx,yr*this.nGridWidthMap)}else{var xr=Math.round(ptPos.x/this.nGridWidthMap),dy=xr%2?this.nHexaHalf:0;newPos=new point(xr*this.nGridWidthMap,Math.round((ptPos.y+dy)/this.nHexaWidth)*this.nHexaWidth-dy)}if(Math.abs(newPos.x-ptPos.x)>this.nHexa4th){var ptPosA=[],nDistA=[];dy=0===dy?this.nHexaHalf:0,newPos.x>ptPos.x?(ptPosA[0]=new point(newPos.x-this.nGridWidthMap,newPos.y-this.nHexaHalf),ptPosA[1]=new point(newPos.x-this.nGridWidthMap,newPos.y+this.nHexaHalf)):(ptPosA[0]=new point(newPos.x+this.nGridWidthMap,newPos.y-this.nHexaHalf),ptPosA[1]=new point(newPos.x+this.nGridWidthMap,newPos.y+this.nHexaHalf)),nDistA[0]=Math.sqrt(Math.pow(ptPosA[0].x-ptPos.x,2)+Math.pow(ptPosA[0].y-ptPos.y,2)),nDistA[1]=Math.sqrt(Math.pow(ptPosA[1].x-ptPos.x,2)+Math.pow(ptPosA[1].y-ptPos.y,2)),nDistA[3]=Math.sqrt(Math.pow(newPos.x-ptPos.x,2)+Math.pow(newPos.y-ptPos.y,2)),nDistA[0]<nDistA[3]?newPos=new point(Math.round(ptPosA[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ptPosA[0].y+dy)/this.nHexaWidth)*this.nHexaWidth-dy):nDistA[1]<nDistA[3]&&(newPos=new point(Math.round(ptPosA[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ptPosA[1].y+dy)/this.nHexaWidth)*this.nHexaWidth-dy))}ptPos=newPos}}if(this.__fAggregate&&this.nGridWidthMap&&ptPos2&&!this.szFlag.match(/\bORIGIN\b/)){if(this.szFlag.match(/\bRECT\b/))ptPos2=this.dX||this.dY?new point(Math.round((ptPos2.x+this.dX)/this.nGridWidthMap)*this.nGridWidthMap-this.dX,Math.round((ptPos2.y+this.dY)/this.nGridWidthMap)*this.nGridWidthMap-this.dY):new point(Math.round(ptPos2.x/this.nGridWidthMap)*this.nGridWidthMap,Math.round(ptPos2.y/this.nGridWidthMap)*this.nGridWidthMap);else{if(this.szFlag.match(/PLOTY/)){var yr=Math.round(ptPos2.y/this.nGridWidthMap),dx=yr%2?this.nHexaHalf:0;newPos=new point(Math.round((ptPos2.x+dx)/this.nHexaWidth)*this.nHexaWidth-dx,yr*this.nGridWidthMap)}else{var xr=Math.round(ptPos2.x/this.nGridWidthMap),dy=xr%2?this.nHexaHalf:0;newPos=new point(xr*this.nGridWidthMap,Math.round((ptPos2.y+dy)/this.nHexaWidth)*this.nHexaWidth-dy)}if(Math.abs(newPos.x-ptPos2.x)>this.nHexa4th){var ptPosA=[],nDistA=[];dy=0===dy?this.nHexaHalf:0,newPos.x>ptPos2.x?(ptPosA[0]=new point(newPos.x-this.nGridWidthMap,newPos.y-this.nHexaHalf),ptPosA[1]=new point(newPos.x-this.nGridWidthMap,newPos.y+this.nHexaHalf)):(ptPosA[0]=new point(newPos.x+this.nGridWidthMap,newPos.y-this.nHexaHalf),ptPosA[1]=new point(newPos.x+this.nGridWidthMap,newPos.y+this.nHexaHalf)),nDistA[0]=Math.sqrt(Math.pow(ptPosA[0].x-ptPos2.x,2)+Math.pow(ptPosA[0].y-ptPos2.y,2)),nDistA[1]=Math.sqrt(Math.pow(ptPosA[1].x-ptPos2.x,2)+Math.pow(ptPosA[1].y-ptPos2.y,2)),nDistA[3]=Math.sqrt(Math.pow(newPos.x-ptPos2.x,2)+Math.pow(newPos.y-ptPos2.y,2)),nDistA[0]<nDistA[3]?newPos=new point(Math.round(ptPosA[0].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ptPosA[0].y+dy)/this.nHexaWidth)*this.nHexaWidth-dy):nDistA[1]<nDistA[3]&&(newPos=new point(Math.round(ptPosA[1].x/this.nGridWidthMap)*this.nGridWidthMap,Math.round((ptPosA[1].y+dy)/this.nHexaWidth)*this.nHexaWidth-dy))}ptPos2=newPos}this.themeNodesPosA[szId2]=ptPos2}if(szSelectionId=szId,this.szAggregationField){var szAgId=__mpap_decode_utf8(this.objTheme.dbRecords[j][this.objTheme.nAggregationFieldIndex]);szId=szThemeLayer+"::"+szAgId,"$aggregation$"==this.szTitleField&&(r=szAgId)}else szId=szThemeLayer+"::"+String(ptPos.x)+","+String(ptPos.y)+(this.__fMultiParts?","+String(nValue):""),this.themeNodesPosA[szId]=ptPos;if(ptPos2&&this.szFlag.match(/VECTOR/)&&(szId+="&"+String(ptPos2.x)+","+String(ptPos2.y),this.themeNodesPosA[szId]=ptPos2),this.__fAggregate){let e=this.itemA[szId];if(e){if(s)continue;let t=0;if(this.__fMultiParts)t=h;else if(this.__fExact){const i=n[0]-1;if(isNaN(i))continue;e.nValuesA[i]=this.__fMax?Math.max(e.nValuesA[i]||0,h):(e.nValuesA[i]||0)+h,e.nCountA[i]=(e.nCountA[i]||0)+1,t=h}else{const i=this.szFieldsA.length;for(let a=0;a<i;a++){const i=n[a]||0;e.nValuesA[a]=this.__fMax?Math.max(e.nValuesA[a],i):e.nValuesA[a]+i,e.nValue100A[a]=this.__fMax?Math.max(e.nValue100A[a],l[a]):e.nValue100A[a]+l[a],t=Math.max(t,i)}}this.__fMax?(e.nSize=Math.max(e.nSize,h||(this.objTheme.nSizeFieldIndex?0:t)),e.nAlpha=Math.max(e.nAlpha,o||1),e.ptPosA=[ptOrigPos],e.szTitle=r,e.dbIndexA.push(j)):(e.nSize+=Math.abs(h||(this.objTheme.nSizeFieldIndex?0:t)),e.nAlpha+=o||1,e.ptPosA.push(ptOrigPos),e.nCount++,e.dbIndexA.push(j),r&&r===e.szTitle||(e.szTitle=this.szAggregation+" of "+e.nCount+" items"))}else{if(s)continue;this.aggregationCount++;let e=0;if(this.__fMultiParts)e=h;else if(this.__fExact){const t=n[0]-1;if(isNaN(t))continue;n=this.nEmptyValuesA.slice(0),n[t]=h,e=h,nCountA=this.nEmptyValuesA.slice(0),nCountA[t]=1}else for(let t=0;t<this.szFieldsA.length;t++)e=Math.max(e,n[t]||0);const t=this.itemA[szId]={nOrigValuesA:[],nValuesA:n,nValue100A:l,nValueSum:0,nCount:1,nCountA:nCountA,szTitle:r,szSelectionId:String(szSelectionId),szSelectionId2:String(szSelectionId2),nSize:Math.abs(h||(this.objTheme.nSizeFieldIndex?0:e)),nAlpha:o||1,szColor:m,szTime:p,szValue:d,dbIndexA:[j],ptPos:ptPos,ptPos2:ptPos2,ptPosA:[ptOrigPos]};this.nCount++}}else this.itemA[szId]&&(szId+="*"+Math.random()),this.aggregationCount++,this.itemA[szId]={nOrigValuesA:[],nValuesA:n,nValue100A:l,nValueSum:0},this.itemA[szId].szSelectionId=String(szThemeLayer+"::"+szSelectionId),this.itemA[szId].szSelectionId2=String(szThemeLayer+"::"+szSelectionId2),this.itemA[szId].nSize=h||0,this.itemA[szId].ptPos=ptPos,this.itemA[szId].ptPos2=ptPos2,this.itemA[szId].dbIndexA=[j],this.itemA[szId].nX=c,this.itemA[szId].nY=u,this.itemA[szId].szColor=m,this.itemA[szId].szTime=p,this.itemA[szId].szValue=d,this.nCount++}if(this.objTheme.nField100IndexA.length>0)if(this.fField100=!0,this.szFlag.match(/DIFFERENCE/)&&1==this.itemA[a]?.nValuesA.length&&!this.szFlag.match(/RELATIVE/))for(a in this.itemA)for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValuesA[k]=this.itemA[a].nValuesA[k]-this.itemA[a].nValue100A[k];else if(this.szFlag.match(/FRACTION/))for(a in this.itemA)for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValuesA[k]=this.itemA[a].nValuesA[k]/this.itemA[a].nValue100A[k]*(this.nFractionScale||1);else if(this.szFlag.match(/PRODUCT/))for(a in this.itemA)for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValuesA[k]*=this.itemA[a].nValue100A[k];else if(this.szFlag.match(/CALCVAL/))for(a in this.itemA)for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValuesA[k]=Math.round(this.itemA[a].nValuesA[k]*this.itemA[a].nValue100A[k]/100);else if(this.szFlag.match(/PERMILLE/))for(a in this.itemA)for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValuesA[k]*=1e3/this.itemA[a].nValue100A[k];else for(a in this.itemA)for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValue100A[k]>(this.nField100Min||0)?(this.itemA[a].nValuesA[k]*=100/this.itemA[a].nValue100A[k],this.itemA[a].nValuesA[k]>0&&this.szFlag.match(/RELATIVE/)?this.itemA[a].nValuesA[k]-=100:this.itemA[a].nValuesA[k]>0&&this.szFlag.match(/INVERT/)&&(this.itemA[a].nValuesA[k]=100-nValue)):this.itemA[a].nValuesA[k]=0;else if(this.__fAggregate&&this.szFlag.match(/MEAN/))if(this.__fMultiParts)for(a in this.itemA)this.itemA[a].nSize/=this.itemA[a].nCount;else for(a in this.itemA){if(this.itemA[a].nCountA)for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValuesA[k]/=this.itemA[a].nCountA[k]||1;else for(k=0;k<this.itemA[a].nValuesA.length;k++)this.itemA[a].nValuesA[k]/=this.itemA[a].nCount;this.szFlag.match(/SIZESUM/)||(this.itemA[a].nSize/=this.itemA[a].nCount)}if(this.szFlag.match(/DIFFERENCE/))for(var a in this.itemA){for(var i=0;i<this.itemA[a].nValuesA.length;i++)if(i<this.itemA[a].nValuesA.length-1){var nTemp=this.itemA[a].nValuesA[i];this.itemA[a].nValuesA[i]=this.itemA[a].nValuesA[i+1]-this.itemA[a].nValuesA[i],this.szFlag.match(/RELATIVE/)&&(this.itemA[a].nValuesA[i]=nTemp>(this.nField100Min||0)?100/nTemp*this.itemA[a].nValuesA[i]:0)}else this.szFlag.match(/STACKED/)||(this.itemA[a].nValuesA[i]=0);this.itemA[a].nValuesA.pop()}if(this.szFlag.match(/AUTO100/))if(this.nGridX)for(var a in this.itemA){var i=0;do{for(var nValue100=0,ii=0;ii<this.nGridX;ii++)nValue100+=this.itemA[a].nValuesA[i+ii]||0;for(var ii=0;ii<this.nGridX;ii++)this.itemA[a].nValuesA[i+ii]/=nValue100/100;i+=this.nGridX}while(i<this.itemA[a].nValuesA.length)}else for(var a in this.itemA){for(var nValue100=0,i=0;i<this.itemA[a].nValuesA.length;i++)nValue100+=this.itemA[a].nValuesA[i]||0;for(var i=0;i<this.itemA[a].nValuesA.length;i++)this.itemA[a].nValue100A[i]=nValue100;this.fField100=!0;for(var i=0;i<this.itemA[a].nValuesA.length;i++)this.itemA[a].nValuesA[i]/=this.itemA[a].nValue100A[i]/100}if(this.szFlag.match(/RELOCATE/)||this.szAggregationField)for(a in this.itemA)if(this.itemA[a].ptPosA){for(var x=0,y=0,p=0;p<this.itemA[a].ptPosA.length;p++)x+=this.itemA[a].ptPosA[p].x,y+=this.itemA[a].ptPosA[p].y;this.itemA[a].ptPos={x:x/this.itemA[a].nCount,y:y/this.itemA[a].nCount}}if(this.szMinAggregation){var nCount=0,nMediaCount=0;for(a in this.itemA)nMediaCount+=this.itemA[a].nCount,nCount++;for(a in nMediaCount/=nCount,this.itemA)this.itemA[a].nCount&&this.itemA[a].nCount<(this.nMinAggregation||Math.sqrt(nMediaCount)-1)&&delete this.itemA[a]}if(this.nMin=Number.MAX_VALUE,this.nMax=-Number.MAX_VALUE,this.nMinA=[],this.nMaxA=[],this.__fExact||this.szSizeField)for(a in this.itemA)isFinite(this.itemA[a].nSize)&&!isNaN(this.itemA[a].nSize)&&(this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[a].nSize),this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[a].nSize),this.nSumSize+=this.itemA[a].nSize);else for(a in this.itemA)for(var v=0;v<this.itemA[a].nValuesA.length;v++)isFinite(this.itemA[a].nValuesA[v])&&!isNaN(this.itemA[a].nValuesA[v])&&(this.nMin=Math.min(this.itemA[a].nValuesA[v],this.nMin),this.nMax=Math.max(this.itemA[a].nValuesA[v],this.nMax));for(a in this.itemA)for(var v=0;v<this.itemA[a].nValuesA.length;v++)isFinite(this.itemA[a].nValuesA[v])&&!isNaN(this.itemA[a].nValuesA[v])?(this.nMinA[v]=Math.min(this.itemA[a].nValuesA[v],this.nMinA[v]||Number.MAX_VALUE),this.nMaxA[v]=Math.max(this.itemA[a].nValuesA[v],this.nMaxA[v]||-Number.MAX_VALUE),this.nSumA[v]+=this.itemA[a].nValuesA[v]):(this.nMinA[v]=this.nMinA[v]||Number.MAX_VALUE,this.nMaxA[v]=this.nMaxA[v]||-Number.MAX_VALUE);if(this.szAlphaField)for(a in this.itemA)isFinite(this.itemA[a].nAlpha)&&!isNaN(this.itemA[a].nAlpha)&&(this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[a].nAlpha),this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[a].nAlpha),this.nSumAlpha+=this.itemA[a].nAlpha);if(this.szSizeField)for(a in this.itemA)isFinite(this.itemA[a].nSize)&&!isNaN(this.itemA[a].nSize)&&(this.nMinSize=Math.min(this.nMinSize,this.itemA[a].nSize),this.nMaxSize=Math.max(this.nMaxSize,this.itemA[a].nSize),this.nSumSize+=this.itemA[a].nSize);if(this.szXField)for(a in this.itemA)isNaN(this.itemA[a].nX)||(this.nMinX=Math.min(this.nMinX,this.itemA[a].nX),this.nMaxX=Math.max(this.nMaxX,this.itemA[a].nX),this.nSumX+=this.itemA[a].nX);if(this.szYField)for(a in this.itemA)isNaN(this.itemA[a].nY)||(this.nMinY=Math.min(this.nMinY,this.itemA[a].nY),this.nMaxY=Math.max(this.nMaxY,this.itemA[a].nY),this.nSumY+=this.itemA[a].nY);if(this.szValueField&&this.szSizeField==this.szValueField)for(a in this.itemA)this.itemA[a].szValue=String(this.itemA[a].nSize);return this.oldSizefield&&(this.szSizeField=this.oldSizefield,this.oldSizeField=null),_TRACE("aggregated: "+this.aggregationCount),_TRACE("coTable: "+this.nMissingLookupCount+" lookups missing"),_TRACE("coTable: "+(100-this.nMissingLookupCount/this.objTheme.dbRecords.length*100).toFixed(2)+" % mapped"),_TRACE("== done with js data loaded === "),_LOG("loadAndAggregateValuesOfTheme === E N D"),this.fAnalyze=!0,!0},MapTheme.prototype.loadTableFromMap=function(){var e,t,i;_TRACE("== MapTheme.loadTable()===> ");var a={table:{fields:0,records:0},fields:[],records:[]},s=SVGDocument.getElementById(this.szThemesA[0]);if(null==s){var n=map.Tiles.getTileNodes(this.szThemesA[0]);n&&(s=n[0])}if(!s)return _TRACE(this.szThemes+"- not found"),this.szThemes="",null;var l=s.getAttributeNS(szMapNs,"info");if(null==l||""===l)return this.szThemes="",null;var h=l.split("|");for(e in h.push("FeatureId"),h)a.fields.push({id:h[e]}),a.table.fields++;for(var o=[],r=[],m=0;m<this.szThemesA.length;m++){var p=this.szThemesA[m];this.objTheme=this.objThemesA[p];var c=map.Layer.getLayerObj(this.szThemesA[m]);if(null==c)return alert("MapTheme error: no layer like '"+this.szThemesA[m]+"'"),!1;if(c.szFlag.match(/tiled/)){r[0]=map.Scale.canvasNode,r.length=1,this.fDataIncomplete=!map.Tiles.allTilesLoaded();break}r[r.length]=SVGDocument.getElementById(c.szName)}for(var u=!0,d=0;d<r.length;d++){var A=r[d].getElementsByTagName("path"),S=r[d].getElementsByTagName("use"),g=r[d].getElementsByTagName("circle");for(e=0;e<A.length;e++)o[o.length]=A.item(e);for(e=0;e<S.length;e++)o[o.length]=S.item(e);for(e=0;e<g.length;e++)o[o.length]=g.item(e)}if(0===o.length){u=!1;for(d=0;d<r.length;d++){A=r[d].getElementsByTagName("g");for(e=0;e<A.length;e++)o[o.length]=A.item(e)}}for(e=0;e<o.length;e++)if(1==o[e].nodeType&&o[e].hasAttributeNS(szMapNs,"info")){var z=-1;if((i=u?o[e].parentNode.getAttributeNS(null,"id"):o[e].getAttributeNS(null,"id"))&&0!==i.length){var f=map.Tiles.getMasterId(i).split(":")[0];for(t=0;t<this.szThemesA.length;t++)f==this.szThemesA[t]&&(z=t)}var T=map.Tiles.getMasterId(i);if(this.itemA[T])continue;if(z>=0){var x=o[e].getAttributeNS(szMapNs,"info").split("|");x.push(T.split("::")[1]),a.records.push(x),a.table.records++,this.itemA[T]=1}}return this.itemA=[],_TRACE("== done from shapes === "),a},MapTheme.prototype.aggregateValues=function(){if(!this.__fAggregateOnLoad&&(this.szFlag.match(/AGGREGATE/)||this.szFlag.match(/GROUP/))&&!(this.szAggregationUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nAggregationUpper||this.szAggregationLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nAggregationLower)){_TRACE("MapTheme.aggregateValues() ---\x3e ");var uniqueTopicA=[],uniqueTopicCount=[],uniqueTopicValue=[],uniqueTopicPos=[],uniqueTopicTitleCount=[],firstItemId=null,nUniqueTopics=0;if(this.nTopicsSkipedByZeroExclusion=0,this.nGridWidthPx){var maxDist=map.Scale.getDistanceInMeter(1e3,1e3,1e3+map.Scale.normalX(this.nGridWidthPx),1e3);this.nGridWidth=maxDist}if(this.nGridMatrix){var mapArea=map.Zoom.getBox(),maxDist=map.Scale.getDistanceInMeter(1e3,1e3,1e3+mapArea.width,1e3);this.nGridWidth=maxDist/(this.nGridMatrix||20)/map.Scale.nZoomScale}var nGridWidthMap=this.nGridWidth?Math.round(map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/20)*map.Scale.nZoomScale*20:0,getFirstKey=function(e){for(var t in e)return t};firstItemId=getFirstKey(this.itemA);var uI="undefined",szLayer=this.itemA[firstItemId].szSelectionId.split("::")[0],newPos=null,nHexaWidth=1.15*nGridWidthMap,nHexaHalf=1.15*nGridWidthMap/2,nHexa4th=nGridWidthMap/4;if(this.szAggregationField)for(var a in this.itemA){var uI="undefined";firstItemId=firstItemId||a,uI=this.itemA[a].szAggregation,uniqueTopicA[uI]||(uniqueTopicA[uI]=[],uniqueTopicPos[uI]=new point(0,0),uniqueTopicCount[uI]=0,uniqueTopicValue[uI]=0,nUniqueTopics++),uniqueTopicA[uI][a]=this.itemA[a],uniqueTopicA[uI][a].nSize=this.itemA[a].nSize||1,uniqueTopicA[uI][a].szTitle=this.itemA[a].szTitle||uI,uniqueTopicValue[uI]+=uniqueTopicA[uI][a].nSize;var ptPos=this.getNodePosition(this.itemA[a].szSelectionId);ptPos&&(uniqueTopicPos[uI].x+=ptPos.x,uniqueTopicPos[uI].y+=ptPos.y,uniqueTopicCount[uI]++)}else if(this.nGridWidth)for(a in this.itemA){var ptPos=this.getNodePosition(this.itemA[a].szSelectionId);if(ptPos){if(this.szFlag.match(/\bRECT\b/))if(this.szFlag.match(/FIXGRID/)){var dX=map.Scale.mapCenter.x*map.Scale.nZoomScale,dY=map.Scale.mapCenter.y*map.Scale.nZoomScale;newPos=new point(Math.round((ptPos.x+dX)/nGridWidthMap)*nGridWidthMap-dX,Math.round((ptPos.y+dY)/nGridWidthMap)*nGridWidthMap-dY)}else newPos=new point(Math.round(ptPos.x/nGridWidthMap)*nGridWidthMap,Math.round(ptPos.y/nGridWidthMap)*nGridWidthMap);else{if(this.szFlag.match(/PLOTY/)){var yr=Math.round(ptPos.y/nGridWidthMap),dx=yr%2?nHexaHalf:0;newPos=new point(Math.round((ptPos.x+dx)/nHexaWidth)*nHexaWidth-dx,yr*nGridWidthMap)}else{var xr=Math.round(ptPos.x/nGridWidthMap),dy=xr%2?nHexaHalf:0;newPos=new point(xr*nGridWidthMap,Math.round((ptPos.y+dy)/nHexaWidth)*nHexaWidth-dy)}if(Math.abs(x-ptPos.x)>nHexa4th){var ptPosA=[],nDistA=[];dy=0===dy?nHexaHalf:0,x>ptPos.x?(ptPosA[0]=new point(newPos.x-nGridWidthMap,newPos.y-nHexaHalf),ptPosA[1]=new point(newPos.x-nGridWidthMap,newPos.y+nHexaHalf)):(ptPosA[0]=new point(newPos.x+nGridWidthMap,newPos.y-nHexaHalf),ptPosA[1]=new point(newPos.x+nGridWidthMap,newPos.y+nHexaHalf)),nDistA[0]=Math.sqrt(Math.pow(ptPosA[0].x-ptPos.x,2)+Math.pow(ptPosA[0].y-ptPos.y,2)),nDistA[1]=Math.sqrt(Math.pow(ptPosA[1].x-ptPos.x,2)+Math.pow(ptPosA[1].y-ptPos.y,2)),nDistA[3]=Math.sqrt(Math.pow(newPos.x-ptPos.x,2)+Math.pow(newPos.y-ptPos.y,2)),nDistA[0]<nDistA[3]?newPos=new point(Math.round(ptPosA[0].x/nGridWidthMap)*nGridWidthMap,Math.round((ptPosA[0].y+dy)/nHexaWidth)*nHexaWidth-dy):nDistA[1]<nDistA[3]&&(newPos=new point(Math.round(ptPosA[1].x/nGridWidthMap)*nGridWidthMap,Math.round((ptPosA[1].y+dy)/nHexaWidth)*nHexaWidth-dy))}}uI=szLayer+"::"+String(newPos.x)+","+String(newPos.y),this.themeNodesPosA[a]=newPos,this.themeNodesPosA[uI]=newPos,uniqueTopicA[uI]||(uniqueTopicA[uI]=[],uniqueTopicPos[uI]=new point(0,0),uniqueTopicCount[uI]=0,nUniqueTopics++),uniqueTopicA[uI][a]=this.itemA[a],uniqueTopicA[uI][a].nSize=this.itemA[a].nSize||1,uniqueTopicPos[uI].x+=ptPos.x,uniqueTopicPos[uI].y+=ptPos.y,uniqueTopicCount[uI]++}else uniqueTopicA[uI]||(uniqueTopicA[uI]=[],uniqueTopicPos[uI]=new point(0,0),uniqueTopicCount[uI]=0,this.fDataIncomplete=fTilesLoaded,nUniqueTopics++),uniqueTopicA[uI][a]=this.itemA[a],uniqueTopicA[uI][a].nSize=this.itemA[a].nSize||1,uniqueTopicCount[uI]++,this.fDataIncomplete=!0}else for(a in this.itemA){var ptPos=this.getNodePosition(this.itemA[a].szSelectionId);ptPos?(uI=this.itemA[a].szSelectionId,uniqueTopicA[uI]||(uniqueTopicA[uI]=[],uniqueTopicPos[uI]=new point(0,0),uniqueTopicCount[uI]=0,nUniqueTopics++),uniqueTopicA[uI][a]=this.itemA[a],uniqueTopicA[uI][a].nSize=this.itemA[a].nSize||1,uniqueTopicPos[uI].x+=ptPos.x,uniqueTopicPos[uI].y+=ptPos.y,uniqueTopicCount[uI]++):(uniqueTopicA[uI]||(uniqueTopicA[uI]=[],uniqueTopicPos[uI]=new point(0,0),uniqueTopicCount[uI]=0,this.fDataIncomplete=fTilesLoaded,nUniqueTopics++),uniqueTopicA[uI][a]=this.itemA[a],uniqueTopicA[uI][a].nSize=this.itemA[a].nSize||1,uniqueTopicCount[uI]++,this.fDataIncomplete=!0)}if(_TRACE("== "+nUniqueTopics+" unique positions found == "),this.szFlag.match(/GROUP/)){for(var t in this.itemA=[],uniqueTopicA){var itemA=uniqueTopicA[t];for(a in this.indexA=[],itemA)this.indexA.push(a);for(var sortA=[],i=0;i<this.indexA.length;i++){var nValue=itemA[this.indexA[i]].nValuesA[0];sortA.push({a:this.indexA[i],y:nValue})}for(i in this.szFlag.match(/\bUP\b/)?sortA.sort(this.sortDownChartObjectsCompare):sortA.sort(this.sortUpChartObjectsCompare),sortA)itemA[sortA[i].a].szSelectionId=t,this.itemA[t+"*"+Math.random()]=itemA[sortA[i].a]}_TRACE("== aggregation done == ")}else{if(this.szFlag.match(/CATEGORICAL/))for(var t in _TRACE("== aggregate by CATEGORICAL value == "),this.szSizeField||(this.szSizeField="$aggregation$"),uniqueTopicA){var itemA=uniqueTopicA[t];uniqueTopicTitleCount[t]=0;var uniqueTitle=[],exactItemA=[];for(a in itemA)uniqueTitle[itemA[a].szTitle]=1,uniqueTopicTitleCount[t]++,exactItemA[itemA[a].nValuesA[0]]||(exactItemA[itemA[a].nValuesA[0]]={itemA:[]}),exactItemA[itemA[a].nValuesA[0]].itemA[a]=itemA[a];for(var v in uniqueTopicA[t]=[],exactItemA){var itemX=exactItemA[v].itemA,tItem=null;for(a in itemX)if(null==tItem)tItem=uniqueTopicA[t][a]=itemX[a],tItem.nCount=1,tItem.dbIndexA=tItem.dbIndexA||[],tItem.nSize=tItem.nSize||1,tItem.nAlpha=tItem.nAlpha||1;else{tItem.nCount+=1;for(var v=0;v<itemA[a].nValue100A.length;v++)tItem.nValue100A[v]+=itemA[a].nValue100A[v]||0;tItem.nSize+=itemX[a].nSize||1,tItem.nAlpha+=itemX[a].nAlpha||1,tItem.szValue=String(tItem.nSize),nGridWidthMap&&!this.szAggregationField&&(!tItem.szTitle||tItem.nCount>3)&&(tItem.szTitle="("+tItem.nCount+")"),tItem.dbIndexA.push(itemX[a].dbIndex)}}}else for(t in _TRACE("== aggregate the values == "),uniqueTopicA){var itemA=uniqueTopicA[t];if(!this.szFlag.match(/SUM/)&&!this.szFlag.match(/ZEROISVALUE/)){var skipA=[],nItems=0;for(a in itemA)if(nItems++,itemA[a])for(var v=0;v<itemA[a].nValuesA.length;v++)if(0===itemA[a].nOrigValuesA[v]){skipA[a]=a;break}if(nItems>1)for(a in skipA)delete itemA[a],this.nTopicsSkipedByZeroExclusion++}uniqueTopicA[t]=[];var tItem=null;for(a in itemA)if(null==tItem)tItem=uniqueTopicA[t][a]=itemA[a],tItem.nCount=1,tItem.dbIndexA=tItem.dbIndexA||[],tItem.nSize=tItem.nSize||1,tItem.nAlpha=tItem.nAlpha||1;else{for(var v=0;v<itemA[a].nValuesA.length;v++)tItem.nValuesA[v]+=itemA[a].nValuesA[v]||0,tItem.nOrigValuesA[v]+=itemA[a].nOrigValuesA[v]||0;tItem.nCount+=1;for(var v=0;v<itemA[a].nValue100A.length;v++)tItem.nValue100A[v]+=itemA[a].nValue100A[v]||0;tItem.nSize+=itemA[a].nSize||1,tItem.nAlpha+=itemA[a].nAlpha||1,tItem.szValue=String(tItem.nSize),tItem.szTitle="("+this.formatValue(tItem.nCount,0)+")",tItem.dbIndexA.push(itemA[a].dbIndex)}}if(_TRACE("== values aggregated by unique topics == "),this.szAggregationField||this.szFlag.match(/RELOCATE/)){var centerPos=new point(0,0),low=0,left=1e6,centerCount=0,chartCount=0;for(t in uniqueTopicA)left=Math.min(left,uniqueTopicPos[t].x/uniqueTopicCount[t]),low=Math.max(low,uniqueTopicPos[t].y/uniqueTopicCount[t]),centerPos.x+=uniqueTopicPos[t].x*(uniqueTopicValue[t]||1),centerPos.y+=uniqueTopicPos[t].y*(uniqueTopicValue[t]||1),centerCount+=uniqueTopicCount[t]*(uniqueTopicValue[t]||1),chartCount+=1;centerPos.x/=centerCount,centerPos.y/=centerCount;var leftPos=new point(left,centerPos.y),lowPos=new point(centerPos.x,low)}_TRACE("== aggregation center set == "),this.nMin=Number.MAX_VALUE,this.nMax=-Number.MAX_VALUE,this.nMinSize=Number.MAX_VALUE,this.nMaxSize=0,this.nSumSize=0,this.nMinAlpha=Number.MAX_VALUE,this.nMaxAlpha=0,this.nSumAlpha=0,this.szFlag.match(/CATEGORICAL/)&&(this.nMinA=[],this.nMaxA=[],this.nSumA=[],this.nOrigMinA=[],this.nOrigMaxA=[],this.nOrigSumA=[],this.nMedianA=[],this.nMeanA=[],this.nCountA=[]);for(var szExactSize="[",nExactSize=this.nStringToValue-1,i=0;i<nExactSize;i++)szExactSize+="0,";szExactSize+="]",this.itemA=[];var nUnique=0,nParts=Math.max(this.szRangesA?this.szRangesA.length:0,this.szExactA?this.szExactA.length:0)-(this.szFlag.match(/CATEGORICAL/)?0:1);_TRACE("== make aggregated topics == ");var fMultiParts=this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/PIE/)||this.szFlag.match(/BAR/)||this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/DOMINANT/)||this.szFlag.match(/\bUSER\b/)||this.szFlag.match(/WAFFLE/));for(t in uniqueTopicA)if(nUnique++,"undefined"!=t){var itemA=uniqueTopicA[t],x;if(fMultiParts){for(a in itemA){x=a;break}this.itemA[x]={};var nValuesA=[];eval("nValuesA = "+szExactSize+";");var nMinA=[],nMaxA=[];this.itemA[x].szSelectionId=x,this.itemA[x].szTitle=itemA[x].szTitle,(this.szAggregationField||this.szFlag.match(/RELOCATE/))&&(this.szFlag.match(/ALIGN/)?(this.itemA[x].szSelectionId=firstItemId,this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[x]=new point(lowPos.x,lowPos.y):this.themeNodesPosA[x]=new point(centerPos.x,centerPos.y)):this.themeNodesPosA[x]=new point(uniqueTopicPos[t].x/uniqueTopicCount[t],uniqueTopicPos[t].y/uniqueTopicCount[t])),this.itemA[x].dbIndexA=[];var nSizeSum=0,nSizeCount=0;for(a in itemA){for(var db in nValuesA[itemA[a].nValuesA[0]-1]=itemA[a].nSize/(this.szFlag.match(/SUM/)?1:itemA[a].nCount),nSizeSum+=itemA[a].nSize,nSizeCount+=itemA[a].nCount,this.itemA[x].dbIndexA.push(itemA[a].dbIndex),itemA[a].dbIndexA)this.itemA[x].dbIndexA.push(itemA[a].dbIndexA[db]);delete this.itemA[x].dbIndex}if(this.itemA[x].nValuesA=this.itemA[x].nOrigValuesA=nValuesA,this.itemA[x].nMinA=nMinA,this.itemA[x].nMaxA=nMaxA,this.itemA[x].nSize=nSizeSum/(this.szFlag.match(/SUM/)?1:nSizeCount),this.itemA[x].nCount=nSizeCount,this.itemA[x].nAlpha=itemA[a].nAlpha,this.itemA[x].szTitle=this.nGridWidth&&!this.szAggregationField&&uniqueTopicTitleCount[t]>1?__formatValue(uniqueTopicTitleCount[t],0)+" item(s) aggregated":this.itemA[x].szTitle||t,this.itemA[x].szValue=this.itemA[x].szTitle,this.itemA[x].szLabel=this.itemA[x].szTitle,this.nMin=this.nMinSize=Math.min(this.nMinSize,this.itemA[x].nSize),this.nMax=this.nMaxSize=Math.max(this.nMaxSize,this.itemA[x].nSize),this.nSumSize+=nSizeSum/(this.szFlag.match(/SUM/)?1:nSizeCount),this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[x].nAlpha),this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[x].nAlpha),this.nSumAlpha+=this.itemA[x].nAlpha,this.szFlag.match(/AUTO100/)){var i,nValue100=0;for(i=0;i<this.itemA[x].nValuesA.length;i++)nValue100+=this.itemA[x].nValuesA[i]||0;for(i=0;i<this.itemA[x].nValuesA.length;i++)this.itemA[i].nValue100A[0]=nValue100;for(this.fField100=!0,i=0;i<this.itemA[x].nValuesA.length;i++)this.itemA[x].nValuesA[i]=this.itemA[x].nOrigValuesA[i]/this.itemA[x].nValue100[i]*100}if(this.szFlag.match(/CATEGORICAL/)&&(this.szFlag.match(/CATEGORICAL/)||!this.nNormalSizeValue)){if(!this.nMinA.length)for(i=0;i<this.itemA[x].nValuesA.length;i++)this.nMinA[i]=null,this.nMaxA[i]=null,this.nSumA[i]=0,this.nOrigMinA[i]=null,this.nOrigMaxA[i]=null,this.nOrigSumA[i]=0,this.nMedianA[i]=0,this.nMeanA[i]=0,this.nCountA[i]=0;for(i=0;i<this.itemA[x].nValuesA.length;i++)this.nMinA[i]=Math.min(this.nMinA[i]||this.itemA[x].nValuesA[i],this.itemA[x].nValuesA[i]),this.nMaxA[i]=Math.max(this.nMaxA[i]||this.itemA[x].nValuesA[i],this.itemA[x].nValuesA[i]),this.nSumA[i]+=this.itemA[x].nValuesA[i],this.nOrigMinA[i]=Math.min(this.nOrigMinA[i]||this.itemA[x].nOrigValuesA[i],this.itemA[x].nOrigValuesA[i]),this.nOrigMaxA[i]=Math.max(this.nOrigMaxA[i]||this.itemA[x].nOrigValuesA[i],this.itemA[x].nOrigValuesA[i]),this.nOrigSumA[i]+=this.itemA[x].nOrigValuesA[i],this.itemA[x].nValuesA[i]&&this.nCountA[i]++}this.nCount=nUnique*nParts}else for(a in itemA)if(itemA[a]){var newId=a;if(!this.szAggregationField){var newId=t;this.itemA[newId]&&(newId=newId.split("*")[0]+"*"+Math.random())}if(this.itemA[newId]=itemA[a],itemA[a].szValue=itemA[a].szValue||1,this.nMinSize=Math.min(this.nMinSize,this.itemA[newId].nSize),this.nMaxSize=Math.max(this.nMaxSize,this.itemA[newId].nSize),this.nSumSize+=this.itemA[newId].nSize,this.nMinAlpha=Math.min(this.nMinAlpha,this.itemA[newId].nAlpha),this.nMaxAlpha=Math.max(this.nMaxAlpha,this.itemA[newId].nAlpha),this.nSumAlpha+=this.itemA[newId].nAlpha,!this.szFlag.match(/SUM/)){var nCount=this.szFlag.match(/SUM/)?1:itemA[a].nCount;this.itemA[newId].nSize/=nCount,this.itemA[newId].szValue/=nCount,this.itemA[newId].nValue100A[0]/=nCount}if(this.nGridWidth||this.szAggregationField){nCount=this.szFlag.match(/SUM/)||this.szFlag.match(/CATEGORICAL/)?1:itemA[a].nCount,this.itemA[newId].szSelectionId=a;for(var v=0;v<this.itemA[newId].nValuesA.length;v++)this.itemA[newId].nValuesA[v]/=nCount,this.itemA[newId].nOrigValuesA[v]/=nCount,this.itemA[newId].nValue100A[v]&&(this.itemA[newId].nValuesA[v]=this.itemA[newId].nOrigValuesA[v]/this.itemA[newId].nValue100A[v],this.szFlag.match(/FRACTION/)||(this.itemA[newId].nValuesA[v]*=this.szFlag.match(/PERMILLE/)?1e3:100),this.szFlag.match(/INVERT/)&&(this.itemA[newId].nValuesA[v]=100-this.itemA[newId].nValuesA[v])),this.nMin=Math.min(this.itemA[newId].nValuesA[v]||Number.MAX_VALUE,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[newId].nValuesA[v]||-Number.MAX_VALUE,this.nMax||-Number.MAX_VALUE)}else this.nMin=Math.min(this.itemA[newId].nSize,this.nMin||Number.MAX_VALUE),this.nMax=Math.max(this.itemA[newId].nSize,this.nMax||-Number.MAX_VALUE);if(this.szFlag.match(/AUTO100/)){var i;for(nValue100=0,i=0;i<this.itemA[newId].nValuesA.length;i++)nValue100+=this.itemA[newId].nValuesA[i]||0;for(i=0;i<this.itemA[newId].nValuesA.length;i++)this.itemA[newId].nValue100A[i]=nValue100;for(this.fField100=!0,i=0;i<this.itemA[newId].nValuesA.length;i++)this.itemA[newId].nValuesA[i]=this.itemA[newId].nOrigValuesA[i]/this.itemA[newId].nValue100A[i]*100}(this.szAggregationField||this.szFlag.match(/RELOCATE/))&&(this.szFlag.match(/ALIGN/)?this.szFlag.match(/\bUP\b/)?this.themeNodesPosA[newId]=new point(lowPos.x,lowPos.y):this.themeNodesPosA[newId]=new point(centerPos.x,centerPos.y):(this.themeNodesPosA[a]=new point(uniqueTopicPos[t].x/uniqueTopicCount[t],uniqueTopicPos[t].y/uniqueTopicCount[t]),this.themeNodesPosA[newId]=new point(uniqueTopicPos[t].x/uniqueTopicCount[t],uniqueTopicPos[t].y/uniqueTopicCount[t])))}}if(this.szMinAggregation){var nCount=0,nMediaCount=0;for(a in this.itemA)nMediaCount+=this.itemA[a].nCount,nCount++;for(a in nMediaCount/=nCount,this.itemA)this.itemA[a].nCount&&this.itemA[a].nCount<(this.nMinAggregation||nMediaCount/2)&&delete this.itemA[a];for(a in this.nMin=Number.MAX_VALUE,this.nMax=-Number.MAX_VALUE,this.itemA)for(var v=0;v<this.itemA[a].nValuesA.length;v++)this.nMin=Math.min(this.itemA[a].nValuesA[v],this.nMin),this.nMax=Math.max(this.itemA[a].nValuesA[v],this.nMax)}this.fSorted=!0,_TRACE("== aggregation done == ")}}},MapTheme.prototype.distributeValues=function(){if(0===this.nCount)return this.szFlag.match(/CATEGORICAL/)&&displayMessage("theme: no matching values !",3e3),!1;if(this.szFlag.match(/OUTLIER/)){var nParts=this.szFieldsA.length;if(this.getMeanMedianQuantile(),this.szFlag.match(/PLOT/)){for(var a in this.itemA){for(var nPopA=[],i=0;i<nParts;i++)this.itemA[a].nValuesA[i]&&nPopA.push(this.itemA[a].nValuesA[i]);this.nDeviationA[a]=this.parent.getDeviationOfArray(nPopA)}for(var a in this.itemA)for(var i=0;i<nParts;i++)Math.abs(this.itemA[a].nValuesA[i]-this.itemA[a].nValuesA[i-1])>this.nDeviationA[a]*(this.nOutlierScale||2)&&this.szFlag.match(/NOOUTLIER/)&&(this.itemA[a].nValuesA[i]=this.itemA[a].nValuesA[i-1])}else{for(var i=0;i<nParts;i++){var nPopA=[];for(var a in this.itemA)this.itemA[a].nValuesA[i]&&nPopA.push(this.itemA[a].nValuesA[i]);this.nDeviationA[i]=this.parent.getDeviationOfArray(nPopA)}for(var i=0;i<nParts;i++)for(var a in this.itemA)Math.abs(this.itemA[a].nValuesA[i]-this.nMeanA[i])>this.nDeviationA[i]*(this.nOutlierScale||3)?this.szFlag.match(/NOOUTLIER/)&&delete this.itemA[a]:this.szFlag.match(/NOOUTLIER/)||delete this.itemA[a]}for(a in this.nMin=Number.MAX_VALUE,this.nMax=-Number.MAX_VALUE,this.itemA)for(var v=0;v<this.itemA[a].nValuesA.length;v++)isNaN(this.itemA[a].nValuesA[v])||(this.nMin=Math.min(this.itemA[a].nValuesA[v],this.nMin),this.nMax=Math.max(this.itemA[a].nValuesA[v],this.nMax))}if((this.szFlag.match(/AGGREGATE/)||this.szFlag.match(/GROUP/))&&this.aggregateValues(),"$aggregation$"==this.szSizeField&&(this.szSizeField=null),_TRACE("== MapTheme.distributeValues()"),this.szFlag.match(/CATEGORICAL/)&&(!this.szExactA||!this.szExactA.length)&&(this.szExactA=this.szExactA||[],this.nStringToValueA)){for(a in this.nStringToValueA)this.szExactA.push(this.nStringToValueA[a]);_TRACE("values: "+this.szExactA+" (generated)")}if(!this.szFlag.match(/CATEGORICAL/)||this.szLabelA&&this.szLabelA.length||this.szValuesA&&(this.szLabelA=this.szValuesA,_TRACE("(label generated from values)")),this.szColorField)if(this.colorFieldA=[],this.colorClassA=[],this.colorClassUsedA=[],this.szColorValuesA)for(i in this.szColorValuesA)this.colorFieldA[this.szColorValuesA[i]]=!0;else if(this.szValuesA)for(i in this.szValuesA)this.colorFieldA[this.szValuesA[i]]=!0;else for(a in this.itemA)this.colorFieldA[this.itemA[a].szColor]=!0;if(this.szSymbolField)if(this.symbolFieldA=[],this.szSymbolValuesA)for(i in this.szSymbolValuesA)this.symbolFieldA[this.szSymbolValuesA[i]]=this.szSymbolsA[i];else for(a in this.itemA)this.symbolFieldA[this.itemA[a].szSymbol]=this.szSymbolsA[i];if(this.origColorScheme||(this.origColorScheme=this.colorScheme=this.defaultColorScheme),_TRACE("colorScheme:"+this.origColorScheme+" (defined)"),isNaN(Number(this.origColorScheme[0])))this.colorScheme=this.origColorScheme.slice(0);else{if(this.szFlag.match(/SEQUENCE/)&&this.szFieldsA.length>this.origColorScheme[0]&&(this.origColorScheme[0]=this.szFieldsA.length),this.szFlag.match(/CATEGORICAL/)&&(this.origColorScheme[0]=this.szExactA.length||1),this.szColorField){var l=0;for(a in this.colorFieldA)l++;this.origColorScheme[0]=l}try{this.colorScheme=ColorScheme.createColorScheme(this.origColorScheme[1],this.origColorScheme[2],this.origColorScheme[0],this.origColorScheme[3],this.origColorScheme[4])}catch(e){this.colorScheme=this.defaultColorScheme}if(this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/ORDER/)){var myColoscheme=this.colorScheme.slice(),myValuesA=this.szValuesA?this.szValuesA.slice():this.szLabelA.slice();if(this.szColorField)for(a in myValuesA=[],this.colorFieldA)myValuesA.push(a),this.getStringValueIndex(a,"set");if(myValuesA.length&&myColoscheme.length&&myValuesA.length==myColoscheme.length){myValuesA.sort(),this.colorScheme=[];for(var i=0;i<myValuesA.length;i++)this.colorScheme[this.nStringToValueA[myValuesA[i]]-1]=myColoscheme[i]}}}if(this.szColorField){var i=0;for(a in this.colorFieldA)this.colorClassA[a]=i,this.colorFieldA[a]=this.colorScheme[i++];for(a in this.itemA)this.itemA[a].nClass=this.colorClassA[this.itemA[a].szColor],this.itemA[a].szColor=this.colorFieldA[this.itemA[a].szColor]}if(this.szSymbolField){var i=0;for(a in this.itemA)this.itemA[a].szSymbol=this.symbolFieldA[this.itemA[a].szSymbol]}try{eval("var __defineColorScheme = HTMLWindow."+this.colorScheme[0]),__defineColorScheme(this)}catch(e){}if(this.colorScheme[0].match(/function||\=\>/))try{eval("var __defineColorScheme = "+this.colorScheme),__defineColorScheme(this)}catch(e){}try{HTMLWindow.ixmaps.htmlgui_colorScheme(this)}catch(e){}if(this.szFlag.match(/DOMINANT/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]="#dddddd",_TRACE("colorscheme: '"+this.colorScheme[this.colorScheme.length-1]+"' added! -0-");if(this.szFieldsA)if(this.colorScheme.length<this.szFieldsA.length&&this.nGridX)for(;this.colorScheme.length<this.nGridX;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd",_TRACE("colorscheme: '"+this.colorScheme[this.colorScheme.length-1]+"' added! -2.1-");else if(!this.szFlag.match(/\bCLIP\b|\bDIFFERENCE\b/))for(;this.colorScheme.length<this.szFieldsA.length;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd",_TRACE("colorscheme: '"+this.colorScheme[this.colorScheme.length-1]+"' added! -2-");if(this.szFlag.match(/NORMALIZE/)&&this.nMax){var nRange=this.nMax-this.nMin;for(a in this.itemA)this.itemA[a].nValuesA[0]=(this.itemA[a].nValuesA[0]-this.nMin)/nRange;this.nMin=0,this.nMax=1}if(this.szFlag.match(/HARMONIZE/)&&this.nMax){if(this.nMaxA){for(v in this.nRangeA=[],this.nMaxA)this.nRangeA.push(this.nMaxA[v]-this.nMinA[v]);for(a in this.itemA)for(v in this.itemA[a].nValuesA)this.itemA[a].nValuesA[v]=(this.itemA[a].nValuesA[v]-this.nMinA[v])/this.nRangeA[v];for(v in this.nMaxA)this.nMinA[v]=0,this.nMaxA[v]=1}else{for(a in this.itemA)this.itemA[a].nValuesA[0]/=this.nMax;this.nMin/=this.nMax,this.nMax/=this.nMax}this.nMin=0,this.nMax=1}if(this.szFlag.match(/INVERTSIZE/)&&this.szSizeField){for(a in this.itemA)this.itemA[a].nSize=this.nMaxSize-this.itemA[a].nSize;this.nNormalSizeValue=this.nNormalSizeValue||this.nMaxSize}_TRACE("start making classes ==>"),this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/SEQUENCE/)||this.getMeanMedianQuantile(),_TRACE("distribute values ==> classes");var nParts=this.colorScheme.length,nRange=this.nMax-this.nMin,nMin=this.nMin,nMax=this.nMax;if(null!=this.nRangeCenterValue&&!isNaN(this.nRangeCenterValue)){var nSymRange=Math.max(Math.abs(this.nRangeCenterValue-nMin),Math.abs(nMax-this.nRangeCenterValue));nMin=this.nRangeCenterValue-nSymRange,nMax=this.nRangeCenterValue+nSymRange,nRange=nMax-nMin}if(this.szFlag.match(/INTEGER/))nParts>nRange?nParts=nRange:nParts>nRange/2?nParts=Math.floor(nRange/2):nRange+=nParts-nRange%nParts;else{var nPreClip=1;for(this.szField100&&(nPreClip=.01);nRange>1e3*nPreClip;)nPreClip*=10;nPreClip>1?(nMin=Math.floor(nMin/nPreClip)*nPreClip,nMax=Math.ceil(nMax/nPreClip)*nPreClip):nMax+=nMax/1e5,nRange=nMax-nMin}if(_TRACE("set range values ==>"),this.szFlag.match(/CHART|CHOROPLETH/)&&(isNaN(nRange)||!isFinite(nRange)))return _ERROR("ERROR on distributeValues: infinite range !"),displayMessage("ERROR: infinite value range !",3e3),!1;if(this.szColorField){this.nRangesA=[];var i=0;for(a in this.colorFieldA)this.nRangesA.push(i++)}else this.nRangesA=this.szRangesA||this.szExactA;if(this.nRangesA&&this.nRangesA.length){var nRangeWidth=this.szFlag.match(/CATEGORICAL/)?0:1,i;if(this.szFlag.match(/BAR/)&&this.szFlag.match(/SEQUENCE/)&&(nRangeWidth=1),nParts=this.nRangesA.length-nRangeWidth,this.szSymbolsA&&this.szSymbolsA.length){for(;this.szSymbolsA.length<nParts;)this.szSymbolsA[this.szSymbolsA.length]=this.szSymbolsA[this.szSymbolsA.length-1];_TRACE("symbols: '"+this.szSymbolsA[this.szSymbolsA.length-1]+"' added!")}if(this.colorScheme&&this.colorScheme.length){for(;this.colorScheme.length<nParts;)this.colorScheme[this.colorScheme.length]=this.colorScheme[this.colorScheme.length-1]||"#dddddd";_TRACE("colorscheme: '"+this.colorScheme[this.colorScheme.length-1]+"'added! -1-")}for(this.partsA=[],i=0;i<nParts;i++){var nMin=Number(this.nRangesA[i]),nMax=Number(this.nRangesA[i+nRangeWidth])+1e-9;this.partsA[this.partsA.length]={min:nMin,max:nMax,color:this.colorScheme[i],nCount:0,nSum:0}}if(this.szFlag.match(/CATEGORICAL/)&&this.exactCountA)for(i=0;i<nParts;i++)this.partsA[i].nCount=this.exactCountA[i];if(this.szFlag.match(/PLOTVAR/)||this.szFlag.match(/DOMINANT/))for(this.getMeanMedianQuantile(),i=0;i<nParts;i++){var nPopA=[];for(a in this.itemA)this.itemA[a].nValuesA[i]&&nPopA.push(this.itemA[a].nValuesA[i]);this.nDeviationA[i]=this.parent.getDeviationOfArray(nPopA),this.szDominantFilter=this.szDominantFilter||"min",this.nDominantDFilter=this.nDominantDFilter||0,this.szDominantFilter.match(/min/)||this.szDominantFilter.match(/max/)?this.nFilterA[i]=this.nMinA[i]+(this.nMaxA[i]-this.nMinA[i])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?this.nFilterA[i]=this.nMeanA[i]+(this.nMaxA[i]-this.nMeanA[i])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[i]=this.nMedianA[i]+(this.nMaxA[i]-this.nMedianA[i])/100*this.nDominantDFilter)}}else{var i,nStep=nRange/nParts;for(_TRACE("nStep:"+nStep),nStep>nPreClip&&(nStep=Math.floor(nStep/nPreClip)*nPreClip),_TRACE("nStep:"+nStep+" (clipped)"),_TRACE("mapTheme min:"+this.nMin+" max:"+this.nMax+" Range:"+nRange+" Parts:"+nParts+" Step:"+nStep),this.nMin==this.nMax&&(nParts=1),this.partsA=[],i=0;i<nParts;i++)this.partsA[this.partsA.length]={min:nMin+i*nStep,max:nMin+(i+1)*nStep,color:this.colorScheme[i],nCount:0,nSum:0};if(this.partsA[this.partsA.length-1].max=nMax,this.szFlag.match(/HEADTAIL/)){var breaks=this.getHeadTail();for(i=0;i<this.partsA.length;i++)this.partsA[i].min=breaks[i],this.partsA[i].max=breaks[i+1]-1e-6;this.partsA[this.partsA.length-1].max=nMax}if(this.szFlag.match(/QUANTILE/)){this.getMeanMedianQuantile();var nMaxMember=Math.round(this.quantileA[0].length/nParts);for(i=0;i<this.partsA.length;i++)this.partsA[i].min=this.quantileA[0][i*nMaxMember],this.partsA[i].max=this.quantileA[0][(i+1)*nMaxMember];this.partsA[this.partsA.length-1].max=nMax}if(this.szFlag.match(/LOG/)){var nMin=Math.log(this.nMin?this.nMin:Math.min(.1,this.nMax/10)),nRange=Math.log(this.nMax?this.nMax:.1)-nMin,nStep=nRange/nParts;for(this.partsA=[],i=0;i<nParts;i++)this.partsA[this.partsA.length]={min:Math.exp(nMin+i*nStep),max:Math.exp(nMin+(i+1)*nStep),color:this.colorScheme[i],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW2/)){var nMin=Math.pow(this.nMin?this.nMin:1,.5),nRange=Math.pow(this.nMax?this.nMax:1,.5)-Math.pow(this.nMin?this.nMin:1,.5),nStep=nRange/nParts;for(this.partsA=[],i=0;i<nParts;i++)this.partsA[this.partsA.length]={min:Math.pow(nMin+i*nStep,2),max:Math.pow(nMin+(i+1)*nStep,2),color:this.colorScheme[i],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}else if(this.szFlag.match(/POW3/)){var nMin=Math.pow(this.nMin?this.nMin:1,1/3),nRange=Math.pow(this.nMax?this.nMax:1,1/3)-Math.pow(this.nMin?this.nMin:1,1/3),nStep=nRange/nParts;for(this.partsA=[],i=0;i<nParts;i++)this.partsA[this.partsA.length]={min:Math.pow(nMin+i*nStep,3),max:Math.pow(nMin+(i+1)*nStep,3),color:this.colorScheme[i],nCount:0,nSum:0};this.partsA[this.partsA.length-1].max=this.nMax}if(this.szFlag.match(/DOMINANT/)||this.szFlag.match(/OFFSETMEAN/)||this.szFlag.match(/OFFSETMEDIAN/)||this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/)){for(this.getMeanMedianQuantile(),i=0;i<this.szFieldsA.length;i++){var quantileA=[];for(a in this.itemA)this.itemA[a].nValuesA[i]&&quantileA.push(this.itemA[a].nValuesA[i]);"$item$"!=this.szFieldsA[i]&&quantileA.sort(this.sortUp),this.nMedianA[i]=quantileA[Math.round(quantileA.length/2)],this.nSum100?this.szFlag.match(/DIFFERENCE/)?this.nMeanA[i]=this.nSumA[i]/this.nCount:(this.nMeanA[i]=this.nOrigSumA[i]/this.nSum100,this.szFlag.match(/FRACTION/)?this.nMeanA[i]*=this.nFractionScale||1:this.szFlag.match(/PERMILLE/)?this.nMeanA[i]*=1e3:(this.nMeanA[i]*=100,this.szFlag.match(/RELATIVE/)?this.nMeanA[i]-=100:this.szFlag.match(/INVERT/)&&(this.nMeanA[i]=100-this.nMeanA[i]))):this.nMeanA[i]=this.nSumA[i]/this.nCount}for(i=0;i<this.partsA.length;i++)this.szDominantFilter=this.szDominantFilter||"min",this.nDominantDFilter=this.nDominantDFilter||0,this.szDominantFilter.match(/min/)||this.szDominantFilter.match(/max/)?this.nFilterA[i]=this.nMinA[i]+(this.nMaxA[i]-this.nMinA[i])/100*this.nDominantDFilter:this.szDominantFilter.match(/mean/)?this.nFilterA[i]=this.nMeanA[i]+(this.nMaxA[i]-this.nMeanA[i])/100*this.nDominantDFilter:this.szDominantFilter.match(/median/)&&(this.nFilterA[i]=this.nMedianA[i]+(this.nMaxA[i]-this.nMedianA[i])/100*this.nDominantDFilter),_TRACE("part-"+i+":  min:"+this.nMinA[i]+" max:"+this.nMaxA[i]+" mean:"+this.nMeanA[i]+" median:"+this.nMedianA[i]+" filter:"+this.nFilterA[i]);if(this.szFlag.match(/DEVIATION/)||this.szFlag.match(/PLOTVAR/))for(i=0;i<this.szFieldsA.length;i++){var nPopA=[];for(a in this.itemA)this.itemA[a].nValuesA[i]&&nPopA.push(this.itemA[a].nValuesA[i]);this.nDeviationA[i]=this.parent.getDeviationOfArray(nPopA)}}}for(var i in this.partsA[this.partsA.length-1]&&(this.partsA[this.partsA.length-1].max+=.001),this.szColorField&&(this.nRangesA=this.szRangesA||this.szExactA),this.szFlag.match(/COMPOSECOLOR/)&&__maptheme_initComposedColor(this.colorScheme.slice(0)),this.nAllMaxValue=-Number.MAX_VALUE,this.nAllMinValue=Number.MAX_VALUE,this.nMaxA)this.nAllMaxValue=Math.max(this.nAllMaxValue,this.nMaxA[i]),this.nAllMinValue=Math.min(this.nAllMinValue,this.nMinA[i]);return _TRACE("== done === "),!0},MapTheme.prototype.sortUp=function(e,t){return e-t},MapTheme.prototype.sortIndexUp=function(e,t){return e.value-t.value},MapTheme.prototype.sortIndexDown=function(e,t){return t.value-e.value},MapTheme.prototype.sortPartsUp=function(e,t){return e.nCount-t.nCount},MapTheme.prototype.sortMeanUp=function(e,t){return e.mean-t.mean},MapTheme.prototype.shuffleArray=function(e,t){for(var i=e.length-1;i>0;i--){var a=Math.floor((t&&t[i]?t[i]:Math.random())*i+1),s=e[i];e[i]=e[a],e[a]=s}},MapTheme.prototype.getRandomNumberArray=function(e){for(var t=[],i=0;i<e;i++)t.push(Math.random());return t};var sum_composecolor_intensity=0,mean_composecolor_intensity=0,__maptheme_initComposedColor=function(e){sum_composecolor_intensity=0,mean_composecolor_intensity=0;for(var t=0;t<e.length;t++){var i=ColorScheme.getHexaColor(e[t]);mean_composecolor_intensity+=Math.max(Math.max(parseInt(i.substr(1,2),16),parseInt(i.substr(3,2),16)),parseInt(i.substr(5,2),16)),sum_composecolor_intensity+=parseInt(i.substr(1,2),16)+parseInt(i.substr(3,2),16)+parseInt(i.substr(5,2),16)}sum_composecolor_intensity/=e.length,mean_composecolor_intensity/=e.length},__maptheme_getComposedColor_additive=function(e,t,i,a){for(var s=0,n=0,l=0,h=0;h<e.length;h++){var o=ColorScheme.getHexaColor(t[h]);s+=parseInt(o.substr(1,2),16)*((e[h]||0)/(i||1)),n+=parseInt(o.substr(3,2),16)*((e[h]||0)/(i||1)),l+=parseInt(o.substr(5,2),16)*((e[h]||0)/(i||1))}var r=Math.max(Math.max(s,n),l);return s=Math.floor(s/r*(a||mean_composecolor_intensity)),n=Math.floor(n/r*(a||mean_composecolor_intensity)),l=Math.floor(l/r*(a||mean_composecolor_intensity)),ColorScheme.getHexaColor("rgb("+s+","+n+","+l+")")},__maptheme_getComposedColor_subtractive=function(e,t,i,a){a=a||Math.min(Math.floor(sum_composecolor_intensity),300)||255;for(var s=0,n=0,l=0,h=0;h<e.length;h++){var o=ColorScheme.getHexaColor(t[h]);s+=(255-parseInt(o.substr(1,2),16))*((e[h]||0)/(i||1)),n+=(255-parseInt(o.substr(3,2),16))*((e[h]||0)/(i||1)),l+=(255-parseInt(o.substr(5,2),16))*((e[h]||0)/(i||1))}var r=Math.max(Math.max(s,n),l);return s=Math.min(255,a-Math.floor(s/r*mean_composecolor_intensity)),n=Math.min(255,a-Math.floor(n/r*mean_composecolor_intensity)),l=Math.min(255,a-Math.floor(l/r*mean_composecolor_intensity)),ColorScheme.getHexaColor("rgb("+s+","+n+","+l+")")};MapTheme.prototype.paintMap=function(e){if(_TRACE("== MapTheme.paintMap("+e+")===> "+this.szId),this.nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartUpper)return this.unpaintMap(),this.fVisible=!1,void this.realizeDone();if(this.nChartLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartLower)return this.unpaintMap(),this.fVisible=!1,void this.realizeDone();this.beginDraw(),this.mapSleep&&(this.mapSleep.checkSleepMessage="painting map");var t=0,i=0,a=0,s=0,n=0,l=0,h="",o="",r=(map.Dictionary.getLocalText("of mean"),map.Dictionary.getLocalText("of median"),!1),m=0,p=0,c=0,u=0,d=null;if(this.fillOpacity=this.fillOpacity?this.fillOpacity:this.nOpacity,this.szStyle="fill-opacity:"+String(this.fillOpacity?this.fillOpacity:fTransparentMap?.6:1),this.autoOpacity){var A=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale;this.szStyle="fill-opacity:"+String(Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom/A)))))}if(this.szShapeType.match(/line/)&&(this.szStyle=this.fillOpacity?"stroke-opacity:"+this.fillOpacity+";":"stroke-opacity:1"),!e||0===e){for(u in e=0,this.indexA=[],this.itemA)this.indexA[this.indexA.length]=u,this.itemA[u].todo=!0;for(p=0;p<this.partsA.length;p++)this.partsA[p].nCount=0,this.partsA[p].nSum=0;if(this.nDoneCount=0,this.szFlag.match(/COMPOSECOLOR/)&&__maptheme_initComposedColor(this.colorScheme.slice(0)),this.parentTheme)for(c=0;c<this.parentTheme.paintedShapeNodesA.length;c++)this.parentTheme.unPaintShape(this.parentTheme.paintedShapeNodesA[c])}for(var S=e;S<this.indexA.length;S++){if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(S,10)))return this.fContinue=!0,this.continueIndex=S,void(this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt));u=this.indexA[S];if(this.nDoneCount++,r=!1,m=0,this.szFlag.match(/COMPOSECOLOR/)){if(this.szFlag.match(/SUBTRACTIVE/))var g=__maptheme_getComposedColor_subtractive(this.itemA[u].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));else g=__maptheme_getComposedColor_additive(this.itemA[u].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));for(d=this.getItemNodes(u),c=0;c<d.length;c++){var z=this.paintShape(d[c],g,-1,-1);if(this.szFlag.match(/DOPACITY/)){if(this.szAlphaField){if(l=0,void 0!==this.itemA[u].nAlpha){var f=1/(this.nDopacityPow||1);l=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,f)*Math.pow(this.itemA[u].nAlpha,f)}}else{f=1/(this.nDopacityPow||1);var T=(isNaN(this.itemA[u].nValueSum)?0:this.itemA[u].nValueSum)/(this.itemA[u].nValue100A[0]/100||1),x=isNaN(this.nMax)?0:this.nMax;l=(this.nDopacityScale||1)*Math.pow(T,f)/Math.pow(x,f)}z.style.setProperty(this.szShapeType.match(/line/)?"stroke-opacity":"fill-opacity",String(l),"")}}r=!0}else if(this.szFlag.match(/DOMINANT/)){r=!0;var y=-1;for(p=0;p<this.itemA[u].nValuesA.length;p++)t=this.itemA[u].nValuesA[p],i=100/this.nMeanA[p]*t,a=100/this.nMedianA[p]*t,s=(t-this.nMeanA[p])/this.nDeviationA[p],n=t,this.szFlag.match(/PERCENTOFMEAN/)&&(n=i),this.szFlag.match(/PERCENTOFMEDIAN/)&&(n=a),this.szFlag.match(/DEVIATION/)&&(n=s),t>this.nFilterA[p]&&n>m&&(this.itemA[u].nClass=p,m=n,y=p);if(y>=0){for(this.itemA[u].nDominant=y,t=this.itemA[u].nValuesA[y],h=" "+this.szFieldsA[y]+" ",this.szLabelA&&this.szLabelA[y]&&(h=" "+this.szLabelA[y]+" "),(this.szFlag.match(/PERCENTOFMEAN/)||this.szFlag.match(/DEVIATION/))&&(o=map.Dictionary.getLocalText(" ( mean: ")+this.formatValue(this.nMeanA[y],1)+this.szUnit+")"),this.szFlag.match(/PERCENTOFMEDIAN/)&&(o=map.Dictionary.getLocalText(" ( median: ")+this.formatValue(this.nMedianA[y],1)+this.szUnit+")"),this.itemA[u].nValue=this.itemA[u].nValuesA[y],this.itemA[u].szLabel=h,this.itemA[u].szColor=this.colorScheme[y],this.itemA[u].nClass=y,d=this.getItemNodes(u),c=0;c<d.length;c++){if((z=this.paintShape(d[c],this.colorScheme[y],this.itemA[u].nValue,y)).setAttributeNS(szMapNs,"tooltip",this.formatValue(t,2)+this.szUnit+h+o),this.szFlag.match(/DOPACITY/)){this.itemA[u].nOrigValuesA,T=0,x=0,l=0;if(T=isNaN(this.itemA[u].nValuesA[y])?0:this.itemA[u].nValuesA[y],x=isNaN(this.nMaxA[y])?0:this.nMaxA[y],this.szAlphaField){if(l=0,void 0!==this.itemA[u].nAlpha){f=1/(this.nDopacityPow||1);l=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,f)*Math.pow(this.itemA[u].nAlpha,f)}}else if(this.szFlag.match(/DOPACITYLOGMEAN/))l=Math.log((this.nDopacityScale||1)*(i-100))/Math.log(100);else if(this.szFlag.match(/DOPACITYPOWMEAN/)){f=1/(this.nDopacityPow||1);l=Math.pow((this.nDopacityScale||1)*(i-100),f)/Math.pow(100,f)}else if(this.szFlag.match(/DOPACITYMEAN/)){f=1/(this.nDopacityPow||1);l=Math.pow((this.nDopacityScale||1)*(i-100),f)/Math.pow(100,f)}else if(this.szFlag.match(/DOPACITYLOGMAX/))l=Math.log(T)/Math.log(x);else if(this.szFlag.match(/DOPACITYPOWMAX/)){f=1/(this.nDopacityPow||1);l=(this.nDopacityScale||1)*Math.pow(T,f)/Math.pow(x,f)}else if(this.szFlag.match(/DOPACITYMAX/)){f=1/(this.nDopacityPow||1);l=(this.nDopacityScale||1)*Math.pow(T,f)/Math.pow(x,f)}else l=Math.log((this.nDopacityScale||1)*T)/Math.log(x);if(l=l<1e-4?0:l,l=Math.min(this.nOpacity||.9,l),this.autoOpacity){A=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale;l*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom/A))))}z.style.setProperty(this.szShapeType.match(/line/)?"stroke-opacity":"fill-opacity",String(l),"")}}this.partsA[y].nCount++}else for(d=this.getItemNodes(u),c=0;c<d.length;c++)this.unPaintShape(d[c]),d[c].removeAttributeNS(szMapNs,"tooltip")}else for(t=this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames?this.nClipFrames==this.itemA[u].nValuesA.length?Number(this.itemA[u].nValuesA[this.nActualFrame]):this.itemA[u].nValuesA[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.itemA[u].nValuesA[1]*this.nActualFrame/(this.nClipFrames-1):this.itemA[u].nValuesA[0],p=0;p<this.partsA.length;p++)if(t<this.partsA[p].max){if(this.itemA[u].nValue=t,this.itemA[u].szColor=this.partsA[p].color,this.itemA[u].nClass=p,this.itemA[u].todo){for(d=this.getItemNodes(u),c=0;c<d.length;c++){z=this.paintShape(d[c],this.partsA[p].color,t,p);if(this.szLabelA&&this.szLabelA[p]&&this.szFlag.match(/CATEGORICAL/)?z.setAttributeNS(szMapNs,"tooltip",this.szLabelA[p]):this.itemA[u].nValue100A[0]?z.setAttributeNS(szMapNs,"tooltip",this.formatValue(t,2)+this.szUnit):(z.setAttributeNS(szMapNs,"tooltip",this.formatValue(t,2)+this.szUnit),z.setAttributeNS(szMapNs,"tooltip",(this.itemA[u].szTitle?this.itemA[u].szTitle:"")+" "+this.formatValue(t,2)+this.szUnit)),this.szFlag.match(/DOPACITY/)){if(this.szAlphaField){if(l=0,void 0!==this.itemA[u].nAlpha){f=1/(this.nDopacityPow||1);l=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,f)*Math.pow(this.itemA[u].nAlpha,f)}}else if(this.nMin<0&&this.nMax>0)if(l=0,this.szFlag.match(/DOPACITYMAX/)){f=1/(this.nDopacityPow||1);l=Math.pow(Math.abs(t),f)/Math.pow(this.nMedianA[0]-this.nMin,f)*(this.fillOpacity||1)*(this.nDopacityScale||1)}else l=this.szFlag.match(/DOPACITYLOG/)?Math.log(Math.abs(t))/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.abs(t)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1);else if(this.szFlag.match(/BIPOLAR/)||this.szFlag.match(/DOPACITYMINMAX/))if(l=0,this.szFlag.match(/DOPACITYMAX/)){f=1/(this.nDopacityPow||1);l=t>=this.nMeanA[0]?Math.pow(Math.abs(t-this.nMeanA[0]),f)/Math.pow(Math.abs(this.nMax-this.nMeanA[0]),f)*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(this.nMeanA[0]-t),f)/Math.pow(Math.abs(this.nMeanA[0]-this.nMin),f)*(this.fillOpacity||1)*(this.nDopacityScale||1)}else if(this.szFlag.match(/DOPACITYLOG/))l=t>=this.nMedianA[0]?Math.log(Math.abs(t-this.nMedianA[0]))/Math.log(this.nMax-this.nMedianA[0])*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.log(Math.abs(t-this.nMedianA[0]))/Math.log(this.nMedianA[0]-this.nMin)*(this.fillOpacity||1)*(this.nDopacityScale||1);else{f=1/(this.nDopacityPow||1);l=t>=this.nMedianA[0]?Math.pow(Math.abs(t-this.nMedianA[0]),f)/Math.pow(this.nMax-this.nMedianA[0],f)*(this.fillOpacity||1)*(this.nDopacityScale||1):Math.pow(Math.abs(t-this.nMedianA[0]),f)/Math.pow(this.nMedianA[0]-this.nMin,f)*(this.fillOpacity||1)*(this.nDopacityScale||1)}else if(this.szFlag.match(/DOPACITYMIN/)){f=1/(this.nDopacityPow||1);l=Math.pow(this.nMax-t,f)/Math.pow(this.nMax-this.nMin,f)*(this.fillOpacity||1)*(this.nDopacityScale||1)}else if(this.szFlag.match(/DOPACITYMAX/)){f=1/(this.nDopacityPow||1);l=Math.pow(t-this.nMin,f)/Math.pow(this.nMax-this.nMin,f)*(this.fillOpacity||1)*(this.nDopacityScale||1)}else this.szFlag.match(/DOPACITYLOG/)?l=Math.log(t-this.nMin)/Math.log(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1):this.szFlag.match(/DOPACITY/)&&(l=(t-this.nMin)/(this.nMedianA[0]-this.nMin)*.5*(this.fillOpacity||1)*(this.nDopacityScale||1));if(l=l<1e-4?0:l,l=Math.min(this.nOpacity||.9,l),this.autoOpacity){A=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale;l*=Math.max(.3,Math.min(1,.3+.7/Math.max(1,Math.log(map.Zoom.nZoom/A))))}z.style.setProperty("fill-opacity",String(l),"")}}this.itemA[u].todo=!1}this.partsA[p].nCount++,this.partsA[p].nSum+=t,r=!0;break}if(!r)for(_TRACE("no value: "+u+", "+this.itemA[u].nValuesA[0]+", "+t),this.itemA[u].szColor=this.szNoDataColor?this.szNoDataColor:"white",d=this.getItemNodes(u),c=0;c<d.length;c++){(z=this.paintShape(d[c],this.szNoDataColor?this.szNoDataColor:"white",-1,-1)).setAttributeNS(szMapNs,"tooltip","no value"),this.szFlag.match(/DOPACITY/),this.nNoData++}}if(_TRACE("== done === "),this.isVisible=!0,this.realizeDone(),this.fShowProgressBar=!1,this.showInfo(),this.endDraw(),this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt),this.szFlag.match(/\bCLIP\b/))if(this.nClipFrames==this.itemA[u].nValuesA.length)this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3e3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3e3,"big");else{var b=this.szXaxisA||this.szLabelA;b&&(0===this.nActualFrame?displayMessage(b[0],3e3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(b[1],3e3,"big"):displayMessage(" ... ",3e3,"big"))}else this.ErrorMessage?(displayMessage(this.ErrorMessage,1e4,"notify"),this.ErrorMessage=null):clearMessage();this.szFlag.match(/VALUES/)&&(!this.szValueUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nValueUpper)&&(!this.szValueLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nValueLower)?(this.mapSleep&&this.mapSleep.initCheckSleep(25),this.fMakeLabel=!0,this.fContinue=!0,this.continueIndex=0,this.nDoneCount=0,this.nSkipCount=0,this.nRealizedCount=0,this.nZeroValueCount=0,this.nMissingRangeCount=0,this.nMissingPositionCount=0,this.nActualFrame=0,setTimeout((function(){map.Themes.executeContinue()}),1e3)):this.unlabelMap()},MapTheme.prototype.unpaintMap=function(){if(_TRACE("== MapTheme.unpaintMap() ===> "),!this.szFlag.match(/FEATURE/))if(this.szFlag.match(/CHART/)){if(this.chartGroup){if(0===this.chartGroup.childNodes.length&&this.itemA){var e=null;for(var t in this.itemA)(e=SVGDocument.getElementById(this.szId+":"+t+":chartgroup"))&&e.parentNode.removeChild(e)}this.fAutoScaleLeader&&(map.Themes.autoScale=null),map.Dom.clearGroup(this.chartGroup)}}else if(!this.szFlag.match(/LOCKED/)){this.beginDraw(),_TRACE("begin ===> ");for(var i=0;i<this.paintedShapeNodesA.length;i++)this.unPaintShape(this.paintedShapeNodesA[i]),this.paintedShapeNodesA[i].removeAttributeNS(szMapNs,"tooltip");this.paintedShapeNodesA.length=0,_TRACE("end ===> "),this.unlabelMap(),this.endDraw(),_TRACE("== unpaintMap done === "),this.isVisible=!1,this.checkVisible(),setTimeout((function(){map.Layer.adaptLabel(null)}),10)}},MapTheme.prototype.paintShape=function(shapeNode,szColor,nValue,nClass){switch(this.paintedShapeNodesA.push(shapeNode),this.szShapeType){case"line":shapeNode.setAttributeNS(null,"style","fill:none;stroke:"+szColor+";"+this.szStyle);break;case"line+buffer":var szId=shapeNode.getAttributeNS(null,"id");if(!szId.match(":paint")){var cloneShape=SVGDocument.getElementById(szId+":paint");if(!cloneShape){var cloneShape=shapeNode.cloneNode(1e3);shapeNode.parentNode.insertBefore(cloneShape,shapeNode),cloneShape.setAttributeNS(null,"id",szId+":paint")}shapeNode=cloneShape}var nStrokeWidth=4;if(this.nBufferSize)if(this.nBufferSize.match(/\$value\$/)){for(var szEvalA=this.nBufferSize.split("$value$"),szEval="",i=0;i<szEvalA.length;i++)szEval+=szEvalA[i],i<szEvalA.length-1&&(szEval+="nValue");nStrokeWidth=eval(szEval)}else if(this.nBufferSize.match(/value/)){var nDelta=100/(this.nMin+1e-9)*(this.nMax-this.nMin);nStrokeWidth=nDelta>1e3?6+Math.log(nValue/this.nMax):10*nValue/(this.nMax-this.nMin)}else nStrokeWidth=this.nBufferSize;nStrokeWidth*=Math.log(1+1/__featureScaling_lastScale),shapeNode.setAttributeNS(null,"style","stroke:"+szColor+";stroke-width:"+map.Scale.normalX(nStrokeWidth)*map.Scale.nZoomScale+";"+this.szStyle+";stroke-linecap:butt;");break;default:shapeNode.setAttributeNS(null,"style","fill:"+szColor+";"+this.szStyle);break}return shapeNode.setAttributeNS(szMapNs,"class",nClass),shapeNode},MapTheme.prototype.unPaintShape=function(e){if("line+buffer"==this.szShapeType){var t=e.getAttributeNS(null,"id"),i=SVGDocument.getElementById(t+":paint");i&&i.parentNode.removeChild(i)}e.removeAttributeNS(null,"style"),e.removeAttributeNS(szMapNs,"class")},MapTheme.prototype.zoomToClass=function(e,t){_TRACE("== MapTheme.zoomToClass() ===> ");var i=0;if(this.szFlag.match(/DOMINANT/))for(var a in this.itemA)this.itemA[a].nClass==e&&i++;else i=this.partsA[e].nCount;if(0!==i){var s,n=null;if(this.szFlag.match(/CHART/))for(var l=this.chartGroup.childNodes,h=0;h<l.length;h++){var o=l.item(h);if(null==o.getAttributeNS(szMapNs,"class")||""===o.getAttributeNS(szMapNs,"class"))for(var r=o.firstChild.childNodes,m=0;m<r.length;m++){var p=r.item(m);Number(p.getAttributeNS(szMapNs,"class"))}else Number(o.getAttributeNS(szMapNs,"class"))}else{if(this.szFlag.match(/DOMINANT/)){for(a in this.itemA)if(this.itemA[a].nClass==e&&"highlight"==this.evidenceMode)for(n=this.getItemNodes(a),s=0;s<n.length;s++);else if(this.itemA[a].nClass!=e&&"highlight"!=this.evidenceMode)for(n=this.getItemNodes(a),s=0;s<n.length;s++);}else{var c=new point(1e5,1e5),u=new point(-1e5,-1e5),d=this.partsA[e].min,A=this.partsA[e].max;for(h=1;h<t;h++)d=Math.min(d,this.partsA[e+h].min),A=Math.max(A,this.partsA[e+h].max);for(a in this.szFlag.match(/CATEGORICAL/)&&(d++,A++),this.itemA)if(this.itemA[a].nValuesA[0]>d&&this.itemA[a].nValuesA[0]<A)for(n=this.getItemNodes(a),s=0;s<n.length;s++){var S=map.Dom.getBox(n[s]);if(0===S.width||0===S.height){var g=getMatrix(n[s]);S.x+=g[4],S.y+=g[5],S.width=map.Scale.viewBox.width/20,S.height=map.Scale.viewBox.height/20,S.x-=S.width/2,S.y-=S.height/2}var z=map.Scale.getMapOffset(n[s]);S.x+=z.x,S.y+=z.y,c.x=Math.min(c.x,S.x),c.y=Math.min(c.y,S.y),u.x=Math.max(u.x,S.x+S.width),u.y=Math.max(u.y,S.y+S.height)}var f=new box(c.x,c.y,u.x-c.x,u.y-c.y);f.scale(1.2),f=map.Zoom.clipArea(f),map.Zoom.setNewArea(f)}_TRACE("== zoomToClass done === ")}}else displayMessage("No members !")},MapTheme.prototype.markClass=function(e,t){if(_TRACE("== MapTheme.markClass("+e+") ===> "),!1!==this.fMarkEnable)if(map.Themes.enableSubThemes&&this.szFlag.match(/DOMINANT|COMPOSE/)&&!this.szFlag.match(/CHART/)){if(this.szFlag.match(/SUBTHEME/))return;this.createSubTheme(e)}else if(isNaN(e))displayMessage("no class!");else{var i=this.szItemFilter&&this.szItemFilter.length;if(this.szFlag.match(/CHART/)&&!i||(this.fUnmarkEnable=!0,this.unmarkClass(),this.fUnmarkEnable=!1),!1!==this.fMarkEnable){var a=0;if(this.szFlag.match(/DOMINANT/)&&!this.szFlag.match(/CHART/))for(var s in this.itemA)this.itemA[s].nClass==e&&a++;else a=1==this.partsA.length&&this.szFlag.match(/DOPACITY/)?99:this.partsA[e]?this.partsA[e].nCount:0;if(a>500&&"highlight"==this.evidenceMode)displayMessage("Sorry ! to many members");else if(0!==a){var n;clearMessage(),highLightList.removeAll();var l=null,h=(this.fShadow?5:10)/this.nScale;if(this.szFlag.match(/CHART/)){for(var o=this.chartGroup.childNodes,r=[],m=0;m<o.length;m++){var p=o.item(m);if(null==p.getAttributeNS(szMapNs,"class")||""===p.getAttributeNS(szMapNs,"class"))for(var c=p.getElementsByTagName("g"),u=0;u<c.length;u++)for(var d=c.item(u).childNodes,A=0;A<d.length;A++){var S=d.item(A);if(S.getAttributeNS&&S.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/PLOT/)&&"isolate_gray"!=this.evidenceMode){var g=S.getAttributeNS(null,"transform");g&&g.length&&(S.setAttributeNS(szMapNs,"orig-transform",g),S.setAttributeNS(null,"transform",""))}var z=Number(S.getAttributeNS(szMapNs,"class"));if(this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(this.szFieldsA.length>1||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/)))!0===this.markedClasses[z]?(S.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),S.style.setProperty("fill-opacity","1","")):(S.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),S.style.setProperty("fill-opacity","0.85",""));else if(!0===this.markedClasses[z])i||(S.style.setProperty("display","inline",""),S.getAttributeNS(szMapNs,"save-style")&&S.setAttributeNS(null,"style",S.getAttributeNS(szMapNs,"save-style")),r.push(p));else if("isolate_gray"==this.evidenceMode){S.getAttributeNS(szMapNs,"save-style")||S.setAttributeNS(szMapNs,"save-style",S.getAttributeNS(null,"style")),S.style.setProperty("fill","#bbbbbb",""),"none"!=S.style.getPropertyValue("stroke")&&S.style.setProperty("stroke","#888888","");var f=S.style.getPropertyValue("fill-opacity");this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/WAFFLE/)?(S.style.setProperty("fill-opacity","0",""),S.style.setProperty("stroke-opacity",String(.9*f),""),S.style.setProperty("stroke-width",String(h),"")):S.style.setProperty("fill-opacity",String(0),"")}else S.style.setProperty("display","none","")}}else{z=Number(p.getAttributeNS(szMapNs,"class"));!0===this.markedClasses[z]?i||(this.szFlag.match(/VECTOR/)?(p.firstChild.style.setProperty("stroke","",""),p.firstChild.style.setProperty("stroke-opacity","",""),p.firstChild.style.setProperty("marker-end","",""),p.style.setProperty("display","inline","")):(p.style.setProperty("display","inline",""),(z=p.getAttributeNS(szMapNs,"fill"))&&p.style.setProperty("fill",z,"")),r.push(p)):"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(p.firstChild.style.setProperty("stroke","#888888",""),p.firstChild.style.setProperty("stroke-opacity","0.5",""),p.firstChild.style.setProperty("marker-end","none","")):(p.setAttributeNS(szMapNs,"fill",p.style.getPropertyValue("fill")),p.style.setProperty("fill","#bbbbbb",""),p.setAttributeNS(szMapNs,"stroke",p.style.getPropertyValue("fill")),p.style.setProperty("stroke","#888888",""),p.setAttributeNS(szMapNs,"fill-opacity",p.style.getPropertyValue("fill-opacity")),p.style.setProperty("fill-opacity","0.05","")):p.style.setProperty("display","none","")}}r.forEach((function(e){e.parentNode.appendChild(e)}))}else{if(this.beginDraw(),this.szFlag.match(/DOMINANT/)){for(s in this.itemA)if(this.itemA[s].nClass==e&&"highlight"==this.evidenceMode)for(l=this.getItemNodes(s),n=0;n<l.length;n++)highLightList.addItem(l[n]);else if(this.itemA[s].nClass!=e&&"highlight"!=this.evidenceMode)for(l=this.getItemNodes(s),n=0;n<l.length;n++)l[n].setAttributeNS(szMapNs,"themestyle",l[n].getAttributeNS(null,"style")),l[n].style.setProperty("display","none","")}else{var T=this.partsA[e].min,x=this.partsA[e].max;for(m=1;m<t;m++)T=Math.min(T,this.partsA[e+m].min),x=Math.max(x,this.partsA[e+m].max);for(s in this.itemA){var y=!1;if(this.markedClasses&&this.markedClasses[this.itemA[s].nClass]&&(y=!0),y){if("highlight"==this.evidenceMode)for(l=this.getItemNodes(s),n=0;n<l.length;n++)highLightList.addItem(l[n])}else if("highlight"!=this.evidenceMode)for(l=this.getItemNodes(s),n=0;n<l.length;n++)if(this.szFlag.match(/BUFFER/)){(b=SVGDocument.getElementById(l[n].getAttributeNS(null,"id")+":paint"))&&b.style.setProperty("display","none","")}else{l[n].setAttributeNS(szMapNs,"themestyle",l[n].getAttributeNS(null,"style")),l[n].setAttributeNS(null,"style",l[n].getAttributeNS(szMapNs,"origthemestyle"));var b,M=l[n].getAttribute("id");l[n].firstChild&&l[n].firstChild.nextSibling&&(M=l[n].firstChild.nextSibling.getAttribute("id")||M),(b=SVGDocument.getElementById(M+"L"))&&(b.setAttributeNS(szMapNs,"display",b.style.getPropertyValue("display")),b.style.setProperty("display","none","")),(b=SVGDocument.getElementById(M+"L:bg"))&&(b.setAttributeNS(szMapNs,"display",b.style.getPropertyValue("display")),b.style.setProperty("display","none","")),(b=SVGDocument.getElementById(M+":::value"))&&(b.setAttributeNS(szMapNs,"display",b.style.getPropertyValue("display")),b.style.setProperty("display","none","")),(b=SVGDocument.getElementById(M+":::value:bg"))&&(b.setAttributeNS(szMapNs,"display",b.style.getPropertyValue("display")),b.style.setProperty("display","none",""))}}}this.endDraw(),this.fMarkClass=!0,_TRACE("== markClass done === ")}}else displayMessage("class has no members !",3e3)}}},MapTheme.prototype.unmarkClass=function(e){if(!1!==this.fUnmarkEnable)if(this.subTheme)this.removeSubTheme();else{if(this.szItemFilter&&this.szItemFilter.length)return this.fMarkEnable=!0,void this.filterItems(this.szItemFilter,this.itemFilterOpt);if(_TRACE("== MapTheme.unmarkClass() ===> "),clearMessage(),this.szFlag.match(/CHART/)){for(var t=this.chartGroup.childNodes,i=0;i<t.length;i++){var a=t.item(i);if(null==a.getAttributeNS(szMapNs,"class")||""===a.getAttributeNS(szMapNs,"class"))for(var s=a.getElementsByTagName("g"),n=0;n<s.length;n++)for(var l=s.item(n).childNodes,h=0;h<l.length;h++){var o=l.item(h);if(o.getAttributeNS&&o.getAttributeNS(szMapNs,"class")){if(this.szFlag.match(/SEQUENCE/)){var r=o.getAttributeNS(szMapNs,"orig-transform");r&&r.length&&(o.removeAttributeNS(szMapNs,"orig-transform"),o.setAttributeNS(null,"transform",r))}this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(o.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),o.style.setProperty("fill-opacity","1","")),o.style&&(o.style.setProperty("display","inline",""),o.getAttributeNS(szMapNs,"save-style")&&o.setAttributeNS(null,"style",o.getAttributeNS(szMapNs,"save-style")))}}else this.szFlag.match(/VECTOR/)?(a.firstChild.style.setProperty("stroke","",""),a.firstChild.style.setProperty("stroke-opacity","",""),a.firstChild.style.setProperty("marker-end","",""),a.style.setProperty("display","inline","")):a.style.setProperty("display","inline","")}this.szFlag.match(/TEXTONLY/)&&setTimeout((function(){map.Layer.adaptLabel()}),10)}else{if(this.beginDraw(),"highlight"!=this.evidenceMode)for(var m in this.itemA)for(var p=this.getItemNodes(m),c=0;c<p.length;c++)if(this.szFlag.match(/BUFFER/)){(d=SVGDocument.getElementById(p[c].getAttributeNS(null,"id")+":paint"))&&d.style.setProperty("display","inline","")}else{var u=p[c].getAttributeNS(szMapNs,"themestyle");if(u&&u.length&&"null"!=u){p[c].setAttributeNS(null,"style",u),p[c].removeAttributeNS(szMapNs,"themestyle");var d,A=p[c].getAttribute("id");p[c].firstChild&&p[c].firstChild.nextSibling&&(A=p[c].firstChild.nextSibling.getAttribute("id")||A),(d=SVGDocument.getElementById(A+"L"))&&d.style.setProperty("display",d.getAttributeNS(szMapNs,"display"),""),(d=SVGDocument.getElementById(A+"L:bg"))&&d.style.setProperty("display",d.getAttributeNS(szMapNs,"display"),""),(d=SVGDocument.getElementById(A+":::value"))&&d.style.setProperty("display",d.getAttributeNS(szMapNs,"display"),""),(d=SVGDocument.getElementById(A+":::value:bg"))&&d.style.setProperty("display",d.getAttributeNS(szMapNs,"display"),"")}}else highLightList.removeAll();this.endDraw(),this.fMarkClass=!1,_TRACE("== unmarkClass done === ")}}},MapTheme.prototype.showClass=function(e,t,i){_TRACE("== MapTheme.showClass() ===> ");var a;if(this.szFlag.match(/DOMINANT/))for(var s in this.itemA)this.itemA[s].nClass==e&&0;else this.partsA[e].nCount;clearMessage();var n=null,l=i?"inline":"none";if(this.szFlag.match(/CHART/))for(var h=this.chartGroup.childNodes,o=0;o<h.length;o++){var r=h.item(o);if(null==r.getAttributeNS(szMapNs,"class")||""===r.getAttributeNS(szMapNs,"class"))for(var m=r.firstChild.childNodes,p=0;p<m.length;p++){var c=m.item(p);Number(c.getAttributeNS(szMapNs,"class"))==e&&c.style.setProperty("display",l,"")}else Number(r.getAttributeNS(szMapNs,"class"))==e&&r.style.setProperty("display",l,"")}else{if(this.beginDraw(),this.szFlag.match(/DOMINANT/)){for(s in this.itemA)if(this.itemA[s].nClass==e)for(n=this.getItemNodes(s),a=0;a<n.length;a++)n[a].setAttributeNS(szMapNs,"themestyle",n[a].getAttributeNS(null,"style")),n[a].style.setProperty("display",l,"")}else{var u=this.partsA[e].min,d=this.partsA[e].max;for(o=1;o<t;o++)u=Math.min(u,this.partsA[e+o].min),d=Math.max(d,this.partsA[e+o].max);for(s in this.szFlag.match(/CATEGORICAL/)&&(u++,d++),this.itemA)if(this.szFlag.match(/CATEGORICAL/)&&this.itemA[s].nValuesA[0]==u||this.itemA[s].nValuesA[0]>u&&this.itemA[s].nValuesA[0]<d)for(n=this.getItemNodes(s),a=0;a<n.length;a++)if(this.szFlag.match(/BUFFER/)){var A=SVGDocument.getElementById(n[a].getAttributeNS(null,"id")+":paint");A&&A.style.setProperty("display",l,"")}else if(i){var S=n[a].getAttributeNS(szMapNs,"themestyle");S&&S.length&&"null"!=S&&(n[a].setAttributeNS(null,"style",S),n[a].removeAttributeNS(szMapNs,"themestyle"))}else n[a].setAttributeNS(szMapNs,"themestyle",n[a].getAttributeNS(null,"style")),n[a].setAttributeNS(null,"style",n[a].getAttributeNS(szMapNs,"origthemestyle"))}this.endDraw()}_TRACE("== showClass done === ")},MapTheme.prototype.setTimeFrame=function(e,t){_TRACE("== MapTheme.setTimeFrame("+e+","+t+") ===> "),clearMessage(),highLightList.removeAll();var i=this.szItemFilter&&this.szItemFilter.length,a=(this.fShadow?5:10)/this.nScale,s=this.chartGroup.childNodes;this.szFlag.match(/CHART/)&&(s=this.chartGroup.parentNode.childNodes);for(var n=[],l=0;l<s.length;l++){var h=s.item(l);if(null==h.getAttributeNS(szMapNs,"time")||""===h.getAttributeNS(szMapNs,"time"))for(var o=h.getElementsByTagName("g"),r=0;r<o.length;r++)for(var m=o.item(r).childNodes,p=0;p<m.length;p++){var c=m.item(p);if(c.getAttributeNS&&c.getAttributeNS(szMapNs,"time")){var u=Number(c.getAttributeNS(szMapNs,"time"));if(this.szFlag.match(/BAR/)&&this.szFlag.match(/3D/)&&!this.szFlag.match(/STACKED/)&&(this.szFieldsA.length>1||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/CATEGORICAL/)))u>=e&&u<=t?(c.setAttributeNS(null,"transform","matrix(1 0 0 1 -10 6.6)"),c.style.setProperty("fill-opacity","1","")):(c.setAttributeNS(null,"transform","matrix(1 0 0 1 0 0)"),c.style.setProperty("fill-opacity","0.85",""));else if(u>=e&&u<=t)i||(c.style.setProperty("display","inline",""),c.getAttributeNS(szMapNs,"save-style")&&c.setAttributeNS(null,"style",c.getAttributeNS(szMapNs,"save-style")),n.push(h));else if("isolate_gray"==this.evidenceMode){c.getAttributeNS(szMapNs,"save-style")||c.setAttributeNS(szMapNs,"save-style",c.getAttributeNS(null,"style")),c.style.setProperty("fill","#bbbbbb",""),"none"!=c.style.getPropertyValue("stroke")&&c.style.setProperty("stroke","#888888","");var d=c.style.getPropertyValue("fill-opacity");this.szFlag.match(/SEQUENCE/)||this.szFlag.match(/WAFFLE/)?(c.style.setProperty("fill-opacity","0",""),c.style.setProperty("stroke-opacity",String(.9*d),""),c.style.setProperty("stroke-width",String(a),"")):c.style.setProperty("fill-opacity",String(0),"")}else c.style.setProperty("display","none","")}}else if((u=Number(h.getAttributeNS(szMapNs,"time")))>=e&&u<=t){if(!i){var A;if(this.szFlag.match(/VECTOR/))h.firstChild.style.setProperty("stroke","",""),h.firstChild.style.setProperty("stroke-opacity","",""),h.firstChild.style.setProperty("marker-end","",""),h.style.setProperty("display","inline","");else h.style.setProperty("display","inline",""),(A=h.getAttributeNS(szMapNs,"fill"))&&h.style.setProperty("fill",A,"");n.push(h)}}else"isolate_gray"==this.evidenceMode?this.szFlag.match(/VECTOR/)?(h.firstChild.style.setProperty("stroke","#888888",""),h.firstChild.style.setProperty("stroke-opacity","0.5",""),h.firstChild.style.setProperty("marker-end","none","")):(h.setAttributeNS(szMapNs,"fill",h.style.getPropertyValue("fill")),h.style.setProperty("fill","#bbbbbb",""),h.setAttributeNS(szMapNs,"stroke",h.style.getPropertyValue("fill")),h.style.setProperty("stroke","#888888",""),h.setAttributeNS(szMapNs,"fill-opacity",h.style.getPropertyValue("fill-opacity")),h.style.setProperty("fill-opacity","0.05","")):h.style.setProperty("display","none","")}n.forEach((function(e){e.parentNode.appendChild(e)})),_TRACE("== setTimeFrame done === ")},MapTheme.prototype.createSubTheme=function(e){if(this.subTheme&&this.removeSubTheme(),null!=e||this.markedClasses&&this.markedClasses.length){var t="";this.coTable&&void 0!==this.coTable&&(t+="dbtable:"+this.coTable+";"),this.szSelectionField&&void 0!==this.szSelectionField&&(t+="lookupfield:"+this.szSelectionField+";"),this.szAlphaField&&void 0!==this.szAlphaField&&(t+="alphafield:"+this.szAlphaField+";"),this.szAlphaField100&&void 0!==this.szAlphaField100&&(t+="alphafield100:"+this.szAlphaField100+";"),this.szTitleField&&void 0!==this.szTitleField&&(t+="titlefield:"+this.szTitleField+";"),this.nDopacityScale&&void 0!==this.nDopacityScale&&(t+="dopacityscale:"+this.nDopacityScale+";"),this.nDopacityPow&&void 0!==this.nDopacityPow&&(t+="dopacitypow:"+this.nDopacityPow+";");var i="lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";";i+="lookupsuffix:"+(this.szSelectionFieldSuffix||null)+";",i+="lookupprefix:"+(this.szSelectionFieldPrefix||null)+";",i+="lookupdigits:"+(Number(this.nSelectionFieldDigits)||null)+";",i+="lookuptonumber:"+(this.fSelectionFieldToNumber||null)+";",t+=i+="lookuptoupper:"+(this.fSelectionFieldToUpper||null)+";",this.szAggregationField&&void 0!==this.szAggregationField&&(t+="aggregationfield:"+this.szAggregationField+";"),this.szUnits&&void 0!==this.szUnits&&(t+="units:"+this.szUnits+";");var a="";if(this.szFlag.match(/DOPACITY/)&&(a+="DOPACITYMAX|"),this.szFlag.match(/AGGREGATE/)&&(a+="AGGREGATE|"),this.szFlag.match(/GROUP/)&&(a+="GROUP|"),this.szFlag.match(/SUM/)&&(a+="SUM|"),this.szFlag.match(/ZEROISVALUE/)&&(a+="ZEROISVALUE|"),this.szFlag.match(/VALUES/)&&(a+="VALUES|"),map.Themes.enableMultiChoropleth=!0,this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/)&&this.szLabelA){for(var s=[],n=[],l=0;l<this.markedClassesA.length;l++)s.push(this.szLabelA[this.markedClassesA[l]]),n.push(this.colorScheme[this.markedClassesA[l]]);if(this.markedClassesA&&this.markedClassesA.length>1){var h=this.getDefinitionObject();h.style.type+="|NOINFO",h.style.values=s,h.style.colorscheme=n,this.subTheme=map.Themes.newThemeByObj(h)}else t+='filter:WHERE "'+this.szFields+'" IN "('+s.join(",")+')";',this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields,this.szField100,"type:CHOROPLETH|CATEGORICAL|NOINFO|NOLEGEND|SUBTHEME|"+a+";colorscheme:7|white|"+this.colorScheme[e]+";"+t,this.szLabelA[e],""),this.subTheme.parentTheme=this}else if(this.markedClassesA&&this.markedClassesA.length>1){var o=this.szFields.split("|"),r="",m="",p="";for(l=0;l<this.markedClassesA.length;l++)r+=(r.length?"|":"")+o[this.markedClassesA[l]],m+=(m.length?"|":"")+this.colorScheme[this.markedClassesA[l]],p+=(p.length?"|":"")+this.szLabelA[this.markedClassesA[l]];this.subTheme=map.Themes.newTheme(this.szThemes,r,this.szField100,"type:"+this.szFlag+"|SUBTHEME|NOINFO;colorscheme:"+m+";label:"+p+";"+t)}else e=this.markedClassesA[0]||e,this.subTheme=map.Themes.newTheme(this.szThemes,this.szFields.split("|")[e],this.szField100,"type:CHOROPLETH|LOG|DOPACITY|NOINFO|NOLEGEND|SUBTHEME|"+a+";colorscheme:7|white|"+this.colorScheme[e]+";"+t+";alphafield:null;alphafield100:null;dopacitypow:1;dopacityscale:2;",this.szLabelA?this.szLabelA[e]:"","");map.Themes.subTheme=this}},MapTheme.prototype.removeSubTheme=function(){map.Themes.enableMultiChoropleth=!1,this.subTheme&&(map.Themes.subTheme=!1,map.Themes.removeTheme(null,this.subTheme.szId),this.subTheme=null,map.Themes.realizeDone(this))},MapTheme.prototype.isItemInFilter=function(objTheme,item,szFilter,opt){if(0===szFilter.length&&(void 0===opt||!opt.field))return!0;if(void 0!==item.dbIndex||void 0!==item.dbIndexA){var row=item.dbIndex||item.dbIndexA[0];if(szFilter.length){if(this.__szValue=objTheme.dbRecords[row].join(" "),eval("this.__szValue.match(/"+szFilter.replace(/\//gi,"\\/")+"/i)"))return!0}else if(opt&&opt.field){for(var i=0;i<objTheme.dbFields.length;i++)if(objTheme.dbFields[i].id==opt.field){if(opt.min&&objTheme.dbRecords[row][i]<opt.min)return!1;if(opt.max&&objTheme.dbRecords[row][i]>opt.max)return!1;if(opt.txt&&objTheme.dbRecords[row][i]!=opt.txt)return!1}return!0}}return!1},MapTheme.prototype.filterItems=function(e,t){if(_TRACE("== MapTheme.filterItems() ===> "),!1!==this.fMarkEnable){this.szItemFilter=e,this.itemFilterOpt=t,this.filterNodesA=e.length||t&&t.field?[]:null;for(var i=null,a=0;a<this.szThemesA.length&&(!(i=this.objThemesA[this.szThemesA[a]])||!i.dbRecords);a++);if(i&&i.dbRecords){if(this.szFlag.match(/CHART/)){var s=this.chartGroup.childNodes;for(a=0;a<s.length;a++){var n=[],l=s.item(a);n.push(l);for(var h=0;h<n.length;h++){var o=n[h].getAttributeNS(null,"id");o=o.split(":")[1]+"::"+o.split(":")[3],this.itemA[o]?this.isItemInFilter(i,this.itemA[o],e,t)?(l.style.setProperty("display","inline",""),this.filterNodesA&&this.filterNodesA.push(o)):l.style.setProperty("display","none",""):l.style.setProperty("display","inline","")}}}else{for(var r in this.beginDraw(),this.itemA)if(this.itemA[r]&&void 0!==this.itemA[r].dbIndex)if(this.isItemInFilter(i,this.itemA[r],e,t)){this.filterNodesA&&this.filterNodesA.push(r);for(var m=this.getItemNodes(r),p=0;p<m.length;p++)if(this.szFlag.match(/BUFFER/)){(u=SVGDocument.getElementById(m[p].getAttributeNS(null,"id")+":paint"))&&u.style.setProperty("display","inline","")}else{var c=m[p].getAttributeNS(szMapNs,"themestyle");if(c&&c.length&&"null"!=c)m[p].setAttributeNS(null,"style",c),m[p].removeAttributeNS(szMapNs,"themestyle"),(u=SVGDocument.getElementById(m[p].firstChild.nextSibling.getAttribute("id")+"L"))&&u.style.setProperty("display",u.getAttributeNS(szMapNs,"display"),""),(u=SVGDocument.getElementById(m[p].firstChild.nextSibling.getAttribute("id")+"L:bg"))&&u.style.setProperty("display",u.getAttributeNS(szMapNs,"display"),"")}}else for(m=this.getItemNodes(r),p=0;p<m.length;p++){var u;if(this.szFlag.match(/BUFFER/))(u=SVGDocument.getElementById(m[p].getAttributeNS(null,"id")+":paint"))&&u.style.setProperty("display","none","");else m[p].getAttributeNS(szMapNs,"themestyle")||m[p].setAttributeNS(szMapNs,"themestyle",m[p].getAttributeNS(null,"style")),m[p].setAttributeNS(null,"style",m[p].getAttributeNS(szMapNs,"origthemestyle")),(u=SVGDocument.getElementById(m[p].firstChild.nextSibling.getAttribute("id")+"L"))&&(u.setAttributeNS(szMapNs,"display",u.style.getPropertyValue("display")),u.style.setProperty("display","none","")),(u=SVGDocument.getElementById(m[p].firstChild.nextSibling.getAttribute("id")+"L:bg"))&&(u.setAttributeNS(szMapNs,"display",u.style.getPropertyValue("display")),u.style.setProperty("display","none",""))}this.endDraw()}this.fMarkClass=!0,_TRACE("== filterItems done === ")}}},MapTheme.prototype.selectFilterItems=function(){map.Selections.newSelection("generic",this.filterNodesA,"type:queryresult",this.szItemFilter)},MapTheme.prototype.highlightItems=function(e,t){if(""!==e){highLightList.removeAll();var i=e.split(t||","),a=this;i.forEach((function(e){if(a.szFlag.match(/CHART/)){var t=SVGDocument.getElementById(a.szId+":"+e+":chartgroup");t||(e=a.szThemesA[0]+"::"+e,t=SVGDocument.getElementById(a.szId+":"+e+":chartgroup")),highLightList.addItem(t.parentNode,"isolate"),map.displayInfo(null,t.firstChild,"add|fix")}else{for(var i=a.getItemNodes(e),s=0;s<i.length;s++)highLightList.addItem(i[s]);map.displayInfo(null,i[0].firstChild.nextSibling,"add|fix")}}))}else this.clearHighlightItems()},MapTheme.prototype.clearHighlightItems=function(){highLightList.removeAll(),map.removeInfo()},MapTheme.prototype.labelMap=function(e){_TRACE("== MapTheme.labelMap("+e+")===> "+this.szId),_TRACE("== ==> ");var t=map.Zoom.getBox(),i=null;if(this.szValuesTextStyle="font-family:verdana;font-size:"+map.Scale.normalX(11)+"px;pointer-events:none",!e||0===e){var a=0;e=0,this.indexA=[];var s=0,n=0;if(this.fClipCharts){for(a in this.itemA)if(n++,this.itemA[a].nValuesA&&this.itemA[a].nValuesA.length>0){if(!(i=this.getNodePosition(this.itemA[a].szSelectionId)))continue;if(i.x<t.x||i.x>t.x+t.width||i.y<t.y||i.y>t.y+t.height){var l;this.nSkipCount++,(l=SVGDocument.getElementById(this.szId+":"+a+":chart"))&&(l.parentNode.removeChild(l),this.chartPosA[this.itemA[a].szSelectionId]=null,this.posItemA[this.itemA[a].szSelectionId]=null);continue}this.indexA[this.indexA.length]=a,s++}}else for(a in this.itemA)this.indexA[this.indexA.length]=a,n++,s++;_TRACE(s+" to draw ("+n+")"),s>this.nMaxThemeCharts&&(this.indexA.length=0,this.nSkipCount=s),this.mapSleep&&(this.mapSleep.nCount=s),this.fEnableProgressBar=!1}for(var h=e;h<this.indexA.length;h++){if(this.fCancel)return displayMessage("Canceled by user",1e3,!0),void(this.fCancel=!1);if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(h,10)))return this.fContinue=!0,void(this.continueIndex=h);a=this.indexA[h];if(this.nDoneCount++,this.itemA[a].nValuesA&&this.itemA[a].nValuesA.length>0){if(!(i=this.getNodePosition(this.itemA[a].szSelectionId))){_TRACE("missing position: "+a),this.nMissingPositionCount++;continue}if(this.fClipCharts&&!this.szFlag.match(/BUFFER/)&&(i.x<t.x||i.x>t.x+t.width||i.y<t.y||i.y>t.y+t.height)){this.nSkipCount++;continue}for(var o=this.getItemNodes(a),r=0;r<o.length;r++){var m=this.itemA[a].nValue;!this.szValueField&&this.itemA[a].szLabel&&(m=this.itemA[a].szLabel),this.labelShape(o[r],this.itemA[a].szColor,m)}}}this.fMakeLabel=!1,setTimeout((function(){map.Layer.adaptLabel(null)}),10),_TRACE("== done === ")},MapTheme.prototype.unlabelMap=function(){for(var e in map.Layer.generatedLabelA)map.Dom.removeElementById(e),map.Layer.generatedLabelA[e]=null},MapTheme.prototype.labelShape=function(e,t,i){if(this.szFlag.match(/VALUES/)&&"undefined"!=i&&void 0!==i){if(this.szFlag.match(/NOZERO/)&&0===i)return;var a="font-family:verdana;font-weight:normal",s=e.parentNode.getAttributeNS(null,"id"),n=SVGDocument.getElementById(s+":label");if(n){var l=SVGDocument.getElementById(s+":values:bg");l||(l=map.Dom.newGroup(n.parentNode,s+":values:bg"),map.Layer.generatedLabelA[s+":values:bg"]=l);var h=SVGDocument.getElementById(s+":values");h||(h=map.Dom.newGroup(n.parentNode,s+":values"),map.Layer.generatedLabelA[s+":values"]=h);try{var o=e.firstChild.nextSibling.getAttributeNS(null,"id").split("#"),r=o[0]+"L"+(o[1]?"#"+o[1]:"")}catch(t){r=e.getAttributeNS(null,"id")+":::value"}if(SVGDocument.getElementById(r))return;var m=__maptheme_getChartColors(t);if("string"==typeof i)var p=i;else p=this.formatValue(i,this.nValueDecimals||0)+(this.szUnit.match(/\%/)?"%":"");var c=this.szTextColor||m.highColor,u=m.lowColor,d=1,A=Math.max(.3,e.style.getPropertyValue("fill-opacity")||"1");this.szFlag.match(/DTEXT/)&&(d=Math.max(.7,Math.min(1.5,2/Math.sqrt(this.nMax)*Math.sqrt(i))));var S=map.Scale.normalX(11)*map.Scale.nZoomScale*d*map.Scale.nLabelScaling*(this.nLabelScale||1),g=map.Dom.newText(l,0,0,a+";font-size:"+S+"px;text-anchor:middle;fill:none;stroke:"+u+";stroke-width:"+map.Scale.normalX(4)*map.Scale.nZoomScale+";stroke-opacity:0.5;pointer-events:none;display:none;stroke-linejoin:bevel;",p),z=map.Dom.newText(h,0,0,a+";font-size:"+S+"px;text-anchor:middle;fill:"+c+";stroke:none;pointer-events:none;display:none;",p);z.setAttributeNS(null,"id",r),g.setAttributeNS(null,"id",r+":bg"),this.szFlag.match(/DOPACITY/)&&(z.style.setProperty("fill-opacity",A,""),g.style.setProperty("stroke-opacity",.3*A,""));var f=e.getAttributeNS(szMapNs,"center");if(f)var T=f.split(","),x=new point(Number(T[0].split(":")[1]),Number(T[1].split(":")[1]));else x=this.getNodePosition(e.getAttributeNS(null,"id"));x?(z.fu.setPosition(x.x,x.y),g.fu.setPosition(x.x,x.y)):_TRACE(e.getAttributeNS(null,"id")+" no position")}}},MapTheme.prototype.zoomTo=function(){_TRACE("== MapTheme.zoomTo() ===> ");var e=new point(1e5,1e5),t=new point(-1e5,-1e5);if(this.szFlag.match(/FEATURE/)){var i=SVGDocument.getElementById(this.szThemesA[0]),a=map.Dom.getBox(i);map.Zoom.setNewArea(a)}else{if(this.szFlag.match(/CHART/))for(var s in this.itemA){var n=this.itemA[s].ptPos||this.getNodePosition(this.itemA[s].szSelectionId);n&&n.x&&n.y&&(e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),t.x=Math.max(t.x,n.x),t.y=Math.max(t.y,n.y))}else for(var s in this.itemA)for(var l=this.getItemNodes(s),h=0;h<l.length;h++){if(0===(a=map.Dom.getBox(l[h])).width||0===a.height){var o=getMatrix(l[h]);a.x+=o[4],a.y+=o[5],a.width=map.Scale.viewBox.width/20,a.height=map.Scale.viewBox.height/20,a.x-=a.width/2,a.y-=a.height/2}var r=map.Scale.getMapOffset(l[h]);a.x+=r.x,a.y+=r.y,e.x=Math.min(e.x,a.x),e.y=Math.min(e.y,a.y),t.x=Math.max(t.x,a.x+a.width),t.y=Math.max(t.y,a.y+a.height)}var m=new box(e.x,e.y,t.x-e.x,t.y-e.y);m.scale(1),(m=map.Zoom.clipArea(m)).width>=0&&m.height>=0&&map.Zoom.setNewArea(m),_TRACE("== zoomTo done === ")}},MapTheme.prototype.createChartGroup=function(e){if(!this.chartGroup&&(this.szFlag.match(/FEATURE/)?(this.chartGroup=map.Dom.newGroup(map.Layer.layerNode,this.szThemesA[0]),map.Dom.newGroup(map.Layer.layerNode,this.szThemesA[0]+":label"),map.Layer.listA[this.szThemesA[0]]=new ixMap.Layer.Item(null),map.Layer.listA[this.szThemesA[0]].szName=this.szThemesA[0],map.Layer.listA[this.szThemesA[0]].szHighlight="fill:url(#DiagUp200000000);stroke:black;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;",map.Layer.listA[this.szThemesA[0]].szSelection=this.szItemField,(this.nFeatureLower||this.nFeatureUpper)&&(map.Layer.depListA[this.szThemesA[0]]={},map.Layer.depListA[this.szThemesA[0]].nLower=this.nFeatureLower||0,map.Layer.depListA[this.szThemesA[0]].nUpper=this.nFeatureUpper||1e9,map.Layer.depListA[this.szThemesA[0]].shapeId=this.szThemesA[0],map.Layer.depListA[this.szThemesA[0]].szDisplayAttribute="none",map.Layer.depListA[this.szThemesA[0]].szFeature=this.szThemesA[0],setTimeout("map.Layer.switchScaleDependentLayer(null)",10))):this.chartGroup=map.Dom.newGroup(e,this.szId+":chartgroup"),this.chartGroup.style.setProperty("opacity",String(this.nOpacity?this.nOpacity:1),""),0==this.fVisible&&this.chartGroup.style.setProperty("display","none",""),this.szFlag.match(/SILENT/)&&this.chartGroup.style.setProperty("pointer-events","none",""),this.szFlag.match(/VECTOR/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/NOSCALE/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/AGGREGATE/)&&(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/GRIDSIZE/)&&!this.szFlag.match(/AGGREGATE/)&&antiZoomAndPanList.addGroup(this.chartGroup),this.szFlag.match(/BUFFER/))){this.szFlag.match(/OVERLAY/)&&!this.szShapeType.match(/line/)&&this.chartGroup.style.setProperty("opacity",String(1),"");map.Layer.getLayerObj(this.szThemesA[0]);this.chartGroup.style.setProperty("pointer-events","none",""),antiZoomAndPanList.addGroup(this.chartGroup);var t=this.colorScheme[0],i=this.colorScheme[1]?this.colorScheme[1]:"red";void 0!==this.szBorderColor&&(i=this.szBorderColor);var a="stroke-width:0;";if(void 0!==this.szBorderStyle)switch(this.szBorderStyle){case"dotted":a="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case"dashed":a="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:300,300;";break;case"solid":a="stroke-width:"+map.Scale.normalX(1)+";";break;case"none":a="stroke-width:0;";break}if(void 0!==this.szBorderWidth)switch(this.szBorderWidth){case"thin":a+="stroke-width:"+map.Scale.normalX(.5)+";";break;case"thick":a+="stroke-width:"+map.Scale.normalX(1.5)+";";break;default:a+="stroke-width:"+map.Scale.normalX(this.szBorderWidth)+";";break}var s=this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0;this.chartGroup.setAttributeNS(null,"style","fill:"+t+";fill-opacity:"+s+";stroke:"+i+";"+a+";")}},MapTheme.prototype.chartMap=function(startIndex){if(_TRACE("== MapTheme.chartMap()  "),this.nChartUpper||this.nChartLower){if(this.nChartUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nChartUpper||this.nChartLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nChartLower)return this.chartGroup||this.createChartGroup(map.Layer.objectGroup),this.chartGroup.style.setProperty("display","none",""),this.fVisible=!1,void this.realizeDone();this.chartGroup||this.createChartGroup(map.Layer.objectGroup),this.chartGroup.style.setProperty("display","inline",""),this.fVisible=!0}this.chartGroup&&!startIndex&&(this.chartPosA=[]);var nChartSize=this.nChartSize?this.nChartSize:30,zoomBox=map.Zoom.getBox();if(this.szFlag.match(/AGGREGATE/)&&this.nGridWidth){var deltaX=map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth||0)*map.Scale.nZoomScale;zoomBox.x-=deltaX/2,zoomBox.y-=deltaX/2,zoomBox.width+=deltaX,zoomBox.height+=deltaX}else{var deltaX=map.Scale.normalX(30)*map.Scale.nZoomScale;zoomBox.x-=deltaX/2,zoomBox.y-=deltaX/2,zoomBox.width+=deltaX,zoomBox.height+=deltaX}var mapGeoBounds=map.Zoom.getBoundsOfMapInGeoBounds(),width=(mapGeoBounds[1].x-mapGeoBounds[0].x)/2,tile=Math.floor(Math.round(1/width*100)/100);if(mapGeoBounds[0].x=Math.floor(mapGeoBounds[0].x*tile)/tile,mapGeoBounds[0].y=Math.floor(mapGeoBounds[0].y*tile)/tile,mapGeoBounds[1].x=Math.ceil(mapGeoBounds[1].x*tile)/tile,mapGeoBounds[1].y=Math.ceil(mapGeoBounds[1].y*tile)/tile,this.mapGeoBounds&&this.szFlag.match(/FEATURE/)&&this.szFlag.match(/CLIPTOGEOBOUNDS|CLIPTOVIEW/)&&mapGeoBounds[0].x==this.mapGeoBounds[0].x&&mapGeoBounds[0].y==this.mapGeoBounds[0].y&&mapGeoBounds[1].x==this.mapGeoBounds[1].x&&mapGeoBounds[1].y==this.mapGeoBounds[1].y)this.realizeDone();else{this.mapGeoBounds=new Array(new point(mapGeoBounds[0].x,mapGeoBounds[0].y),new point(mapGeoBounds[1].x,mapGeoBounds[1].y));var ptOff=null,szColor="#777777",szLColor="#888888",nFontSize=8;if(!startIndex||0===startIndex){if(_TRACE("first call to chartMap(), init !"),!this.partsA)return void this.realizeDone();var a=0;startIndex=0,this.indexA=[],this.szValuesLineStyle="stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.5;",this.szValuesLineBgStyle="stroke:"+szLColor+";stroke-width:"+map.Scale.normalX(.5)+";opacity:1;",this.szValuesTextStyle="font-family:"+(this.szTextFont||"arial")+";font-size:"+map.Scale.normalX(nFontSize)+"px;fill:"+szColor+";pointer-events:none",this.szValuesTextBgStyle="font-family:"+(this.szTextFont||"arial")+";font-size:"+map.Scale.normalX(nFontSize)+"px;fill:none;stroke:white;stroke-width:"+map.Scale.normalY(nFontSize)/5+";stroke-opacity:0.8;pointer-events:none;stroke-linejoin:bevel;pointer-events:none";var objectGroup=map.Layer.objectGroup;if(this.chartGroup||this.createChartGroup(objectGroup),this.blur(this.nBlur),this.autoOpacity){var dx=map.Scale.nTrueMapScale*map.Scale.nZoomScale/map.Scale.nNormalSizeScale;this.fillOpacity=1*Math.max(.1,Math.min(1,20/Math.max(1,Math.pow(map.Zoom.nZoom/dx,.5))))}this.mapSleep&&(this.mapSleep.checkSleepMessage="creating charts");var nSize=nChartSize*this.nScale*map.Scale.nFeatureScaling*map.Scale.nObjectScaling*map.Zoom.nZoom;fObjectScaling&&(nSize=nChartSize*this.nScale*map.Scale.nFeatureScaling*map.Scale.nObjectScaling),this.szFlag.match(/LINEAR/)||this.szFlag.match(/SIZEP1/)?this.nSizePow=1:this.szFlag.match(/SIZEP1H/)?this.nSizePow=1.5:this.szFlag.match(/SIZELOG/)||this.szFlag.match(/SIZEP10/)?this.nSizePow=10:this.szFlag.match(/SIZEP4/)?this.nSizePow=4:this.szFlag.match(/SIZEP3/)||this.szFlag.match(/SIZEVOLUME/)?this.nSizePow=3:this.nSizePow=this.nSizePow||2,this.nCharSizeNormal=nChartSize;var nRot=getRotateAttributeValue(map.Scale.canvasNode);if(this.szFlag.match(/\bSORT\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)){for(a in this.indexA=[],this.itemA)this.indexA[this.indexA.length]=a;for(var sortA=[],i=0;i<this.indexA.length;i++){var nValue=this.itemA[this.indexA[i]].nValuesA[this.nActualFrame||0];this.itemA[this.indexA[i]].nSize?nValue=this.itemA[this.indexA[i]].nSize:this.szFlag.match(/SIZE/)&&this.itemA[this.indexA[i]].nValueSum&&(nValue=this.itemA[this.indexA[i]].nValueSum),isNaN(nValue)||sortA.push({a:this.indexA[i],y:nValue})}if(this.szFlag.match(/\bUP\b/)?sortA.sort(this.sortDownChartObjectsCompare):sortA.sort(this.sortUpChartObjectsCompare),this.szValueField&&"$index$"==this.szValueField)for(var i=0;i<sortA.length;i++)this.itemA[sortA[i].a].szValue=String(sortA.length-i);this.indexA=[]}if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/CATEGORICAL/)){for(var s=0;s<this.partsA.length;s++)this.partsA[s].nCount=0,this.partsA[s].nSum=0;this.fRedrawInfo=!0,this.szFlag.match(/SEQUENCE/)&&(this.nFadeNegative=this.nFadeNegative||1)}var nToDraw=0,nCharts=0,nNoPos=0;if(!this.fClipCharts||this.szFlag.match(/BUFFER/)||this.szFlag.match(/\bPOSITION\b/)||this.szFlag.match(/FEATURE/))for(a in this.itemA)this.indexA[this.indexA.length]=a,nCharts++,nToDraw++;else{for(i=0;i<this.partsA.length;i++)this.partsA[i].nCount=0,this.partsA[i].nSum=0;for(a in this.itemA)if(nCharts++,this.itemA[a].nValuesA&&this.itemA[a].nValuesA.length>0){var ptOff=this.itemA[a].ptPos||this.getNodePosition(this.itemA[a].szSelectionId);if(!ptOff){this.missedA[a]=a,nNoPos++;continue}if(!this.szFlag.match(/NOCLIPTOVIEW/)&&(ptOff.x<zoomBox.x||ptOff.x>zoomBox.x+zoomBox.width||ptOff.y<zoomBox.y||ptOff.y>zoomBox.y+zoomBox.height)){if(!this.szFlag.match(/\b(VECTOR|BEZIER)\b/)){var chartGroup;this.nSkipCount++,(chartGroup=this.itemA[a].chartNode)&&chartGroup.parentNode&&(chartGroup.parentNode&&chartGroup.parentNode.removeChild(chartGroup),this.itemA[a].chartNode=null,this.chartPosA[this.itemA[a].szSelectionId]=null,this.posItemA[this.itemA[a].szSelectionId]=null);continue}var ptOff=this.itemA[a].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[a].nValuesA[0]-1]):null);if(!ptOff)continue;if(ptOff.x<zoomBox.x||ptOff.x>zoomBox.x+zoomBox.width||ptOff.y<zoomBox.y||ptOff.y>zoomBox.y+zoomBox.height){this.nSkipCount++,(chartGroup=this.itemA[a].chartNode)&&chartGroup.parentNode&&(chartGroup.parentNode&&chartGroup.parentNode.removeChild(chartGroup),this.itemA[a].chartNode=null,this.chartPosA[this.itemA[a].szSelectionId]=null,this.posItemA[this.itemA[a].szSelectionId]=null);continue}}if(this.indexA[this.indexA.length]=a,this.szFlag.match(/CHART/))if(this.szFlag.match(/CATEGORICAL/))if(this.nMaxA.length>1)for(i=0;i<this.partsA.length;i++)this.partsA[i].nCount+=this.itemA[a].nCountA&&this.itemA[a].nCountA[i]&&!isNaN(this.itemA[a].nCountA[i])?this.itemA[a].nCountA[i]:0,this.partsA[i].nSum+=this.itemA[a].nValuesA&&this.itemA[a].nValuesA[i]&&!isNaN(this.itemA[a].nValuesA[i])?this.itemA[a].nValuesA[i]:0;else this.szAlphaField?this.szColorField&&this.partsA[this.itemA[a].nClass]?(this.partsA[this.itemA[a].nClass].nCount++,this.partsA[this.itemA[a].nClass].nSum+=isNaN(this.itemA[a].nAlpha)?isNaN(this.itemA[a].nSize)?1:this.itemA[a].nSize:this.itemA[a].nAlpha):this.partsA[this.itemA[a].nValuesA[0]-1]&&(this.partsA[this.itemA[a].nValuesA[0]-1].nCount++,this.partsA[this.itemA[a].nValuesA[0]-1].nSum+=isNaN(this.itemA[a].nAlpha)?isNaN(this.itemA[a].nSize)?1:this.itemA[a].nSize:this.itemA[a].nAlpha):this.szColorField&&this.partsA[this.itemA[a].nClass]?(this.partsA[this.itemA[a].nClass].nCount++,this.partsA[this.itemA[a].nClass].nSum+=isNaN(this.itemA[a].nSize)?1:this.itemA[a].nSize):this.partsA[this.itemA[a].nValuesA[0]-1]&&(this.partsA[this.itemA[a].nValuesA[0]-1].nCount++,this.partsA[this.itemA[a].nValuesA[0]-1].nSum+=isNaN(this.itemA[a].nSize)?1:this.itemA[a].nSize);else if(this.nMaxA.length>1)for(i=0;i<this.partsA.length;i++)this.szFlag.match(/MEAN/)&&!this.itemA[a].nValuesA[i]||(this.partsA[i].nCount++,this.partsA[i].nSum+=isNaN(this.itemA[a].nValuesA[i])?0:this.itemA[a].nValuesA[i]);else for(i=0;i<this.partsA.length;i++)this.itemA[a].nValuesA[0]>=this.partsA[i].min&&this.itemA[a].nValuesA[0]<this.partsA[i].max&&(this.partsA[i].nCount++,this.partsA[i].nSum+=isNaN(this.itemA[a].nValuesA[0])?0:this.itemA[a].nValuesA[0]);nToDraw++}if(nCharts==nNoPos&&!map.Tiles.allTilesLoaded())return this.fDataIncomplete=!0,this.fRedraw=!0,map.Tiles.switchScaleDependentTiles(),void setTimeout((function(){map.Themes.execute()}),1)}if(_TRACE(nToDraw+" to draw ("+nCharts+")"),nToDraw>this.nMaxThemeCharts)for(a in this.ErrorMessage="max charts ("+this.nMaxThemeCharts+") exceeded; please zoom in",this.indexA.length=0,this.nSkipCount=nToDraw,this.itemA)(chartGroup=SVGDocument.getElementById(this.szId+":"+a+":chart"))&&chartGroup.parentNode.removeChild(chartGroup);if(this.fRedrawAllCharts=!1,nToDraw>this.nMaxShadowCharts?(this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=!1):(this.fOrigShadow&&!this.fShadow&&(this.fRedrawAllCharts=!0),this.fShadow=this.fOrigShadow),this.szShadowUpper&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nShadowUpper?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow),this.szShadowLower&&(map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nShadowLower?(this.xOrigShadow=this.xOrigShadow||this.fOrigShadow,this.fShadow=this.fOrigShadow=!1):this.fOrigShadow=this.xOrigShadow||this.fOrigShadow),this.mapSleep&&(this.mapSleep.nCount=nToDraw),this.fSorted=!1,this.fSortBeforeDraw&&(this.nMin!=this.nMax||this.szSizeField)&&!this.szFlag.match(/NOSRT/)&&!this.szFlag.match(/\bDOT\b/)&&(!this.szFlag.match(/NOSIZE/)||this.szFlag.match(/3D/)||this.szFlag.match(/\bSORT\b/))&&(!this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/AGGREGATE/)||this.szSizeField||this.szFlag.match(/\bSORT\b/))){_TRACE("sort before drawing");var chartYPosA=[],nValue;if((this.szFlag.match(/3D/)||this.szFlag.match(/PLOT/)||this.szFlag.match(/xxxBOXxxx/)||this.szFlag.match(/POINTER/)&&this.szFlag.match(/BAR/))&&(!this.szFlag.match(/MULTIPLE/)&&!this.szFlag.match(/MULTIGRID/)||this.szFlag.match(/AGGREGATE/)))for(var i=0;i<this.indexA.length;i++)(ptOff=this.itemA[this.indexA[i]].ptPos||this.getNodePosition(this.itemA[this.indexA[i]].szSelectionId))?chartYPosA[i]=nRot?{a:this.indexA[i],y:ptOff.x*Math.sin(nRot)+ptOff.y*Math.cos(nRot)}:{a:this.indexA[i],y:ptOff.y}:chartYPosA[i]={a:this.indexA[i],y:0};else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/SUM/))for(var i=0;i<this.indexA.length;i++)nValue=this.itemA[this.indexA[i]].nSize,isNaN(nValue)||chartYPosA.push({a:this.indexA[i],y:nValue});else if(this.szSizeField||this.szFlag.match(/AGGREGATE/)&&this.szFlag.match(/MEAN/))for(var i=0;i<this.indexA.length;i++)nValue=this.itemA[this.indexA[i]].nValuesA[this.nActualFrame||0],isNaN(nValue)||chartYPosA.push({a:this.indexA[i],y:nValue});else if(this.szFlag.match(/SIZE/))for(var i=0;i<this.indexA.length;i++)nValue=this.itemA[this.indexA[i]].nValueSum,isNaN(nValue)||chartYPosA.push({a:this.indexA[i],y:nValue});else for(var i=0;i<this.indexA.length;i++)nValue=this.itemA[this.indexA[i]].nValuesA[this.nActualFrame||0],isNaN(nValue)||chartYPosA.push({a:this.indexA[i],y:nValue});_TRACE("sort ---\x3e "),this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)&&!this.szFlag.match(/3D/)?chartYPosA.sort(this.sortDownChartObjectsCompare):chartYPosA.sort(this.sortUpChartObjectsCompare),_TRACE("done");for(var i=0;i<chartYPosA.length;i++)this.indexA[i]=chartYPosA[i].a;this.fSorted=!0}if(this.nMaxCharts&&nToDraw>this.nMaxCharts)return this.fContinue=!0,this.continueIndex=nToDraw-this.nMaxCharts,this.indexA.slice(nToDraw-this.nMaxCharts-1,this.nMaxCharts),void map.Themes.executeContinue();this.fDone||this.unpaintMap()}if(this.chart={szColor:this.colorScheme[0],szLineColor:this.colorScheme[1]?this.colorScheme[1]:"none",szTextColor:this.colorScheme[1]?this.colorScheme[1]:"none"},(this.colorScheme.length>2||this.szFlag.match(/CATEGORICAL/))&&(this.chart.szColor=this.colorScheme[this.colorScheme.length-1],this.chart.szLineColor=this.colorScheme[0]),this.szFlag.match(/NOLINES/))this.chart.szLineColor="none";else if("none"==this.chart.szLineColor){var cColor=__maptheme_getChartColors(szColor);this.chart.szLineColor=cColor.textColor}if(this.nXLen=this.nMaxA.length/(this.nGridX||1),this.szFlag.match(/PLOT/)&&(this.szFlag.match(/GRIDSIZE/)||this.szFlag.match(/AUTOSIZE/))){var nRadius=0,nDynScale=map.Layer.nDynamicObjectScale,nAutoSize=this.szFlag.match(/GAP/)?1.2:1;nRadius=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/nAutoSize*this.nScale/nDynScale:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/nAutoSize*this.nScale/nDynScale:map.Scale.normalX(nChartSize/3),this.nAutoScale=nRadius/map.Scale.normalX(nChartSize*((this.itemA[a]?this.itemA[a].nValuesA.length:1)/(this.nGridX||1))),this.nGridSize=nRadius}else if(this.szFlag.match(/GRIDSIZE/)){var nDynScale=map.Layer.nDynamicObjectScale,nAutoSize=this.szFlag.match(/\bRECT\b/)||!this.szFlag.match(/AGGREGATE/)?this.szFlag.match(/GAP/)?1.15:1:this.szFlag.match(/GAP/)?.8:.75;this.nGridWidthPx?this.nGridSize=map.Scale.normalX(this.nGridWidthPx)/nAutoSize/nDynScale:this.nGridSize=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/nAutoSize/nDynScale:map.Scale.normalX(nChartSize/3)}if(this.szFlag.match(/PLOTXY/)){var nDynScale=map.Layer.nDynamicObjectScale,nAutoSize=1.15;this.nGridWidthPx?this.nChartWidth=map.Scale.normalX(this.nGridWidthPx)/nAutoSize/this.nScale/nDynScale:this.nChartWidth=this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/nAutoSize/this.nScale/nDynScale:map.Scale.normalX(nChartSize/3),this.nChartWidth-=2*map.Scale.normalX(this.nBoxMargin||0),this.nChartHeight=this.nChartWidth-map.Scale.normalY(this.szFlag.match(/TITLE/)?10:0),this.nGridSize=this.nChartWidth,this.nAutoScale=1,this.nRangeX=this.nMaxX-this.nMinX,this.nRangeY=this.nMaxY-this.nMinY}if(fObjectScaling?this.nChartGroupScale=(this.nAutoScale||this.nScale)*map.Layer.nObjectScale*map.Scale.nObjectScaling:this.nChartGroupScale=(this.nAutoScale||this.nScale)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,this.nChartGroupScaleX=this.nChartGroupScale,this.nChartGroupScaleY=this.nChartGroupScale/map.Zoom.nZoomY*map.Zoom.nZoomX,this.fGlowInScale=!1,(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(this.fGlowInScale=!0),this.fDoRedraw=!1,(this.indexA.length<1e3||this.fRedraw||this.fRedrawAllCharts||this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))&&(this.fDoRedraw=!this.fDone),this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper||this.szValueLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nValueLower,this.szFlag.match(/\bUSER\b/))try{var opt={target:this.chartGroup,theme:this};this.userDraw?(this.opt=opt,eval("HTMLWindow.ixmaps."+this.userDraw+"_init(SVGDocument,this.opt);"),delete this.opt):HTMLWindow.ixmaps.htmlgui_initChart(SVGDocument,opt)}catch(e){displayMessage("'"+(this.userDraw||"USER chart")+"' undefined!",5e3)}if(this.szFlag.match(/FEATURE/)){if(this.chartGroup.style.setProperty("fill",this.chart.szColor||"white"),this.chartGroup.style.setProperty("fill-opacity",this.fillOpacity||.7),this.chartGroup.style.setProperty("stroke",this.szLineColor||"red"),this.chartGroup.style.setProperty("stroke-width",map.Scale.normalX(this.nLineWidth||1)*this.nChartGroupScaleY/(fFeatureScalingDynamic?1:map.Layer.nDynamicObjectScale)),void 0!==this.szBorderStyle)switch(this.szBorderStyle){case"dotted":this.chartGroup.style.setProperty("stroke-dasharray","0.1 0.2");break;case"dashed":this.chartGroup.style.setProperty("stroke-dasharray","0.5 0.2");break}if(this.szFlag.match(/DASH/)&&this.chartGroup.style.setProperty("stroke-dasharray","0.1 0.2"),this.chartGroup.style.setProperty("stroke-opacity","1"),this.chartGroup.style.setProperty("stroke-linecap","butt"),this.chartGroup.style.setProperty("stroke-linejoin","round"),this.szFlag.match(/SILENT/))this.chartGroup.style.setProperty("pointer-events","none","");else{for(var szInfo="",i=0;i<this.objTheme.dbFields.length-1;i++)szInfo+=(i?"|":"")+this.objTheme.dbFields[i].id;this.chartGroup.setAttributeNS(szMapNs,"info",szInfo)}if(!0===this.fShadow&&SVGDocument.getElementById(szShadowFilterShapeId))this.chartGroup.style.setProperty("filter","url(#"+szShadowFilterShapeId+")","");else if(!0===this.fShadow){_TRACE("create shadow filter for objects ! --------------------------------------");var filterNode=map.Dom.newNode("filter",this.chartGroup.parentNode);filterNode.setAttributeNS(null,"id",szShadowFilterShapeId),filterNode.setAttributeNS(null,"x","-1"),filterNode.setAttributeNS(null,"y","-1"),filterNode.setAttributeNS(null,"width","2000%"),filterNode.setAttributeNS(null,"height","2000%");var filter=map.Dom.newNode("feGaussianBlur",filterNode);filter.setAttributeNS(null,"stdDeviation","0.3"),filter.setAttributeNS(null,"result","BlurAlpha"),filter=map.Dom.newNode("feOffset",filterNode),filter.setAttributeNS(null,"in","BlurAlpha"),filter.setAttributeNS(null,"dx","0.2"),filter.setAttributeNS(null,"dy","0.5"),filter.setAttributeNS(null,"result","OffsetBlurAlpha"),filter=map.Dom.newNode("feColorMatrix",filterNode),filter.setAttributeNS(null,"in","OffsetBlurAlpha"),filter.setAttributeNS(null,"type","matrix"),filter.setAttributeNS(null,"values","0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0 0 0 1 0"),filter.setAttributeNS(null,"result","matrixOut"),filter=map.Dom.newNode("feMerge",filterNode);var merge=map.Dom.newNode("feMergeNode",filter);merge.setAttributeNS(null,"in","matrixOut"),merge=map.Dom.newNode("feMergeNode",filter),merge.setAttributeNS(null,"in","SourceGraphic"),this.chartGroup.style.setProperty("filter","url(#"+szShadowFilterShapeId+")","")}}_TRACE("start drawing");var nRadius=map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/2*20;nRadius=nRadius*map.Scale.nZoomScale*20;for(var nAi=startIndex;nAi<this.indexA.length;nAi++){if(this.fCancel)return displayMessage("Canceled by user",1e3,!0),void(this.fCancel=!1);if(this.mapSleep&&(this.mapSleep.nDoneCount=this.nDoneCount,this.mapSleep.checkSleep(nAi,10)))return this.fContinue=!0,this.continueIndex=nAi,this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt),void(null!=this.markedClass&&this.markClass(this.markedClass,1));var shapeGroup=null,a=this.indexA[nAi];if(this.nDoneCount++,this.itemA[a]&&this.itemA[a].nValuesA&&0!==this.itemA[a].nValuesA.length){var selectionId=this.itemA[a].szSelectionId;if(!this.szFlag.match(/FEATURE/)){if(ptOff=this.itemA[a].ptPos||this.getNodePosition(selectionId),ptOff&&(ptOff.x=isNaN(ptOff.x)?0:ptOff.x,ptOff.y=isNaN(ptOff.y)?0:ptOff.y),!ptOff||isNaN(ptOff.x)||isNaN(ptOff.y)){_TRACE("missing position: "+a),this.nMissingPositionCount++;continue}if(this.fRedraw&&(this.itemA[a].chartNode=this.itemA[a].chartNode||SVGDocument.getElementById(this.szId+":"+a+":chart")),this.itemA[a].chartNode&&this.itemA[a].chartNode.parentNode){if(!this.fDoRedraw){this.nRealizedCount++;continue}this.itemA[a].chartNode.parentNode.removeChild(this.itemA[a].chartNode),this.itemA[a].chartNode=null}}var ptNull=new point(0,0);if(this.szFlag.match(/FEATURE/)){if(a.match(/\*/)&&(shapeGroup=SVGDocument.getElementById(a.split("*")[0])),shapeGroup||(shapeGroup=map.Dom.newGroup(this.chartGroup,a)),!this.objTheme.dbRecords[this.itemA[a].dbIndex][this.objTheme.nFieldSelectionIndex]){var ptOff=this.itemA[a].ptPos||this.getNodePosition(selectionId);ptOff&&shapeGroup.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,ptOff.x,ptOff.y]);continue}var szGeo=this.objTheme.dbRecords[this.itemA[a].dbIndex][this.objTheme.nFieldSelectionIndex];if(!szGeo.match(/coordinates/i)){var ptOff=this.itemA[a].ptPos||this.getNodePosition(selectionId);ptOff&&shapeGroup.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,ptOff.x,ptOff.y]);continue}var json=JSON.parse(this.objTheme.dbRecords[this.itemA[a].dbIndex][this.objTheme.nFieldSelectionIndex]);if(!json)continue;if(this.szFlag.match(/CLIPTOGEOBOUNDS|CLIPTOVIEW/)&&"Polygon"==json.type){var linesA=json.coordinates,fOutOfView=!0;for(i in linesA){var coordinatesA=linesA[i];for(ii in coordinatesA)if(coordinatesA[ii][0]>mapGeoBounds[0].x&&coordinatesA[ii][0]<mapGeoBounds[1].x&&coordinatesA[ii][1]>mapGeoBounds[0].y&&coordinatesA[ii][1]<mapGeoBounds[1].y){fOutOfView=!1;break}}if(fOutOfView){for(i in shapeGroup.parentNode.removeChild(shapeGroup),map.Themes.themeNodesA[a])map.Themes.themeNodesA[a][i].parentNode&&map.Themes.themeNodesA[a][i].parentNode.removeChild(map.Themes.themeNodesA[a][i]);map.Themes.themeNodesA[a]=[];continue}if(map.Themes.themeNodesA[a]&&map.Themes.themeNodesA[a].length)continue}if(this.szFlag.match(/SILENT/))shapeGroup.style.setProperty("pointer-events","none","");else{for(var szInfo="",data=this.objTheme.dbRecords[this.itemA[a].dbIndex],i=0;i<data.length-1;i++)szInfo+=(i?"|":"")+data[i];shapeGroup.setAttributeNS(szMapNs,"info",szInfo),shapeGroup.setAttributeNS(szMapNs,"tooltip",a)}if(this.szTimeField){var uTime=new Date(this.itemA[a].szTime).getTime()||this.itemA[a].szTime;shapeGroup.setAttributeNS(szMapNs,"time",uTime)}if(this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[a].nValuesA[0]-1];else if(this.partsA.length>1)for(this.chart.szColor=this.szNoDataColor?this.szNoDataColor:"white",i=0;i<this.partsA.length;i++)this.itemA[a].nValuesA[0]>=this.partsA[i].min&&this.itemA[a].nValuesA[0]<this.partsA[i].max&&(this.chart.szColor=this.colorScheme[i],this.itemA[a].nClass=i,this.partsA[i].nCount++);shapeGroup.setAttributeNS(null,"style","stroke:"+this.chart.szColor),shapeGroup.setAttributeNS(szMapNs,"class",void 0!==this.itemA[a].nClass?this.itemA[a].nClass:String(this.itemA[a].nValuesA[0]-1));var maxLenX=map.Scale.getMapPositionOfLatLon(80,180).x-map.Scale.getMapPositionOfLatLon(80,-180).x;if("Point"==json.type){map.Layer.listA[this.szThemesA[0]].szType="point";var coordinatesA=json.coordinates,pt=map.Scale.getMapPositionOfLatLon(coordinatesA[1],coordinatesA[0]);shapeGroup.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,pt.x,pt.y]);var shape=map.Dom.newShape("circle",shapeGroup,0,0,map.Scale.normalX(1),"fill:#dd0000;fill-opacity:0.3;stroke:#dd0000;stroke-opacity:1;stroke-width:1")}if("LineString"==json.type){this.chartGroup.style.setProperty("fill","none"),map.Layer.listA[this.szThemesA[0]].szType="line";var coordinatesA=json.coordinates,pt=map.Scale.getMapPositionOfLatLon(coordinatesA[0][1],coordinatesA[0][0]),d="M "+pt.x+","+pt.y+" l ",ptAct=new point(pt.x,pt.y);for(i in coordinatesA){var pt=map.Scale.getMapPositionOfLatLon(coordinatesA[i][1],coordinatesA[i][0]);Math.abs(pt.x-ptAct.x)>.99*maxLenX&&(pt=map.Scale.getMapPositionOfLatLon(coordinatesA[i][1],coordinatesA[i][0]+(pt.x<0?360:-360))),d+=pt.x-ptAct.x+","+(pt.y-ptAct.y)+" ",ptAct=new point(pt.x,pt.y)}var shape=map.Dom.newShape("path",shapeGroup,d,"")}if("MultiLineString"==json.type){this.chartGroup.style.setProperty("fill","none"),map.Layer.listA[this.szThemesA[0]].szType="line";var linesA=json.coordinates;for(i in linesA){var coordinatesA=linesA[i],ptAct=null,pt=map.Scale.getMapPositionOfLatLon(coordinatesA[0][1],coordinatesA[0][0]),d="M "+pt.x+","+pt.y+" l ";for(var ii in ptAct=new point(pt.x,pt.y),coordinatesA){var pt=map.Scale.getMapPositionOfLatLon(coordinatesA[ii][1],coordinatesA[ii][0]);Math.abs(pt.x-ptAct.x)>.99*maxLenX&&(pt=map.Scale.getMapPositionOfLatLon(coordinatesA[ii][1],coordinatesA[ii][0]+(pt.x<0?360:-360))),d+=pt.x-ptAct.x+","+(pt.y-ptAct.y)+" ",ptAct=new point(pt.x,pt.y)}var shape=map.Dom.newShape("path",shapeGroup,d,"")}}if("Polygon"==json.type){map.Layer.listA[this.szThemesA[0]].szType="polygon";var linesA=json.coordinates,d="",x=0,y=0,count=0;for(i in linesA){var coordinatesA=linesA[i],ptAct=null,pt=map.Scale.getMapPositionOfLatLon(coordinatesA[0][1],coordinatesA[0][0]);for(ii in d+="M "+pt.x+","+pt.y+" l ",ptAct=new point(pt.x,pt.y),coordinatesA){var pt=map.Scale.getMapPositionOfLatLon(coordinatesA[ii][1],coordinatesA[ii][0]);Math.abs(pt.x-ptAct.x)>.99*maxLenX&&(pt=map.Scale.getMapPositionOfLatLon(coordinatesA[ii][1],coordinatesA[ii][0]+(pt.x<0?360:-360))),x+=pt.x,y+=pt.y,d+=pt.x-ptAct.x+","+(pt.y-ptAct.y)+" ",ptAct=new point(pt.x,pt.y)}d+=" z",count+=coordinatesA.length}var shape=map.Dom.newShape("path",shapeGroup,d,"");shapeGroup.setAttributeNS(szMapNs,"center","x:"+x/count+",y:"+y/count),shapeGroup.setAttributeNS(szMapNs,"area",this.itemA[a].nSize),shapeGroup.setAttributeNS(null,"style","fill:"+this.chart.szColor+";")}if("MultiPolygon"==json.type){var x=[],y=[],count=[];map.Layer.listA[this.szThemesA[0]].szType="polygon";var polygonA=json.coordinates;for(var p in polygonA){var linesA=polygonA[p],d="";for(i in x[p]=0,y[p]=0,count[p]=0,linesA){var coordinatesA=linesA[i],ptAct=null,pt=map.Scale.getMapPositionOfLatLon(coordinatesA[0][1],coordinatesA[0][0]);for(ii in d+="M "+pt.x+","+pt.y+" l ",ptAct=new point(pt.x,pt.y),coordinatesA){var pt=map.Scale.getMapPositionOfLatLon(coordinatesA[ii][1],coordinatesA[ii][0]);Math.abs(pt.x-ptAct.x)>.99*maxLenX&&(pt=map.Scale.getMapPositionOfLatLon(coordinatesA[ii][1],coordinatesA[ii][0]+(pt.x<0?360:-360))),x[p]+=pt.x,y[p]+=pt.y,d+=pt.x-ptAct.x+","+(pt.y-ptAct.y)+" ",ptAct=new point(pt.x,pt.y)}d+=" z",count[p]+=coordinatesA.length}var shape=map.Dom.newShape("path",shapeGroup,d,"")}var pp=0;for(p in count)count[p]>pp&&(shapeGroup.setAttributeNS(szMapNs,"center","x:"+x[p]/count[p]+",y:"+y[p]/count[p]),shapeGroup.setAttributeNS(szMapNs,"area",this.itemA[a].nSize),pp=count[p]);shapeGroup.setAttributeNS(null,"style","fill:"+this.chart.szColor+";")}}else if(this.szFlag.match(/\bDOT\b/)){if(shapeGroup=map.Dom.newGroup(this.chartGroup,this.szId+":"+selectionId+":chartgroup"),shapeGroup.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,ptOff.x,ptOff.y]),this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[a].nValuesA[0]-1];else if(this.partsA.length>1)for(i=0;i<this.partsA.length;i++)this.itemA[a].nValuesA[0]>=this.partsA[i].min&&this.itemA[a].nValuesA[0]<this.partsA[i].max&&(this.chart.szColor=this.colorScheme[i]);this.itemA[a].chartNode=map.Dom.newShape("circle",shapeGroup,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none;")}else if(this.szFlag.match(/\bQUAD\b/)){if(shapeGroup=map.Dom.newGroup(this.chartGroup,this.szId+":"+selectionId+":chart"),shapeGroup.fu.setMatrix([this.nChartGroupScaleX,0,0,this.nChartGroupScaleY,ptOff.x,ptOff.y]),this.szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[this.itemA[a].nValuesA[0]-1];else if(this.partsA.length>1)for(i=0;i<this.partsA.length;i++)this.itemA[a].nValuesA[0]>=this.partsA[i].min&&this.itemA[a].nValuesA[0]<this.partsA[i].max&&(this.chart.szColor=this.colorScheme[i]);this.itemA[a].chartNode=map.Dom.newShape("rect",shapeGroup,-nRadius,-nRadius,2*nRadius,2*nRadius,"fill:"+this.chart.szColor+";stroke:none;")}else if(this.szFlag.match(/\bBEZIER\b/)){if(this.nMinValue&&this.itemA[a].nSize<this.nMinValue)continue;var p1=this.itemA[a].ptPos,p2=this.itemA[a].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[a].nValuesA[0]-1]):null);if(p1&&p2&&p1!=p2){shapeGroup=this.itemA[a].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+a+(a?":chartgroup":":ochrtgroup")),this.chart.szColor=this.szLineColor||this.itemA[a].szColor||this.colorScheme[this.itemA[a].nValuesA[0]-1]||this.szNoDataColor;var nPow=1/(this.nSizePow||1),nLineWidth=this.nLineWidth||10/Math.pow(this.nNormalSizeValue||this.nMaxSize,nPow)*Math.pow(Math.abs(this.itemA[a].nSize),nPow),nGap=Number(this.nGapSize||20),ll=nLineWidth+(this.szFlag.match(/\bGAP\b/)?nGap:3);if(nLineWidth=map.Scale.normalX(nLineWidth)*this.nChartGroupScaleY*this.nScale,nLineWidth<=0)continue;if(this.szFlag.match(/\bREVERSE\b/)||this.itemA[a].nSize<0){var tmp=p1;p1=p2,p2=tmp}var len=Math.sqrt((p2.y-p1.y)*(p2.y-p1.y)+(p2.x-p1.x)*(p2.x-p1.x)),x=p2.x-p1.x,y=p2.y-p1.y,len=Math.sqrt(x*x+y*y);if(this.szFlag.match(/\bDYNAMICWIDTH\b/)&&(nLineWidth*=Math.max(1,Math.log10(len))),len<=0)continue;var nBow=this.nRangeScale;if(this.szFlag.match(/\bRANDOM\b/)&&(nBow-=.66*this.nRangeScale*Math.random()),this.szFlag.match(/\bSHORT\b/))var dx=y/len*(nBow||5)*100*this.nChartGroupScaleY,dy=x/len*(nBow||5)*100*this.nChartGroupScaleY;else if(this.szFlag.match(/\bLONG\b/))var dx=y/5e4*Math.max(len,500)*(nBow||5),dy=x/5e4*Math.max(len,500)*(nBow||5);else var dx=y/50*(nBow||5),dy=x/50*(nBow||5);this.szFlag.match(/\bPOINTER|ARROW\b/)&&(x-=x/len*map.Scale.normalX(ll)*this.nChartGroupScaleY*this.nScale*(this.nMarkerSize||1),y-=y/len*map.Scale.normalX(ll)*this.nChartGroupScaleY*this.nScale*(this.nMarkerSize||1));var x0=0,y0=0;this.szFlag.match(/\bGAP\b/)&&(x+=dx/500*ll,y-=dy/500*ll,x0=x/len*nGap*20*this.nChartGroupScaleY,y0=y/len*nGap*20*this.nChartGroupScaleY);var d="M"+x0+","+y0+" C"+(x/4+dx)+","+(y/4-dy)+" "+(x/2+dx)+","+(y/2-dy)+" "+x+","+y,shape=map.Dom.newShape("path",shapeGroup,d,"stroke-linecap:butt;fill:none;stroke:"+this.chart.szColor+";stroke-width:"+nLineWidth+";stroke-opacity:"+(this.fillOpacity||.3)+";");if(this.szFlag.match(/DOPACITYMIN/)){var nPow=1/(this.nDopacityPow||1),nOpacity=Math.pow(this.nMax-this.itemA[a].nSize,nPow)/Math.pow(this.nMax-this.nMin,nPow)*(this.fillOpacity||1)*(this.nDopacityScale||1);shape.style.setProperty("stroke-opacity",String(nOpacity),"")}else if(this.szFlag.match(/DOPACITY/)){var nPow=1/(this.nDopacityPow||1),nOpacity=Math.pow(this.itemA[a].nSize-this.nMin,nPow)/Math.pow(this.nMax-this.nMin,nPow)*(this.fillOpacity||1)*(this.nDopacityScale||1);shape.style.setProperty("stroke-opacity",String(nOpacity),"")}if(this.szFlag.match(/\bDASH\b/)){var d1=1e3*this.nChartGroupScaleY,d2=100*this.nChartGroupScaleY+nLineWidth;shape.style.setProperty("stroke-dasharray",String(d1)+" "+String(d2)),shape.style.setProperty("stroke-dashoffset","0"),shape.style.setProperty("stroke-linecap","round");var dashoff=Math.random()*d1,from=dashoff+d1+d2,to=dashoff,myAnimation=map.Dom.constructNode("animate",shape,{attributeType:"XML",attributeName:"stroke-dashoffset",from:String(from),to:String(to),dur:"2s",repeatCount:"indefinite"})}if(this.szFlag.match(/\bGRADIENT\b|\bFADEIN\b/)){var szColor2=this.szLineColorA?this.szLineColorA[0]:this.chart.szColor,nFade=this.szFlag.match(/\bFADEIN\b/)?.2:2,gradientId="Gradient"+Math.random();if(Math.abs(y)>Math.abs(x)){var myGradient=map.Dom.constructNode("linearGradient",shapeGroup,{id:gradientId,x1:"0%",y1:"0%",x2:"0%",y2:"100%"});map.Dom.constructNode("stop",myGradient,{offset:"0","stop-color":y<0?this.chart.szColor:szColor2,"stop-opacity":y<0?"2":nFade}),map.Dom.constructNode("stop",myGradient,{offset:"1","stop-color":y<0?szColor2:this.chart.szColor,"stop-opacity":y<0?nFade:"2"})}else{var myGradient=map.Dom.constructNode("linearGradient",shapeGroup,{id:gradientId});map.Dom.constructNode("stop",myGradient,{offset:"0","stop-color":x<0?this.chart.szColor:szColor2,"stop-opacity":x<0?"2":nFade}),map.Dom.constructNode("stop",myGradient,{offset:"1","stop-color":x<0?szColor2:this.chart.szColor,"stop-opacity":x<0?nFade:"2"})}shape.style.setProperty("stroke",""),shape.style.setProperty("fill","none"),shape.setAttributeNS(null,"stroke","url(#"+gradientId+")")}if(this.szFlag.match(/\bPOINTER|ARROW\b/)){var arrowId="ArrowMarker"+Math.random(),tmpDefs=map.Dom.newNode("defs",shapeGroup),nP=Math.min(5,2.5+100/(nLineWidth/this.nChartGroupScale))*(this.nMarkerSize||1),myMarker=map.Dom.constructNode("marker",tmpDefs,{id:arrowId,markerWidth:nP,markerHeight:nP,refX:nP/1.7,refY:nP/2,orient:"auto",markerUnits:"strokeWidth"}),myShape=map.Dom.constructNode("path",myMarker,{d:"M0,"+nP+" L"+nP+","+nP/2+" L0,0 Z",style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:none;stroke-width:0.03"});if(shape.setAttributeNS(null,"marker-end","url(#"+arrowId+")"),this.szFlag.match(/DOPACITYMIN/)){var nPow=1/(this.nDopacityPow||1),nOpacity=Math.pow(this.nMax-this.itemA[a].nSize,nPow)/Math.pow(this.nMax-this.nMin,nPow)*(this.fillOpacity||1)*(this.nDopacityScale||1);myShape.style.setProperty("opacity",String(nOpacity),"")}else if(this.szFlag.match(/DOPACITY/)){var nPow=1/(this.nDopacityPow||1),nOpacity=Math.pow(this.itemA[a].nSize-this.nMin,nPow)/Math.pow(this.nMax-this.nMin,nPow)*(this.fillOpacity||1)*(this.nDopacityScale||1);myShape.style.setProperty("opacity",String(nOpacity),"")}}if(this.szFlag.match(/\bVALUES\b/)&&!this.fHideValues){var pathId="VectorPath"+Math.random();if(x<0){var d="M"+x+","+y+" C"+(x/2+dx)+","+(y/2-dy)+" "+(x/4+dx)+","+(y/4-dy)+" "+x0+","+y0,tshape=map.Dom.newShape("path",shapeGroup,d,"fill:none;stroke:none");tshape.setAttributeNS(null,"id",pathId)}else shape.setAttributeNS(null,"id",pathId);var nFontSize=Math.min(len,Math.sqrt(this.itemA[a].nSize)/Math.sqrt(this.nNormalSizeValue||this.nMaxSize)*this.nValueScale);nFontSize=24*map.Scale.normalX(nFontSize)*this.nChartGroupScaleY*this.nScale;var szText=this.formatValue(this.itemA[a].nSize,this.nValueDecimals||(this.itemA[a].nSize<1?2:0),"ROUND")+this.szUnit,tPath=map.Dom.newTextOnPath(shapeGroup,pathId,szText,"font-family:arial;font-size:"+nFontSize+"px;fill:"+this.chart.szColor+";stroke:#ffffff;stroke-width:"+nLineWidth/10+"px;baseline-shift:-35%","40%")}if(shapeGroup.setAttributeNS(szMapNs,"class",void 0!==this.itemA[a].nClass?this.itemA[a].nClass:String(this.itemA[a].nValuesA[0]-1)),shapeGroup.setAttributeNS(szMapNs,"tooltip",this.formatValue(this.itemA[a].nSize,this.nValueDecimals||(this.itemA[a].nSize<1?2:0),"ROUND")+this.szUnit),this.szTimeField){var uTime=new Date(this.itemA[a].szTime).getTime()||this.itemA[a].szTime;shapeGroup.setAttributeNS(szMapNs,"time",uTime)}shapeGroup.fu.setMatrix([1,0,0,1,p1.x,p1.y])}}else if(this.szFlag.match(/\bVECTOR\b/)){if(this.nMinValue&&this.itemA[a].nSize<this.nMinValue)continue;var p1=this.itemA[a].ptPos,p2=this.itemA[a].ptPos2||(this.szLabelA?this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[this.itemA[a].nValuesA[0]-1]):null);if(p1&&p2){shapeGroup=this.itemA[a].chartNode=map.Dom.newGroup(this.chartGroup,this.szId+":"+a+(a?":chartgroup":":ochrtgroup")),this.chart.szColor=this.szLineColor||this.colorScheme[this.itemA[a].nValuesA[0]-1];var nLineWidth=this.nLineWidth||2/(this.nNormalSizeValue||1)/this.nMaxSize*this.itemA[a].nSize,shape=map.Dom.newShape("line",shapeGroup,0,0,p2.x-p1.x,p2.y-p1.y,"stroke:"+this.chart.szColor+";stroke-width:"+map.Scale.normalX((nLineWidth||.1)*this.nChartGroupScaleY)+";stroke-opacity:"+(this.fillOpacity||.3)+";");if(this.szFlag.match(/\bDASH\b/)){var d1=1e3*this.nChartGroupScaleY,d2=300*this.nChartGroupScaleY;shape.style.setProperty("stroke-dasharray",String(d1)+" "+String(d2)),shape.style.setProperty("stroke-dashoffset","0");var dashoff=Math.random()*d1,from=dashoff+d1+d2,to=dashoff,myAnimation=map.Dom.constructNode("animate",shape,{attributeType:"XML",attributeName:"stroke-dashoffset",from:String(from),to:String(to),dur:"1s",repeatCount:"indefinite"})}if(this.szFlag.match(/\bPOINTER|ARROW\b/)){var tmpDefs=map.Dom.newNode("defs",shapeGroup),myMarker=map.Dom.constructNode("marker",tmpDefs,{id:this.szId+":"+selectionId+":chartgroup:ArrowMarker",markerWidth:"4",markerHeight:"4",refX:"4",refY:"2",orient:"auto",markerUnits:"strokeWidth"}),myShape=map.Dom.constructNode("path",myMarker,{d:"M0,4 L4,2 L0,0 Z",style:"fill:"+this.chart.szColor+";opacity:"+2*(this.fillOpacity||.3)+";stroke:white;stroke-width:0.1"});shape.setAttributeNS(null,"marker-end","url(#"+this.szId+":"+selectionId+":chartgroup:ArrowMarker)")}shapeGroup.setAttributeNS(szMapNs,"class",void 0!==this.itemA[a].nClass?this.itemA[a].nClass:String(this.itemA[a].nValuesA[0]-1)),shapeGroup.setAttributeNS(szMapNs,"tooltip",this.formatValue(this.itemA[a].nSize,this.nValueDecimals||(this.itemA[a].nSize<1?2:0),"ROUND")+this.szUnit),shapeGroup.fu.setMatrix([1,0,0,1,p1.x,p1.y])}}else{if(shapeGroup=null,selectionId)if(shapeGroup=SVGDocument.getElementById(this.szId+":"+selectionId+":chart"),shapeGroup)shapeGroup.fu=new Methods(shapeGroup);else if(shapeGroup=map.Dom.newGroup(this.chartGroup,this.szId+":"+selectionId+":chart"),this.szFlag.match(/BOX/)){var szLineColor="#bbbbbb";void 0!==this.szBorderColor&&(szLineColor=this.szBorderColor);var szLineStyle="stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.3;";if(void 0!==this.szBorderStyle)switch(this.szBorderStyle){case"dotted":szLineStyle="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case"dashed":szLineStyle="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case"solid":szLineStyle="stroke-width:"+map.Scale.normalX(1)+";";break;case"none":szLineStyle="stroke-width:0;";break}if(void 0!==this.szBorderWidth)switch(this.szBorderWidth){case"thin":szLineStyle+="stroke-width:"+map.Scale.normalX(.3)+";";break;case"thick":szLineStyle+="stroke-width:"+map.Scale.normalX(1.5)+";";break}var newBox=map.Dom.newShape("rect",shapeGroup,0,0,1,1,"fill:"+(this.szBoxColor||"white")+";fill-opacity:"+(this.nBoxOpacity||1)+";stroke:"+szLineColor+";"+szLineStyle);switch(newBox.setAttributeNS(null,"id",this.szId+":"+selectionId+":chart:box"),newBox.style.setProperty("pointer-events","none",""),this.szSymbolBoxStyle){case"frame":this.boxShape.setAttributeNS(null,"fill-opacity",0);break;case"field":this.boxShape.setAttributeNS(null,"fill-opacity",1);break}}this.itemA[a].chartNode=shapeGroup,shapeGroup.setAttributeNS(szMapNs,"value",String(this.itemA[a].nValuesA[0])),ptNull=this.drawChart(shapeGroup,a,nChartSize,this.szFlag);var __scale=this.nScale;this.nScale=this.nAutoScale||this.nScale;var nAutoScale=1;if("auto"==this.nMaxValue&&(nAutoScale=1/Math.pow(this.nMax,1/3)*Math.pow(this.nMaxValuePlot,1/3),map.Themes.autoScale||(this.fAutoScaleLeader=!0,map.Themes.autoScale=[]),nAutoScale=map.Themes.autoScale[a]=map.Themes.autoScale[a]||nAutoScale),ptNull&&ptOff&&shapeGroup&&(this.szFlag.match(/PLOT/)&&this.nGridSize&&this.nAutoScale&&(ptNull.x+=this.nGridSize/2/this.nAutoScale*nAutoScale,ptNull.y-=this.nGridSize/2/this.nAutoScale*nAutoScale),this.szFlag.match(/NOSCALE/)?shapeGroup.fu.setMatrix([this.nScale,0,0,this.nScale,ptOff.x-ptNull.x*this.nScale,ptOff.y-ptNull.y*this.nScale]):shapeGroup.fu.setMatrix([this.nChartGroupScaleX*nAutoScale,0,0,this.nChartGroupScaleY*nAutoScale,ptOff.x-ptNull.x*map.Layer.nObjectScale*this.nScale,ptOff.y-ptNull.y*map.Layer.nObjectScale*this.nScale]),this.itemA[a].ptPos&&this.itemA[a].ptPos2&&(shapeGroup.setAttributeNS(szMapNs,"xEnd",this.itemA[a].ptPos2.x),shapeGroup.setAttributeNS(szMapNs,"yEnd",this.itemA[a].ptPos2.y),shapeGroup.setAttributeNS(szMapNs,"dur",10))),this.nScale=__scale,ptNull){if(selectionId=selectionId.split("*")[0],(this.szFlag.match(/MULTIPLE/)||this.szFlag.match(/ALIGN/))&&shapeGroup.lastChild.firstChild){var bBox=map.Dom.getBox(shapeGroup.lastChild),offset=this.szFlag.match(/\bUP\b/)?bBox.height:bBox.width;if(this.chartPosA[selectionId]){this.chartPosA[selectionId]+=this.szFlag.match(/TEXTONLY/)?5:.5*offset;var ptChart=shapeGroup.lastChild.fu.getPosition(),line=offset*(this.nGridX||10);this.szFlag.match(/\bUP\b/)?shapeGroup.lastChild.fu.setPosition(ptChart.x+bBox.width*Math.floor(this.chartPosA[selectionId]/line),ptChart.y-bBox.y-bBox.height/2-this.chartPosA[selectionId]%line):shapeGroup.lastChild.fu.setPosition(ptChart.x+this.chartPosA[selectionId]%line,ptChart.y-bBox.height*Math.floor(this.chartPosA[selectionId]/line)),this.chartPosA[selectionId]+=this.szFlag.match(/TEXTONLY/)?offset:.5*offset}else this.chartPosA[selectionId]=this.szFlag.match(/TEXTONLY/)?offset:-bBox.y;this.posItemA&&(this.posItemA[selectionId]||(this.posItemA[selectionId]=[]),this.posItemA[selectionId].push(this.itemA[a]))}else if((this.szFlag.match(/MULTIFIX/)||this.szFlag.match(/MULTIGRID/))&&shapeGroup.lastChild){var offset=1,dX=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1)),dY=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1));if(ptOff=this.getNodePosition(selectionId)){if(selectionId=String(ptOff.x)+String(ptOff.y),this.chartPosA[selectionId]){var ptChart=shapeGroup.lastChild.fu.getPosition(),actOffset=this.chartPosA[selectionId],line=this.nGridX||7;this.szFlag.match(/\bUP\b/)?shapeGroup.lastChild.fu.setPosition(ptChart.x+dX*Math.floor(actOffset/line),ptChart.y-dY*(actOffset%line)):shapeGroup.lastChild.fu.setPosition(ptChart.x+dX*(actOffset%line),ptChart.y-dY*Math.floor(actOffset/line)),this.chartPosA[selectionId]+=offset}else this.chartPosA[selectionId]=offset;this.posItemA&&(this.posItemA[selectionId]||(this.posItemA[selectionId]=[]),this.posItemA[selectionId].push(this.itemA[a])),this.itemA[a].labelGroup&&actOffset%line!=line-1&&this.itemA[a].labelGroup.style.setProperty("display","none","")}}else if((this.szFlag.match(/MULTISQUARE/)||this.szFlag.match(/MULTIQUAD/))&&shapeGroup.lastChild){var offset=1,dX=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1)),dY=map.Scale.normalX(this.nCharSizeNormal*(this.nRangeScale||1));if(ptOff=this.getNodePosition(selectionId)){if(selectionId=String(ptOff.x)+String(ptOff.y),this.chartPosA[selectionId]){var ptChart=shapeGroup.lastChild.fu.getPosition(),actOffset=this.chartPosA[selectionId],square=Math.floor(Math.sqrt(actOffset));if(square<(this.nGridX||1e7)){var line=actOffset-square*square,x=line<=square?line:square,y=line<=square?square:square-(line-square);shapeGroup.lastChild.fu.setPosition(ptChart.x+x*dX,ptChart.y-y*dY),this.chartPosA[selectionId]+=offset}else{var ptChart=shapeGroup.lastChild.fu.getPosition(),actOffset=this.chartPosA[selectionId],line=this.nGridX||7;this.szFlag.match(/\bUP\b/)?shapeGroup.lastChild.fu.setPosition(ptChart.x+dX*Math.floor(actOffset/line),ptChart.y-dY*(actOffset%line)):shapeGroup.lastChild.fu.setPosition(ptChart.x+dX*(actOffset%line),ptChart.y-dY*Math.floor(actOffset/line)),this.chartPosA[selectionId]+=offset}}else this.chartPosA[selectionId]=offset;this.posItemA&&(this.posItemA[selectionId]||(this.posItemA[selectionId]=[]),this.posItemA[selectionId].push(this.itemA[a])),this.itemA[a].labelGroup&&actOffset%line!=line-1&&this.itemA[a].labelGroup.style.setProperty("display","none","")}}if(this.szFlag.match(/TEXTONLY/)&&fCheckLabelOverlap){var text=SVGDocument.getElementById(this.szId+":"+a+":text");if(text)var cItem=new ixMap.Label.Item(text)}if(nRot&&setRotate(shapeGroup,-Number(nRot)),!0===this.fShadow&&SVGDocument.getElementById(szShadowFilterId))shapeGroup.style.setProperty("filter","url(#"+szShadowFilterId+")","");else if(!0===this.fShadow){_TRACE("create shadow filter for objects ! --------------------------------------");var filterNode=map.Dom.newNode("filter",this.chartGroup.parentNode);filterNode.setAttributeNS(null,"id",szShadowFilterId),filterNode.setAttributeNS(null,"filterUnits","objectBoundingBox"),filterNode.setAttributeNS(null,"x","-50%"),filterNode.setAttributeNS(null,"y","-50%"),filterNode.setAttributeNS(null,"width","200%"),filterNode.setAttributeNS(null,"height","200%");var filter=map.Dom.newNode("feGaussianBlur",filterNode);filter.setAttributeNS(null,"stdDeviation","10"),filter.setAttributeNS(null,"result","BlurAlpha"),filter=map.Dom.newNode("feOffset",filterNode),filter.setAttributeNS(null,"in","BlurAlpha"),filter.setAttributeNS(null,"dx","10"),filter.setAttributeNS(null,"dy","10"),filter.setAttributeNS(null,"result","OffsetBlurAlpha"),filter=map.Dom.newNode("feColorMatrix",filterNode),filter.setAttributeNS(null,"in","OffsetBlurAlpha"),filter.setAttributeNS(null,"type","matrix"),filter.setAttributeNS(null,"values","0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0 0 0 1 0"),filter.setAttributeNS(null,"result","matrixOut"),filter=map.Dom.newNode("feMerge",filterNode);var merge=map.Dom.newNode("feMergeNode",filter);merge.setAttributeNS(null,"in","matrixOut"),merge=map.Dom.newNode("feMergeNode",filter),merge.setAttributeNS(null,"in","SourceGraphic");var bBox=map.Dom.getBox(shapeGroup.lastChild);bBox.width&&bBox.height&&shapeGroup.style.setProperty("filter","url(#"+szShadowFilterId+")","")}}}}}if(this.szFlag.match(/BOX/))if(this.nBoxUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper||this.nBoxLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nBoxLower){var boxGroup=SVGDocument.getElementById(this.szId+":"+p+":chart:box");boxGroup&&boxGroup.parentNode.removeChild(boxGroup)}else for(var nAi=0;nAi<this.indexA.length;nAi++){var a=this.indexA[nAi];if(this.itemA[a].fDone){var p=this.itemA[a].szSelectionId,shapeGroup=SVGDocument.getElementById(this.szId+":"+p+":chart"),chartGroup=SVGDocument.getElementById(this.szId+":"+p+":chartgroup"),boxGroup=SVGDocument.getElementById(this.szId+":"+p+":chart:box");if(shapeGroup&&boxGroup&&!boxGroup.getAttributeNS(szMapNs,"boxed")){this.szFlag.match(/\bPLOT\b/)&&chartGroup&&chartGroup.style.setProperty("display","none");var bBox=map.Dom.getBox(shapeGroup),margin=map.Scale.normalX(this.nBoxMargin||2);margin=Math.min(2*margin,margin*(bBox.width/map.Scale.normalX(nChartSize)));var center=new point(bBox.x+bBox.width/2,bBox.y+bBox.height/2);if(this.szFlag.match(/CIRCULAR/)){var radius=Math.max(bBox.width,bBox.height)/2*1.1+margin,circularbox=map.Dom.newShape("circle",boxGroup.parentNode,center.x,center.y,radius,"fill:"+(this.szBoxColor||"#eeeeee")+";stroke:"+(this.szBorderColor||"#dddddd")+";fill-opacity:"+(this.nBoxOpacity||1));boxGroup.parentNode.insertBefore(circularbox,boxGroup.parentNode.firstChild),boxGroup.parentNode.removeChild(boxGroup),bBox.x-=(2*radius-bBox.width)/2,bBox.y-=(2*radius-bBox.height)/2,bBox.height=bBox.width=2*radius}if(this.szFlag.match(/TITLE/)&&this.szTitleField&&(!this.szTitleUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nTitleUpper)&&(!this.szTitleLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nTitleLower)){var nFontSize=map.Scale.normalX(5);this.szFlag.match(/DTEXT/)&&(nFontSize=Math.max(map.Scale.normalX(.9),Math.min(bBox.width/5,map.Scale.normalX(14/this.nScale)))),this.szFlag.match(/GRIDSIZE/)&&(nFontSize=Math.max(bBox.width/10,map.Scale.normalX(6))),nFontSize*=this.nTextScale||this.nValueScale||1;var szTitle=this.itemA[a].szTitle;try{var szTitle=HTMLWindow.ixmaps.htmlgui_onInfoTitle(this.itemA[a].szTitle,this.itemA[a])}catch(e){}szTitle+=this.szTitleUnits||"";var textColor=this.szTextColor||"#888888",posY=this.szFlag.match(/BOTTOMTITLE/)?bBox.y+bBox.height+1*nFontSize:bBox.y-.7*nFontSize;this.szFlag.match(/BAR/)&&!this.szFlag.match(/BOTTOMTITLE/)&&(posY=this.nMaxValue?-this.nMaxValue*nChartSize/this.nScale:posY);var newText=null,newTextBg=null;this.szFlag.match(/CIRCULAR/)?(newTextBg=map.Dom.newText(shapeGroup,center.x+10,posY,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:middle;fill:none;stroke:white;stroke-width:"+nFontSize/7+"px;opacity:0.5;pointer-events:none;",String(szTitle||" ")),newText=map.Dom.newText(shapeGroup,center.x+10,posY,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:middle;fill:"+textColor+";stroke:none;pointer-events:none;",String(szTitle||" "))):this.szAlign&&this.szAlign.match(/right/)?(newTextBg=map.Dom.newText(shapeGroup,bBox.x+bBox.width,posY,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:end;fill:none;stroke:white;stroke-width:"+nFontSize/7+"px;opacity:0.5;pointer-events:none;",String(szTitle||" ")),newText=map.Dom.newText(shapeGroup,bBox.x+bBox.width,posY,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:end;fill:"+textColor+";stroke:none;pointer-events:none;",String(szTitle||" "))):(newTextBg=map.Dom.newText(shapeGroup,bBox.x,posY,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:start;fill:none;stroke:white;stroke-width:"+nFontSize/7+"px;opacity:0.5;pointer-events:none;",String(szTitle||" ")),newText=map.Dom.newText(shapeGroup,bBox.x,posY,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:start;fill:"+textColor+";stroke:none;pointer-events:none;",String(szTitle||" "))),map.Dom.wrapText(newTextBg,bBox.width);var nRows=map.Dom.wrapText(newText,bBox.width);if(this.szFlag.match(/BOTTOMTITLE/)||(newTextBg.fu.setPosition(newText.fu.getPosition().x,newText.fu.getPosition().y-1*nFontSize*(nRows-1)),newText.fu.setPosition(newText.fu.getPosition().x,newText.fu.getPosition().y-1*nFontSize*(nRows-1))),this.szFlag.match(/CLIPPEDTITLE/)){var oldHeight=bBox.height;bBox.height+=1.8*nFontSize,bBox.y-=bBox.height-oldHeight,map.Dom.setClipRect(newText,new box(bBox.x,bBox.y-10*nFontSize,bBox.width-nFontSize/3,20*nFontSize))}else bBox=map.Dom.getBox(shapeGroup),bBox.y+=.1*nFontSize,bBox.height-=.1*nFontSize;if(this.szTimeField){var uTime=new Date(this.itemA[a].szTime).getTime()||this.itemA[a].szTime;newText.setAttributeNS(szMapNs,"time",uTime)}}if(this.szFlag.match(/\bPLOTX\b/)){var oldHeight=bBox.height;bBox.height=map.Scale.normalX(nChartSize),bBox.y=-map.Scale.normalX(nChartSize/2),bBox.width=this.nMax*map.Scale.normalX(1.1*nChartSize)/this.nMax*5*(this.nRangeScale||1)}else if(this.szFlag.match(/\bPLOTY\b/)){var oldHeight=bBox.height,oldWidth=bBox.width;bBox.width=map.Scale.normalX(nChartSize),bBox.height=this.nMax*map.Scale.normalX(1.1*nChartSize)/this.nMax*5*(this.nRangeScale||1),bBox.x-=(bBox.width-oldWidth)/2,bBox.y-=(bBox.height-oldHeight)/2}var _width=bBox.width+2*margin,_height=bBox.height+2*margin;if(_width>=0&&_height>=0&&(boxGroup.setAttributeNS(null,"x",bBox.x-margin),boxGroup.setAttributeNS(null,"y",bBox.y-margin),boxGroup.setAttributeNS(null,"width",bBox.width+2*margin),boxGroup.setAttributeNS(null,"height",bBox.height+2*margin)),(this.szFlag.match(/AUTOSIZE/)||this.szFlag.match(/GRIDSIZE/))&&bBox.width>bBox.height&&(boxGroup.setAttributeNS(null,"y",bBox.y-margin-(bBox.width-bBox.height)),boxGroup.setAttributeNS(null,"height",bBox.width+2*margin)),void 0!==this.nBorderRadius&&!isNaN(this.nBorderRadius)){var nCorner=Math.min(map.Scale.normalX(this.nBorderRadius),map.Scale.normalX(this.nBorderRadius*(bBox.width/map.Scale.normalX(nChartSize))));boxGroup.setAttributeNS(null,"rx",nCorner),boxGroup.setAttributeNS(null,"ry",nCorner)}var nStroke=map.Scale.normalX(.2*(this.szBorderWidth||1)*(bBox.width/map.Scale.normalX(nChartSize)));if(boxGroup.style.setProperty("stroke-width",nStroke),boxGroup.setAttributeNS(szMapNs,"boxed","1"),this.szFlag.match(/\bPLOT\b/)&&chartGroup&&chartGroup.style.setProperty("display","inline"),this.szTimeField){var uTime=new Date(this.itemA[a].szTime).getTime()||this.itemA[a].szTime;boxGroup.setAttributeNS(szMapNs,"time",uTime)}}}}if(_TRACE("== drawing done === "),this.szFlag.match(/FEATURE/)){map.Themes.addToThemeNodesCache(this.chartGroup);var themes=map.Themes.getAllThemes();for(var i in themes)themes[i]!=this&&!themes[i].szFlag.match(/FEATURE/)&&themes[i].szThemesA[0]==this.szThemesA[0]&&themes[i].fDone&&(themes[i].fRealize=!0,setTimeout("map.Themes.execute()",500))}if(this.szItemFilter&&this.szItemFilter.length&&this.filterItems(this.szItemFilter,this.itemFilterOpt),null!=this.markedClass&&this.markClass(this.markedClass,1),this.isVisible=!0,this.realizeDone(),this.fShowProgressBar=!1,displayProgressBar(1,1,"",1,"",1),this.showInfo(),this.szFlag.match(/SHOWSTATISTIC/)&&this.showErrorInfo(),this.szFlag.match(/\bCLIP\b/))if(this.nClipFrames==this.itemA[a].nValuesA.length)this.szXaxisA&&this.szXaxisA[this.nActualFrame]?displayMessage(this.szXaxisA[this.nActualFrame],3e3,"big"):this.szLabelA&&this.szLabelA[this.nActualFrame]&&displayMessage(this.szLabelA[this.nActualFrame],3e3,"big");else{var labelA=this.szXaxisA||this.szLabelA;labelA&&(0===this.nActualFrame?displayMessage(labelA[0],3e3,"big"):this.nActualFrame==this.nClipFrames-1?displayMessage(labelA[1],3e3,"big"):displayMessage(" ... ",3e3,"big"))}else this.ErrorMessage?(displayMessage(this.ErrorMessage,1e4,"notify"),this.ErrorMessage=null):clearMessage();if(this.fSorted||(this.fResort=!0,map.Themes.execute()),this.szFlag.match(/DECLUTTER/)&&this.declutterCharts(),this.szFlag.match(/\bANIMATESCALE\b/)&&this.animateCharts("scale"),this.szFlag.match(/\bANIMATESCALEXX\b/)&&this.animateCharts("fire"),this.szFlag.match(/\bUSER\b/))try{var opt={target:this.chartGroup,theme:this};this.userDraw&&(this.opt=opt,eval("HTMLWindow.ixmaps."+this.userDraw+"_finish(SVGDocument,this.opt);"),delete this.opt)}catch(e){}}},MapTheme.prototype.sortChartObjects=function(){if(!(!this.chartGroup||this.szFlag.match(/NOSRT/)||this.szFlag.match(/NOSIZE/)&&!this.szFlag.match(/3D/)||this.szFlag.match(/CATEGORICAL/)&&!this.szFlag.match(/AGGREGATE/)&&!this.szSizeField)){var e,t=null,i=[],a=this.chartGroup.childNodes;if(this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/BUFFER/)||this.szFlag.match(/TEXTONLY/))for(var s=0;s<a.length;s++){t=a.item(s);i[s]={node:t,y:Math.abs(Number(t.getAttributeNS(szMapNs,"value")))}}else{var n=getRotateAttributeValue(map.Scale.canvasNode)/180*Math.PI;for(s=0;s<a.length;s++){t=a.item(s);i[s]=n?{node:t,y:getTranslate(t).x*Math.sin(n)+getTranslate(t).y*Math.cos(n)}:{node:t,y:getTranslate(t).y}}}this.szFlag.match(/\bSORT\b/)&&this.szFlag.match(/\bUP\b/)&&!this.szFlag.match(/SEQUENCE/)?i.sort(this.sortDownChartObjectsCompare):i.sort(this.sortUpChartObjectsCompare);for(s=0;s<i.length;s++)i[s].node.parentNode.appendChild(i[s].node);(e=getMatrix(this.chartGroup))&&setMatrix(this.chartGroup,e)}},MapTheme.prototype.sortUpChartObjectsCompare=function(e,t){return e.y-t.y},MapTheme.prototype.sortDownChartObjectsCompare=function(e,t){return t.y-e.y},MapTheme.prototype.getChartSize=function(e,t,i,a){if(i.match(/NOSIZE/))return Math.max(5,t/4);a=Math.abs(a);var s=0,n=Math.max(5,t/2),l=this.nMax-this.nMin,h=this.nMax100-this.nMin100;this.nNormalSizeValue&&(l=h=this.nMaxSize=this.nNormalSizeValue);var o=this.itemA[e].nValue100A[0];return i.match(/SIZE/)&&!i.match(/NORMSIZE/)&&this.szSizeField&&e&&this.itemA[e]?n=i.match(/SIZELOG/)?Math.max(1,n/Math.log(this.nMaxSize)*Math.log(this.itemA[e].nSize)):n/Math.pow(this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[e].nSize,1/this.nSizePow):i.match(/SIZE/)&&!i.match(/NORMSIZE/)&&(n=i.match(/SIZELOG/)?Math.max(1,n/Math.log(l)*Math.log(a)):n/Math.pow(l,1/this.nSizePow)*Math.pow(a,1/this.nSizePow)),s=map.Scale.normalX(10),i.match(/HEIGHT/)&&!i.match(/NORMSIZE/)&&(s=i.match(/SIZE/)?this.szSizeField&&e&&this.itemA[e]?s*Math.pow(10/l*this.itemA[e].nSize,1/3)*3:s*Math.pow(10/l*a,1/3)*3:o&&this.nMax100&&this.nMin100&&!i.match(/FRACTION/)?10*s/h*o:10*s/l*a),i.match(/ZOOM/)&&(n*=map.Scale.nObjectScaling,this.origSize=n,n=t/10+1*n/(Math.log(Math.abs(l))*Math.log(Math.abs(a))||1),n=Math.min(n,t),n=Math.max(n,t/5)),Math.abs(n)},MapTheme.prototype.checkChartSize=function(e,t,i,a){if(this.nChartSizeMin&&!i.match(/ZOOM/)&&this.getChartSize(e,t,i,a)/map.Layer.nObjectScale<this.nChartSizeMin)return!1;return!0},MapTheme.prototype.getChart=function(e,t,i,a,s){return this.fRealizeDone||this.realize(),this.drawChart(e,t,i,a,s)},MapTheme.prototype.drawChart=function(chartGroup,a,nChartSize,szFlag,nMark){var nPartsA=null,nValue100=0,nMax=0;if(this.szChartFlag=szFlag,a){if(!this.itemA[a])return null;this.itemA[a].fDone=!1;var nPartsA=this.itemA[a].nValuesA,nValue100=this.itemA[a].nValue100A[0],nMax=Math.max(this.nMax,Math.abs(this.nMin)),nMySum=0;if(!this.szFlag.match(/BUFFER/))for(var i=0;i<nPartsA.length;i++)isNaN(nPartsA[i])&&(nPartsA[i]=0),nMySum+=nPartsA[i];if(this.szFlag.match(/MORPH/)&&this.szFlag.match(/\bCLIP\b/)&&this.nClipFrames){nPartsA=[];var nValueA=this.itemA[a].nValuesA;for(i=0;i<nValueA.length/2;i++){var nValue=nValueA[i]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+nValueA[i+nValueA.length/2]*this.nActualFrame/(this.nClipFrames-1);nPartsA[i]=nValue}for(var nMySum=0,i=0;i<nPartsA.length;i++)isNaN(nPartsA[i])&&(nPartsA[i]=0),nMySum+=nPartsA[i]}if(szFlag.match(/NOPE/))return new point(0,0);if(szFlag.match(/\bDOT\b/)){var nSize=1,nValue=nPartsA[0];if(szFlag.match(/CATEGORICAL/))this.chart.szColor=this.colorScheme[nValue];else if(this.colorScheme.length>2||this.szRanges&&this.szRanges.length)for(fDoDraw=!1,i=0;i<this.partsA.length;i++)if(nValue<this.partsA[i].max){this.chart.szColor=this.colorScheme[i];var cColor=__maptheme_getChartColors(szColor);szFlag.match(/NOLINES/)?this.chart.szLineColor="none":this.chart.szLineColor=cColor.textColor,szFlag.match(/RANGE/)&&!szFlag.match(/RANGES/)&&(nSize=map.Scale.normalX(2+5*(i+1)/this.partsA.length)),nClass=i,fDoDraw=!0;break}return newShape=map.Dom.newShape("circle",chartGroup,0,0,map.Scale.normalX(3),"fill:"+this.chart.szColor+";stroke:none;"),new point(0,0)}}else{var nPartsA=[],nMySum=0;if(szFlag=szFlag||this.szFlag+"|XAXIS",this.szOrigFlag.match(/CATEGORICAL/))if(this.szOrigFlag.match(/SUM/))for(var i=0;i<this.colorScheme.length;i++)this.partsA[i]&&(nPartsA[i]=this.partsA[i].nSum,nMax=Math.max(nMax,this.partsA[i].nSum),nMySum+=nPartsA[i]);else if(this.szOrigFlag.match(/COUNT/))for(var i=0;i<this.colorScheme.length;i++)nPartsA[i]=100*this.partsA[i].nSum,nMax=Math.max(nMax,100*this.partsA[i].nSum),nMySum+=nPartsA[i];else for(var i=0;i<this.colorScheme.length;i++)nPartsA[i]=this.nOrigSumA[i]||this.exactCountA[i]||1,nMax=Math.max(nMax,this.nOrigSumA[i]||this.exactCountA[i]||1);else if(this.szOrigFlag.match(/COUNT/))for(var i=0;i<this.colorScheme.length;i++)nPartsA[i]=this.partsA[i].nCount,nMax=Math.max(nMax,this.partsA[i].nCount),nMySum+=nPartsA[i];else for(var i=0;i<this.colorScheme.length;i++)nPartsA[i]=this.partsA[i].nSum,nMax=Math.max(nMax,this.partsA[i].nSum),nMySum+=nPartsA[i];var nValue100=this.nSum100;if(nValue100){nMax=0,nMySum=nValue100;for(var i=nPartsA.length-1;i>=0;i--)this.szFlag.match(/DIFFERENCE/)?nValue100=i>0?nPartsA[i-1]:this.nSum100:this.szFlag.match(/CALCVAL/)||this.szFlag.match(/CALC100/)||this.szFlag.match(/PRODUCT/)?nPartsA[i]=nPartsA[i]:(nPartsA[i]=nPartsA[i]/nValue100,nMax=Math.max(nMax,nPartsA[i]),this.szFlag.match(/PERMILLE/)?nPartsA[i]=1e3*nPartsA[i]:this.szFlag.match(/FRACTION/)||(nPartsA[i]=100*nPartsA[i]),this.szFlag.match(/RELATIVE/)&&(nPartsA[i]=nPartsA[i]-100),this.szFlag.match(/INVERT/)&&(nPartsA[i]=100-nPartsA[i]));if(this.szFlag.match(/STACKED/)){if(nMax=100,this.szFlag.match(/NORMSIZE/)||szFlag.match(/NORMSIZE/)){nMax=0;for(var i=0;i<nPartsA.length;i++)nMax+=nPartsA[i]}}else nMax*=100,nMax+=nMax/10,nMax=this.nMax}else{if(this.szFlag.match(/DIFFERENCE/))for(var i=nPartsA.length-1;i>=0;i--)i>0?nPartsA[i]-=nPartsA[i-1]:this.szFlag.match(/STACKED/)||(nPartsA[i]=0);if(a&&this.szAggregation&&this.szAggregation.match(/mean/)){for(var i=0;i<nPartsA.length;i++)nPartsA[i]=nPartsA[i]/this.nCount;this.szFlag.match(/MENUSIZE/)?nMax/=this.nCount:nMax=this.nMax}if(this.szFlag.match(/MEAN/))for(var i=0;i<nPartsA.length;i++)nPartsA[i]=nPartsA[i]/this.partsA[i].nCount;if(this.szFlag.match(/STACKED/)&&(this.szFlag.match(/NORMSIZE/)||szFlag.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||szFlag.match(/MENUSIZE/))){nMax=0;for(var i=0;i<nPartsA.length;i++)nMax+=nPartsA[i]}}}if(this.nChartSizeMin&&!szFlag.match(/ZOOM/)){var nSize=a?this.getChartSize(a,nChartSize,szFlag,nMySum):1;if(nSize/map.Layer.nObjectScale<this.nChartSizeMin)return null}else if(!this.szFlag.match(/MULTIFIX|MULTIGRID|MULTIQUAD/)){var nSize=a?this.getChartSize(a,nChartSize,szFlag,nMySum):1;if(isNaN(nSize)||0===nSize)return null}var ptNull=new point(0,0);if(szFlag?(!szFlag.match(/CHART/)&&szFlag.match(/VALUES/)||szFlag.match(/NORMSIZE/)||szFlag.match(/MENUSIZE/))&&(szFlag=this.szFlag+"|"+szFlag):szFlag=this.szFlag,szFlag.match(/DOMINANT|COMPOSE/)&&!szFlag.match(/CHART/)&&(szFlag=szFlag.match(/PERCENTOFMEAN/)?"BAR|OFFSETMEAN|POINTER|XAXIS|VALUES|ZOOM":szFlag.match(/PERCENTOFMEDIAN/)?"BAR|OFFSETMEDIAN|POINTER|XAXIS|VALUES|ZOOM":szFlag.match(/DEVIATION/)?"BAR|DEVIATION|POINTER|VALUES|ZOOM":"BAR|XAXIS|HORZ|SORT|VALUES|ZOOM"),szFlag.match(/ZOOM/)&&szFlag.match(/BAR/)&&szFlag.match(/POINTER/)&&nPartsA.length>1&&(szFlag=this.removeDefinition(szFlag,"SIZE")+"|COMPRESSMAX"),1==nPartsA.length&&0===nPartsA[0]&&!szFlag.match(/ZEROISVALUE|AUTOCOMPLETE|CATEGORICAL/))return this.nZeroValueCount++,null;szFlag.match(/VALUES/)&&(this.fHideValues=!1,szFlag.match(/ZOOM/)||(this.fHideValues=this.szValueUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nValueUpper||this.szValueLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nValueLower),szFlag.match(/ZOOM/)&&szFlag.match(/PIE/)&&nPartsA.length>25&&(szFlag=this.removeDefinition(szFlag,"VALUES")));var shapeGroup=map.Dom.newGroup(chartGroup,this.szId+":"+a+(a?":chartgroup":":ochrtgroup")),shapeOnTopGroup=null,textOnTopGroup=null;if(szFlag.match(/MOVABLE/)&&(shapeGroup.setAttributeNS(null,"id",shapeGroup.getAttributeNS(null,"id")+":movable"),shapeGroup.setAttributeNS(null,"onmousedown",'map.Themes.initChartOffset(evt,"'+this.szId+'","'+this.szId+":"+a+':chartgroup:movable")'),shapeGroup.setAttributeNS(null,"onmouseup",'map.Themes.endChartOffset(evt,"'+this.szId+'","'+this.szId+":"+a+':chartgroup:movable")')),szFlag.match(/CHOROPLETH/)){var nMaxRadius=map.Scale.normalX(nChartSize/2),nRadius=2*nMaxRadius/3,szColor=this.colorScheme[0],szLineColor=this.colorScheme[1]?this.colorScheme[1]:"none",nLineWidth=map.Scale.normalX(.1)*map.Scale.nFeatureScaling*map.Scale.nObjectScaling,newShape=map.Dom.constructNode("use",shapeGroup,{"xlink:href":"#choropleth_icon"});newShape.fu.scale(2,2),nChartSize=2*nRadius/map.Scale.normalX(1),ptNull.x=0,ptNull.y=nRadius+map.Scale.normalY(5)}if(szFlag.match(/BLANK/))return null;if(szFlag.match(/\bUSER\b/))try{var nMaxRadius=map.Scale.normalX(nChartSize/2);if(szFlag.match(/AUTOSIZE/)){var nDynScale=map.Layer.nDynamicObjectScale,nAutoSize=szFlag.match(/\bRECT\b/)?szFlag.match(/GAP/)?2.3:2:szFlag.match(/GAP/)?1.7:1.6;nMaxValue=Math.max(this.nAllMaxValue,this.nMax),nMaxRadius=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/nAutoSize/nDynScale:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/nAutoSize/nDynScale:nMaxRadius}var nMaxValue=Math.max(this.nMax,this.nMaxA[0]);this.nNormalSizeValue&&(nMaxValue=this.nNormalSizeValue,this.nMaxSize=this.nNormalSizeValue);var nValue=this.itemA[a].nValuesA[0],szColor=this.colorScheme[0],szLineColor=this.colorScheme[1]?this.colorScheme[1]:"none",szTextColor=this.colorScheme[1]?this.colorScheme[1]:"white";if((this.colorScheme.length>2||szFlag.match(/CATEGORICAL/))&&(szColor=this.colorScheme[this.colorScheme.length-1],szLineColor=this.colorScheme[0]),szFlag.match(/NOLINES/))szLineColor="none";else if("none"==szLineColor){var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.lowColor}if(szFlag.match(/CATEGORICAL/)){nClass=nValue-1,szColor=this.colorScheme[nClass]||this.colorScheme[0];var cColor=__maptheme_getChartColors(szColor);szTextColor=cColor.textColor,szLineColor=szFlag.match(/NOLINES/)?"none":cColor.lowColor,szFlag.match(/RANGE/)&&!szFlag.match(/RANGES/)&&(nRadius=map.Scale.normalX(2+5*(i+1)/this.partsA.length)),fDoDraw=!0}else if(this.szFlag.match(/COMPOSECOLOR/))this.szFlag.match(/SUBTRACTIVE/)?this.itemA[a].szColor=__maptheme_getComposedColor_subtractive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[a].szColor=__maptheme_getComposedColor_additive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));else if(this.colorScheme.length>2||this.partsA.length>1||this.szRanges&&this.szRanges.length)if(fDoDraw=!1,this.szFlag.match(/DOMINANT/)){var nRelevanz=0,nLastRelevant=0;for(nIndex=-1,i=0;i<this.itemA[a].nValuesA.length;i++){nValue=this.itemA[a].nValuesA[i];var nPercentOfMean=100/this.nMeanA[i]*nValue,nPercentOfMedian=100/this.nMedianA[i]*nValue,nDeviation=(nValue-this.nMeanA[i])/this.nDeviationA[i];nRelevanz=nValue,this.szFlag.match(/PERCENTOFMEAN/)&&(nRelevanz=nPercentOfMean),this.szFlag.match(/PERCENTOFMEDIAN/)&&(nRelevanz=nPercentOfMedian),this.szFlag.match(/DEVIATION/)&&(nRelevanz=nDeviation),nValue>this.nFilterA[i]&&nRelevanz>nLastRelevant&&(this.itemA[a].nClass=i,nLastRelevant=nRelevanz,nIndex=i)}if(nIndex>=0){this.itemA[a].nDominant=nIndex,nValue=this.itemA[a].nValuesA[nIndex],szLabel=" "+this.szFieldsA[nIndex]+" ",this.szLabelA&&this.szLabelA[nIndex]&&(szLabel=" "+this.szLabelA[nIndex]+" "),this.itemA[a].nValue=this.itemA[a].nValuesA[nIndex],this.itemA[a].szLabel=szLabel,szColor=this.colorScheme[nIndex];var cColor=__maptheme_getChartColors(szColor);szTextColor=cColor.textColor,szLineColor=szFlag.match(/NOLINES/)?"none":cColor.lowColor,nClass=nIndex,fDoDraw=!0,nValue=nPartsA[nClass||0]}}else for(i=0;i<this.partsA.length;i++)if(nValue>=this.partsA[i].min&&nValue<this.partsA[i].max){szColor=this.colorScheme[i];var cColor=__maptheme_getChartColors(szColor);szTextColor=cColor.textColor,szLineColor=szFlag.match(/NOLINES/)?"none":cColor.lowColor,szFlag.match(/RANGE/)&&!szFlag.match(/RANGES/)&&(nRadius=map.Scale.normalX(2+5*(i+1)/this.partsA.length)),nClass=i,fDoDraw=!0;break}if(this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(this.nClipFrames==nPartsA.length?(nValue=Number(nPartsA[this.nActualFrame]),nMaxValue=this.nNormalSizeValue||this.nMaxA[this.nActualFrame]):nValue=nPartsA[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+nPartsA[nPartsA.length-1]*this.nActualFrame/(this.nClipFrames-1),0===nValue&&!szFlag.match(/ZEROISVALUE/)))return null;if(szFlag.match(/INVERTSIZE/)&&nMaxValue-nPartsA[0]==0&&!szFlag.match(/ZEROISVALUE/))return null;var nSizeValue=a&&this.itemA[a]&&this.szSizeField?this.itemA[a].nSize||0:nValue,nSizeMax=a&&this.itemA[a]&&this.szSizeField?this.nMaxSize:nMaxValue;if(0===nSizeValue&&!szFlag.match(/NOSIZE/))return null;if(this.nMinValue&&nSizeValue<this.nMinValue)return null;nRadius=szFlag.match(/GRIDSIZE/)?this.nGridSize:szFlag.match(/MENUSIZE/)?map.Scale.normalX(nChartSize/2.5):szFlag.match(/CATEGORICAL/)&&!this.szSizeField?nMaxRadius/3/(this.nNormalSizeValue||1):szFlag.match(/NOSIZE/)?nMaxRadius/2:szFlag.match(/FIXSIZE/)?nMaxRadius/2/(this.nNormalSizeValue||1):szFlag.match(/NORMSIZE/)?2*nMaxRadius/3/(szFlag.match(/CATEGORICAL/)?1:Math.log(nSizeMax)*Math.log(Math.abs(nSizeValue))):szFlag.match(/SUM/)&&!a?2*nMaxRadius/3:nMaxRadius/Math.pow(nSizeMax,1/this.nSizePow)*Math.pow(Math.abs(nSizeValue),1/this.nSizePow),shapeGroup.parentNode.setAttributeNS(szMapNs,"value",String(nValue)),shapeGroup.parentNode.setAttributeNS(szMapNs,"class",String(nClass));var textColor=__maptheme_getChartColors(szColor).lowColor,objTheme=this.objThemesA[this.szThemesA[0]],opt={target:shapeGroup,theme:this,item:this.itemA[a],value:nValue,values:nPartsA,size:nRadius,maxSize:nMaxRadius,color:szColor,textcolor:textColor,ccolor:__maptheme_getChartColors(szColor),class:nClass,flag:szFlag,mark:nMark,dbRecord:objTheme.dbRecords?objTheme.dbRecords[this.itemA[a].dbIndex]:null};this.ptNullUser=null,this.userDraw?(this.opt=opt,eval("this.ptNullUser = HTMLWindow.ixmaps."+this.userDraw+"(SVGDocument,this.opt);"),delete this.opt):this.ptNullUser=HTMLWindow.ixmaps.htmlgui_drawChart(SVGDocument,opt),this.ptNullUser?(shapeGroup.fu.setPosition(shapeGroup.fu.getPosition().x-this.ptNullUser.x,shapeGroup.fu.getPosition().y-this.ptNullUser.y),this.ptNullUser.x=0,this.ptNullUser.y=0):this.userChartDrawError=(this.userChartDrawError||0)+1}catch(e){}if(szFlag.match(/PIE/)){if(0===nMySum&&!szFlag.match(/AUTOCOMPLETE/))return null;if(szFlag.match(/\bSORT\b/)){for(this.sortedIndex=[],i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;if(szFlag.match(/\bREVERSE\b/))for(this.sortedIndex=[],i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:nPartsA.length-i,value:nPartsA[i]};if(this.nCenterValue=0,szFlag.match(/CENTER/)){this.nCenter=0;for(var __nSum=0,__nMax=-Number.MAX_VALUE,__nMin=Number.MAX_VALUE,p=0;p<(this.nClipParts||nPartsA.length);p++){var nI=this.sortedIndex?this.sortedIndex[p].index:p;__nSum+=nPartsA[nI]||0,nPartsA[nI]<__nMin&&(__nMin=nPartsA[nI],this.nCenterMin=nI),nPartsA[nI]>__nMax&&(__nMax=nPartsA[nI],this.nCenterMax=nI)}this.szCenterPart=this.szCenterPart||"max",this.szCenterPart&&("first"==this.szCenterPart?this.nCenter=0:"last"==this.szCenterPart?this.nCenter=nPartsA.length-1:"min"==this.szCenterPart?this.nCenter=this.nCenterMin:"max"==this.szCenterPart?this.nCenter=this.nCenterMax:Number(this.szCenterPart)&&(this.nCenter=Number(this.szCenterPart))),this.nCenterValue=nPartsA[this.nCenter],this.nCenterSize=this.nCenterValue/__nSum*100}var nHeight=0,nSize=Math.max(5,nChartSize/2),nRange=this.nMax-this.nMin,nRange100=this.nMax100-this.nMin100;this.nNormalSizeValue&&(nRange=nRange100=this.nNormalSizeValue),szFlag.match(/GRIDSIZE/)&&!szFlag.match(/NORMSIZE/)?nSize=this.nGridSize/nChartSize*(szFlag.match(/\bRECT\b/)?.72:.6):szFlag.match(/SIZE/)&&!szFlag.match(/NORMSIZE/)&&this.szSizeField&&a&&this.itemA[a]?nSize=szFlag.match(/SIZELOG/)?Math.max(1,nSize/Math.log(this.nMaxSize)*Math.log(this.itemA[a].nSize)):nSize/Math.pow(this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[a].nSize,1/this.nSizePow):szFlag.match(/SIZE/)&&!szFlag.match(/NORMSIZE/)&&(nSize=szFlag.match(/SIZELOG/)?Math.max(1,nSize/Math.log(nRange)*Math.log(nMySum)):nSize/Math.pow(nRange,1/this.nSizePow)*Math.pow(nMySum,1/this.nSizePow)),nHeight=map.Scale.normalX(10),szFlag.match(/HEIGHT/)&&!szFlag.match(/NORMSIZE/)&&(nHeight=szFlag.match(/SIZE/)?this.szSizeField&&a&&this.itemA[a]?nHeight*Math.pow(10/nRange*this.itemA[a].nSize,1/3)*3:nHeight*Math.pow(10/nRange*nMySum,1/3)*3:nValue100&&this.nMax100&&this.nMin100&&!szFlag.match(/FRACTION/)?10*nHeight/nRange100*nValue100:10*nHeight/nRange*nMySum),szFlag.match(/ZOOM/)&&(nSize*=map.Scale.nObjectScaling,this.origSize=nSize,nSize=nChartSize/10+3*nSize/Math.log(nRange)*Math.log(nMySum)*map.Layer.nDynamicObjectScale,nSize=Math.min(nSize,1.2*nChartSize),nSize=Math.max(nSize,nChartSize/2));for(var donutsA=[],s=0;s<(this.nGridX||1);s++){var donut=DonutCharts.newChart(SVGDocument,shapeGroup,0,0,map.Scale.normalX(nSize),0);if(donut.ident=s,ptNull.x=0,ptNull.y=map.Scale.normalY(nSize)+map.Scale.normalY(5),donut.setStyle("flat"),donut.setLine("#555566"),donut.setLineWidth(map.Scale.normalX(this.nLineWidth||.1)),szFlag.match(/NOLINES/)&&donut.setLine("none"),szFlag.match(/WHITELINES/)&&donut.setLine("white"),this.szLineColor&&donut.setLine(this.szLineColor),szFlag.match(/3D/)){donut.setStyle("3D");var nPow=.5;szFlag.match(/P3/)?nPow=1/3:szFlag.match(/P4/)&&(nPow=1/4),szFlag.match(/SIZE/)&&!szFlag.match(/NORMSIZE/)&&this.szSizeField&&a&&this.itemA[a]?nHeight=nHeight/Math.pow(this.nMaxSize,nPow)*Math.pow(this.itemA[a].nSize,nPow):szFlag.match(/SIZE/)&&!szFlag.match(/NORMSIZE/)&&(nHeight=nHeight/Math.pow(nRange,nPow)*Math.pow(nMySum,nPow)),szFlag.match(/ZOOM/)&&(nHeight*=map.Scale.nObjectScaling,nHeight=nHeight/this.origSize*nSize),ptNull.y*=.7}if(szFlag.match(/VOLUME/)&&donut.addStyle("VOLUME"),szFlag.match(/DONUT/))szFlag.match(/3D/)?donut.setRadInner(map.Scale.normalX(.5*nSize)):szFlag.match(/XTHIN/)?donut.setRadInner(map.Scale.normalX(.95*nSize)):szFlag.match(/THIN/)?donut.setRadInner(map.Scale.normalX(.66*nSize)):szFlag.match(/THICK/)?donut.setRadInner(map.Scale.normalX(.25*nSize)):donut.setRadInner(map.Scale.normalX(.42*nSize));else if(szFlag.match(/CENTER/)){var radius=Math.sqrt(Math.pow(map.Scale.normalX(nSize),2)/100*this.nCenterSize);donut.setRadInner(radius)}szFlag.match(/STARBURST/)&&(donut.addStyle("STARBURST"),ptNull.y*=.8),szFlag.match(/XLFLOWER/)||szFlag.match(/XLRAYS/)?(donut.addStyle("XLRAYS"),ptNull.y*=.8):szFlag.match(/LFLOWER/)||szFlag.match(/LRAYS/)?(donut.addStyle("LRAYS"),ptNull.y*=.8):szFlag.match(/XSFLOWER/)||szFlag.match(/XSRAYS/)?(donut.addStyle("XSRAYS"),ptNull.y*=.8):szFlag.match(/SFLOWER/)||szFlag.match(/SRAYS/)?(donut.addStyle("SRAYS"),ptNull.y*=.8):(szFlag.match(/FLOWER/)||szFlag.match(/RAYS/))&&(donut.addStyle("RAYS"),ptNull.y*=.8),szFlag.match(/SILENT/)&&donut.addStyle("SILENT"),szFlag.match(/AUTOCOMPLETE/)&&(donut.addStyle("AUTOCOMPLETE"),donut.szNoDataColor=this.szNoDataColor||"#eeeeee"),szFlag.match(/BIGTOTOP/)&&donut.addStyle("BIGTOTOP"),szFlag.match(/NOROTATE/)&&donut.addStyle("NOROTATE"),szFlag.match(/ROTATE/)&&donut.addStyle("ROTATE"),szFlag.match(/SYMMETRIC/)&&donut.addStyle("SYMMETRIC"),szFlag.match(/HALFPLUS20/)&&(donut.addStyle("HALFPLUS20"),donut.addStyle("NOROTATE")),szFlag.match(/HALFMINUS20/)&&(donut.addStyle("HALFMINUS20"),donut.addStyle("NOROTATE")),szFlag.match(/HALFPLUS10/)&&(donut.addStyle("HALFPLUS10"),donut.addStyle("NOROTATE")),szFlag.match(/HALFMINUS10/)&&(donut.addStyle("HALFMINUS10"),donut.addStyle("NOROTATE")),szFlag.match(/HALF/)&&(donut.addStyle("HALF"),donut.addStyle("NOROTATE")),szFlag.match(/DIRECTION/)&&donut.addStyle("DIRECTION"),szFlag.match(/DIRECTED/)&&donut.addStyle("DIRECTED"),szFlag.match(/POLAR/)&&s==(this.nGridX||1)-1&&donut.addStyle("POLAR");var nMaxI=0,nMinI=0,nMaxValue=0;if(szFlag.match(/DONUT/))for(var i=0;i<nPartsA.length;i++)nPartsA[i]>nPartsA[nMaxI]&&(nMaxI=i),nPartsA[i]<nPartsA[nMinI]&&(nMinI=i);if(szFlag.match(/STARBURST/)){for(var i=0;i<nPartsA.length;i++)nPartsA[i]=Math.max(nPartsA[i],0),nMaxValue=Math.max(nMaxValue,this.nMaxA[i]);szFlag.match(/\bSIZE\b/)||donut.setNormalSizeValue(this.nNormalSizeValue||this.nMaxValue||nMaxValue),donut.setMaxValue(this.nMaxValue||nMaxValue)}szFlag.match(/BOW/)&&(donut.nBow=1.3),szFlag.match(/SBOW/)&&(donut.nBow=1.2),szFlag.match(/XSBOW/)&&(donut.nBow=1.1),szFlag.match(/LBOW/)&&(donut.nBow=1.5),szFlag.match(/XLBOW/)&&(donut.nBow=1.8),donutsA.push(donut)}for(var nSumPercent=0,stacked=0,i=0;i<(this.nClipParts?Math.min(this.nClipParts,nPartsA.length):nPartsA.length);i++){var nDonut=i%(this.nGridX||1),donut=donutsA[nDonut],szLabel="",nI=i;this.sortedIndex&&(nI=this.sortedIndex[nI].index);var nPartClass=nI;if(!szFlag.match(/CENTER/)||szFlag.match(/DONUT/)||nI!=this.nCenter){szLabel=this.szLabelA&&this.szLabelA[nI]?" '"+this.szLabelA[nI]+"'":" '"+this.szFieldsA[nI]+"'";var szColor=a&&this.itemA[a].szColor||this.colorScheme[nI],szColor=a?this.itemA[a].szColor||this.colorScheme[nI%(this.nGridX||1e5)]:this.colorScheme[nI%(this.nGridX||1e6)];if(szFlag.match(/CLASSES/)||1==nPartsA.length)for(x=0;x<this.partsA.length;x++)if(szFlag.match(/CATEGORICAL/)&&nPartsA[nI]==this.partsA[x].min||!szFlag.match(/CATEGORICAL/)&&nPartsA[nI]<this.partsA[x].max){szColor=this.colorScheme[x],nPartClass=x;break}var szUnit=(szFlag.match(/AUTOCOMPLETE/)&&!this.szUnit.match(/%/)?" % ":"")+this.szUnit;if(this.szShowParts){var szTmpColor=szColor;for(p in szColor="none",this.szShowPartsA)this.szShowPartsA[p]==nI&&(szColor=szTmpColor)}if(nPartsA[nI]>0||0===nPartsA[nI]&&!szFlag.match(/ZEROISNOTVALUE/)){if(szFlag.match(/COUNT/)&&this.itemA[a].nCountA)var donutPart=donut.addPart(nPartsA[nI],nHeight,szColor,0,this.formatValue(this.itemA[a].nCountA[nI],this.nValueDecimals||(this.itemA[a].nCountA[nI]<1?2:0),"ROUND")+szUnit,szLabel);else{0==nDonut&&(nStacked=0);var donutPart=donut.addPart(nPartsA[nI]+(szFlag.match(/STACKED/)?nStacked:0),nHeight,szColor,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(nPartsA[nI],this.nValueDecimals||(nPartsA[nI]<1?2:0),"ROUND")+szUnit),szLabel);nStacked+=nPartsA[nI]}if(donutPart.nClass=nPartClass,szFlag.match(/DIRECTION|DIRECTED/)){var p1=this.itemA[a].ptPos,p2=this.getNodePosition(this.szThemesA[0]+"::"+this.szLabelA[nI]);if(p1&&p2){var angle=Math.atan2(p1.y-p2.y,p2.x-p1.x)*(180/Math.PI);donutPart.nAngle=(450-angle)%360}}}"none"==this.colorScheme[i]&&donut.setLine(this.szLineColor||"black"),nSumPercent+=nPartsA[nI]}}donut.partsA.length<2&&a&&1==this.itemA[a].nCount&&(donut.nRadInner=0);for(var s=(this.nGridX||1)-1;s>=0;s--)donutsA[s].realize();if(szFlag.match(/CENTER/)&&!szFlag.match(/DONUT/)){var nRadius=Math.sqrt(Math.pow(map.Scale.normalX(nSize),2)/100*this.nCenterSize),szColor=this.colorScheme[this.nCenter],circle=map.Dom.newShape("circle",shapeGroup,0,0,.9*nRadius,"fill:"+szColor+";");if(circle&&(circle.setAttributeNS(szMapNs,"class",String(this.nCenter)),circle.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[this.nCenter]+": "+nPartsA[this.nCenter]+this.szUnit:nPartsA[this.nCenter]+this.szUnit)),szFlag.match(/GLOW/)&&!szFlag.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)){var newShapeBg1=map.Dom.newShape("circle",shapeGroup,0,0,6*nRadius,"fill:"+szColor+";stroke:none;fill-opacity:0.05;pointer-events:none;");newShapeBg1&&newShapeBg1.setAttributeNS(szMapNs,"class",String(nCenter));var newShapeBg2=map.Dom.newShape("circle",shapeGroup,0,0,2*nRadius,"fill:"+szColor+";stroke:none;fill-opacity:0.1;pointer-events:none;");newShapeBg2&&newShapeBg2.setAttributeNS(szMapNs,"class",String(nCenter))}if(szFlag.match(/CENTERVALUE/)||szFlag.match(/ZOOM/)||szFlag.match(/VALUES/)&&!this.fHideValues){var szText=this.formatValue(this.nCenterValue,this.nValueDecimals||(this.nCenterSize,0),"ROUND")+(this.szUnit.length<=5?this.szUnit:""),cColor=__maptheme_getChartColors(szColor),szTextColor=cColor.textColor,nFontSize=String(Math.min(.8*nRadius,nRadius*(3.3/szText.length))*this.nValueScale),text=map.Dom.newText(shapeGroup,0,.33*nFontSize,"font-family:arial;font-size:"+nFontSize+"px;font-weight:bold;text-anchor:middle;fill:"+szTextColor+";opacity:"+String(this.nOpacity?this.nOpacity:1)+";stroke:none;pointer-events:none",szText);text&&text.setAttributeNS(szMapNs,"class",String(this.nCenter))}}else if(szFlag.match(/CENTERVALUE/))var szText=String(this.itemA[a].nCount||this.itemA[a].nSize),szTextColor=this.szValueColor||this.szTextColor||"#888888",nRadius=map.Scale.normalX(nSize),nFontSize=String(Math.min(.5*nRadius,nRadius*(2/szText.length))),nOpacity=this.nValueSizeMin?nFontSize/map.Scale.normalX(5):1,newTextbg=map.Dom.newText(shapeGroup,0,.35*nFontSize,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:middle;fill:none;stroke:black;stroke-width:"+nFontSize/40+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",szText),newText=map.Dom.newText(shapeGroup,0,.35*nFontSize,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:middle;fill:"+szTextColor+";opacity:"+nOpacity+";stroke:none;pointer-events:none",szText);if(szFlag.match(/VALUES/)&&!szFlag.match(/STACKED/)&&(szFlag.match(/ZOOM/)||!this.fHideValues)){var nFontSize=Math.min(.8*nSize,nSize*(3.4/(donut.partsA[0]?donut.partsA[0].szText.length:1)));if(nPartsA.length>1||szFlag.match(/NOINLINETEXT/)||szFlag.match(/ZOOM/)&&nFontSize<6){var nFontSize=szFlag.match(/ZOOM/)||szFlag.match(/NORMSIZE/)?map.Scale.normalX(8):map.Scale.normalX(5*(this.nValueScale||1));this.drawDonutText(donut,nFontSize)}else{var szText=donut.partsA[0]?donut.partsA[0].szText:"",cColor=__maptheme_getChartColors(szColor),szTextColor=this.szValueColor||this.szTextColor||cColor.textColor,nRadius=map.Scale.normalX(nSize),nFontSize=String(Math.min(.8*nRadius,nRadius*(3.4/szText.length))),nOpacity=this.nValueSizeMin?nFontSize/map.Scale.normalX(5):1;szFlag.match(/VOLUME/)&&(nHeight=donut.donutPartsA[0].nHeight),szFlag.match(/3D/)||(nHeight=.6*nRadius);var newText=map.Dom.newText(shapeGroup,0,nRadius/2-nHeight+.45*nFontSize,"font-family:arial;font-size:"+nFontSize+"px;text-anchor:middle;fill:"+szTextColor+";opacity:"+nOpacity+";stroke:none;pointer-events:none",szText);szFlag.match(/3D/)&&(newText.fu.setPosition(0,-nRadius/2+nFontSize*(szFlag.match(/VOLUME/)?.5:.25)),newText.fu.scale(1,.5))}}if(this.fillOpacity&&shapeGroup.setAttributeNS(null,"fill-opacity",String(this.fillOpacity)),this.nOpacity&&(shapeGroup.setAttributeNS(null,"fill-opacity",String(this.nOpacity)),shapeGroup.setAttributeNS(null,"stroke-opacity",String(this.nOpacity))),szFlag.match(/FADEDEVIATION/)){var nDev=(nPartsA[0]-this.nMeanA[0])/this.nDeviationA[0];if(nDev>10){var nOpacity=Math.pow(10,.5)/Math.pow(nDev,.5);shapeGroup.setAttributeNS(null,"opacity",String(nOpacity))}}else if(szFlag.match(/LIMITDEVIATION/)){var nDev=(nPartsA[0]-this.nMeanA[0])/this.nDeviationA[0];nDev>10&&shapeGroup.setAttributeNS(null,"opacity","0")}if(szFlag.match(/ZOOM/)&&szFlag.match(/STARBURST/),1==nPartsA.length&&szFlag.match(/CATEGORICAL/))donut.donutPartsA[0]&&(donut.donutPartsA[0].objNode.setAttributeNS(szMapNs,"class",chartGroup.getAttributeNS(szMapNs,"class")),donut.donutPartsA[0].objNode.setAttributeNS(szMapNs,"part",String(i)),donut.donutPartsA[0].textNode&&(donut.donutPartsA[0].textNode.setAttributeNS(szMapNs,"class",chartGroup.getAttributeNS(szMapNs,"class")),donut.donutPartsA[0].textNode.setAttributeNS(szMapNs,"part",String(i))));else for(var i=0;i<donut.donutPartsA.length;i++)donut.donutPartsA[i]&&(donut.donutPartsA[i].objNode.setAttributeNS(szMapNs,"class",String(donut.partsA[i].nClass)),donut.donutPartsA[i].objNode.setAttributeNS(szMapNs,"part",String(i)),donut.donutPartsA[i].textNode&&(donut.donutPartsA[i].textNode.setAttributeNS(szMapNs,"class",String(donut.partsA[i].nClass)),donut.donutPartsA[i].textNode.setAttributeNS(szMapNs,"part",String(i))));this.nRealizedCount++}else if(szFlag.match(/WAFFLE/)){var nChartWidth=map.Scale.normalX(nChartSize);if(szFlag.match(/GRIDSIZE/))nChartWidth=1.05*this.nGridSize;else if(szFlag.match(/AUTOSIZE/)){var nDynScale=map.Layer.nDynamicObjectScale,nAutoSize=szFlag.match(/\bRECT\b/)?szFlag.match(/GAP/)?2.3:2:szFlag.match(/GAP/)?1.7:1.6;nMaxValue=Math.max(this.nAllMaxValue,this.nMax),nChartWidth=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/nAutoSize/nDynScale:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/nAutoSize/nDynScale:nMaxRadius,nChartWidth=nChartWidth/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize)}if(nChartWidth*=.97,newShape=map.Dom.newShape("rect",shapeGroup,-nChartWidth/2+10,-nChartWidth/2+10,nChartWidth-20,nChartWidth-20,"fill:"+(this.szBoxColor||"back")+";stroke:"+(this.szBorderColor||"none")+";stroke-width:"+(this.szBorderWidth||2)+";fill-opacity:"+(this.nBoxOpacity||.05)+";opacity:1;"),nChartWidth*=.9,szFlag.match(/\bSORT\b/)){for(this.sortedIndex=[],i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i]};this.sortedIndex.sort(this.sortIndexDown)}else this.sortedIndex=null;var nMax=Math.max(this.nMax,Math.abs(this.nMin)),nGridX=this.nGridX||(szFlag.match(/WAFFLE100/)?10:Math.max(5,Math.round(Math.sqrt(nMax))));szFlag.match(/AUTO100/)&&(nGridX=10);var nWaffleWidth=nChartWidth/(1.1*nGridX),x=-nChartWidth/2,y=nChartWidth/2,nX=0,nRows=0,nWaffles=1e5;for(szFlag.match(/WAFFLE100/)&&(nWaffles=100),i=0;i<nPartsA.length;i++){var index=this.sortedIndex?this.sortedIndex[i].index:i;if(nPartsA[index]=Math.round(nPartsA[index]),nPartsA[index]){var nPart=Math.min(nPartsA[index],nWaffles);for(nWaffles-=nPartsA[index],ii=0;ii<nPart;ii++)newShape=map.Dom.newShape("rect",shapeGroup,x,y-nWaffleWidth,nWaffleWidth,nWaffleWidth,"fill:"+this.colorScheme[index]+";stroke:null;fill-opacity:"+(this.fillOpacity||1)+";opacity:"+(this.nOpacity||1)+";"),newShape.setAttributeNS(szMapNs,"class",String(index)),newShape.setAttributeNS(szMapNs,"tooltip",this.szLabelA?this.szLabelA[index]+": "+nPartsA[index]+this.szUnit:nPartsA[index]+this.szUnit),x+=1.1*nWaffleWidth,++nX>=nGridX&&(x=-nChartWidth/2,y-=1.1*nWaffleWidth,nX=0)}}this.nRealizedCount++}else if(szFlag.match(/BUBBLE/)||szFlag.match(/SQUARE/)||szFlag.match(/LABEL/)){var nMaxRadius=map.Scale.normalX(nChartSize/2);if(szFlag.match(/AUTOSIZE/)){var nDynScale=map.Layer.nDynamicObjectScale,nAutoSize=szFlag.match(/\bRECT\b/)?szFlag.match(/GAP/)?2.3:2:szFlag.match(/GAP/)?1.7:1.6;nMaxValue=Math.max(this.nAllMaxValue,this.nMax),nMaxRadius=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/nAutoSize/nDynScale:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/nAutoSize/nDynScale:nMaxRadius}var nMaxValue=Math.max(this.nMax,this.nMaxA[0]);this.nNormalSizeValue&&(nMaxValue=this.nNormalSizeValue,this.nMaxSize=this.nNormalSizeValue);var nValue=nPartsA[0];if(this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(this.nClipFrames==nPartsA.length?(nValue=Number(nPartsA[this.nActualFrame]),nMaxValue=this.nNormalSizeValue||this.nMaxA[this.nActualFrame]):nValue=nPartsA[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+nPartsA[nPartsA.length-1]*this.nActualFrame/(this.nClipFrames-1),0===nValue&&!szFlag.match(/ZEROISVALUE/)))return null;if(szFlag.match(/INVERTSIZE/)&&nMaxValue-nPartsA[0]==0&&!szFlag.match(/ZEROISVALUE/))return null;var nSizeValue=a&&this.itemA[a]&&this.szSizeField?this.itemA[a].nSize||0:nValue,nSizeMax=a&&this.itemA[a]&&this.szSizeField?this.nMaxSize:nMaxValue;if(0===nSizeValue&&!szFlag.match(/NOSIZE/))return null;if(this.nMinValue&&nSizeValue<this.nMinValue)return null;nRadius=szFlag.match(/MENUSIZE/)?map.Scale.normalX(nChartSize/2.5):szFlag.match(/CATEGORICAL/)&&!this.szSizeField?nMaxRadius/3/(this.nNormalSizeValue||1):szFlag.match(/NOSIZE/)?nMaxRadius/2:szFlag.match(/FIXSIZE/)?nMaxRadius/2/(this.nNormalSizeValue||1):szFlag.match(/NORMSIZE/)?2*nMaxRadius/3/(szFlag.match(/CATEGORICAL/)?1:Math.log(nSizeMax)*Math.log(Math.abs(nSizeValue))):szFlag.match(/SUM/)&&!a?2*nMaxRadius/3:nMaxRadius/Math.pow(nSizeMax,1/this.nSizePow)*Math.pow(Math.abs(nSizeValue),1/this.nSizePow);var fDoDraw=!0,nClass=null,newShape=null,newShapeBg=null,newShapeBg1=null,newShapeBg2=null,newText=null,newTextBg=null,newText2=null,newText2Bg=null,szColor=this.colorScheme[0],szLineColor=this.colorScheme[1]?this.colorScheme[1]:"none",szTextColor=this.colorScheme[1]?this.colorScheme[1]:"white";if((this.colorScheme.length>2||szFlag.match(/CATEGORICAL/))&&(szColor=this.colorScheme[this.colorScheme.length-1],szLineColor=this.colorScheme[0]),szFlag.match(/NOLINES/))szLineColor="none";else if("none"==szLineColor){var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.lowColor}if(szFlag.match(/CATEGORICAL/)){nClass=nValue-1,szColor=this.colorScheme[nClass]||this.colorScheme[0];var cColor=__maptheme_getChartColors(szColor);szTextColor=cColor.textColor,szLineColor=szFlag.match(/NOLINES/)?"none":cColor.lowColor,szFlag.match(/RANGE/)&&!szFlag.match(/RANGES/)&&(nRadius=map.Scale.normalX(2+5*(i+1)/this.partsA.length)),fDoDraw=!0}else if(this.szFlag.match(/COMPOSECOLOR/))this.szFlag.match(/SUBTRACTIVE/)?this.itemA[a].szColor=__maptheme_getComposedColor_subtractive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[a].szColor=__maptheme_getComposedColor_additive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness));else if(this.colorScheme.length>2||this.partsA.length>1||this.szRanges&&this.szRanges.length)if(fDoDraw=!1,this.szFlag.match(/DOMINANT/)){var nRelevanz=0,nLastRelevant=0;for(nIndex=-1,i=0;i<this.itemA[a].nValuesA.length;i++){nValue=this.itemA[a].nValuesA[i];var nPercentOfMean=100/this.nMeanA[i]*nValue,nPercentOfMedian=100/this.nMedianA[i]*nValue,nDeviation=(nValue-this.nMeanA[i])/this.nDeviationA[i];nRelevanz=nValue,this.szFlag.match(/PERCENTOFMEAN/)&&(nRelevanz=nPercentOfMean),this.szFlag.match(/PERCENTOFMEDIAN/)&&(nRelevanz=nPercentOfMedian),this.szFlag.match(/DEVIATION/)&&(nRelevanz=nDeviation),nValue>this.nFilterA[i]&&nRelevanz>nLastRelevant&&(this.itemA[a].nClass=i,nLastRelevant=nRelevanz,nIndex=i)}if(nIndex>=0){this.itemA[a].nDominant=nIndex,nValue=this.itemA[a].nValuesA[nIndex],szLabel=" "+this.szFieldsA[nIndex]+" ",this.szLabelA&&this.szLabelA[nIndex]&&(szLabel=" "+this.szLabelA[nIndex]+" "),this.itemA[a].nValue=this.itemA[a].nValuesA[nIndex],this.itemA[a].szLabel=szLabel,szColor=this.colorScheme[nIndex];var cColor=__maptheme_getChartColors(szColor);szTextColor=cColor.textColor,szLineColor=szFlag.match(/NOLINES/)?"none":cColor.lowColor,nClass=nIndex,fDoDraw=!0}}else for(i=0;i<this.partsA.length;i++)if(nValue>=this.partsA[i].min&&nValue<this.partsA[i].max){szColor=this.colorScheme[i];var cColor=__maptheme_getChartColors(szColor);szTextColor=cColor.textColor,szLineColor=szFlag.match(/NOLINES/)?"none":cColor.lowColor,szFlag.match(/RANGE/)&&!szFlag.match(/RANGES/)&&(nRadius=map.Scale.normalX(2+5*(i+1)/this.partsA.length)),nClass=i,fDoDraw=!0;break}if(this.itemA[a]&&(this.itemA[a].szColor=szColor),szTextColor=this.szValueColor||this.szTextColor||szTextColor,szLineColor=this.szLineColor||szLineColor,!fDoDraw)return this.nMissingRangeCount++,null;var nLineWidth=this.nLineWidth||.1;if(nLineWidth=szFlag.match(/OUTLINE/)?map.Scale.normalX(Math.min(1,1/nMaxRadius*nRadius)):map.Scale.normalX(nLineWidth/Math.sqrt(nMaxRadius)*Math.sqrt(nRadius)),szFlag.match(/BUBBLE/)){var uTime=null;"$item$"==this.szTimeField?uTime=new Date(this.szFieldsA[nIndex].split(" ")[0]).getTime():a&&(uTime=new Date(this.itemA[a].szTime).getTime()),szFlag.match(/GLOW/)&&!szFlag.match(/ZOOM/)&&this.fGlowInScale?(newShape=map.Dom.newShape("circle",shapeGroup,0,0,6*nRadius,"fill:"+szColor+";stroke:none;fill-opacity:0.05;pointer-events:none;"),newShape&&(newShape.setAttributeNS(szMapNs,"class",String(nClass)),newShape.setAttributeNS(szMapNs,"time",uTime)),newShape=map.Dom.newShape("circle",shapeGroup,0,0,2*nRadius,"fill:"+szColor+";stroke:none;fill-opacity:0.1;pointer-events:none;"),newShape&&(newShape.setAttributeNS(szMapNs,"class",String(nClass)),newShape.setAttributeNS(szMapNs,"time",uTime))):szFlag.match(/AURA/)&&!szFlag.match(/ZOOM/)&&this.fGlowInScale&&(newShape=map.Dom.newShape("circle",shapeGroup,0,0,1.3*nRadius,"fill:"+(this.szLineColor||szColor)+";stroke:none;fill-opacity:0.3;"),newShape&&(newShape.setAttributeNS(szMapNs,"class",String(nClass)),newShape.setAttributeNS(szMapNs,"time",uTime))),newShape=map.Dom.newShape("circle",shapeGroup,0,0,nRadius,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";")}else if(szFlag.match(/SQUARE/))newShape=map.Dom.newShape("rect",shapeGroup,-nRadius,-nRadius,2*nRadius,2*nRadius,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");else if(szFlag.match(/TEXTONLY/))newShape=map.Dom.newShape("rect",shapeGroup,-nRadius,-8,2.05*nRadius,8,"fill:none;stroke:none;");else if(szFlag.match(/LABEL/)){var szText=this.formatValue(nValue,this.nValueDecimals||(nValue<1||nMaxValue<=1?1:0),"ROUND")+(this.szUnit.length<=5?this.szUnit:"");0===nValue&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/SIGN/))?szText="+-"+szText:nValue>0&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/SIGN/))&&(szText="+"+szText);var nFontHeight=Math.min(.8*nRadius,nRadius*(3.4/szText.length));!this.fShadow&&this.fOrigShadow&&nRadius>map.Scale.normalX(5)&&(newShape=map.Dom.newShape("rect",shapeGroup,.02*nRadius-nRadius,.83*-nFontHeight+.02*nRadius,2.05*nRadius,1.6*nFontHeight,"fill:#000000;stroke:none;opacity:"+.4*(this.fillOpacity?this.fillOpacity:1)),newShape&&(newShape.setAttributeNS(null,"rx",map.Scale.normalX(2*nRadius/nMaxRadius)),newShape.setAttributeNS(null,"ry",map.Scale.normalX(2*nRadius/nMaxRadius))),newShape=map.Dom.newShape("rect",shapeGroup,.03*nRadius-nRadius,.83*-nFontHeight+.03*nRadius,2.05*nRadius,1.6*nFontHeight,"fill:"+szColor+";stroke:none;opacity:"+.2*(this.fillOpacity?this.fillOpacity:1)),newShape&&(newShape.setAttributeNS(null,"rx",map.Scale.normalX(2*nRadius/nMaxRadius)),newShape.setAttributeNS(null,"ry",map.Scale.normalX(2*nRadius/nMaxRadius)))),newShape=map.Dom.newShape("rect",shapeGroup,-nRadius,.83*-nFontHeight,2.05*nRadius,1.6*nFontHeight,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";"),newShape&&(newShape.setAttributeNS(null,"rx",map.Scale.normalX(2*nRadius/nMaxRadius)),newShape.setAttributeNS(null,"ry",map.Scale.normalX(2*nRadius/nMaxRadius)))}if(newShape){if(szFlag.match(/SILENT/)||(szFlag.match(/CATEGORICAL/)&&this.szLabelA&&this.szLabelA[nValue-1]?newShape.setAttributeNS(szMapNs,"tooltip",this.szLabelA[nValue-1]+" "+this.szTitle):newShape.setAttributeNS(szMapNs,"tooltip",this.formatValue(nValue,2)+this.szUnit+" "+this.szTitle)),newText=null,szFlag.match(/VALUES/)&&!this.fHideValues){var szText=null;this.szValueField&&"$title$"==this.szValueField?szText=this.itemA[a].szTitle:this.szValueField&&this.itemA[a].szValue?(szText=this.itemA[a].szValue,isNaN(szText)||(szText=this.formatValue(__scanValue(this.itemA[a].szValue),this.nValueDecimals||(this.itemA[a].szValue<1?1:0),"ROUND")+(this.szUnit.length<=5?this.szUnit:""),0===nValue&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?szText="+/-"+szText:nValue>0&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(szText="+"+szText))):this.szValueField&&this.szValueField==this.szSizeField&&nSizeValue?(szText=this.formatValue(__scanValue(nSizeValue),this.nValueDecimals||(nSizeValue<1?1:0),"ROUND")+(this.szUnit.length<=5?this.szUnit:""),0===nSizeValue&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?szText="+/-"+szText:nSizeValue>0&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(szText="+"+szText)):szFlag.match(/CATEGORICAL/)&&this.szLabelA?szText=this.szLabelA[nValue-1]||"?":(szText=this.formatValue(nValue,this.nValueDecimals||(nValue<1||nMaxValue<=1?1:0),"ROUND")+(this.szUnit.length<=5?this.szUnit:""),0===nValue&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))?szText="+/-"+szText:nValue>0&&(this.szFlag.match(/DIFFERENCE/)||this.szFlag.match(/RELATIVE/)||this.szFlag.match(/\bSIGN\b/))&&(szText="+"+szText));var nFontSize=String(Math.min(.8*nRadius,nRadius*(3.3/szText.length))*this.nValueScale);if(szFlag.match(/TEXTONLY/)){var cColor=__maptheme_getChartColors(szColor);if(szTextColor=cColor.textColor,nFontSize=.8*nRadius*this.nValueScale,this.nValueSizeMin&&!szFlag.match(/ZOOM/)&&nFontSize*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin))return null;if(this.nValueValueMin&&!szFlag.match(/ZOOM/)&&nValue<this.nValueValueMin)return null;var szFont=this.szTextFont||"arial";newTextBg=map.Dom.newText(shapeGroup,0,.33*nFontSize,"font-family:"+szFont+";font-size:"+nFontSize+"px;font-weight:normal;text-anchor:middle;fill:none;stroke:"+szColor+";stroke-width:"+nFontSize/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",szText),newTextBg.setAttributeNS(null,"id",this.szId+":"+a+":text:bg"),newText=map.Dom.newText(shapeGroup,0,.33*nFontSize,"font-family:"+szFont+";font-size:"+nFontSize+"px;font-weight:normal;text-anchor:middle;fill:"+(this.szValueColor||this.szTextColor||"#000000")+";opacity:"+nOpacity+";stroke:none;",szText),newText.setAttributeNS(null,"id",this.szId+":"+a+":text"),newShape.parentNode.removeChild(newShape)}else if(szFlag.match(/LABEL/)||nFontSize>map.Scale.normalX(1)){var nOpacity=this.nValueSizeMin?nFontSize/map.Scale.normalX(5):1;newText=map.Dom.newText(shapeGroup,0,.33*nFontSize,"font-family:"+(this.szTextFont||"arial")+";font-size:"+nFontSize+"px;font-weight:bold;text-anchor:middle;fill:"+szTextColor+";opacity:"+nOpacity+";stroke:none;pointer-events:none",szText)}}if(szFlag.match(/DTEXT/)&&a&&!szFlag.match(/ZOOM/)){var nTextOpacity=Math.pow(Math.abs(nRadius),1/3)/Math.pow(nMaxRadius,1/3);newShape.style.setProperty("fill-opacity",String(nTextOpacity),""),newShape.style.setProperty("stroke-opacity",String(nTextOpacity),""),newText&&newText.style.setProperty("fill-opacity",String(nTextOpacity),"")}else newShape.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:1),""),szFlag.match(/OUTLINE/)||this.szLineColor?newShape.style.setProperty("stroke-opacity","1",""):newShape.style.setProperty("stroke-opacity",String(this.fillOpacity&&this.fillOpacity<.5?1:.3),"")}if(null!=nClass&&(newShape&&(newShape.setAttributeNS(szMapNs,"value",String(nValue)),newShape.setAttributeNS(szMapNs,"class",String(nClass))),newText&&(newText.setAttributeNS(szMapNs,"value",String(nValue)),newText.setAttributeNS(szMapNs,"class",String(nClass))),newTextBg&&(newTextBg.setAttributeNS(szMapNs,"value",String(nValue)),newTextBg.setAttributeNS(szMapNs,"class",String(nClass)))),this.szTimeField){var uTime=null;uTime="$item$"==this.szTimeField?new Date(this.szFieldsA[nIndex].split(" ")[0]).getTime():new Date(this.itemA[a].szTime).getTime(),newShape&&newShape.setAttributeNS(szMapNs,"time",uTime),newText&&newText.setAttributeNS(szMapNs,"time",uTime),newTextBg&&newTextBg.setAttributeNS(szMapNs,"time",uTime)}nChartSize=2*nRadius/map.Scale.normalX(1),ptNull.x=0,ptNull.y=szFlag.match(/TEXTONLY/)?nRadius:nRadius+map.Scale.normalY(5),this.nRealizedCount++}else if(szFlag.match(/SYMBOL/)){if(void 0!==this.szSymbolBoxStyle){var szLineColor="#dddddd";void 0!==this.szBorderColor&&(szLineColor=this.szBorderColor);var szLineStyle="stroke-width:0;";if(void 0!==this.szBorderStyle)switch(this.szBorderStyle){case"dotted":szLineStyle="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:round;stroke-dasharray:1,50;";break;case"dashed":szLineStyle="stroke-width:"+map.Scale.normalX(1)+";stroke-linecap:butt;stroke-dasharray:30,30;";break;case"solid":szLineStyle="stroke-width:"+map.Scale.normalX(1)+";";break;case"none":szLineStyle="stroke-width:0;";break}var newFrame=map.Dom.newShape("rect",shapeGroup,0,0,1,1,"fill:white;stroke:"+szLineColor+";"+szLineStyle);switch(this.szSymbolBoxStyle){case"frame":newFrame.setAttributeNS(null,"fill-opacity",0);break;case"field":newFrame.setAttributeNS(null,"fill-opacity",1);break}}if(this.szSymbolsA){if(this.szSymbolsA.length<nPartsA.length)for(i=this.szSymbolsA.length;i<nPartsA.length;i++)this.szSymbolsA.push(this.szSymbolsA[this.szSymbolsA.length-1])}else for(this.szSymbolsA=[],i=0;i<nPartsA.length;i++)this.szSymbolsA.push("circle");var shapeTextGroup=null;if(szFlag.match(/VALUES|AXIS/)&&(shapeTextGroup=map.Dom.newGroup(shapeGroup,this.szId+":"+a+":textgroup")),this.initAngle=0,szFlag.match(/\bSORT\b/)){if(szFlag.match(/\bBYMEAN\b/)){for(this.sortedIndex=[],this.sortedMax=0,i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i],tvalue:nPartsA[i],mean:this.nMeanA[i]},this.sortedMax=Math.max(this.sortedMax,nPartsA[i]);this.sortedIndex.sort(this.sortMeanUp),this.initAngle=0}else if(szFlag.match(/\bBYMEDIAN\b/)){for(this.sortedIndex=[],this.sortedMax=0,i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i],tvalue:nPartsA[i],mean:this.nMedianA[i]},this.sortedMax=Math.max(this.sortedMax,nPartsA[i]);this.sortedIndex.sort(this.sortMeanUp),this.initAngle=0}else if(szFlag.match(/\bUP\b/)){for(this.sortedIndex=[],this.sortedMax=0,i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i],tvalue:nPartsA[i]},this.sortedMax=Math.max(this.sortedMax,nPartsA[i]);this.sortedIndex.sort(this.sortIndexUp),this.initAngle=0}else if(szFlag.match(/\bDOWN\b/)){for(this.sortedIndex=[],this.sortedMax=0,i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i],tvalue:nPartsA[i]},this.sortedMax=Math.max(this.sortedMax,nPartsA[i]);this.sortedIndex.sort(this.sortIndexDown),this.initAngle=0}else if(szFlag.match(/\bRANDOM\b/)){if(this.sortedIndex=[],this.sortedMax=0,this.nClipParts&&this.nClipParts<nPartsA.length){var tempIndex=[];for(i=0;i<nPartsA.length;i++)tempIndex[i]={index:i,value:nPartsA[i],tvalue:nPartsA[i]};for(tempIndex.sort(this.sortIndexDown),i=0;i<this.nClipParts;i++){var sI=tempIndex[i].index;this.sortedIndex[i]={index:sI,value:nPartsA[sI],tvalue:nPartsA[sI]},this.sortedMax=Math.max(this.sortedMax,nPartsA[i])}}else for(i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i],tvalue:nPartsA[i]},this.sortedMax=Math.max(this.sortedMax,nPartsA[i]);a?(this.itemA[a].randomA||(this.itemA[a].randomA=this.getRandomNumberArray(nPartsA.length+1)),this.shuffleArray(this.sortedIndex,this.itemA[a].randomA),this.initAngle=Math.floor(360*this.itemA[a].randomA[0])):this.initAngle=0}}else this.sortedIndex=null;if(szFlag.match(/RINGS/))if(this.sortedIndex){var dValue=0;for(i=0;i<this.sortedIndex.length;i++)this.sortedIndex[i].value&&(this.sortedIndex[i].value+=dValue,dValue=this.sortedIndex[i].value);this.sortedIndex.sort(this.sortIndexDown)}else{var dValue=0;for(this.sortedIndex=[],i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i],tvalue:nPartsA[i]},this.sortedIndex[i].value&&(this.sortedIndex[i].value+=dValue,dValue=this.sortedIndex[i].value);this.sortedIndex.sort(this.sortIndexDown)}if(szFlag.match(/\bSMOOTH\b/)&&!szFlag.match(/\bZOOM\b/)){var ra=3,nPartsRawA=nPartsA.slice();for(i=nPartsA.length-2;i>=ra-2;i--){for(nPartsA[i]=nPartsRawA[i],nPartsA[i]+=nPartsRawA[i+1],r=1;r<ra-1;r++)nPartsA[i]+=nPartsRawA[i-r];nPartsA[i]/=ra}}if(szFlag.match(/\bLINREG\b/)){var xsum=0,ysum=0;for(i=0;i<nPartsA.length;i++)xsum+=i,ysum+=nPartsA[i];for(var xmean=xsum/nPartsA.length,ymean=ysum/nPartsA.length,num=0,denom=0,i=0;i<nPartsA.length;i++){var x=i,y=nPartsA[i];num+=(x-xmean)*(y-ymean),denom+=(x-xmean)*(x-xmean)}var linreg_m=num/denom,linreg_b=ymean-linreg_m*xmean}var topShape=null,topText=null,topText2=null,topGrid=null,nClass=0,szTooltip="",nSymbols=0,nSymbolOffsetX=0,nSymbolOffsetY=0,nStarRadius=0,nChartMaxValue=0,nNonZeroValues=0,nNonZeroValuesDone=0,fPlotInit=!1,nPLastValue=0,nStartI=0,nMaxI=nPartsA.length;if(this.nClipParts&&this.nClipParts<nPartsA.length&&(szFlag.match(/\bUP\b/)?nStartI=nPartsA.length-this.nClipParts:nMaxI=this.nClipParts),this.szFlag.match(/DOMINANT/)){var nRelevanz=0,nLastRelevant=0,nnIndex=-1;for(i=0;i<this.itemA[a].nValuesA.length;i++){var nValue=this.itemA[a].nValuesA[i],nPercentOfMean=100/this.nMeanA[i]*nValue,nPercentOfMedian=100/this.nMedianA[i]*nValue,nDeviation=(nValue-(this.nMeanA[i]||0))/this.nDeviationA[i];nRelevanz=nValue,this.szFlag.match(/PERCENTOFMEAN/)&&(nRelevanz=nPercentOfMean),this.szFlag.match(/PERCENTOFMEDIAN/)&&(nRelevanz=nPercentOfMedian),this.szFlag.match(/DEVIATION/)&&(nRelevanz=nDeviation),nValue>(this.nFilterA[i]||0)&&nRelevanz>nLastRelevant&&(this.itemA[a].nClass=i,nLastRelevant=nRelevanz,nnIndex=i)}nnIndex>=0&&(this.itemA[a].nDominant=nnIndex,nStartI=nnIndex,nMaxI=nStartI+1,nClass=nnIndex)}else this.szFlag.match(/COMPOSECOLOR/)&&(this.szFlag.match(/SUBTRACTIVE/)?this.itemA[a].szColor=__maptheme_getComposedColor_subtractive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)):this.itemA[a].szColor=__maptheme_getComposedColor_additive(this.itemA[a].nValuesA,this.colorScheme,this.nMax,Math.floor(255*this.nBrightness)));for(this.szFlag.match(/\bCLIP\b/)&&(nMaxI=nStartI+1),i=nStartI;i<nMaxI;i++)nNonZeroValues+=0!==nPartsA[i],nChartMaxValue=Math.max(nChartMaxValue,nPartsA[i]);if(this.szFlag.match(/STACKED/)&&this.nGridX)for(i=nStartI;i<nMaxI;){for(var nStacked=0,ii=0;ii<this.nGridX;ii++)nStacked+=nPartsA[i++];nChartMaxValue=Math.max(nChartMaxValue,nStacked)}var nAllMaxValueText=Math.max(this.nAllMaxValue,this.nMax),szMaxText=this.formatValue(nAllMaxValueText,this.nValueDecimals||"")+(this.szUnit.length<=5?this.szUnit:""),tStackValue=0;for(i=nStartI;i<nMaxI;i++){var nIndex=i,nValue=nPartsA[nIndex],tValue=nPartsA[nIndex];if(szFlag.match(/COUNT/)&&this.itemA[a].nCountA&&(tValue=this.itemA[a].nCountA[nIndex]),this.sortedIndex&&(nValue=this.sortedIndex[nIndex].value,tValue=this.sortedIndex[nIndex].tvalue,nIndex=this.sortedIndex[nIndex].index),this.szValueField&&this.itemA[a]&&"$title$"==this.szValueField?tValue=this.itemA[a].szTitle:this.szValueField&&this.itemA[a]&&this.itemA[a].szValue&&(tValue=isNaN(this.itemA[a].szValue)?this.itemA[a].szValue:__scanValue(this.itemA[a].szValue)),this.szShowParts){var skipIt=!0;for(p in this.szShowPartsA)this.szShowPartsA[p]==nIndex%(this.nGridX||1e6)&&(skipIt=!1);if(skipIt)continue}if(!szFlag.match(/ZOOM/)||!this.markedClasses||this.markedClasses[nIndex]){if(nClass=nIndex,this.nGridX&&szFlag.match(/PLOT/)&&(nClass%=this.nGridX),szFlag.match(/STACKED/)&&(0==nClass&&(tStackValue=0),tValue+=tStackValue,tStackValue=tValue),(szFlag.match(/ZOOM/)||szFlag.match(/NORMSIZE/))&&this.szLabelA){var szValue=this.formatValue(tValue,tValue<1?2:0);szTooltip=szValue+this.szUnit,szTooltip+=" "+this.szLabelA[nIndex%(this.nGridX||1e7)]}else{var szValue=this.formatValue(tValue,2);szTooltip=" "+szValue+this.szUnit}var uTime=null;if(this.szTimeField&&(uTime="$item$"==this.szTimeField?new Date(this.szFieldsA[nIndex].split(" ")[0]).getTime():new Date(this.itemA[a].szTime).getTime()),!szFlag.match(/CATEGORICAL/)||szFlag.match(/AGGREGATE/)||szFlag.match(/GROUP/)){var nMaxRadius=map.Scale.normalX(nChartSize/2),nMaxValue=this.nNormalSizeValue||this.nAllMaxValue;if(szFlag.match(/MENUSIZE/)?nMaxValue=5*nChartMaxValue:!this.nNormalSizeValue||szFlag.match(/SEQUENCE/)&&this.szSizeField||(nMaxValue=this.nNormalSizeValue,this.nMaxSize=this.nNormalSizeValue),nChartMaxValue&&szFlag.match(/ZOOM/)&&szFlag.match(/SEQUENCE/)&&(nMaxValue=nChartMaxValue/2+nChartMaxValue/2*Math.pow(nMaxValue,.5)/Math.pow(nChartMaxValue,.5)),szFlag.match(/INVERTSIZE/)&&nMaxValue-nValue==0&&!szFlag.match(/ZEROISVALUE/))return null;if(this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(nValue=this.nClipFrames==nPartsA.length?Number(nPartsA[this.nActualFrame]):nPartsA[nIndex]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+nPartsA[nPartsA.length-1]*this.nActualFrame/(this.nClipFrames-1),tValue=nValue),!nValue&&!szFlag.match(/PLOT|NOSIZE/))continue;var nRadius=0;if(szFlag.match(/AUTOSIZE/)){var nDynScale=map.Layer.nDynamicObjectScale,nAutoSize=szFlag.match(/\bRECT\b/)?szFlag.match(/GAP/)?2.3:2:szFlag.match(/GAP/)?1.6:1.5;nMaxValue=Math.max(this.nAllMaxValue,this.nMax),nMaxRadius=this.nGridWidthPx?map.Scale.normalX(this.nGridWidthPx)/nAutoSize/nDynScale:this.nGridWidth?map.Scale.getDeltaXofDistanceInMeter(this.nGridWidth)/nAutoSize/nDynScale:nMaxRadius}if(nRadius=szFlag.match(/GRIDSIZE/)&&!szFlag.match(/PLOT/)?this.nGridSize/2:szFlag.match(/NOSIZE/)?map.Scale.normalX(nChartSize/3):szFlag.match(/FIXSIZE/)?map.Scale.normalX(nChartSize/3)/(this.nNormalSizeValue||1):nMaxRadius/Math.pow(nMaxValue,1/this.nSizePow)*Math.pow(nValue,1/this.nSizePow),szFlag.match(/SEQUENCE/)?szFlag.match(/MENUSIZE/)||szFlag.match(/SUM/)&&!a?nRadius*=this.szField100?1:2:szFlag.match(/ZOOM/)&&!szFlag.match(/PLOT/)?nRadius*=2:szFlag.match(/AGGREGATE/)&&szFlag.match(/CATEGORICAL/)||!this.szSizeField||!a||!this.itemA[a]||(nRadius=nRadius/Math.pow(this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[a].nSize,1/this.nSizePow)):szFlag.match(/MENUSIZE/)||szFlag.match(/SUM/)&&!a?nRadius=1.5*nMaxRadius:szFlag.match(/ZOOM/)&&!szFlag.match(/PLOT/)?nRadius=Math.max(nRadius,2*nMaxRadius/3):szFlag.match(/NOSIZE/)?nRadius=nMaxRadius/5:!szFlag.match(/GRIDSIZE/)&&this.szSizeField&&a&&this.itemA[a]?(nRadius=nMaxRadius/Math.pow(this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[a].nSize,1/this.nSizePow),szFlag.match(/PLOTXY/)&&(nRadius/=5)):szFlag.match(/PLOTXY/)&&(nRadius/=5),isNaN(nRadius)||!nRadius){if(!szFlag.match(/STAR|STACKED|PLOT/))continue;nRadius=1}var szSymbol=this.szSymbolsA[nIndex];if(this.nRangesA&&this.nRangesA.length)for(ii=0;ii<this.nRangesA.length;ii++)if(nValue==this.nRangesA[ii]||Number(nValue)==Number(this.nRangesA[ii])){szSymbol=this.szSymbolsA[ii]||this.szSymbolsA[0]||"circle";break}if(szSymbol=this.itemA[a]&&this.itemA[a].szSymbol||szSymbol,szFlag.match(/SEQUENCE/)&&(szSymbol=this.szSymbolsA[nIndex]),a&&this.itemA[a].szColor)szColor=this.itemA[a].szColor,nClass=this.itemA[a].nClass,this.colorClassUsedA&&(this.colorClassUsedA[nClass]=!0);else if((szFlag.match(/SEQUENCE/)||szFlag.match(/DOMINANT/))&&this.colorScheme.length>=this.partsA.length)var szColor=this.colorScheme[nIndex%(this.nGridX||1e4)],szLineColor=this.colorScheme[nIndex];else{var szColor=this.colorScheme[0],szLineColor=this.colorScheme[1]?this.colorScheme[1]:"none";if(this.colorScheme.length>2&&(szColor=this.colorScheme[this.colorScheme.length-1],szLineColor=this.colorScheme[0]),szFlag.match(/NOLINES/))szLineColor="none";else if("none"==szLineColor){var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.textColor}if(this.colorScheme.length>2||this.szRanges&&this.szRanges.length){for(ii=0;ii<this.partsA.length;ii++){if(szFlag.match(/CATEGORICAL/)&&nValue==this.partsA[ii].min||!szFlag.match(/CATEGORICAL/)&&nValue<this.partsA[ii].max){szColor=this.colorScheme[ii];var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.textColor,szFlag.match(/RANGE/)&&!szFlag.match(/RANGES/)&&(nRadius=map.Scale.normalX(2+5*(ii+1)/this.partsA.length)),nClass=ii;break}if(this.szRanges&&this.szRanges.length&&nValue<this.partsA[ii].min){szColor=this.colorScheme[ii-1];var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.textColor,nClass=ii-1;break}}szFlag.match(/NOLINES/)&&(szLineColor="none")}}if(szLineColor=szLineColor||szColor,this.nSymbolScale=nRadius/map.Scale.normalX(nChartSize),"circle"==szSymbol||"square"==szSymbol||"roundrect"==szSymbol||"carot"==szSymbol||"diamond"==szSymbol||"triangle"==szSymbol||"hexagon"==szSymbol||"empty"==szSymbol||"label"==szSymbol||"cross"==szSymbol){szLineColor=this.szLineColor||szLineColor;var nLineWidth=(this.nLineWidth||1)*map.Scale.normalX(Math.min(2*nRadius/nMaxRadius,.2));switch(szSymbol){case"empty":newShape=map.Dom.newShape("circle",shapeGroup,0,0,nRadius,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+nLineWidth+";");break;case"circle":!this.fShadow&&this.fOrigShadow&&(newShapeBg=map.Dom.newShape("circle",shapeGroup,map.Scale.normalX(.5)+.02*nRadius,map.Scale.normalX(.5)+.02*nRadius,1.02*nRadius,"fill:#000000;stroke:none;opacity:"+.6*(this.fillOpacity?this.fillOpacity:1))),newShapeBg1=null,newShapeBg2=null,!szFlag.match(/GLOW/)||this.sortedIndex&&i!=nStartI||szFlag.match(/ZOOM/)||this.szGlowUpper&&!(map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)||this.szGlowLower&&!(map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)?szFlag.match(/AURA/)&&i==nStartI&&!szFlag.match(/ZOOM/)&&(!this.szGlowUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nGlowUpper)&(!this.szGlowLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale>=this.nGlowLower)&&(newShapeBg1=map.Dom.newShape("circle",shapeGroup,0,0,1.3*nRadius,"fill:"+(this.szLineColor||szColor)+";stroke:none;fill-opacity:0.3;"),newShapeBg1&&(newShapeBg1.setAttributeNS(szMapNs,"class",String(nClass)),newShapeBg1.setAttributeNS(szMapNs,"time",String(uTime)))):(newShapeBg1=map.Dom.newShape("circle",shapeGroup,0,0,6*nRadius,"fill:"+szColor+";stroke:none;fill-opacity:0.05;pointer-events:none;"),newShapeBg1&&(newShapeBg1.setAttributeNS(szMapNs,"class",String(nClass)),newShapeBg1.setAttributeNS(szMapNs,"time",uTime)),newShapeBg2=map.Dom.newShape("circle",shapeGroup,0,0,2*nRadius,"fill:"+szColor+";stroke:none;fill-opacity:0.1;pointer-events:none;"),newShapeBg2&&(newShapeBg2.setAttributeNS(szMapNs,"class",String(nClass)),newShapeBg2.setAttributeNS(szMapNs,"time",String(uTime)))),newShape=map.Dom.newShape("circle",shapeGroup,0,0,nRadius,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"square":newShape=map.Dom.newShape("rect",shapeGroup,-nRadius,-nRadius,2*nRadius,2*nRadius,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"roundrect":newShape=map.Dom.newShape("rect",shapeGroup,-nRadius,-nRadius,2*nRadius,2*nRadius,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";"),newShape.setAttributeNS(null,"rx",.3*nRadius);break;case"cross":newShape=map.Dom.newShape("rect",shapeGroup,1.6*-nRadius,.4*-nRadius,2*nRadius*1.6,2*nRadius*.4,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";"),newShape=map.Dom.newShape("rect",shapeGroup,.4*-nRadius,1.6*-nRadius,2*nRadius*.4,2*nRadius*1.6,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+map.Scale.nFeatureScaling*map.Scale.nObjectScaling+";");break;case"carot":case"diamond":newShape=map.Dom.newShape("rect",shapeGroup,-nRadius,-nRadius,2*nRadius,2*nRadius,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";"),newShape&&newShape.setAttributeNS(null,"transform","rotate(45)");break;case"triangle":newShape=map.Dom.newShape("path",shapeGroup,"M 0,"+nRadius+" l"+1.2*nRadius+",-"+2*nRadius+" -"+2.4*nRadius+",0 "+1.2*nRadius+","+2*nRadius+"z","fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"hexagon":var A=nRadius/2,B=nRadius*Math.sin(60/180*Math.PI),C=nRadius;newShape=map.Dom.newShape("path",shapeGroup,"M -"+nRadius+",0 l "+A+",-"+B+" "+C+",0 "+A+","+B+" -"+A+","+B+" -"+C+",0 -"+A+",-"+B+" z","fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"label":var szText=this.formatValue(tValue,this.nValueDecimals||(tValue<1||nMaxValue<=1?1:0),"ROUND")+(this.szUnit.length<=5?this.szUnit:"");if(szFlag.match(/TEXTONLY/)){if(szTextColor=__maptheme_getChartColors(szColor).textColor,nFontSize=String(Math.max(Math.min(.8*nRadius,map.Scale.normalX(500)),map.Scale.normalX(2))),this.nValueSizeMin&&!szFlag.match(/ZOOM/)&&nFontSize*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){newShape=map.Dom.newShape("rect",shapeGroup,0,0,0,0,"fill:none;"),newShapeBg=map.Dom.newShape("rect",shapeGroup,0,0,0,0,"fill:none;");break}if(this.nValueValueMin&&!szFlag.match(/ZOOM/)&&nValue<this.nValueValueMin){newShape=map.Dom.newShape("rect",shapeGroup,0,0,0,0,"fill:none;"),newShapeBg=map.Dom.newShape("rect",shapeGroup,0,0,0,0,"fill:none;");break}var szFont=this.szTextFont||"arial";newShapeBg=map.Dom.newText(shapeGroup,0,0,"font-family:"+szFont+";font-size:"+nFontSize+"px;font-weight:bold;text-anchor:middle;fill:none;stroke:"+szColor+";stroke-width:"+nFontSize/7+";stroke-opacity:0.5;pointer-events:none;stroke-linejoin:bevel;",szText),newShapeBg.setAttributeNS(null,"id",this.szId+":"+a+":text:bg"),newShape=map.Dom.newText(shapeGroup,0,0,"font-family:"+szFont+";font-size:"+nFontSize+"px;font-weight:bold;text-anchor:middle;fill:"+(this.szValueColor||this.szTextColor||"#000000")+";opacity:"+nOpacity+";stroke:none;",szText),newShape.setAttributeNS(null,"id",this.szId+":"+a+":text")}else{var nFontSize=String(Math.max(1,Math.min(.8*nRadius,nRadius*(3.4/szText.length))));if(this.nValueSizeMin&&!szFlag.match(/ZOOM/)&&nFontSize*map.Layer.nDynamicObjectScale<map.Scale.normalX(this.nValueSizeMin)){newShape=map.Dom.newShape("rect",shapeGroup,0,0,0,0,"fill:none;");break}if(this.nValueValueMin&&!szFlag.match(/ZOOM/)&&nValue<this.nValueValueMin){newShape=map.Dom.newShape("rect",shapeGroup,0,0,0,0,"fill:none;");break}var nLabelHeight=1.6*nFontSize;newShape=map.Dom.newShape("rect",shapeGroup,-nRadius,.83*-nFontSize,2.05*nRadius,1.6*nFontSize,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";"),newShape&&(newShape.setAttributeNS(null,"rx",map.Scale.normalX(2*nRadius/nMaxRadius)),newShape.setAttributeNS(null,"ry",map.Scale.normalX(2*nRadius/nMaxRadius)))}break}if(newShape){if(szFlag.match(/OUTLINE/))newShape.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),newShape.style.setProperty("stroke-opacity","1"),newShape.style.setProperty("fill-opacity","0.7");else if(szFlag.match(/RANDOM/)){if(newShape.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),""),newShape.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),""),szFlag.match(/DOPACITY/)){var nPow=1/(this.nDopacityPow||1),nOpacity=Math.pow(nValue,nPow)/Math.pow(this.sortedMax,nPow)*(this.nOpacity||1)*(this.nDopacityScale||1);newShape.style.setProperty("fill-opacity",String(nOpacity),"")}}else if(szFlag.match(/\bSORT\b/)&&szFlag.match(/DOPACITY/)){newShape.style.setProperty("stroke-opacity",String(this.nOpacity?this.nOpacity:1),"");var nPow=1/(this.nDopacityPow||1),nOpacity=Math.pow(nValue,nPow)/Math.pow(this.sortedMax,nPow)*(this.nOpacity||1)*(this.nDopacityScale||1);newShape.style.setProperty("fill-opacity",String(nOpacity),"")}else if(szFlag.match(/DOPACITY/)&&this.szAlphaField){if(a&&void 0!==this.itemA[a].nAlpha){var nPow=1/(this.nDopacityPow||1),nOpacity=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,nPow)*Math.pow(this.itemA[a].nAlpha,nPow);newShape.style.setProperty("fill-opacity",String(nOpacity),"")}}else if(szFlag.match(/DOPACITY/)){var nPow=1/(this.nDopacityPow||1),nOpacity=Math.pow(nValue-this.nMin,nPow)/Math.pow(this.nMax-this.nMin,nPow)*(this.fillOpacity||1)*(this.nDopacityScale||1);newShape.style.setProperty("fill-opacity",String(nOpacity),""),szFlag.match(/CATEGORICAL/)||(nClass=Math.min(6,Math.ceil((nValue-this.nMin)/(this.nMax-this.nMin)*7)),newShape.setAttributeNS(szMapNs,"class",String(nClass)),shapeGroup.setAttributeNS(szMapNs,"class",String(nClass)),chartGroup.setAttributeNS(szMapNs,"class",String(nClass)))}else newShape.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),"");this.chartGroup&&this.chartGroup.style.setProperty("opacity",String(1),""),newShape.setAttributeNS(szMapNs,"tooltip",szTooltip),newShape.setAttributeNS(szMapNs,"time",uTime)}}else szSymbol.match(/.svg|.png|.jpeg/)?(newShape=map.Dom.constructNode("image",shapeGroup,{"xlink:href":szSymbol}),newShape.setAttributeNS(null,"x",String(map.Scale.normalX(-nChartSize/2))),newShape.setAttributeNS(null,"y",String(map.Scale.normalY(-nChartSize/2))),newShape.setAttributeNS(null,"width",String(map.Scale.normalX(nChartSize))),newShape.setAttributeNS(null,"height",String(map.Scale.normalY(nChartSize)))):newShape=map.Dom.constructNode("use",shapeGroup,{"xlink:href":"#"+szSymbol+":antizoomandpan"}),map.Dom.newShape("circle",shapeGroup,0,0,.5*nRadius,"fill:white;stroke:none;opacity:0"),newShape.fu.scale(nRadius/nMaxRadius,nRadius/nMaxRadius),newShape.setAttributeNS(null,"style","fill:"+szColor+";stroke:"+szLineColor);if(newShape&&szFlag.match(/VALUES/)&&!szFlag.match(/TEXTONLY/)&&!this.fHideValues){var newText=null,szText=tValue;isNaN(tValue)||(szText=this.formatValue(tValue,this.nValueDecimals||"")+(this.szUnit.length<=5?this.szUnit:""));var cColor=__maptheme_getChartColors(szColor),szTextColor=this.szValueColor||this.szTextColor||cColor.textColor,szMaxTextLength=Math.max((tValue.length||0)+1,szMaxText.length),nFontSize=String(Math.min(1*nMaxRadius,nMaxRadius*(("hexagon"==szSymbol?2.7:3.2)/szMaxTextLength)));if(nFontSize*=nRadius/nMaxRadius*this.nValueScale,szFlag.match(/ZOOM/)&&szFlag.match(/LINES/)&&!szFlag.match(/INLINETEXT/)&&(null==this.nGridX||this.nGridX<=1||szFlag.match(/STACKED/))){szTextColor="black",textOnTopGroup=textOnTopGroup||map.Dom.newGroup(chartGroup,this.szId+":"+a+":textchartontop"),nFontSize=4+.5*nPartsA.length/(this.nGridX?2*this.nGridX:1);var scalefont=Math.log(nPartsA.length)/3;newText=this.createTextLabel(SVGDocument,textOnTopGroup,"",szText,nFontSize*scalefont*this.nValueScale,"","rgba(255,255,255,0)",cColor.lowColor,"GLOW"),newText.setAttributeNS(null,"opacity","0.9"),textOnTopGroup.fu.setPosition(3*-map.Scale.normalX(nFontSize*scalefont),-map.Scale.normalY(8/(this.nGridX||1)))}else if("circle"==szSymbol||"square"==szSymbol||"roundrect"==szSymbol||"triangle"==szSymbol||"hexagon"==szSymbol||"label"==szSymbol||"empty"==szSymbol)if(szFlag.match(/CENTERVALUES/))0===nClass&&(newText=map.Dom.newText(shapeGroup,0,.33*nFontSize,"font-family:"+(this.szTextFont||"arial")+";font-size:"+nFontSize+"px;text-anchor:middle;fill:"+szTextColor+";stroke:none;pointer-events:none",szText));else if((szFlag.match(/\bCENTER\b/)||szFlag.match(/\bTOP\b/)||szFlag.match(/\bBOTTOM\b/))&&!szFlag.match(/\bDOMINANT\b/)){if(nValue){var nTextSize=6;this.szChartFlag+="|VALUEBACKGROUND",shapeOnTopGroup=shapeOnTopGroup||map.Dom.newGroup(chartGroup,this.szId+":"+a+":chartontop"),nStarRadius=nStarRadius||nRadius;var xPos=-map.Scale.normalX(1),yPos=-map.Scale.normalX(1.33*nTextSize)*(nNonZeroValues-nNonZeroValuesDone-1);if(newText=this.createTextLabel(SVGDocument,shapeOnTopGroup,"",szText,nTextSize,"",this.colorScheme[nIndex%(this.nGridX||1e4)],this.szTextColor),newText.fu.setPosition(xPos,yPos),a&&(szFlag.match(/ZOOM/)||szFlag.match(/NORMSIZE/))&&this.szLabelA){var tWidth=newText.fu.getBox().width;newTextBg=map.Dom.newText(shapeOnTopGroup,0,0,this.szValuesTextBgStyle,this.szLabelA[nIndex]),newTextBg.fu.setPosition(xPos+tWidth+map.Scale.normalX(6),yPos-map.Scale.normalX(-1)),newTextBg.fu.scale(.6,.6),newText=map.Dom.newText(shapeOnTopGroup,0,0,this.szValuesTextStyle+";fill:#000;fill-opacity:0.8",this.szLabelA[nIndex]),newText.fu.setPosition(xPos+tWidth+map.Scale.normalX(6),yPos-map.Scale.normalX(-1)),newText.fu.scale(.6,.6)}newText.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),newText=null,nNonZeroValuesDone++}}else if(this.szValueField&&szFlag.match(/2VALUES/)){newText=map.Dom.newText(shapeGroup,0,.2*-nFontSize,"font-family:"+(this.szTextFont||"arial")+";font-size:"+nFontSize+"px;text-anchor:middle;fill:"+szTextColor+";stroke:none;pointer-events:none",szText);var nFontSize2=Math.min(.8*nFontSize,120),szValue=this.formatValue(nValue,this.nValueDecimals||0)+this.szUnit;newText2=map.Dom.newText(shapeGroup,0,nFontSize-.2*nFontSize2,"font-family:"+(this.szTextFont||"arial")+";font-size:"+nFontSize2+"px;text-anchor:middle;fill:"+szTextColor+";stroke:none;pointer-events:none",szValue)}else newText=map.Dom.newText(shapeGroup,0,.33*nFontSize,"font-family:"+(this.szTextFont||"arial")+";font-size:"+nFontSize+"px;text-anchor:middle;fill:"+szTextColor+";stroke:none;pointer-events:none",szText);else nFontSize=Math.max(.8*nRadius,1)*this.nValueScale,shapeOnTopGroup=shapeOnTopGroup||map.Dom.newGroup(chartGroup,this.szId+":"+a+":chartontop"),newText=this.createTextLabel(SVGDocument,shapeOnTopGroup,"",szText,nFontSize/map.Scale.normalX(1),"","rgba(255,255,255,0.3)",cColor.lowColor,"GLOW"),newText.fu.setPosition(map.Scale.normalX(0)+nSymbolOffsetX,map.Scale.normalY(0)+nSymbolOffsetY)}if(newShape&&(newShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),newShape.setAttributeNS(szMapNs,"time",uTime),newText&&(newText.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),newText.setAttributeNS(szMapNs,"time",uTime),newText.setAttributeNS(szMapNs,"tooltip",szTooltip)),newText2&&(newText2.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),newText2.setAttributeNS(szMapNs,"time",uTime)),newShapeBg&&(newShapeBg.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),newShapeBg.setAttributeNS(szMapNs,"time",uTime)),!szFlag.match(/CENTER/))){var pos=null;if(szFlag.match(/STAR/)){if(0===i&&(topShape=newShape,topText=newText,topText2=newText2,nStarRadius=nRadius,szFlag.match(/EXPAND/)&&szFlag.match(/\bSORT\b/)&&szFlag.match(/\bUP\b/)&&(nStarRadius=szFlag.match(/LINEAR/)||szFlag.match(/SIZEP1/)?(szFlag.match(/EXPANDMAX/)?2:.5)*nMaxRadius/nMaxValue*this.sortedIndex[nPartsA.length-1].value:(szFlag.match(/EXPANDMAX/)?2:.5)*nMaxRadius/Math.sqrt(nMaxValue)*Math.sqrt(this.sortedIndex[nPartsA.length-1].value)),szFlag.match(/ZOOM/)&&szFlag.match(/STAR/)&&szFlag.match(/\bUP\b/)?nStarRadius*=2:szFlag.match(/COMPRESS/)&&(nStarRadius*=szFlag.match(/COMPRESSMAX/)?.25:.5)),(i>0||szFlag.match(/\bUP\b/))&&nRadius){var nStarParts=this.nClipParts&&this.nClipParts<this.partsA.length?this.nClipParts:this.partsA.length,_a=nRadius,_c=nStarRadius+nRadius,_b=Math.sqrt(Math.pow(_c,2)-Math.pow(_a,2)),_h=_a*_b/_c,_f=90-Math.asin(_h/_a)/Math.PI*180,_r=nStarRadius+nRadius;szFlag.match(/\bUP\b/)&&(i>5&&(_f/=1+nRadius/nMaxRadius*2),_r=nStarRadius*(1+nStarParts/5)),szFlag.match(/ZOOM/)||(this.nRangeScale?_r*=this.nRangeScale:_r=szFlag.match(/EXPANDMAX/)?2*_r:szFlag.match(/EXPAND/)?1.5*_r:_r),this.initAngle+=_f,nSymbolOffsetX=Math.cos(this.initAngle/180*Math.PI)*_r,nSymbolOffsetY=Math.sin(this.initAngle/180*Math.PI)*_r,this.initAngle+=_f,pos=new point(map.Scale.normalX(0)+nSymbolOffsetX,map.Scale.normalY(0)+nSymbolOffsetY)}}else if(szFlag.match(/RANDOM/)){var dRadius=szFlag.match(/EXPANDMAX/)?2*nRadius:szFlag.match(/EXPAND/)?1.5*nRadius:nRadius;szFlag.match(/ZOOM/)&&(nMaxRadius*=2,dRadius*=2),nSymbolOffsetX=Math.cos(this.initAngle+360/this.partsA.length*i/180*Math.PI)*Math.min(nMaxRadius,dRadius),nSymbolOffsetY=Math.sin(this.initAngle+360/this.partsA.length*i/180*Math.PI)*Math.min(nMaxRadius,dRadius),pos=new point(map.Scale.normalX(0)+nSymbolOffsetX,map.Scale.normalY(0)+nSymbolOffsetY)}else szFlag.match(/HORZ/)?(nSymbolOffsetX+=nRadius,pos=new point(map.Scale.normalX(0)+nSymbolOffsetX,map.Scale.normalY(0)+nSymbolOffsetY),nSymbolOffsetX+=nRadius):szFlag.match(/BOTTOM/)?pos=new point(map.Scale.normalX(0),-nRadius):szFlag.match(/TOP/)?pos=new point(.3*-nRadius,.7*nRadius-nMaxRadius):szFlag.match(/CONE/)?pos=new point(map.Scale.normalY(.33*i),-map.Scale.normalY(1*i)):szFlag.match(/BASE/)&&(pos=new point(map.Scale.normalX(0),nSymbolOffsetY-nRadius),nSymbolOffsetY-=nRadius*(szFlag.match(/VALUES/)?1.25:1));if(pos?(newShape.fu.setPosition(pos.x,pos.y),newShapeBg&&newShapeBg.fu.setPosition(pos.x,pos.y),newShapeBg1&&newShapeBg1.fu.setPosition(pos.x,pos.y),newShapeBg2&&newShapeBg2.fu.setPosition(pos.x,pos.y),newText&&newText.fu.setPosition(pos.x,pos.y),newText2&&newText2.fu.setPosition(pos.x,pos.y)):newText2&&newText2.fu.setPosition(0,0),szFlag.match(/PLOT/)){0!==nValue||szFlag.match(/STACKED/)||(newShape.parentNode.removeChild(newShape),newShapeBg&&newShapeBg.parentNode.removeChild(newShapeBg),newText&&newText.parentNode.removeChild(newText));var nStep=map.Scale.normalX(nChartSize)*(szFlag.match(/LINES/),1),nAxis=i*nStep;this.nGridX&&(nAxis=szFlag.match(/PLOTVAR/)?Math.floor(i%this.nGridX)*nStep:Math.floor(i/this.nGridX)*nStep);var nMinValue=0,nMaxValue=this.nAllMaxValue||this.nMax;if(nMaxValue=Math.max(nChartMaxValue,nMaxValue),nMaxValue=this.nMaxValuePlot=void 0!==this.nMaxValue?this.nMaxValue:nMaxValue,nMinValue=this.nMinValuePlot=void 0!==this.nMinValue?this.nMinValue:Math.min(this.nMin,this.nAllMinValue),"auto"==this.nMaxValue&&(nMaxValue=this.nMaxValuePlot=nChartMaxValue),"inherit"==this.nMaxValue){this.nMaxValuePlot=this.nMinValuePlot=null;for(var t=0;t<this.parent.themesA.length;t++)this.parent.themesA[t]!=this&&this.parent.themesA[t].nMaxValuePlot&&(nMaxValue=this.parent.themesA[t].nMaxValuePlot)}var nScale=map.Scale.normalX(nChartSize)/(nMaxValue-nMinValue)*(this.nGridX||nPartsA.length-1)*(this.nRangeScale||1);if(!fPlotInit){var szGridId=this.szId+":"+this.itemA[a].szSelectionId+":chartgrid",gridGroup=null;if(!gridGroup||szFlag.match(/ZOOM/)){shapeOnTopGroup=shapeOnTopGroup||map.Dom.newGroup(chartGroup,this.szId+":"+a+":chartontop");var gridGroup=map.Dom.newGroup(shapeOnTopGroup,szGridId)}}if(szFlag.match(/PLOTXY/)){fPlotInit||(fPlotInit=!0,szFlag.match(/BOX/)&&szFlag.match(/\bGRID\b/)&&!gridGroup.childNodes.length&&(map.Dom.newShape("line",gridGroup,0,0,this.nChartWidth+100,0,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newShape("line",gridGroup,0,0,0,-this.nChartHeight-100,"stroke:#888888;stroke-width:"+map.Scale.normalX(.3)+";"),map.Dom.newText(gridGroup,10,80,"font-family:arial;font-size:80px;text-anchor:start;fill:#444444;stroke:none;pointer-events:none;",String(this.nMinX)),map.Dom.newText(gridGroup,this.nChartWidth+100,80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMaxX)),map.Dom.newText(gridGroup,-10,10,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMinY)),map.Dom.newText(gridGroup,-10,-this.nChartHeight-100+80,"font-family:arial;font-size:80px;text-anchor:end;fill:#444444;stroke:none;pointer-events:none;",String(this.nMaxY))));var x=50+(this.itemA[a].nX-this.nMinX)*this.nChartWidth/this.nRangeX,y=-100-(this.itemA[a].nY-this.nMinY)*this.nChartHeight/this.nRangeY;newShape.fu.setPosition(x,y),newShapeBg&&newShapeBg.fu.setPosition(x,y),newShapeBg1&&newShapeBg1.fu.setPosition(x,y),newShapeBg2&&newShapeBg2.fu.setPosition(x,y),newText&&newText.fu.setPosition(x,y)}else if(szFlag.match(/PLOTYX/))newShape.fu.setPosition((nMaxValue+Math.abs(nMaxValue-nValue))*nScale,nAxis),newShapeBg&&newShapeBg.fu.setPosition((nMaxValue+Math.abs(nMaxValue-nValue))*nScale,nAxis),newText&&newText.fu.setPosition((nMaxValue+Math.abs(nMaxValue-nValue))*nScale,nAxis);else if(szFlag.match(/PLOTY/)){newShape.fu.setPosition(0,(-nMaxValue+Math.abs(nMaxValue-nValue))*nScale),newShapeBg&&newShapeBg.fu.setPosition(0,(-nMaxValue+Math.abs(nMaxValue-nValue))*nScale),newText&&newText.fu.setPosition(0,(-nMaxValue+Math.abs(nMaxValue-nValue))*nScale);var nYStep=1;if(nYStep=nMaxValue/5,nYStep=Math.ceil(nYStep/(10*Math.floor(Math.log(nYStep))))*(10*Math.floor(Math.log(nYStep)))||1,nMaxValue=Math.ceil(nMaxValue/nYStep)*nYStep,!fPlotInit&&(fPlotInit=!0,szFlag.match(/BOX/)&&szFlag.match(/\bGRID\b/)))for(var s=map.Scale.normalX(nChartSize)/2;s<nMaxValue*nScale;s+=nScale*nYStep)map.Dom.newShape("line",gridGroup,-20,-s,20,-s,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else if(szFlag.match(/PLOTX/)){newShape.fu.setPosition((nMaxValue-Math.abs(nMaxValue-nValue))*nScale,0),newShapeBg&&newShapeBg.fu.setPosition((nMaxValue-Math.abs(nMaxValue-nValue))*nScale,0),newText&&newText.fu.setPosition((nMaxValue-Math.abs(nMaxValue-nValue))*nScale,0);var nYStep=1;if(nYStep=nMaxValue/5,nYStep=Math.ceil(nYStep/(10*Math.floor(Math.log(nYStep))))*(10*Math.floor(Math.log(nYStep)))||1,nMaxValue=Math.ceil(nMaxValue/nYStep)*nYStep,!fPlotInit&&(fPlotInit=!0,szFlag.match(/BOX/)&&szFlag.match(/\bGRID\b/)))for(var s=map.Scale.normalX(nChartSize);s<nMaxValue*nScale+map.Scale.normalX(nChartSize);s+=nScale*nYStep)map.Dom.newShape("line",gridGroup,s,-20,s,20,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";")}else{var nYStep=1;if(nYStep=Math.ceil(nMaxValue-nMinValue)/5,nYStep<.5&&(nYStep=Math.ceil(nMaxValue-nMinValue)/10),nYStep>1){var nDez=Math.pow(10,Math.floor(Math.log10(nYStep)));nYStep=Math.ceil(nYStep/nDez)*nDez||1}for(nMaxValue=Math.ceil(nMaxValue/nYStep)*nYStep,nMinValue=Math.floor(nMinValue/nYStep)*nYStep;(nMaxValue-nMinValue)/nYStep<5;)nYStep/=2;if((nMaxValue-nMinValue)/nYStep>5&&(nYStep*=2),!fPlotInit){fPlotInit=!0,this.plot_last_last_position=[],this.plot_last_position=[],this.plot_last_value=[],this.plot_last_stacked_value=[],this.plot_last_shape=[],this.plot_last_mean=[],this.plot_last_areaValue=[],this.plot_area_points=[],this.plot_area_shapes=[],this.plot_area_shapes[0]=map.Dom.newShape("path",shapeGroup,"M0,0","fill:"+szColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:none");var nPlotScale=nPartsA.length/(this.nGridX||1),nScaleFontSize=map.Scale.normalX(Math.max(nPartsA.length/(this.nGridX||1),3));nScaleFontSize*=(szFlag.match(/ZOOM/),1);var plotGroup=map.Dom.newGroup(shapeGroup,"");if(plotGroup.parentNode.insertBefore(plotGroup,shapeGroup.firstChild),szFlag.match(/BOX/)&&szFlag.match(/\bGRID\b/)&&(szFlag.match(/ZOOM/)||!(this.nBoxUpper&&map.Scale.nTrueMapScale*map.Scale.nZoomScale>this.nBoxUpper||this.nBoxLower&&map.Scale.nTrueMapScale*map.Scale.nZoomScale<this.nBoxLower))){if(!szFlag.match(/ZOOM/)){var left=-nStep/(szFlag.match(/LINES/)?3:1),right=nStep*(this.nGridX?nPartsA.length/this.nGridX-1:nPartsA.length-1);map.Dom.newShape("rect",shapeGroup,0,-(nMaxValue-nMinValue)*nScale,right,(nMaxValue-nMinValue)*nScale,"fill:#ffffff;fill-opacity:0;stroke:none;pointer-events:none")}for(var nBgOpacity=.8,incr=0,s=0;s<=(nMaxValue-nMinValue)*nScale;s+=nScale*nYStep){var st=this.formatValue(Math.round(szFlag.match(/INVERT/)?nMaxValue-s/nScale+nMinValue:100*(s/nScale+nMinValue))/100,2);nMaxValue>5&&(st=String(Math.round(szFlag.match(/INVERT/)?nMaxValue-s/nScale+nMinValue:s/nScale+nMinValue)));var sy=s;szFlag.match(/LOG/)&&(sy=100*Math.pow(10,incr++),sy>nMaxValue&&(s=nMaxValue*nScale),st=this.formatValue(sy,0),sy=Math.log10(sy)*nMaxValue/Math.ceil(Math.log10(nMaxValue))*nScale);var left=-nStep/(szFlag.match(/LINES/)?5:1),right=nStep*(this.nGridX?nPartsA.length/this.nGridX-1:nPartsA.length-1);if(szFlag.match(/PLOTVAR/)&&nPartsA.length/this.nGridX>1&&(right=nStep*this.nGridX),szFlag.match(/GRADIENT/)&&0!==s){var myRight=right+(szFlag.match(/LINES/),0);plotShape=map.Dom.newShape("path",shapeGroup,"M0,"+-s+" L "+myRight+","+-s+" "+myRight+","+(nScale*nYStep-s)+" 0,"+(nScale*nYStep-s)+" z","fill:#d8d8dd;fill-opacity:"+nBgOpacity+";stroke:none;"),nBgOpacity-=.3}sy===-nMinValue*nScale?map.Dom.newShape("line",gridGroup,left,-sy,right,-sy,"stroke:#444444;stroke-opacity:1;stroke-width:"+map.Scale.normalX(.05*nPlotScale)+";"):map.Dom.newShape("line",gridGroup,left,-sy,right,-sy,"stroke:#888888;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.05*nPlotScale)+";stroke-dasharray:"+6*nPlotScale+" "+3*nPlotScale+";"),szFlag.match(/RIGHT/)?map.Dom.newText(gridGroup,right+map.Scale.normalX(15),.3*nScaleFontSize-sy,"font-family:arial;font-size:"+nScaleFontSize+"px;text-anchor:start;fill:"+(szFlag.match(/\bCOLOR\b/)?szColor:"#888888")+";stroke:none;pointer-events:none;",st):map.Dom.newText(gridGroup,1.1*left,.3*nScaleFontSize-sy,"font-family:arial;font-size:"+nScaleFontSize+"px;text-anchor:end;fill:"+(szFlag.match(/\bCOLOR\b/)?szColor:"#888888")+";stroke:none;pointer-events:none;",st),this.nPlotHeight=s}if(szFlag.match(/ZOOM/)&&(this.nLowValue&&(map.Dom.newShape("line",gridGroup,left,-(this.nLowValue-nMinValue)*nScale,right,-(this.nLowValue-nMinValue)*nScale,"stroke:#dd0000;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.1*nPlotScale)+";stroke-dasharray:"+6*nPlotScale+" "+3*nPlotScale+";"),szFlag.match(/ZOOM/)&&map.Dom.newText(gridGroup,1.06*right,-(this.nLowValue-nMinValue)*nScale+.3*nScaleFontSize,"font-family:arial;font-size:"+nScaleFontSize+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",this.nLowValue)),this.nHighValue&&(map.Dom.newShape("line",gridGroup,left,-(this.nHighValue-nMinValue)*nScale,right,-(this.nHighValue-nMinValue)*nScale,"stroke:#dd0000;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.1*nPlotScale)+";stroke-dasharray:"+6*nPlotScale+" "+3*nPlotScale+";"),szFlag.match(/ZOOM/)&&map.Dom.newText(gridGroup,1.06*right,-(this.nHighValue-nMinValue)*nScale+.3*nScaleFontSize,"font-family:arial;font-size:"+nScaleFontSize+"px;text-anchor:end;fill:#888888;stroke:none;pointer-events:none;",this.nHighValue))),map.Dom.newShape("line",gridGroup,nAxis,0,nAxis,-(nMaxValue-nMinValue)*nScale,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(.1)+";"),this.szXaxisA&&this.szXaxisA.length)for(var s=0;s<this.szXaxisA.length;s++)(this.szXaxisA[s].length&&" "!=this.szXaxisA[s]||0==s||s==this.szXaxisA.length-1)&&(map.Dom.newShape("line",gridGroup,nStep*s,100,nStep*s,-(nMaxValue-nMinValue)*nScale,"stroke:#888888;stroke-opacity:0.4;stroke-width:"+map.Scale.normalX(.05*this.szXaxisA.length)+";stroke-dasharray:"+6*this.szXaxisA.length+" "+3*this.szXaxisA.length+";"),map.Dom.newText(gridGroup,nStep*s,1.5*nScaleFontSize,"font-family:arial;font-size:"+nScaleFontSize+"px;text-anchor:middle;fill:#888888;stroke:none;pointer-events:none;",this.szXaxisA[s]))}szFlag.match(/NOCLIP/)||map.Dom.setClipRect(shapeGroup,{x:-100,y:-(nMaxValue-nMinValue)*nScale,width:100+nMaxI/(this.nGridX||1)*nStep,height:100+(nMaxValue-nMinValue)*nScale})}var xi=this.nGridX?Math.floor(i/this.nGridX)+1:1,yi=this.nGridX?i%this.nGridX:1;szFlag.match(/LOG/)&&nValue&&(nValue=Math.log10(nValue)*nMaxValue/Math.ceil(Math.log10(nMaxValue)));var nPValue=szFlag.match(/INVERT/)?nMaxValue-nValue:nValue;if(nPValue-=nMinValue,nPValue+=szFlag.match(/STACKED/)&&this.plot_last_stacked_value[xi]||0,newShape.fu.setPosition(nAxis,-nPValue*nScale),newShapeBg&&newShapeBg.fu.setPosition(nAxis,-nPValue*nScale),newText&&newText.parentNode){if(this.nXLen>10){var nModulo=Math.floor(this.nXLen/5),ai=Math.floor(i/(this.nGridX||1));0!=ai&&ai!=this.nXLen-1&&(!this.szXaxisA||!this.szXaxisA.length||this.nXLen>100&&this.nXLen,newText.parentNode.removeChild(newText))}nPLastValue=nPValue,newText&&newText.parentNode&&(szFlag.match(/\bINLINETEXT\b/)?newText.fu.setPosition(nAxis,-nPValue*nScale):szFlag.match(/\bSTACKED\b/)?newText.parentNode.removeChild(newText):szFlag.match(/LINES/)&&(null==this.nGridX||this.nGridX<=1)?(newText.fu.setPosition(nAxis-map.Scale.normalX(nChartSize*this.nGridX||1),-nPValue*nScale),newText.fu.scale(2.5,2.5)):(newText.fu.scale(1.5*this.nValueScale,1.5*this.nValueScale),newText.fu.setPosition(nAxis-map.Scale.normalX(nChartSize/7),-nPValue*nScale)))}if(szFlag.match(/LINES/)){var plotShape=null;if(szFlag.match(/ZEROISVALUE/)&&!szFlag.match(/ZEROISNOTVALUE/)&&this.plot_last_position[yi]&&(nValue||this.plot_last_position[yi].y)||nValue&&this.plot_last_position[yi]&&this.plot_last_position[yi].y)if(szFlag.match(/AREA/)){if(plotShape=map.Dom.newShape("path",plotGroup,"M"+(this.plot_last_position[yi].x-2)+","+this.plot_last_position[yi].y+"L"+nAxis+","+-nPValue*nScale+" "+nAxis+","+(-nPValue+nValue)*nScale+" "+(this.plot_last_position[yi].x-2)+","+((this.plot_last_last_position[yi-1]?this.plot_last_last_position[yi-1].y:0)+nMinValue*nScale)+" z","fill:"+szColor+";fill-opacity:"+(this.fillOpacity||1)+";"),plotShape){if(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),this.nXLen<25)var v=this.formatValue(this.plot_last_areaValue[yi],this.nValueDecimals||2)+" ... "+this.formatValue(nValue,this.nValueDecimals||2);else var v=this.formatValue(nValue,this.nValueDecimals||2);if(plotShape.setAttributeNS(szMapNs,"tooltip",v+this.szUnit+" "+(this.szLabelA?this.szLabelA[nIndex%(this.nGridX||1e6)]:"")),plotShape.setAttributeNS(szMapNs,"time",String(uTime)),this.szFlag.match(/\bFADE\b/)){var gradientId="Gradient"+Math.random(),myGradient=map.Dom.constructNode("linearGradient",shapeGroup,{id:gradientId,gradientTransform:"rotate(90)"});map.Dom.constructNode("stop",myGradient,{offset:"0","stop-color":szColor,"stop-opacity":"1"}),map.Dom.constructNode("stop",myGradient,{offset:"1","stop-color":szColor,"stop-opacity":"0.1"}),plotShape.style.setProperty("fill","url(#"+gradientId+")")}}var linecap=1==i||i==nMaxI-1||2==xi||xi==nMaxI/(this.nGridX||1)?"but":"round";plotShape=map.Dom.newShape("line",plotGroup,this.plot_last_position[yi].x,this.plot_last_position[yi].y,nAxis,-nPValue*nScale,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(szFlag.match(/STACKED/)?1:this.nLineWidth||3)+";stroke-linecap:"+linecap+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"tooltip",this.formatValue(nValue,this.nValueDecimals||2)+this.szUnit+" "+(this.szLabelA?this.szLabelA[nClass%(this.nGridX||1e6)]:"")))}else{if(plotShape=map.Dom.newShape("line",plotGroup,this.plot_last_position[yi].x,this.plot_last_position[yi].y,nAxis,-nPValue*nScale,"stroke:"+(this.szLineColor||szColor)+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";stroke-linecap:round;"),this.nXLen<25)var v=this.formatValue(this.plot_last_areaValue[yi],this.nValueDecimals||2)+" ... "+this.formatValue(nValue,this.nValueDecimals||2);else var v=this.formatValue(nValue,this.nValueDecimals||2);plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"tooltip",v+this.szUnit+" "+(this.szLabelA?this.szLabelA[nClass%(this.nGridX||1e6)]:"")),plotShape.setAttributeNS(szMapNs,"time",String(uTime)));try{shapeGroup.insertBefore(plotShape,this.plot_last_shape[yi])}catch(e){}}if(szFlag.match(/LOLLIPOP/)&&nValue&&(plotShape=map.Dom.newShape("line",plotGroup,nAxis,nMinValue*nScale,nAxis,-nPValue*nScale,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:butt;"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime)))),szFlag.match(/LASTPOP/)&&nValue&&i>=nMaxI-(this.nGridX||1)&&(plotShape=map.Dom.newShape("circle",plotGroup,nAxis,-nPValue*nScale,map.Scale.normalX((this.nLineWidth||5)*(this.nMarkerSize||1.5)),"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"time",String(uTime)))),plotShape&&this.szFlag.match(/\bLASTARROW\b/)&&i>=nMaxI-(this.nGridX||1)){var arrowId="ArrowMarker"+Math.random(),tmpDefs=map.Dom.newNode("defs",plotGroup),nP=Math.min(5,2.5+100/((this.nLineWidth||1)/this.nChartGroupScale))*(this.nMarkerSize||3),myMarker=map.Dom.constructNode("marker",tmpDefs,{id:arrowId,markerWidth:nP,markerHeight:nP,refX:nP/1.7,refY:nP/2,orient:"auto",markerUnits:"strokeWidth"}),myMarkerShape=map.Dom.constructNode("path",myMarker,{d:"M0,"+nP+" L"+nP+","+nP/2+" L0,0 Z",style:"fill:"+szColor+";opacity:1;stroke:none;stroke-width:0.03"});plotShape.setAttributeNS(null,"marker-end","url(#"+arrowId+")")}if(szFlag.match(/\bLASTVALUE\b/)&&!szFlag.match(/\bZOOM\b/)&&nValue&&i>=nMaxI-(this.nGridX||1)&&(newText=this.createTextLabel(SVGDocument,shapeGroup,"",nValue,3/this.nScale*this.nValueScale,"","rgba(255,255,255,0)",this.szTextColor||"#444444","GLOW"),newText.fu.setPosition(nAxis-2e3,-nPValue*nScale-1e3)),szFlag.match(/PLOTVAR/)){var nMean=szFlag.match(/MEDIAN/)?this.nMedianA[nIndex]:this.nMeanA[nIndex];nMean-=nMinValue,this.plot_last_mean[yi]&&(plotShape=map.Dom.newShape("path",gridGroup,"M"+this.plot_last_mean[yi].x+","+(this.plot_last_mean[yi].y-this.nDeviationA[nIndex-1]*nScale)+" L "+nAxis+","+(-nMean-this.nDeviationA[nIndex])*nScale+" "+nAxis+","+(-nMean+this.nDeviationA[nIndex])*nScale+" "+this.plot_last_mean[yi].x+","+(this.plot_last_mean[yi].y+this.nDeviationA[nIndex-1]*nScale)+" z","fill:#d8d8dd;fill-opacity:0.2;stroke:none;"),plotShape&&plotShape.setAttributeNS(szMapNs,"tooltip","standard deviation"),plotShape=map.Dom.newShape("line",shapeGroup,this.plot_last_mean[yi].x,this.plot_last_mean[yi].y,nAxis,-nMean*nScale,"stroke:#888888;stroke-width:"+map.Scale.normalX(2)+";stroke-linecap:round;stroke-dasharray:10 80;"),plotShape&&plotShape.setAttributeNS(szMapNs,"tooltip","mean")),this.plot_last_mean[yi]=new point(nAxis,-nMean*nScale)}this.plot_last_last_position[yi]=szFlag.match(/STACKED/)&&this.plot_last_position[yi]||new point(0,0),this.plot_last_position[yi]=nPValue>=0?new point(nAxis,-nPValue*nScale):new point(nAxis,0),this.plot_last_shape[yi]=newShape,this.plot_last_areaValue[yi]=nValue,this.plot_area_points.push(new point(nAxis,-nPValue*nScale))}else if(szFlag.match(/LOLLIPOP/)&&nValue)plotShape=map.Dom.newShape("line",plotGroup,nAxis,nMinValue*nScale,nAxis,-nPValue*nScale,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:butt;"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime)));else if(szFlag.match(/LASTPOP/)&&nValue)plotShape=map.Dom.newShape("line",plotGroup,nAxis,0,nAxis,-nPValue*nScale,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(3)+";stroke-linecap:round;"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime)));else if(nPartsA.length/this.nGridX>1)if(szFlag.match(/PLOTVAR/)){newShape.style.setProperty("fill-opacity",xi==nPartsA.length/this.nGridX?"1":"0.2",""),newShape.style.setProperty("stroke-width",xi==nPartsA.length/this.nGridX?"0":"3","");var plotShape=null;this.plot_last_position[yi]&&(szFlag.match(/PLOTVAR/)?(plotShape=map.Dom.newShape("line",shapeGroup,this.plot_last_position[yi].x,this.plot_last_position[yi].y,nAxis,-nPValue*nScale,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(2)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime)),plotShape.parentNode.insertBefore(plotShape,plotShape.parentNode.firstChild)),plotShape=map.Dom.newShape("line",shapeGroup,this.plot_last_position[yi].x-40,this.plot_last_position[yi].y,this.plot_last_position[yi].x+40,this.plot_last_position[yi].y,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime)),plotShape.parentNode.insertBefore(plotShape,plotShape.parentNode.firstChild)),plotShape=map.Dom.newShape("line",shapeGroup,nAxis,0,nAxis,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime)),plotShape.parentNode.insertBefore(plotShape,plotShape.parentNode.firstChild))):(plotShape=map.Dom.newShape("line",shapeGroup,this.plot_last_position[yi].x,this.plot_last_position[yi].y,nAxis,-nPValue*nScale,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(this.nLineWidth||3)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime)),shapeGroup.insertBefore(plotShape,this.plot_last_shape[yi])))),this.plot_last_last_position[yi]=this.plot_last_position[yi]||new point(0,0),this.plot_last_position[yi]=new point(nAxis,-nPValue*nScale),this.plot_last_shape[yi]=newShape}else szFlag.match(/BOX/)&&map.Dom.newShape("line",gridGroup,nAxis,0,nAxis,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";");else if(szFlag.match(/PLOTVAR/)){var plotShape=null,nMean=szFlag.match(/MEDIAN/)?this.nMedianA[nIndex]:this.nMeanA[nIndex];nMean-=nMinValue,plotShape=map.Dom.newShape("line",gridGroup,nAxis,-(nMean-this.nDeviationA[nIndex])*nScale,nAxis,-(nMean+this.nDeviationA[nIndex])*nScale,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime))),plotShape=map.Dom.newShape("line",gridGroup,nAxis-40,-nMean*nScale,nAxis+40,-nMean*nScale,"stroke:#444444;stroke-width:"+map.Scale.normalX(2)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime))),plotShape=map.Dom.newShape("line",gridGroup,nAxis-80,-(nMean-this.nDeviationA[nIndex])*nScale,nAxis+80,-(nMean-this.nDeviationA[nIndex])*nScale,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime))),plotShape=map.Dom.newShape("line",gridGroup,nAxis-80,-(nMean+this.nDeviationA[nIndex])*nScale,nAxis+80,-(nMean+this.nDeviationA[nIndex])*nScale,"stroke:#444444;stroke-width:"+map.Scale.normalX(1)+";"),plotShape&&(plotShape.setAttributeNS(szMapNs,"value",String(nValue)),plotShape.setAttributeNS(szMapNs,"class",String(nClass%(this.nGridX||1e6))),plotShape.setAttributeNS(szMapNs,"time",String(uTime))),map.Dom.newShape("line",gridGroup,nAxis,0,nAxis,-this.nPlotHeight,"stroke:#dddddd;stroke-width:"+map.Scale.normalX(.25)+";"),this.plot_last_position[yi]&&(plotShape=map.Dom.newShape("line",gridGroup,this.plot_last_position[yi].x,this.plot_last_position[yi].y,nAxis,-nMean*nScale,"stroke:#888888;stroke-width:"+map.Scale.normalX(1)+";")),this.plot_last_last_position[yi]=this.plot_last_position[yi]||new point(0,0),this.plot_last_position[yi]=new point(nAxis,-nMean*nScale)}else szFlag.match(/BOX/)&&map.Dom.newShape("line",gridGroup,nAxis,0,nAxis,-this.nPlotHeight,"stroke:#aaaaaa;stroke-width:"+map.Scale.normalX(.25)+";");this.plot_last_value[xi]=nValue,this.plot_last_stacked_value[xi]=nPValue}nSymbolOffsetY=0}else"label"==szSymbol&&(nSymbolOffsetY-=nLabelHeight/1.95),newShape.fu.setPosition(map.Scale.normalX(0)+nSymbolOffsetX,map.Scale.normalY(0)+nSymbolOffsetY),newShapeBg&&newShapeBg.fu.setPosition(map.Scale.normalX(0)+nSymbolOffsetX,map.Scale.normalY(0)+nSymbolOffsetY),newText&&newText.fu.setPosition(nSymbolOffsetX,map.Scale.normalY(0)+nSymbolOffsetY),nSymbolOffsetY-="label"==szSymbol?nLabelHeight/1.95:nRadius}}else{var szSymbol="";if(this.nRangesA&&this.nRangesA.length)for(ii=0;ii<this.nRangesA.length;ii++)if(nValue==this.nRangesA[ii]||Number(nValue)==Number(this.nRangesA[ii])){szSymbol=this.szSymbolsA[ii]||this.szSymbolsA[0]||"circle",nClass=ii;break}szSymbol=this.itemA[a].szSymbol||szSymbol;var szTooltip=String(nValue),szLabel=String(nValue);if(this.szLabelA&&this.szLabelA[nClass]&&(szTooltip=this.szLabelA[nClass],szLabel=this.szLabelA[nClass]),szSymbol.length||0!==nIndex||(szSymbol="empty",szTooltip=szLabel="no data",nClass=0),szSymbol.length){nSymbols++;var newShape=null;nClass=void 0!==this.itemA[a].nClass?this.itemA[a].nClass:nClass,szColor=void 0!==this.itemA[a].szColor?this.itemA[a].szColor:this.colorScheme[nClass],szFlag.match(/NOLINES/)?szLineColor="none":(szLineColor=this.itemA[a].szColor||this.colorScheme[nClass],"white"!=szColor&&"#ffffff"!=szColor||(szLineColor="gray")),szLineColor=this.szLineColor||szLineColor;var nRadius=map.Scale.normalX(nChartSize/2);if(szFlag.match(/FIXSIZE/)?nRadius=map.Scale.normalX(nChartSize/2)/(this.nNormalSizeValue||1):szFlag.match(/NOSIZE/)?nRadius=map.Scale.normalX(nChartSize/2):a&&this.itemA[a]&&this.itemA[a].nSize&&(nRadius=nRadius/Math.pow(this.nNormalSizeValue||this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[a].nSize,1/this.nSizePow)),"circle"==szSymbol||"square"==szSymbol||"roundrect"==szSymbol||"label"==szSymbol||"carot"==szSymbol||"diamond"==szSymbol||"triangle"==szSymbol||"hexagon"==szSymbol||"cross"==szSymbol||"empty"==szSymbol){var nMaxRadius=map.Scale.normalX(nChartSize/2),nLineWidth=(this.nLineWidth||1)*map.Scale.normalX(Math.min(nRadius/nMaxRadius,1));switch(szSymbol){case"empty":newShape=map.Dom.newShape("circle",shapeGroup,0,0,nRadius,"fill:#888888;fill-opacity:0;stroke:#888888;stroke-width:"+nLineWidth+";");break;case"circle":newShape=map.Dom.newShape("circle",shapeGroup,0,0,nRadius,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"square":newShape=map.Dom.newShape("rect",shapeGroup,.8*-nRadius,.8*-nRadius,2*nRadius*.8,2*nRadius*.8,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"roundrect":newShape=map.Dom.newShape("rect",shapeGroup,.8*-nRadius,.8*-nRadius,2*nRadius*.8,2*nRadius*.8,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";"),newShape.setAttributeNS(null,"rx",.3*nRadius);break;case"cross":var A=.4*nRadius,B=.8*nRadius;newShape=map.Dom.newShape("path",shapeGroup,"M 0,-"+(B+A/2)+" l"+A/2+",0 0,"+B+" "+B+",0 0,"+A+" -"+B+",0 0,"+B+" -"+A+",0 0,-"+B+" -"+B+",0 0,-"+A+" "+B+",0 0,-"+B+" "+A/2+",0 z","fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"diamond":case"carot":newShape=map.Dom.newShape("rect",shapeGroup,.8*-nRadius,.8*-nRadius,2*nRadius*.8,2*nRadius*.8,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";"),newShape&&newShape.setAttributeNS(null,"transform","rotate(45)");break;case"triangle":newShape=map.Dom.newShape("path",shapeGroup,"M 0,"+nRadius+" l"+1.2*nRadius+",-"+2*nRadius+" -"+2.4*nRadius+",0 "+1.2*nRadius+","+2*nRadius+"z","fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"hexagon":var A=nRadius/2,B=nRadius*Math.sin(60/180*Math.PI),C=nRadius;newShape=map.Dom.newShape("path",shapeGroup,"M -"+nRadius+",0 l "+A+",-"+B+" "+C+",0 "+A+","+B+" -"+A+","+B+" -"+C+",0 -"+A+",-"+B+" z","fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break;case"label":var nLabelHeight=2*nRadius*.4;newShape=map.Dom.newShape("rect",shapeGroup,.8*-nRadius,.4*-nRadius,2*nRadius*.8,2*nRadius*.4,"fill:"+szColor+";stroke:"+szLineColor+";stroke-width:"+nLineWidth+";");break}if(!newShape)continue;if(szFlag.match(/HORZ/)){if(szFlag.match(/LEFT/)&&(nIndex=-nIndex),szFlag.match(/VALUES/)){var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.textColor;var newText=map.Dom.newText(shapeTextGroup,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(nRadius/2)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",szLabel);newText.fu.setPosition(nIndex*nRadius*2,-nRadius-map.Scale.normalX(5)),nPartsA.length>1&&setRotate(newText,-45)}if(szFlag.match(/AXIS/)&&this.szXaxisA&&(!this.fHideValues||szFlag.match(/ZOOM/))){var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.textColor;var szAxisText=this.szXaxisA[i],newText=map.Dom.newText(shapeTextGroup,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(nRadius)+"px;text-anchor:start;baseline-shift:-90%;fill:#bbbbbb;stroke:none;pointer-events:none",szAxisText);newText.fu.setPosition(nIndex*nRadius*2+map.Scale.normalX(2),nRadius+map.Scale.normalX(1)),nPartsA.length>1&&setRotate(newText,45)}newShape.setAttributeNS(szMapNs,"tooltip",szTooltip),newShape.fu.setPosition(nIndex*nRadius*2,0),szFlag.match(/LEFT/)&&(nIndex=-nIndex)}else{if(szFlag.match(/VALUES/)&&(!this.fHideValues||szFlag.match(/ZOOM/))){var cColor=__maptheme_getChartColors(szColor),szTextColor=this.szValueColor||this.szTextColor||cColor.textColor,szMaxTextLength=Math.max((tValue.length||0)+1,szMaxText.length);if(szFlag.match(/INLINETEXT/)){var szText=this.formatValue(tValue,this.nValueDecimals||(tValue<1||nMaxValue<=1?1:0),"ROUND")+(this.szUnit.length<=5?this.szUnit:""),nFontSize=String(Math.min(1*nMaxRadius,nMaxRadius*(("hexagon"==szSymbol?2.7:3.2)/szMaxTextLength)));nFontSize*=nRadius/nMaxRadius*this.nValueScale;var newText=map.Dom.newText(shapeGroup,0,.33*nFontSize,"font-family:"+(this.szTextFont||"arial")+";font-size:"+nFontSize+"px;text-anchor:middle;fill:"+szTextColor+";stroke:none;pointer-events:none",szText)}else{var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.textColor;var szText=this.formatValue(tValue,this.nValueDecimals||(tValue<1||nMaxValue<=1?1:0),"ROUND")+(this.szUnit.length<=5?this.szUnit:""),newText=map.Dom.newText(shapeTextGroup,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(nRadius/2*this.nValueScale)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",szText);newText.fu.setPosition(nRadius+map.Scale.normalX(3),-nIndex*(2*nRadius-map.Scale.normalY(0)))}}newShape.setAttributeNS(szMapNs,"tooltip",szTooltip),newShape.fu.setPosition(0,-nIndex*(2*nRadius-map.Scale.normalY(0)))}if(szFlag.match(/OUTLINE/))newShape.style.setProperty("stroke-width",String(map.Scale.normalX(.5))),newShape.style.setProperty("stroke-opacity","1"),newShape.style.setProperty("fill-opacity","0.7");else if(szFlag.match(/DOPACITY/)&&this.szAlphaField){if(a&&void 0!==this.itemA[a].nAlpha){var nPow=1/(this.nDopacityPow||1),nOpacity=(this.nDopacityScale||1)/Math.pow(this.nMaxAlpha,nPow)*Math.pow(this.itemA[a].nAlpha,nPow);newShape.style.setProperty("fill-opacity",String(nOpacity),"")}}else newShape.style.setProperty("fill-opacity",String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:1),"")}else{if(szSymbol.match(/.svg|.png|.jpeg/)?(newShape=map.Dom.constructNode("image",shapeGroup,{"xlink:href":szSymbol}),newShape.setAttributeNS(null,"x",String(map.Scale.normalX(-nChartSize/2))),newShape.setAttributeNS(null,"y",String(map.Scale.normalY(-nChartSize))),newShape.setAttributeNS(null,"width",String(map.Scale.normalX(nChartSize))),newShape.setAttributeNS(null,"height",String(map.Scale.normalY(nChartSize)))):newShape=map.Dom.constructNode("use",shapeGroup,{"xlink:href":"#"+szSymbol+":antizoomandpan"}),newShape.setAttributeNS(null,"style","fill:"+szColor+";stroke:"+szLineColor),this.szSizeField&&a&&this.itemA[a]){var nScale=1/Math.sqrt(this.nMaxSize)*Math.sqrt(this.itemA[a].nSize);newShape.fu.scale(nScale,nScale)}if(newShape.fu.scale(nRadius/nChartSize,nRadius/nChartSize),newShape.fu.setPosition(map.Scale.normalX(0)+nIndex*map.Scale.normalX(20),map.Scale.normalY(0)),nIndex>0&&(map.Dom.newText(shapeGroup,map.Scale.normalX(-9)+nIndex*map.Scale.normalX(20),0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(360)+"px;text-anchor:middle;baseline-shift:-50%;fill:none;stroke:black;stroke-width:60;pointer-events:none;opacity:0.3;","+"),map.Dom.newText(shapeGroup,map.Scale.normalX(-9)+nIndex*map.Scale.normalX(20),0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(360)+"px;text-anchor:middle;baseline-shift:-50%;fill:white;stroke:none;pointer-events:none;opacity:0.8;","+")),szFlag.match(/VALUES/)){var cColor=__maptheme_getChartColors(szColor);szLineColor=cColor.textColor;var newText=map.Dom.newText(shapeTextGroup,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(nRadius/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",szLabel);newText.fu.setPosition(nRadius/2+map.Scale.normalX(3),2*nRadius*-nIndex),szFlag.match(/MULTILINE/)&&this.szSizeField&&a&&this.itemA[a]&&(newText=map.Dom.newText(shapeTextGroup,0,0,"font-family:"+(this.szTextFont||"arial")+";font-size:"+String(nRadius/2)+"px;text-anchor:start;baseline-shift:-45%;fill:#bbbbbb;stroke:none;pointer-events:none",String(this.itemA[a].nSize)+this.szSizeValueUnits),newText.fu.setPosition(nRadius/2+map.Scale.normalX(3),2*nRadius*-nIndex+nRadius/2))}}newShape.setAttributeNS(szMapNs,"value",String(nValue)),newShape.setAttributeNS(szMapNs,"class",String(nClass)),newShape.setAttributeNS(szMapNs,"time",String(uTime)),this.nRealizedCount++}else this.nMissingRangeCount++}}}if(shapeTextGroup&&shapeTextGroup.parentNode&&shapeTextGroup.parentNode.appendChild(shapeTextGroup),topShape&&topShape.parentNode&&topShape.parentNode.appendChild(topShape),topText&&topText.parentNode&&topText.parentNode.appendChild(topText),topText2&&topText2.parentNode&&topText2.parentNode.appendChild(topText2),0&szFlag.match(/AREA/)&&!this.nGridX&&this.plot_area_points&&this.plot_area_points.length){for(var fdo=!0,np=this.plot_area_points.length,p=0;p<np;p++)0===this.plot_area_points[p].y&&(fdo=!1);if(fdo||szFlag.match(/ZEROISVALUE/)){for(var d="M"+this.plot_area_points[0].x+","+this.plot_area_points[0].y+" L ",p=1;p<np;p++)d+=this.plot_area_points[p].x+","+this.plot_area_points[p].y+" ";d+=this.plot_area_points[np-1].x+",0 ",d+="0,0 ",d+="z ",this.plot_area_shapes[0].setAttributeNS(null,"d",d)}}if(szFlag.match(/\bLINREG\b/)){var x1=0,x2=nPartsA.length-1,y1=linreg_m*x1+linreg_b,y2=linreg_m*x2+linreg_b,szLineColor=this.szLineColorA?this.szLineColorA[0]:this.chart.szColor,linearRegressionShape=map.Dom.newShape("line",plotGroup,x1*nStep,-y1*nScale,x2*nStep,-y2*nScale,"stroke:"+szLineColor+";stroke-width:50;stroke-dasharray:50 50");linearRegressionShape.setAttributeNS(szMapNs,"tooltip","linerar regression")}if(void 0!==this.szSymbolBoxStyle){var bBox=map.Dom.getBox(shapeGroup);newFrame.setAttributeNS(null,"x",-map.Scale.normalX(15)),newFrame.setAttributeNS(null,"y",-map.Scale.normalY(15)),newFrame.setAttributeNS(null,"width",map.Scale.normalX(30*nSymbols)),newFrame.setAttributeNS(null,"height",map.Scale.normalY(30)),newFrame.setAttributeNS(null,"fill-opacity",1)}ptNull.x=map.Scale.normalY(0),ptNull.y=map.Scale.normalY(szFlag.match(/ZOOM/)||szFlag.match(/MENUSIZE/)?20:nRadius/map.Scale.normalY(1)+5)}else if(szFlag.match(/BUFFER/)){var nMaxValue=this.nMaxA[0],nValue=nPartsA[0],nRadius=this.nBufferSize?this.nBufferSize:1e3;this.szShapeType.match(/line/)&&(nRadius*=this.nScale),nRadius=map.Scale.getDeltaXofDistanceInMeter(nRadius);var szColor=this.colorScheme[0],i;if(this.szFields&&this.szFields.length&&this.nRangesA&&this.nRangesA.length)if(szColor=null,this.nRangesA.length==this.colorScheme.length)for(i=0;i<this.nRangesA.length;i++)if(nValue==this.nRangesA[i]||Number(nValue)==Number(this.nRangesA[i])){szColor=this.colorScheme[i];var cColor=__maptheme_getChartColors(szColor);szLineColor=void 0!==this.szBorderColor?this.szBorderColor:this.fillOpacity<.8?"#888888":cColor.textColor;break}if(this.szShapeType.match(/dummy||point/)){if(!szColor)return new point(0,0);nChartSize=2*nRadius/map.Scale.normalX(1),ptNull.x=0,ptNull.y=nRadius+map.Scale.normalY(5);var nFillOpacity=1;nFillOpacity=.75,(this.szFlag.match(/OVERLAY/)||0===this.fillOpacity)&&(nFillOpacity=this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0),nFillOpacity=this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0;var newShape=map.Dom.newShape("circle",shapeGroup,0,0,nRadius,"");if(this.szFlag.match(/VALUE/))var szTextStyle="font-family:arial;font-size:"+map.Scale.normalX(30)+"px;fill:#222222;fill-opacity:1;stroke:white;stroke-opacity:0.2;stroke-dasharray:none;pointer-events:none;",newText=map.Dom.newText(shapeGroup,nRadius-map.Scale.normalX(20),0,szTextStyle,ixMap.Scale.prototype.formatDistanceString(this.nBufferSize));this.nRealizedCount++}if(this.szShapeType.match(/line/)){var shapeNode=SVGDocument.getElementById(a),szId=shapeNode.getAttributeNS(null,"id");if(!szId.match(":paint")){var cloneShape=SVGDocument.getElementById(szId+":paint");if(!cloneShape){var cloneShape=shapeNode.cloneNode(1e3);shapeGroup.appendChild(cloneShape),cloneShape.setAttributeNS(null,"id",szId+":paint")}shapeNode=cloneShape,this.nRealizedCount++}var nStrokeWidth=2*nRadius/map.Scale.normalX(1);return shapeNode.setAttributeNS(null,"style","fill:none;stroke:"+szColor+";stroke-linejoin:round;stroke-linecap:round;stroke-width:"+map.Scale.normalX(nStrokeWidth)*map.Scale.nZoomScale+";stroke-opacity:"+String(this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0)),null}}else if(szFlag.match(/BAR/)||szFlag.match(/BARS/)){var nPosX=0,nPosY=0,origChartSize=nChartSize,nSizer=1,nHeight=0,nSize=1,nRange=this.nMax-this.nMin,nRange100=this.nMax100-this.nMin100;if(this.nNormalSizeValue&&(nRange=nRange100=this.nMaxSize=this.nNormalSizeValue),szFlag.match(/SIZE/)&&!szFlag.match(/NORMSIZE/)&&this.szSizeField&&a&&this.itemA[a])nSizer=szFlag.match(/SIZELOG/)?1/Math.max(1,Math.log(this.nMaxSize)*Math.log(this.itemA[a].nSize)):1/Math.pow(this.nMaxSize,1/this.nSizePow)*Math.pow(this.itemA[a].nSize,1/this.nSizePow);else if(szFlag.match(/SIZE/)&&!szFlag.match(/NORMSIZE/)){var nValueSum=nMySum;szFlag.match(/POINTER/)&&(nValueSum/=nPartsA.length),nSizer=szFlag.match(/SIZELOG/)?1/Math.max(1,Math.log(nRange)*Math.log(Math.abs(nValueSum))):1/Math.pow(nRange,1/this.nSizePow)*Math.pow(Math.abs(nValueSum),1/this.nSizePow)}0===nSizer&&0!==nMySum&&(nSizer=30/nChartSize),nChartSize*=nSizer;var nWidth=map.Scale.normalX(nChartSize/nPartsA.length*.66);szFlag.match(/STACKED/)&&(nWidth=map.Scale.normalX(nChartSize/3),this.nGridX&&!szFlag.match(/MULTI/)&&(nWidth/=2)),szFlag.match(/MENUSIZE/)&&1==nPartsA.length&&(nWidth=map.Scale.normalX(nChartSize/2));var nTextSize=nWidth<map.Scale.normalX(5)?4*nWidth/5:5*nWidth/5,nTextOpacity=1;szFlag.match(/COLUMN/)&&(nWidth*=szFlag.match(/THICK/)?2:szFlag.match(/THIN/)?1:1.5),szFlag.match(/THIN/)&&(nWidth*=.6,nTextSize*=.75),szFlag.match(/THICK/)&&(nWidth*=1.5,nTextSize*=1.5),szFlag.match(/STACKED/)?nTextSize=map.Scale.normalX(5):(szFlag.match(/ZOOM/)||szFlag.match(/NORMSIZE/))&&1==nPartsA.length&&(nTextSize*=2.5),szFlag.match(/STACKED/)&&!szFlag.match(/ZOOM/)&&(nTextSize*=nSizer),nTextSize*=this.nValueScale||1;var szTextStyle="font-family:arial;font-size:"+.95*nTextSize+"px;fill:#606060;pointer-events:none;";szTextStyle=map.Scale.tStyle.Values.szStyle+"font-size:"+.95*nTextSize+"px";var szTextBgStyle=szTextStyle+";fill:none;stroke:none;";szFlag.match(/NORMSIZE/)||szFlag.match(/MENUSIZE/)||this.szFlag.match(/NORMSIZE/)||this.szFlag.match(/MENUSIZE/)||!this.nNormalSizeValue||this.szField100&&!szFlag.match(/POINTER/)||(nMax=this.nNormalSizeValue),this.nOverrideMax&&(nMax=this.nOverrideMax);var nStep=map.Scale.normalX(origChartSize)/nMax;(szFlag.match(/OFFSETMEAN/)||szFlag.match(/OFFSETMEDIAN/)||szFlag.match(/DEVIATION/))&&(nStep=map.Scale.normalX(nChartSize)/300),szFlag.match(/SIZE/)&&szFlag.match(/SEQUENCE/)&&a&&nPartsA.length>1&&!this.szSizeField&&!this.szField100?nStep=nStep*nPartsA.length/nSizer:szFlag.match(/SIZE/)&&a&&nPartsA.length>1&&!szFlag.match(/EXPAND/)&&(this.szField100||szFlag.match(/POINTER/)?nStep*=nSizer:nStep/=szFlag.match(/SIZEP4/)?nSizer*nSizer:nSizer),this.nRangeScale&&(nStep*=this.nRangeScale),szFlag.match(/COMPRESSMAX/)?nStep/=4:szFlag.match(/COMPRESSMORE/)?nStep/=3:szFlag.match(/COMPRESS/)?nStep/=2:szFlag.match(/EXPANDMAX/)?nStep*=4:szFlag.match(/EXPANDMORE/)?nStep*=3:szFlag.match(/EXPAND/)&&(nStep*=2),szFlag.match(/POINTER/)&&!szFlag.match(/NORMSIZE/)&&(nStep*=1.2);var barGroup=map.Dom.newGroup(shapeGroup,"");if(szFlag.match(/\bSORT\b/)){for(this.sortedIndex=[],i=0;i<nPartsA.length;i++)this.sortedIndex[i]={index:i,value:nPartsA[i]};this.sortedIndex.sort(szFlag.match(/STACKED/)?this.sortIndexUp:this.sortIndexDown)}else this.sortedIndex=null;var nStartI=0;szFlag.match(/\bUP\b/)&&(nStartI=nPartsA.length-1);var nCenter=1;szFlag.match(/CENTER/)&&(nCenter=2);var minNextTextPos=new point(0,0),lastValue=null,lastHeight=null,lastX=null,lastY=null,lastWidth=null,lastColor=null,nValueSum=0,nBarsDrawn=0,nClass=null,nOldStep=nStep;for(i=this.nClipParts&&this.nClipParts<nPartsA.length?nPartsA.length-this.nClipParts:0;i<nPartsA.length;i++){if(this.szShowParts){var skipIt=!0;for(p in this.szShowPartsA)this.szShowPartsA[p]==i&&(skipIt=!1);if(skipIt)continue}nStep=nOldStep;var nIndex=Math.abs(nStartI-i);this.sortedIndex&&(nIndex=this.sortedIndex[nIndex].index);var nValue=nPartsA[nIndex];this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)&&this.nClipFrames&&(nValue=this.nClipFrames==nPartsA.length?Number(nPartsA[this.nActualFrame]):nPartsA[0]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+nPartsA[nPartsA.length-1]*this.nActualFrame/(this.nClipFrames-1),nIndex=this.nActualFrame,i=nPartsA.length);var nTextValue=nValue;szFlag.match(/INVERT/)&&(0!==nValue||szFlag.match(/ZEROISVALUE/))&&(nValue=this.nMax-nValue);var szValue=this.formatValue(nValue,this.nValueDecimals||2);szFlag.match(/OFFSETMEAN/)||szFlag.match(/OFFSETMEDIAN/)?(szFlag.match(/OFFSETMEAN/)&&(nValue=100/this.nMeanA[nIndex]*nValue),szFlag.match(/OFFSETMEDIAN/)&&(nValue=100/this.nMedianA[nIndex]*nValue),nValue-=100,nValue=isFinite(nValue)&&!isNaN(nValue)?nValue:0,nTextValue=nValue,nMax=100,szValue=this.formatValue(nValue,this.nValueDecimals||2),nValue>0&&(szValue="+"+szValue)):szFlag.match(/DEVIATION/)&&(nValue=(nValue-this.nMeanA[nIndex])/this.nDeviationA[nIndex],nValue=isFinite(nValue)&&!isNaN(nValue)?nValue:0,nTextValue=nValue,nValue*=100,szValue=this.formatValue(nValue,this.nValueDecimals||2),nValue>0&&(szValue="+"+szValue));var nColor=this.colorScheme[nIndex]||this.colorScheme[nIndex%(this.nGridX||1e6)],nClass=nIndex%(this.nGridX||1e6);if((szFlag.match(/SEQUENCE|CLIP/)||1==nPartsA.length)&&this.colorScheme.length>=2)for(nColor=this.colorScheme[this.partsA.length-1],ii=0;ii<this.partsA.length;ii++)if(nValue<this.partsA[ii].max){nColor=this.colorScheme[ii],nClass=ii;break}if(szFlag.match(/LEFT/)&&szFlag.match(/HORZ/)&&(nValue=-nValue),nValue<0&&!szFlag.match(/STACKED/)&&(nPosY=-nValue*nStep,nValue=-nValue),szFlag.match(/VOLUME/)&&szFlag.match(/3D/)?(nStep=1,nValue=nWidth=this.szSizeField&&a?map.Scale.normalX(nChartSize/3*2)*Math.pow(1/this.nMaxSize*this.itemA[a].nSize,1/3):map.Scale.normalX(nChartSize/3*2)*Math.pow(1/nMax*nValue,1/3)):(szFlag.match(/POINTER/)&&szFlag.match(/SIZE/)&&a&&(nWidth=szFlag.match(/WIDTH/)&&nValue100&&(!(szFlag.match(/DIFFERENCE/)||szFlag.match(/RELATIVE/)||szFlag.match(/FRACTION/))||szFlag.match(/OFFSETMEAN/)||szFlag.match(/OFFSETMEDIAN/)||szFlag.match(/DEVIATION/))?map.Scale.normalX(nChartSize)*Math.pow(Math.abs(1/this.nMax100*nValue100),.5):map.Scale.normalX(nChartSize)*Math.pow(Math.abs(1/nMax*nValue),1/3),nTextSize=.6*nWidth,this.nValueSizeMin&&!szFlag.match(/ZOOM/)&&(nTextSize=nTextSize*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?nTextSize:0),this.nValueValueMin&&!szFlag.match(/ZOOM/)&&(nTextSize=nValue>this.nValueValueMin?nTextSize:0),szFlag.match(/ZOOM|XAXIS/)||(nTextOpacity=Math.pow(Math.abs(nValue),.5)/Math.pow(this.nMax,.5),this.szFadeValuePow&&Number(this.szFadeValuePow)&&(nTextOpacity=Math.pow(Math.abs(nValue),Number(this.szFadeValuePow))/Math.pow(nMax,Number(this.szFadeValuePow))))),szFlag.match(/DTEXT/)&&a&&!szFlag.match(/ZOOM/)?(nTextSize=map.Scale.normalX(nChartSize/3*2)*Math.pow(Math.abs(1/nMax*nValue),.5)*.75,this.nValueSizeMin&&!szFlag.match(/ZOOM/)&&(nTextSize=nTextSize*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?nTextSize:0),this.nValueValueMin&&!szFlag.match(/ZOOM/)&&(nTextSize=nValue>this.nValueValueMin?nTextSize:0),nTextOpacity=Math.pow(Math.abs(nValue),1/3)/Math.pow(nMax,1/3)):(this.nValueSizeMin&&!szFlag.match(/ZOOM/)&&(nTextSize=nTextSize*map.Layer.nDynamicObjectScale>map.Scale.normalX(this.nValueSizeMin)?nTextSize:0),this.nValueValueMin&&!szFlag.match(/ZOOM/)&&(nTextSize=nValue>this.nValueValueMin?nTextSize:0))),nValue=isFinite(nValue)&&!isNaN(nValue)?nValue:0,0===nValue&&szFlag.match(/NOZERO/))nPosY=0;else if(nTextValue<0&&szFlag.match(/NONEGATIVE/))nPosY=0;else if(nTextValue>0&&szFlag.match(/ONLYNEGATIVE/))nPosY=0;else{var barShape=map.Dom.newGroup(barGroup,"");this.szFlag.match(/MENUSIZE/)&&1==nPartsA.length&&!szFlag.match(/VOLUME/)&&(nWidth*=.8,nValue=nWidth/nStep*1.7,map.Dom.newShape("rect",barShape,0,-map.Scale.normalY(.75*nChartSize),map.Scale.normalX(.5*nChartSize),map.Scale.normalY(.75*nChartSize),"fill:red;stroke:none;fill-opacity:0"));var nnValue=nValue;if(szFlag.match(/COLUMN/)){if(nValue*nStep>0){var donut=DonutCharts.newChart(SVGDocument,barShape,nPosX+nWidth/2,0,nWidth/2,0);donut.setStyle("3D"),donut.addStyle("SILENT"),donut.addPart(100,nValue*nStep*2-(szFlag.match(/SPACED/)?nWidth/2:nWidth/5),nColor,0,(this.szAggregation&&this.szAggregation.match(/sum/),this.formatValue(nPartsA[nI],this.nValueDecimals||(nPartsA[nI]<5?1:0),"ROUND")+this.szUnit),this.formatValue(nPartsA[nI],2)+this.szUnit+szLabel),donut.realize()}}else if(szFlag.match(/3D/)){var cColor=__maptheme_getChartColors(nColor);if(szFlag.match(/VOLUME/)&&lastHeight){var nDY=(nValue*nStep-lastHeight)/15;nPosY+=nDY;var szColor="white";szColor="#444444",szColor=lastColor.borderColor;var szFillColor=lastColor.mainColor,szFillOpacity=.3;lastHeight<nValue*nStep&&(szFillOpacity=.2),map.Dom.newShape("line",barShape,lastX+lastWidth,lastY-nDY,nPosX,nPosY-nDY,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(.25)+";"),map.Dom.newShape("line",barShape,lastX+lastWidth,lastY-lastHeight-nDY,nPosX,nPosY-nValue*nStep-nDY,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(.25)+";"),map.Dom.newShape("line",barShape,lastX+lastWidth+lastWidth/3,lastY-lastWidth/4-nDY,nPosX+nWidth/3,nPosY-nWidth/4-nDY,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(.25)+";"),map.Dom.newShape("line",barShape,lastX+lastWidth+lastWidth/3,lastY-lastHeight-lastWidth/4-nDY,nPosX+nWidth/3,nPosY-nValue*nStep-nWidth/4-nDY,"stroke:"+szColor+";stroke-width:"+map.Scale.normalX(.25)),map.Dom.newShape("path",barShape,"M"+(lastX+lastWidth)+","+(lastY-nDY)+" L "+nPosX+","+(nPosY-nDY)+" "+nPosX+","+(nPosY-nValue*nStep-nDY)+" "+(lastX+lastWidth)+","+(lastY-lastHeight-nDY)+" z","fill:"+szFillColor+";stroke:"+szColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+szFillOpacity),lastHeight-nValue*nStep>-nWidth/4&&map.Dom.newShape("path",barShape,"M"+(lastX+lastWidth)+","+(lastY-lastHeight-nDY)+" L "+nPosX+","+(nPosY-nValue*nStep-nDY)+" "+(nPosX+nWidth/3)+","+(nPosY-nValue*nStep-nWidth/4-nDY)+" "+(lastX+lastWidth+lastWidth/3)+","+(lastY-lastHeight-lastWidth/4-nDY)+" z","fill:"+szFillColor+";stroke:"+szColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:"+szFillOpacity)}if(lastHeight=nValue*nStep,lastX=nPosX,lastY=nPosY,lastWidth=nWidth,lastColor=cColor,nnValue=this.nFilterA[nIndex],nnValue){var tmpStyle="fill:#FFFFFF;stroke:gray;stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.1;stroke-opacity:0.1";map.Dom.newShape("path",barShape,"M"+nPosX+",0 l "+nWidth+",0 "+nWidth/3+","+-nWidth/4+" "+-nWidth+" 0 z",tmpStyle),map.Dom.newShape("rect",barShape,nPosX+nWidth/3,-nnValue*nStep/nCenter-nWidth/4,nWidth,nnValue*nStep,tmpStyle),map.Dom.newShape("path",barShape,"M"+nPosX+",0 l 0,"+-nnValue*nStep/nCenter+" "+nWidth/3+","+-nWidth/4+" 0,"+nnValue*nStep+" z",tmpStyle),map.Dom.newShape("rect",barShape,nPosX,-nnValue*nStep/nCenter,nWidth,nnValue*nStep,tmpStyle),map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth)+",0 l 0,"+-nnValue*nStep/nCenter+" "+nWidth/3+","+-nWidth/4+" 0,"+nnValue*nStep+" z",tmpStyle),cColor.highColor=ColorScheme.getDerivateColor(nColor,.9)}if(nPosY<=0||szFlag.match(/LEFT/)||szFlag.match(/VOLUME/)){nValue&&(0===nValue&&(cColor=__maptheme_getChartColors("none")),map.Dom.newShape("rect",barShape,nPosX,-nValue*nStep/nCenter,nWidth,nValue*nStep,"fill:"+cColor.mainColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:0.3"),map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth)+",0 l 0,"+-nValue*nStep/nCenter+" "+nWidth/3+","+-nWidth/4+" 0,"+nValue*nStep+" z","fill:"+cColor.lowColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)),cColor.highColor=ColorScheme.getDerivateColor(nColor,.9));var strokeOpacity=1;map.Dom.newShape("path",barShape,"M"+nPosX+","+-nValue*nStep/nCenter+" l "+nWidth+",0 "+nWidth/3+","+-nWidth/4+" "+-nWidth+" 0 z","fill:"+cColor.highColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";stroke-opacity:"+strokeOpacity)}else map.Dom.newShape("path",barShape,"M"+nPosX+",0 l "+nWidth+",0 "+nWidth/3+","+-nWidth/4+" "+-nWidth+" 0 z","fill:"+cColor.highColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.2"),map.Dom.newShape("rect",barShape,nPosX+nWidth/3,-nValue*nStep/nCenter-nWidth/4,nWidth,nValue*nStep,"fill:"+cColor.mainColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",barShape,"M"+nPosX+",0 l 0,"+-nValue*nStep/nCenter+" "+nWidth/3+","+-nWidth/4+" 0,"+nValue*nStep+" z","fill:"+cColor.lowColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),cColor.highColor=ColorScheme.getDerivateColor(nColor,.9),map.Dom.newShape("rect",barShape,nPosX,-nValue*nStep/nCenter,nWidth,nValue*nStep,"fill:"+cColor.mainColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth)+",0 l 0,"+-nValue*nStep/nCenter+" "+nWidth/3+","+-nWidth/4+" 0,"+nValue*nStep+" z","fill:"+cColor.lowColor+";stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.4"),cColor.highColor=ColorScheme.getDerivateColor(nColor,.9);nnValue&&(map.Dom.newShape("rect",barShape,nPosX,-nnValue*nStep/nCenter,nWidth,nnValue*nStep,"fill:#FFFFFF;stroke:none;stroke-width:"+map.Scale.normalX(.05)+";fill-opacity:0.25"),nnValue>nValue?map.Dom.newShape("path",barShape,"M"+nPosX+","+-nnValue*nStep/nCenter+" l "+nWidth+",0 "+nWidth/3+","+-nWidth/4+" "+-nWidth+" 0 z","fill:#8888FF;stroke:#444488;stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.2"):map.Dom.newShape("path",barShape,"M"+nPosX+","+-nnValue*nStep/nCenter+" l "+nWidth+",0 "+nWidth/3+","+-nWidth/4+" "+-nWidth+" 0 z","fill:#8888FF;stroke:"+cColor.borderColor+";stroke-width:"+map.Scale.normalX(.1)+";fill-opacity:0.1;stroke-opacity:0.4"))}else if(szFlag.match(/Border/)){map.Dom.newShape("rect",barShape,nPosX,-nValue*nStep/nCenter,nWidth,nValue*nStep,"fill:"+nColor+";stroke:none;");var nOff=2,x1=nPosX+nOff,x2=nPosX+nWidth-nOff,y1=nOff-nValue*nStep/nCenter,y2=y1+nValue*nStep-nOff,cColor=__maptheme_getChartColors(nColor);map.Dom.newShape("line",barShape,x1,y1,x1,y2,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0"),map.Dom.newShape("line",barShape,x1,y1,x2,y1,"stroke:white;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:1.0"),map.Dom.newShape("line",barShape,x1,y2,x2,y2,"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9"),map.Dom.newShape("line",barShape,x2,y1,x2,y2,"stroke:black;stroke-width:"+map.Scale.normalX(.001)+";stroke-opacity:0.9")}else if(szFlag.match(/POINTER/)&&nValue){(szFlag.match(/OFFSETMEAN/)||szFlag.match(/OFFSETMEDIAN/)||szFlag.match(/DEVIATION/))&&Math.abs(nValue*nStep)>1e3&&(nStep=(1e3+(Math.abs(nValue*nStep)-1e3)/10+Math.abs(nValue*nStep)%1e3)/Math.abs(nValue));var szStyle="fill:"+nColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-opacity:0.5;stroke-width:"+map.Scale.normalX(this.nLineWidth)*Math.sqrt(nSizer||1);if(nPosY<=0)if(!this.fShadow&&this.fOrigShadow&&map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth/7+10)+","+(-nValue*nStep/nCenter+10)+" l "+-nWidth/7+",0 0,"+-nWidth/15+" "+nWidth/2+","+-nWidth/3+" "+nWidth/2+","+nWidth/3+" 0,"+nWidth/15+" "+-nWidth/7+",0 0,"+nValue*nStep+" "+5*-nWidth/7+",0 z","fill:000000;fill-opacity:0.5;stroke:none;"),szFlag.match(/SMALLARROW/)){var arrow=map.Dom.newShape("path",barShape,"m "+(nPosX+10*nSizer)+",-230.68306 49.394,-49.394 v 263.787999 c 0,8.2839998 6.716001,14.9999998 15.000001,14.9999998 8.284001,0 15.000001,-6.716 15.000001,-14.9999998 V -280.07706 l 49.394,49.394 c 2.928,2.929 6.767,4.394 10.606,4.394 3.839,0 7.678,-1.465 10.606,-4.394 5.858,-5.857 5.858,-15.355 0,-21.213 l -75,-75 c -5.857001,-5.858 -15.355001,-5.858 -21.213001,0 l -75.0000008,75 c -5.85799995,5.857 -5.85799995,15.355 0,21.213 5.8579998,5.857 15.3559998,5.857 21.2129998,0 z",szStyle);arrow.fu.setPosition(30+nValue*nStep/40,0),arrow.fu.scale(nValue*nStep/250,nValue*nStep/220)}else szFlag.match(/ARROW/)?map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth/3)+","+-nValue*nStep*.9/nCenter+" l "+-nWidth/3+",0 0,"+-nWidth/15+" "+nWidth/2+","+-nWidth/1.5+" "+nWidth/2+","+nWidth/1.5+" 0,"+nWidth/15+" "+-nWidth/3+",0 0,"+nValue*nStep*.9+" "+-nWidth/3+",0 z",szStyle):map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth/7)+","+-nValue*nStep/nCenter+" l "+-nWidth/7+",0 0,"+-nWidth/15+" "+nWidth/2+","+-nWidth/2+" "+nWidth/2+","+nWidth/2+" 0,"+nWidth/15+" "+-nWidth/7+",0 0,"+nValue*nStep+" "+5*-nWidth/7+",0 z",szStyle);else if(!szFlag.match(/NONEGATIVE/)){if(!szFlag.match(/LEFT/))if(szFlag.match(/ZOOM/)||szFlag.match(/NORMSIZE/))szStyle="fill:"+nColor+";stroke:"+nColor+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.5";else if(this.partsA.length>2){var cColor=__maptheme_getChartColors(nColor);szStyle="fill:"+nColor+";stroke:"+cColor.lowColor+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*nSizer||.25)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:0.8"}else{var cColor=__maptheme_getChartColors(nColor);szStyle="fill:"+nColor+";stroke:"+cColor.highColor+";stroke-width:"+map.Scale.normalX(this.nLineWidth)*Math.sqrt(nSizer||1)+";fill-opacity:"+(this.nFadeNegative||.1)+";stroke-opacity:1"}if(szFlag.match(/SMALLARROW/)){var arrow=map.Dom.newShape("path",barShape,"m 155.27191,-100.6065 -49.394,49.393999 V -315.0005 c 0,-8.284 -6.716003,-15 -15.000003,-15 -8.284,0 -15,6.716 -15,15 v 263.787999 l -49.394,-49.393999 c -2.928,-2.929 -6.767,-4.394 -10.606,-4.394 -3.839,0 -7.6779996,1.465 -10.6059996,4.394 -5.85799995,5.856999 -5.85799995,15.354999 0,21.212999 L 80.271907,-4.3935012 c 5.857,5.858 15.355,5.858 21.213003,0 l 75,-74.9999998 c 5.858,-5.857 5.858,-15.355 0,-21.212999 -5.858,-5.857 -15.356,-5.857 -21.213,0 z",szStyle);arrow.fu.setPosition(20+nValue/30,nValue/3),arrow.fu.scale(nValue*nStep/250,nValue*nStep/220)}else szFlag.match(/ARROW/)?map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth/3)+","+-nValue*nStep/nCenter+" l "+nWidth/3+",0 0,"+nValue*nStep+" "+nWidth/3+",0 "+-nWidth/2+","+nWidth/2+" "+-nWidth/2+","+-nWidth/2+" "+nWidth/3+",0 z",szStyle):map.Dom.newShape("path",barShape,"M"+(nPosX+nWidth/7)+","+-nValue*nStep/nCenter+" l "+5*nWidth/7+",0 0,"+nValue*nStep+" "+nWidth/7+",0 "+-nWidth/2+","+nWidth/4+" "+-nWidth/2+","+-nWidth/4+" "+nWidth/7+",0 z",szStyle)}}else if(szFlag.match(/DOTTED/))if(nMax<1e3){0==nPosY&&map.Dom.newShape("rect",barShape,nPosX,0,nWidth,2,"fill:none;stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*nSizer||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1));var nRad=.8*nWidth;nStep=nRad,nGridX=Math.min(5,Math.ceil(nMax/20)),nRad/=nGridX,nStep=nRad/nGridX;for(var r=0;r<nValue;r++)map.Dom.newShape("circle",barShape,nPosX+nRad/2+nRad*(r%nGridX),-nRad*Math.floor(r/nGridX)-nRad/2,nRad/2.2,"fill:"+nColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*nSizer||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1));nValue=Math.ceil(nValue/nGridX)*nGridX+(nValue?.5:0)}else szFlag.match(/NOZERO/)||(nValue=nValue||1e-5),nPosY<=0||szFlag.match(/LEFT/)?map.Dom.newShape("rect",barShape,nPosX,-nValue*nStep/nCenter,nWidth,nValue*nStep,"fill:"+nColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*nSizer||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1)):map.Dom.newShape("rect",barShape,nPosX,-nValue*nStep/nCenter,nWidth,nValue*nStep,"fill:"+nColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+nColor+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.3"),nnValue=this.nFilterA[nIndex],nnValue&&(nPosY<=0||szFlag.match(/LEFT/)?map.Dom.newShape("rect",barShape,nPosX,-nnValue*nStep/nCenter,nWidth,nnValue*nStep,"fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.1"):map.Dom.newShape("rect",barShape,nPosX,-nnValue*nStep/nCenter,nWidth,nnValue*nStep,"fill:none;stroke:"+nColor+";stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.3"));else szFlag.match(/NOZERO/)||(nValue=nValue||1e-5),nPosY<=0||szFlag.match(/LEFT/)?map.Dom.newShape("rect",barShape,nPosX,-nValue*nStep/nCenter,nWidth,nValue*nStep,"fill:"+nColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+(this.szLineColor||"black")+";stroke-width:"+map.Scale.normalX(.25*this.nLineWidth*nSizer||.2)+";stroke-opacity:"+(this.nLineWidth?1:.1)):map.Dom.newShape("rect",barShape,nPosX,-nValue*nStep/nCenter,nWidth,nValue*nStep,"fill:"+nColor+";fill-opacity:"+(this.fillOpacity||1)+";stroke:"+nColor+";stroke-width:"+map.Scale.normalX(.25)+";fill-opacity:0.3"),nnValue=this.nFilterA[nIndex],nnValue&&(nPosY<=0||szFlag.match(/LEFT/)?map.Dom.newShape("rect",barShape,nPosX,-nnValue*nStep/nCenter,nWidth,nnValue*nStep,"fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.5)+";stroke-opacity:0.1"):map.Dom.newShape("rect",barShape,nPosX,-nnValue*nStep/nCenter,nWidth,nnValue*nStep,"fill:none;stroke:"+nColor+";stroke-width:"+map.Scale.normalX(.5)+";fill-opacity:0.3"));if((szFlag.match(/VALUES/)||this.szXaxisA)&&!(nPosY>0&&szFlag.match(/NONEGATIVE/))&&(szFlag.match(/ZOOM/)||!this.fHideValues)){if(nValue||(nValue=0),szFlag.match(/AXIS/)&&(this.szLabelA||this.szXaxisA)){var xi=nIndex/(this.nGridX||1),szAxisText=(this.szXaxisA?this.szXaxisA[xi]:this.szLabelA?this.szLabelA[xi]:" ")||" ",nAxisTextSize=.5*nWidth;szFlag.match(/\bUP\b/)&&(nAxisTextSize=.6*nWidth),szFlag.match(/\bHORZ\b/)&&(nAxisTextSize=.7*nWidth);var newText=map.Dom.newText(barShape,0,0,szTextStyle+";fill:#888888;text-anchor:end;font-size:"+nAxisTextSize+"px"," "+szAxisText+" "),ptPos=new point(map.Scale.normalX(.8),nWidth/2+nTextSize/5*2);this.fNegativeValues?newText.setAttributeNS(null,"transform","translate("+(nPosX+ptPos.y)+","+(-ptPos.x+.9*nTextSize+10)+") rotate(270)"):szFlag.match(/CENTER/)?newText.setAttributeNS(null,"transform","translate("+(nPosX+ptPos.y)+","+(map.Scale.normalX(nChartSize/2)+.9*nTextSize)+") rotate(270)"):szFlag.match(/HORZ/)?newText.setAttributeNS(null,"transform","translate("+(nPosX+ptPos.y)+","+(-ptPos.x+.9*nTextSize+5)+") rotate(270)"):(newText.style.setProperty("text-anchor","end",""),1==nPartsA.length?newText.setAttributeNS(null,"transform","translate("+(nPosX+(szFlag.match(/VOLUME/)?1.3*nWidth:1.5*ptPos.y))+","+-ptPos.x+") "):szAxisText.length>1?newText.setAttributeNS(null,"transform","translate("+(nPosX+.66*ptPos.y)+","+(.66*nTextSize+10)+") rotate(315)"):newText.setAttributeNS(null,"transform","translate("+(nPosX+.1*ptPos.y)+","+(-ptPos.x+nTextSize)+")"))}if(szFlag.match(/VALUES/)&&nTextSize>0&&!(this.nGridX&&this.partsA.length/this.nGridX>2)){var szText=this.formatValue(nTextValue,this.nValueDecimals||(this.nMax<=1?1:0));szFlag.match(/POINTER/)&&nTextValue>0&&(this.nMin<0||szFlag.match(/OFFSETMEAN/)||szFlag.match(/OFFSETMEDIAN/)||this.szFlag.match(/\bSIGN\b/))&&(szText="+"+szText),szFlag.match(/VOLUME/)||(szText+=this.szUnit?" "+this.szUnit+" ":""),!szFlag.match(/STACKED/)||0===nTextValue||nValue100||this.nGridX||(szText=szText+" ("+Math.round(nTextValue/nMySum*100)+"%)"),szFlag.match(/STACKED/)&&(nTextSize=szFlag.match(/ZOOM/)?map.Scale.normalX(18):map.Scale.normalX(5),nTextSize*=this.nValueScale||1);var nTextLen=szText.length*nTextSize*4/8,newText=this.createTextLabel(SVGDocument,barShape,"",szText,nTextSize/map.Scale.normalX(1),null,nTextValue>0&&(szFlag.match(/CTEXT/)||szFlag.match(/VALUEBACKGROUND/))?nColor:null,parseFloat(szText)<0?this.szValueColor||"red":this.szTextColor);newText.style.setProperty("opacity",String(nTextOpacity),"");var newTextBg=null,newUnitText=null,newXaxisText=null;if(this.szXaxisA&&szFlag.match(/CATEGORICAL/)&&!szFlag.match(/AXIS/))var newXaxisText=map.Dom.newTSpan(newText,"fill:fill:#444444;font-size:"+nTextSize+"px"," "+this.szXaxisA[i]);var tLen=newText.fu.getBox().width,ptPos=new point(map.Scale.normalX(-4),nWidth/2+.15*nTextSize),fTextInside=!0;if(szFlag.match(/DOINLINETEXT/)&&!szFlag.match(/ZOOM/)&&!szFlag.match(/NORMSIZE/)||!szFlag.match(/VALUE/)||szFlag.match(/VOLUME/)&&!szFlag.match(/ZOOM/)||!(szFlag.match(/THIN/)||szFlag.match(/NOINLINETEXT/)||szFlag.match(/DTEXT/)||szFlag.match(/SIZE/)||tLen+map.Scale.normalX(1)>nValue*nStep/nCenter||szFlag.match(/STACKED/)||szFlag.match(/NORMSIZE/)||szFlag.match(/ZOOM/))){var cColor=__maptheme_getChartColors(nColor);newText.removeChild(newText.firstChild),newText.firstChild.style.setProperty("fill",cColor.textColor,""),newUnitText&&newUnitText.style.setProperty("fill",cColor.textColor,""),newXaxisText&&newXaxisText.style.setProperty("fill",cColor.textColor,""),newTextBg&&newTextBg.parentNode.removeChild(newTextBg);var dX=map.Scale.normalX(0),dY=map.Scale.normalY(.5);szFlag.match(/VOLUME/)?(nScale=nValue*nStep/(tLen+map.Scale.normalX(2)),newText.parentNode.removeChild(newText),newText=map.Dom.newText(barShape,nPosX+nValue*nStep/2,nTextSize*nScale/4-nValue*nStep/2,"font-family:arial;font-size:"+nTextSize*nScale+"px;text-anchor:middle;fill:"+cColor.textColor+";opacity:"+nOpacity+";stroke:none;pointer-events:none",szText)):(nScale=Math.min(1,nValue*nStep/tLen),nScale<.33?newText.parentNode.removeChild(newText):(nTextValue>0&&(ptPos.x+=Math.max(map.Scale.normalX(1),nValue*nStep-(tLen+map.Scale.normalX(3))*nScale)),dY/=nScale,newText.firstChild.style.setProperty("font-size",String(nTextSize*nScale)),newText.firstChild.setAttributeNS(null,"transform","translate("+(nPosX+ptPos.y-dY)+","+(-ptPos.x-dX)+") rotate(270)\t"))),minNextTextPos.x=Math.max(0,minNextTextPos.x-nValue*nStep)}else if(fTextInside=!1,szFlag.match(/STACKED/))if(0!==nValue||szFlag.match(/ZEROISVALUE/))if(this.nGridX&&nPartsA.length/this.nGridX>2)newText.parentNode.removeChild(newText);else{ptPos.x=0,szFlag.match(/3D/)&&(ptPos.x+=nWidth/4,ptPos.y+=nWidth/3);var nTopDx=nValue*nStep/(szFlag.match(/SUM/),2);minNextTextPos.x=Math.max(0,minNextTextPos.x+(.75*nTextSize-nTopDx));var ptTextPos=new point(minNextTextPos.x+ptPos.x+nTopDx-nTextSize/3,0),nIndent=map.Scale.normalX(.5)*nSizer,nXPos1=nPosX+ptPos.y+nWidth/3,nXPos2=nPosX+ptPos.y+7*nWidth/8,nYPos1=-ptPos.x-nTopDx,nYPos2=-ptTextPos.x-nTextSize/3;if(this.nGridX&&nBarsDrawn<this.nGridX){ptPos.y-=2*nWidth+newText.fu.getBox().width;var nTemp=nXPos2;nXPos2=nXPos1-(szFlag.match(/3D/)?1.5*nWidth:1.4*nWidth),nXPos1=nTemp-(szFlag.match(/3D/)?7*nWidth/4:1.4*nWidth),szFlag.match(/3D/)&&(nYPos1+=nWidth/5,nYPos2+=nWidth/5,ptTextPos.x-=nWidth/7),nIndent=-nIndent}newText.setAttributeNS(null,"transform","translate("+(nPosX+ptPos.y+nWidth+nIndent-nTextSize)+","+(-ptTextPos.x-.25*nTextSize)+") ");var linebgGroup=map.Dom.newGroup(barShape,""),lineGroup=map.Dom.newGroup(barShape,"");map.Dom.newShape("line",linebgGroup,nXPos1,nYPos1,nXPos1+nIndent,nYPos1,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;"),map.Dom.newShape("line",lineGroup,nXPos1,nYPos1,nXPos1+nIndent,nYPos1,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;"),map.Dom.newShape("line",linebgGroup,nXPos1+nIndent,nYPos1,nXPos2,nYPos2,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;stroke-linecap:round;"),map.Dom.newShape("line",lineGroup,nXPos1+nIndent,nYPos1,nXPos2,nYPos2,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;"),map.Dom.newShape("line",linebgGroup,nXPos2,nYPos2,nXPos2+nIndent,nYPos2,"stroke-width:"+map.Scale.normalX(.15)+";stroke:white;opacity:0.2;"),map.Dom.newShape("line",lineGroup,nXPos2,nYPos2,nXPos2+nIndent,nYPos2,"stroke-width:"+map.Scale.normalX(.05)+";stroke:#888888;"),minNextTextPos.x=Math.max(0,minNextTextPos.x+(2*nTextSize/3-(nValue*nStep-nTopDx)))}else newText.parentNode.removeChild(newText);else{ptPos.x+=nWidth/4,szFlag.match(/3D/)&&(ptPos.x+=nWidth/4,ptPos.y=.3*nWidth+nTextSize/2),szFlag.match(/POINTER/)&&nTextValue>0&&(ptPos.x+=.25*nWidth);var xValue=nValue;if(tLen+map.Scale.normalX(1)>(nnValue-nValue)*nStep/nCenter&&(xValue=Math.max(nValue,nnValue),nnValue>nValue&&(xValue+=nWidth/nStep*.2,map.Dom.newShape("line",barShape,nPosX+.6*nWidth,-ptPos.x-nValue*nStep/nCenter+nWidth/3,nPosX+.6*nWidth,-ptPos.x-nnValue*nStep/nCenter-.4*nWidth,"stroke:white;"))),szFlag.match(/VOLUME/)&&(xValue+=nWidth/5),1!=nPartsA.length||szFlag.match(/HORZ/)||szFlag.match(/VOLUME/))szFlag.match(/VOLUME/)?newText.setAttributeNS(null,"transform","translate("+(nPosX+ptPos.y)+","+(-ptPos.x-xValue*nStep/nCenter)+")  scale(0.9,0.9)"):newText.setAttributeNS(null,"transform","translate("+(nPosX+ptPos.y)+","+(-10-.25*nWidth-xValue*nStep/nCenter)+") rotate(270) scale(0.9,0.9)");else{if(szFlag.match(/ZOOM/)||szFlag.match(/NORMSIZE/)){ptPos.y+=szFlag.match(/3D/)?.75*nWidth:.5*nWidth;var dy=Math.min(0,.55*nTextSize-nValue*nStep),dx=nTextSize;!szFlag.match(/3D/)&&!szFlag.match(/ZOOM/)||szFlag.match(/SIZE/)||(dx=0),newText.setAttributeNS(null,"transform","translate("+(nPosX+dx)+","+(dy-.5*nTextSize)+")")}else ptPos.y+=szFlag.match(/3D/)?szFlag.match(/VOLUME/)?.75*nWidth:.6*nWidth:.2*nWidth,newText.setAttributeNS(null,"transform","translate("+(nPosX-.8*nWidth)+","+(-xValue*nStep/nCenter-.8*nTextSize-(szFlag.match(/POINTER/)&&nTextValue>0?.5*nWidth:0))+")");nTextValue<0&&newText.style.setProperty("opacity",String(.75*nTextOpacity),"")}newText.style.setProperty("fill","#404040","")}}}if(null!=nMark&&i==nMark){var nSize=2*nTextSize,cColor=__maptheme_getChartColors(nColor),newPath;newPath=map.Dom.newShape("path",barShape,"M5,0 l 35,-45 -25,0 0,-30 -20,0 0,30 -25,0 35,45","fill:#404040;stroke:white;stroke-width:"+map.Scale.normalX(.2)),newPath.fu.setPosition(i*(nWidth+1.5)+.5*nWidth,-nValue*nStep+(fTextInside?-map.Scale.normalX(3):-tLen-map.Scale.normalX(12)))}if(szFlag.match(/TRENDLINE/)){var dY=Math.min(nValue*nStep/2,map.Scale.normalY(1.5)),cColor=__maptheme_getChartColors(nColor),szColor=cColor.lowColor,nSize=nTextSize/5;if(i>0){var x1=(i-1)*(nWidth+(szFlag.match(/SPACED/)?nWidth/5:1))+nWidth/2,x2=i*(nWidth+(szFlag.match(/SPACED/)?nWidth/5:1))+nWidth/2;szColor="white",szColor=lastValue>nValue?"#CC3333":lastValue<nValue?"#22BB22":cColor.lowColor,map.Dom.newShape("line",barShape,x1,-lastValue*nStep+dY,x2,-nValue*nStep+dY,"stroke:#666666;stroke-width:"+map.Scale.normalX(1/nPartsA.length*1.2)+";opacity:0.8")}var newSpot=map.Dom.newShape("circle",barShape,0,0,nSize,"fill:"+szColor+";stroke:none;opacity:0.8");newSpot&&newSpot.fu.setPosition(i*(nWidth+(szFlag.match(/SPACED/)?nWidth/5:0))+nWidth/2,-nValue*nStep+dY)}if(!szFlag.match(/SILENT/))if(this.szFlag.match(/SEQUENCE/))barShape.setAttributeNS(szMapNs,"tooltip",szValue+" ("+(this.szLabelA?this.szLabelA[nClass]:"")+") ["+this.szFieldsA[nIndex]+"]");else{var szLabel=this.szFieldsA[nIndex];this.szLabelA&&this.szLabelA[nIndex]&&(szLabel=this.szLabelA[nIndex]),szValue+=this.szUnit?" ["+this.szUnit+"]":"",nMySum&&!this.nGridX&&(!this.szField100||this.szFlag.match(/FRACTION/)),barShape.setAttributeNS(szMapNs,"tooltip",szValue+" '"+szLabel+"'")}if(szFlag.match(/FADEIN/))if(2==nPartsA.length&&0===i)barShape.style.setProperty("opacity",String(.6),"");else if(!szFlag.match(/NORMSIZE/)){var nPow=szFlag.match(/FADEINP4/)?10:3;barShape.style.setProperty("opacity",String(.1+.9*Math.pow(i+1,nPow)/Math.pow(nPartsA.length,nPow)),"")}szFlag.match(/FADENEGATIVE/)&&nTextValue<0&&barShape.style.setProperty("opacity",String(.5),""),barShape.setAttributeNS(szMapNs,"class",String(nClass)),barShape.fu.setPosition(0,nPosY),szFlag.match(/STACKED/)?szFlag.match(/CENTER/)||(nPosY-=nValue*nStep):(nPosY=0,nPosX+=nWidth,szFlag.match(/VOLUME/)&&szFlag.match(/SPACED/)?nPosX+=nWidth/(2==nPartsA.length?2:4):szFlag.match(/SPACED/)?nPosX+=nWidth/5:szFlag.match(/\bUP\b/)||(nPosX+=1)),nBarsDrawn++,szFlag.match(/STACKED/)&&!szFlag.match(/MULTI/)&&this.nGridX&&nBarsDrawn%this.nGridX==0&&(nPosY=0,nPosX+=nWidth+nWidth/20),lastValue=nValue}}szFlag.match(/HOR/)&&barGroup.setAttributeNS(null,"transform","rotate(90) translate("+-nPosX+",0)"),szFlag.match(/DIAGLEFT/)&&barGroup.setAttributeNS(null,"transform","rotate(315) translate("+-nPosX+",0)"),szFlag.match(/DIAGRIGHT/)&&barGroup.setAttributeNS(null,"transform","rotate(45) translate("+-nPosX+",0)"),ptNull.y=0,ptNull.x=0,szFlag.match(/HOR/)?(ptNull.y-=1*nWidth/2,szFlag.match(/3D/)&&(ptNull.y-=1*nWidth/3)):szFlag.match(/STACKED/)?ptNull.x=nWidth/2:szFlag.match(/Up/)||szFlag.match(/HOR/)?ptNull.x=0:ptNull.x=nWidth*nBarsDrawn/2,szFlag.match(/MENUSIZE/)&&(ptNull.x+=nWidth*(szFlag.match(/HORZ/)?1:0),ptNull.y+=nWidth*(szFlag.match(/HORZ/)?.3:0),ptNull.y+=nWidth*(szFlag.match(/HORZ/)&&szFlag.match(/3D/)?1:szFlag.match(/VOLUME/)?.3:.6)),this.nRealizedCount++;var barPositionGroup=map.Dom.newGroup(shapeGroup,"");if(barPositionGroup.appendChild(barGroup),szFlag.match(/ZOOM/)){var nScale=240/nTextSize/(nPartsA.length>1?2:1);barPositionGroup.fu.scale(nScale,nScale)}barPositionGroup.fu.setPosition(shapeGroup.fu.getPosition().x-ptNull.x,-ptNull.y),ptNull.x=0,ptNull.y=0,szFlag.match(/HOR/)&&(ptNull.y=1*nWidth/2)}if(szFlag.match(/EXTEND/)&&HTMLWindow.ixmaps.htmlgui_drawChartAfter)try{var objTheme=this.objThemesA[this.szThemesA[0]];HTMLWindow.ixmaps.htmlgui_drawChartAfter(SVGDocument,{target:shapeGroup,theme:this,item:a,values:nPartsA,maxSize:nChartSize,flag:szFlag,mark:nMark,dbRecord:objTheme.dbRecords?objTheme.dbRecords[this.itemA[a].dbIndex]:null})}catch(e){}if(!szFlag.match(/NORMSIZE/)){var ptNullOrig=new point(ptNull.x,ptNull.y);szFlag.match(/PLOT/)?(ptNull.x=map.Scale.normalX(this.nOffsetX||0),ptNull.y=map.Scale.normalY(-this.nOffsetY||0)):(ptNull.x=map.Scale.normalX(this.nOffsetX||0)*(this.nSymbolScale||1),ptNull.y=map.Scale.normalY(-this.nOffsetY||0)*(this.nSymbolScale||1)),this.szAlign&&(szFlag.match(/PLOT/)&&!szFlag.match(/ZOOM/)?(this.szAlign.match(/center/)&&(ptNull.x=map.Scale.normalX(nChartSize/2*nPartsA.length/(this.nGridX||1)),this.szAlign.match(/top/)||(ptNull.y=-map.Scale.normalX(nChartSize/2*nPartsA.length/(this.nGridX||1)))),this.szAlign.match(/right/)&&(ptNull.x=map.Scale.normalX(nChartSize*nPartsA.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&(ptNull.x=map.Scale.normalX(.66*nChartSize*nPartsA.length/(this.nGridX||1))),this.szAlign.match(/10\%right/)&&(ptNull.x=map.Scale.normalX(.9*nChartSize*nPartsA.length/(this.nGridX||1))),this.szAlign.match(/10\%left/)&&(ptNull.x=map.Scale.normalX(.1*nChartSize*nPartsA.length/(this.nGridX||1))),this.szAlign.match(/23left/)&&(ptNull.x=map.Scale.normalX(.33*nChartSize*nPartsA.length/(this.nGridX||1)))):this.nGridX&&!szFlag.match(/ZOOM/)?(this.szAlign.match(/center/)&&(ptNull.x=map.Scale.normalX(nChartSize/2/this.partsA.length*nPartsA.length/(this.nGridX||1))),this.szAlign.match(/right/)&&(ptNull.x=map.Scale.normalX(nChartSize/this.partsA.length*nPartsA.length/(this.nGridX||1))),this.szAlign.match(/23right/)&&(ptNull.x=map.Scale.normalX(nChartSize/this.partsA.length*.66*nPartsA.length/(this.nGridX||1)))):(this.szAlign.match(/center/)&&(ptNull.y=0),this.szAlign.match(/bottom/)&&(ptNull.y=ptNullOrig.y?ptNullOrig.y:map.Scale.normalX(nChartSize/5)),this.szAlign.match(/above/)&&(ptNull.y=ptNullOrig.y?ptNullOrig.y:map.Scale.normalX(nChartSize/2)),this.szAlign.match(/2above/)&&(ptNull.y+=map.Scale.normalX(nChartSize/2)),this.szAlign.match(/below/)&&(ptNull.y=-(ptNullOrig.y?ptNullOrig.y:map.Scale.normalX(nChartSize/2))),this.szAlign.match(/2below/)&&(ptNull.y-=map.Scale.normalX(nChartSize/2)),this.szAlign.match(/top/)&&(ptNull.y=-(ptNullOrig.y?ptNullOrig.y:map.Scale.normalX(nChartSize/2))),this.szAlign.match(/left/)&&(ptNull.x=-(ptNullOrig.y?ptNullOrig.y:map.Scale.normalX(nChartSize/2))),this.szAlign.match(/2left/)&&(ptNull.x-=map.Scale.normalX(nChartSize/2)),this.szAlign.match(/right/)&&(ptNull.x=ptNullOrig.y?ptNullOrig.y:map.Scale.normalX(nChartSize/2)),this.szAlign.match(/2right/)&&(ptNull.x+=map.Scale.normalX(nChartSize/2)),this.szAlign.match(/23right/)&&(ptNull.x=map.Scale.normalX(nChartSize/3)),this.szAlign.match(/baseline/)&&(ptNull.y+=map.Scale.normalY(nChartSize/5))))}if(a&&this.szLabelField&&!szFlag.match(/NORMSIZE/)&&!szFlag.match(/ZOOM/)&&(!this.nLabelUpper||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nLabelUpper)&&(!this.nLabelLower||map.Scale.nTrueMapScale*map.Scale.nZoomScale<=this.nLabelLower)){var szLabel=this.itemA[a].szLabel;szLabel?isNaN(__scanValue(szLabel))?szLabel+=this.szLabelUnits||"":szLabel=this.formatValue(__scanValue(szLabel),this.nValueDecimals||2)+(this.szLabelUnits||""):szLabel=this.szLabelField+"?";var nTextSize=map.Scale.normalX(5)*(this.nTextScale||1),szTextStyle="opacity:0.7;font-family:arial;font-size:"+nTextSize+"px;text-anchor:middle;fill:#000000;pointer-events:none",szBgStyle="opacity:1;fill:white;fill-opacity:0.4;stroke:#000000;stroke-width:"+map.Scale.normalX(1)+"pointer-events:none;",nTextLen=(szLabel.length+2)*nTextSize*.5,labelGroup=map.Dom.newGroup(shapeGroup,"");labelGroup.parentNode.append(labelGroup),szFlag.match(/MULTI/)?szTextStyle+=";fill:#444444;text-anchor:start;":labelGroup.setAttributeNS(szMapNs,"class",String(nClass));var newBg=map.Dom.newShape("rect",labelGroup,-nTextLen/2,.95*-nTextSize,nTextLen,1.2*nTextSize,szBgStyle);newBg.setAttributeNS(null,"rx",.2*nTextSize),newBg.setAttributeNS(null,"ry",.2*nTextSize);var newText=map.Dom.newText(labelGroup,0,0,szTextStyle,szLabel),bBox=newText.fu.getBox(),nWidth=Math.max(bBox.width,nTextLen);if(newBg.setAttributeNS(null,"x",-nWidth/2),newBg.setAttributeNS(null,"width",nWidth),szFlag.match(/MULTI/)?(labelGroup.fu.setPosition(map.Scale.normalX(.8*nChartSize),.77*nTextSize),labelGroup.fu.scale(2,2),newBg.parentNode.removeChild(newBg)):labelGroup.fu.setPosition(nWidth/3,nTextSize/3+ptNullOrig.y),this.itemA[a].labelGroup=labelGroup,this.szTimeField){var uTime=new Date(this.itemA[a].szTime).getTime()||this.itemA[a].szTime;labelGroup.setAttributeNS(szMapNs,"time",uTime)}}if(szFlag.match(/MENU/)){var box=shapeGroup.fu.getBox();shapeGroup.fu.setPosition(-box.x-box.width/2,-box.y-box.height/2-map.Scale.normalY(nChartSize/2)-map.Scale.normalY(2))}else szFlag.match(/ZOOM/)||(shapeGroup.fu.setPosition(shapeGroup.fu.getPosition().x-ptNull.x,shapeGroup.fu.getPosition().y-ptNull.y),gridGroup&&gridGroup.fu.setPosition(gridGroup.fu.getPosition().x-ptNull.x,gridGroup.fu.getPosition().y-ptNull.y));return this.nRotation&&shapeGroup.fu.rotateBy(this.nRotation),ptNull.x=0,ptNull.y=0,a&&(this.itemA[a].fDone=!0),ptNull},MapTheme.prototype.getShapes=function(){var e=map.Layer.getLayerObj(this.szThemesA[0]);if(e&&e.szFlag.match(/tiled/))_TRACE("== done === ");else{for(var t in _TRACE("== MapTheme.getShapes() ===> "),this.itemA)this.parent.themeNodesA[t]||(this.parent.themeNodesA[t]=this.getShapeA(t));_TRACE("== done === ")}},MapTheme.prototype.getItemNodes=function(e){return this.parent.themeNodesA[e]&&this.parent.themeNodesA[e].length||(this.parent.themeNodesA[e]=this.getShapeA(e)),this.parent.themeNodesA[e]||[]},MapTheme.prototype.getShapeA=function(e){if(e=__mpap_decode_utf8(e),s=SVGDocument.getElementById(e.trim()))return new Array(s);if(e.match(/\,/))for(var t=e.split("::"),i=t[0].split(","),a=0;a<i.length;a++){var s;if(s=SVGDocument.getElementById((i[a]+"::"+t[1]).trim()))return new Array(s)}return this.nMissingLookupCount++,this.missedA[e]=e,[]},MapTheme.prototype.getPositions=function(){for(var e in _TRACE("== MapTheme.getPositions() ===> "),this.itemA)this.getNodePosition(this.itemA[e].szSelectionId);_TRACE("== done === ")},MapTheme.prototype.getNodePosition=function(e){if(void 0===e)return null;if(map.Themes.themeNodesPosA[e])return map.Themes.themeNodesPosA[e];var t=this.themeNodesPosA;if(!t[e]){if(e.match(/:clone/))return null;if(e.match(/(-?[0-9\.]+) ?, ?(-?[0-9\.]+)/)){var i=this.getMapPosition(e);return t[e]=new point(i.x,i.y),t[e]}this.parent.themeNodesA[e]||(this.parent.themeNodesA[e]=this.getShapeA(e));var a=this.parent.themeNodesA[e][0];if(this.parent.themeNodesA[e].length>1)for(var s=parseFloat(a.getAttributeNS(szMapNs,"area")),n=1;n<this.parent.themeNodesA[e].length;n++){var l=this.parent.themeNodesA[e][n],h=parseFloat(l.getAttributeNS(szMapNs,"area"));h>s&&(s=h,a=l)}if(a){if(this.szShapeType.match(/line/)){if((m=a.getAttributeNS(szMapNs,"center"))&&m.length>2)var o=m.split(","),r=new box(Number(o[0].split(":")[1]),Number(o[1].split(":")[1]),0,0);else r=map.Dom.getBox(a);r=map.Dom.getBox(a)}else{var m;if(!(m=a.getAttributeNS(szMapNs,"center"))&&a.parentNode&&(m=a.parentNode.getAttributeNS(szMapNs,"center")),m&&m.length>2)o=m.split(","),r=new box(Number(o[0].split(":")[1]),Number(o[1].split(":")[1]),0,0);else r=map.Dom.getBox(a)}var p=map.Scale.getMapOffset(a);t[e]=new point(p.x+r.x+r.width/2,p.y+r.y+r.height/2);var c=getMatrix(a);c&&(t[e].x+=c[4],t[e].y+=c[5])}}return t[e]&&void 0!==t[e].x&&void 0!==t[e].y?t[e]:(this.missedA[e]=e,null)},MapTheme.prototype.getNodeBox=function(e){if(void 0===e)return null;if(!this.parent.themeNodesBoxA[e]){if(e.match(/:clone/))return null;this.parent.themeNodesA[e]||(this.parent.themeNodesA[e]=this.getShapeA(e));var t=this.parent.themeNodesA[e][0];if(this.parent.themeNodesA[e].length>1)for(var i=parseFloat(t.getAttributeNS(szMapNs,"area")),a=1;a<this.parent.themeNodesA[e].length;a++){var s=this.parent.themeNodesA[e][a],n=parseFloat(s.getAttributeNS(szMapNs,"area"));n>i&&(i=n,t=s)}if(t){var l=map.Dom.getBox(t),h=map.Scale.getMapOffset(t);this.parent.themeNodesBoxA[e]=new box(h.x+l.x,h.y+l.y,l.width,l.height)}}return this.parent.themeNodesBoxA[e]},MapTheme.prototype.getNodeArea=function(e){var t=this.getItemNodes(e)[0];return t?Number(t.getAttributeNS(szMapNs,"area"))/1e6:0};var positionRegExp=/(-?[0-9\.]+) ?[, ] ?(-?[0-9\.]+)/;function __sortYposUp(e,t){return e.y>t.y?1:-1}function __sortYposDown(e,t){return e.y<t.y?1:-1}MapTheme.prototype.getMapPosition=function(e){if(e){var t=null;if(e&&(t=e.match(positionRegExp)))return Math.abs(parseFloat(t[1]))>180||Math.abs(parseFloat(t[2]))>180?new point(0,0):map.Scale.getMapPositionOfLatLon(parseFloat(t[1]),parseFloat(t[2]))}return new point(0,0)},MapTheme.prototype.onClick=function(e){this.fRemove||(this.widgetNode&&this.enable(),this.fToFront=!0,executeWithMessage("map.Themes.execute()","... processing ..."),map.Themes.onclickInfo(e,this.szId))},MapTheme.prototype.showErrorInfo=function(){if(_TRACE("== MapTheme.showErrorInfo("+this.szId+")===> "),0!==this.nMissingPositionCount){var e=this.szId+":errordisplay:widget",t=map.Dictionary.getLocalText("Chart statistic"),i=new InfoContainer(SVGDocument,this.widgetNode,e+":movable",new point(map.Scale.normalX(0),map.Scale.normalX(0)),new point(-map.Scale.normalX(15),map.Scale.normalX(80)),"fixed",t),a=i.workspaceNode,s=new Array(map.Dictionary.getLocalText("total items"),map.Dictionary.getLocalText("charts drawn"),map.Dictionary.getLocalText("missing positions"),map.Dictionary.getLocalText("missing value match"),map.Dictionary.getLocalText("zero values"),String(this.nCount),String(this.nRealizedCount),String(this.nMissingPositionCount),String(this.nMissingRangeCount),String(this.nZeroValueCount)),n=map.Dom.newGroup(a,"");n.fu.setPosition(0,map.Scale.normalY(3));createTextGrid(SVGDocument,n,e+":textgrid",s,2);i.reformat()}},MapTheme.prototype.getDataGrid=function(e,t){if(this.szFlag.match(/AGGREGATE/)&&this.itemA[e].nCount>3)return null;var i=map.Themes.getDataRow(e,this);if(i&&i.length){for(var a=0;a<i.length;a++)i[a]=i[a]||"---";var s,n=new ScrollArea(null,t,null,10,10,10);n?(n.reformat(),s=n.workspaceNode):s=t;for(var l=[],h=map.Themes.getFieldIndexArray(this),o=0;o<h.length;o++)l[h[o]]="font-weight:bold;fill:#087BBB",l[h[o+i.length/2]]="font-weight:bold;fill:#087BBB";var r=map.Scale.tStyle.Description.nFontHeight/map.Scale.normalX(1),m=createTextGrid(SVGDocument,s,":textgrid",i,2,r,l);return n?(n.setWidth(Math.min(m.fu.getBox().width/map.Scale.normalX(1)+25,map.Scale.bBox.width/map.Scale.normalY(2.2))),n.setHeight(Math.min(m.fu.getBox().height/map.Scale.normalY(1)+25,map.Scale.bBox.height/map.Scale.normalY(1.5))),n.reformat(),n.hasScrollBars()&&n.setScrollPosition(new point(0,0)),n):m.fu}},MapTheme.prototype.drawTextforOneQuadrant=function(e,t,i,a,s,n,l,h){for(var o=e.szStyle.match(/3D/)?2.4*i:1.2*i,r=o/2,m=h-o*(t.length-2),p=0;p<t.length;p++){var c=t[p].y/t[p].ly,u=Math.max(r,Math.min(t[p].y,m));r=u+o,m+=i;var d=t[p].x;d=l+map.Scale.normalX(2),u>t[p].y&&(c=Math.max(c,u/t[p].y));var A=e.mX+t[p].lx*s,S=e.mY+t[p].ly*n,g=e.mX+t[p].x*s,z=e.mY+t[p].y*n,f=e.mX+d*s,T=e.mY+u*n,x=map.Dom.newGroup(e.frameGroup,"");e.donutPartsA[t[p].index].textNode=x;var y=map.Dom.newGroup(x,""),b=map.Dom.newGroup(x,"");c&&(map.Dom.newShape("line",y,A,S,g,z,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;"),map.Dom.newShape("line",b,A,S,g,z,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),A=g,S=z),t[p].x<l-map.Scale.normalX(3)&&(map.Dom.newShape("line",y,A,S,e.mX+(l-map.Scale.normalX(3))*s,S,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;"),map.Dom.newShape("line",b,A,S,e.mX+(l-map.Scale.normalX(3))*s,S,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),A=e.mX+(l-map.Scale.normalX(3))*s),map.Dom.newShape("line",y,A,S,f,T,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;stroke-linecap:round;"),map.Dom.newShape("line",b,A,S,f,T,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),A=f,f+=map.Scale.normalX(2)*s,map.Dom.newShape("line",y,A,T,f,T,"stroke:white;stroke-width:"+map.Scale.normalX(1.5)+";opacity:0.2;"),map.Dom.newShape("line",b,A,T,f,T,"stroke:#888888;stroke-width:"+map.Scale.normalX(.5)+";opacity:1;"),f+=map.Scale.normalX(1.5)*s;var M=e.partsA[t[p].index]&&e.partsA[t[p].index].szText?e.partsA[t[p].index].szText:null;M||(M=e.partsA[t[p].index].szInfo?e.partsA[t[p].index].szInfo:Math.round(10*e.partsA[t[p].index].nInfoValue)/10+" % ");M.length;var F=this.createTextLabel(SVGDocument,x,"",M,i/map.Scale.normalX(1),a,this.szFlag.match(/VALUEBACKGROUND/)?e.partsA[t[p].index].color:"white",this.szChartFlag.match(/ZOOM/)?null:this.szTextColor);F.fu.setPosition(f-i,T-0*i),F.setAttributeNS(szMapNs,"tooltip",e.partsA[t[p].index].szInfo),e.szStyle.match(/3D/)&&F.fu.scale(1,2)}},MapTheme.prototype.drawDonutText=function(e,t){for(var i=0,a=0,s=0,n=[],l=[],h=[],o=[],r=Math.min(50,this.partsA.length),m=0;m<r;m++){var p=e.getTextPosition(m);if(p){if(this.szShowPartsA){var c=!1;for(var u in this.szShowPartsA)this.szShowPartsA[u]==m&&(c=!0);if(!c)continue}i=Math.max(i,Math.abs(p.y)),a=Math.max(a,p.x),s=Math.min(s,p.x),e.szStyle.match(/STARBURST/)?(a=Math.max(a,p.x),s=Math.min(s,p.x)):(a=e.nRadOuter,s=-e.nRadOuter),p.x>0?p.y>0?l[l.length]={index:m,x:p.x,y:p.y,lx:p.lx,ly:p.ly}:n[n.length]={index:m,x:p.x,y:-p.y,lx:p.lx,ly:-p.ly}:p.y>0?h[h.length]={index:m,x:-p.x,y:p.y,lx:-p.lx,ly:p.ly}:o[o.length]={index:m,x:-p.x,y:-p.y,lx:-p.lx,ly:-p.ly}}}n.sort(__sortYposUp),l.sort(__sortYposUp),h.sort(__sortYposUp),o.sort(__sortYposUp),t||(t=map.Scale.normalX(12)),this.drawTextforOneQuadrant(e,n,t,"text-anchor:start;",1,-1,a,i),this.drawTextforOneQuadrant(e,l,t,"text-anchor:start;",1,1,a,i),this.drawTextforOneQuadrant(e,h,t,"text-anchor:end;",-1,1,-s,i),this.drawTextforOneQuadrant(e,o,t,"text-anchor:end;",-1,-1,-s,i)},MapTheme.prototype.createTextLabel=function(e,t,i,a,s,n,l,h,o){var r="#555555",m=!0,p=!0,c=1,u=" "+this.szChartFlag+"|"+this.szFlag;if((u.match(/ZOOM/)||u.match(/MENUSIZE/)||u.match(/NORMSIZE/)||u.match(/INFOSIZE/)||u.match(/AXIS/)||u.match(/SELECTION/))&&(m=!!l&&m,p=!1),u.match(/VALUEBACKGROUND/)&&(m=!0),u.match(/HORZ/)&&(m=!1),isNaN(s)&&(s=14),n||(n=""),l&&m?(r=h||ColorScheme.getTextColor(l),c=u.match(/ZOOM/)?.9:.5):(l="#fefeff",r=h),e&&t){var d=map.Dom.newGroup(t,i),A=null;p&&!this.fShadow&&this.fOrigShadow&&(A=map.Dom.newShape("rect",d,1,1,1,1,"fill:#444444;fill-opacity:0.4;stroke:none;"));var S=map.Dom.newShape("rect",d,1,1,1,1,"fill:"+l+";fill-opacity:"+c+";stroke:none;stroke-width:"+map.Scale.normalX(.05*s)),g=map.Scale.tStyle.Values.szStyle+(this.szTextFont?"font-family:"+this.szTextFont:"")+";font-size:"+map.Scale.normalY(s)+"px;fill:"+r+";fill-opacity:1;"+n;if(o&&o.match(/\bGLOW\b/))map.Dom.newText(d,map.Scale.normalX(s),map.Scale.normalY(.25*s),g+";font-size:"+map.Scale.normalY(s)+"px;font-weight:normal;fill:none;stroke:white;stroke-width:"+map.Scale.normalY(s)/5+";stroke-opacity:0.8;pointer-events:none;stroke-linejoin:bevel;",a);map.Dom.newText(d,map.Scale.normalX(s),map.Scale.normalY(.25*s),g,a);var z=map.Dom.newText(SVGHiddenGroup,map.Scale.normalX(s),map.Scale.normalY(.25*s),g,a),f=z.fu.getBox();return SVGHiddenGroup.removeChild(z),S.setAttributeNS(null,"rx",map.Scale.normalX(.1*s)),S.setAttributeNS(null,"ry",map.Scale.normalX(.1*s)),S.setAttributeNS(null,"x",f.x-map.Scale.normalX(.3*s)),S.setAttributeNS(null,"y",f.y-map.Scale.normalY(0*s)),S.setAttributeNS(null,"width",f.width+map.Scale.normalX(.7*s)),S.setAttributeNS(null,"height",f.height+.1*map.Scale.normalY(s)),A&&(A.setAttributeNS(null,"rx",map.Scale.normalX(.1*s)),A.setAttributeNS(null,"ry",map.Scale.normalX(.1*s)),A.setAttributeNS(null,"x",f.x-map.Scale.normalX(.3*s)+map.Scale.normalX(.12*s)),A.setAttributeNS(null,"y",f.y+map.Scale.normalY(0*s)+map.Scale.normalY(.12*s)),A.setAttributeNS(null,"width",f.width+map.Scale.normalX(.7*s)),A.setAttributeNS(null,"height",f.height+.1*map.Scale.normalY(s))),m||(S.style.setProperty("display","none",""),A&&A.style.setProperty("display","none","")),d}},MapTheme.prototype.getOverviewChart=function(e,t){e.fu=new Methods(e);var i=30;if(this.szChartFlag+="|MENUSIZE",this.szOverviewChart&&"NONE"!=this.szOverviewChart&&this.nCount){var a=map.Scale.normalX(100),s=map.Scale.normalY(100),n=map.Scale.normalX(75),l=map.Scale.normalX(50);if("undefined"!=typeof DonutCharts){var h=map.Dom.newGroup(e),o=DonutCharts.newChart(SVGDocument,h,a,s,n,l);this.szOverviewChart.match(/PIE/)&&(o.setStyle("flat"),o.setRadInner(0),o.setRadOuter(map.Scale.normalX(55)),o.setCenter(map.Scale.normalX(80),map.Scale.normalY(55))),(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))&&(o.setStyle("3D"),o.setCenter(map.Scale.normalX(80),map.Scale.normalY(100))),o.setLine("white"),o.setLineWidth(map.Scale.normalX(.1));for(var r=map.Scale.normalY(20),m=0;m<this.partsA.length;m++){var p=this.partsA[m].nCount/this.nCount*100,c=100/this.nSum*this.partsA[m].nSum;this.nRealizedCount&&this.szFlag.match(/CHART/)&&(p=this.partsA[m].nCount/this.nRealizedCount*100),this.nExactCount&&this.exactSizeA&&(p=this.partsA[m].nCount/this.nExactCount*100,c=this.exactSizeA[m]),this.szOverviewChart.match(/DONUT/)&&(r=map.Scale.normalY(this.partsA[m].nSum/this.nSum*80));var u=String(this.partsA[m].nCount),d=p?String(" = "+this.formatValue(p,1)+" %"):"",A=c?String(", "+this.szLabelA[m]+" => "+this.formatValue(c,1)+this.szUnit):"";this.szOverviewChart.match(/PERCENTOFVALUE/)?(p=c,d="",u=this.nExactCount&&this.exactSizeA?String(this.formatValue(p,0)):String(this.formatValue(p,1)+(this.szFlag.match(/CHART/)?this.szUnit:" %"))):this.szOverviewChart.match(/DONUT/)||(A=""),this.szFlag.match(/CATEGORICAL/)?(d+=" ("+this.szLabelA[m]+")",A=""):this.szLegendLabelA&&this.szLegendLabelA.length&&(d+=" ["+this.szLegendLabelA[m]+"])"),o.addPart(p,r,this.partsA[m].color,0,u,String(this.partsA[m].nCount)+" member(s)"+d+A,"map.Themes.markClass(evt,'"+this.szId+"','"+m+"')","map.Themes.unmarkClass(evt,'"+this.szId+"')")}if(o.realize(),this.drawDonutText(o),(L=map.Dom.getBox(e)).width>0&&L.height>0){var S=e.fu.getPosition(),g=this.szOverviewChart.match(/PERCENTOFVALUE/)?"*  value / class":"*  members / class",z=map.Scale.normalY(10);(this.szOverviewChart.match(/DONUT/)||this.szOverviewChart.match(/3D/))&&(z=map.Scale.normalY(15)),map.Dom.newText(e,map.Scale.normalX(80),L.y+L.height+z,map.Scale.tStyle.Note.szStyle+";text-anchor:middle;",g)}}}else{if((this.szFlag.match(/BUBBLE/)||this.szFlag.match(/SQUARE/)||this.szFlag.match(/SYMBOL/))&&(!this.szFlag.match(/CATEGORICAL/)||!this.szFlag.match(/SYMBOL/))){var f=this.nMinA[0],T=this.nMaxA[0];this.szSizeField&&(f=this.nMinSize,T=this.nMaxSize);var x=(V=map.Scale.normalX(i/2))/Math.sqrt(T)*Math.sqrt(f);(this.szFlag.match(/LINEAR/)||this.szFlag.match(/SIZEP1/))&&(x=V/T*f);this.colorScheme[1]&&this.colorScheme[1],g=this.szFlag.match(/SUM/)?"sum":"mean";var y=5,b=map.Dom.newGroup(e);if(!this.szFlag.match(/CATEGORICAL/)){var M=map.Dom.newGroup(b);this.drawChart(M,null,1.5*i,"VALUES|ZOOM|NORMSIZE");if(this.szFlag.match(/SEQUENCE/)){var F=map.Dom.getBox(M);S=M.fu.getPosition();M.fu.setPosition(F.width/1.5+S.x,-F.height/2+S.y);var C=map.Scale.normalX(7*i)/F.height;M.fu.scale(C,C),i*=7}map.Dom.newText(b,map.Scale.normalX(0),map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText(g)),b.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(i)),y=i+15}if(!this.szFlag.match(/SEQUENCE/)){var w=map.Dom.newGroup(e),N=map.Dom.getBox(b);w.fu.setPosition(N.x+N.width+map.Scale.normalX(.66*i),map.Scale.normalY(-5)),y=0;var O="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(.25)+"px",R=map.Dom.newGroup(w);if(this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",R,0,0,V,O):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",R,-V,-V,2*V,2*V,O),map.Dom.newShape("line",R,0,-V,1.1*V,-V,O),map.Dom.newText(R,1.1*V+map.Scale.normalX(2),-V,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",this.formatValue(T,1)+this.szUnit),R.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(y+i/2)),x>0&&x!=V){var I=map.Dom.newGroup(w);this.szFlag.match(/BUBBLE/)?map.Dom.newShape("circle",I,0,0,x,O):this.szFlag.match(/SQUARE/)&&map.Dom.newShape("rect",I,-x,-x,2*x,2*x,O),map.Dom.newShape("line",I,0,-x,1.1*V,-x,O),map.Dom.newText(I,1.1*V+map.Scale.normalX(2),-x,"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-60%;fill:black;stroke:none;pointer-events:none",this.formatValue(f,1)+this.szUnit),I.fu.setPosition(map.Scale.normalX(20),map.Scale.normalY(y)+2*V-x)}map.Dom.newText(w,map.Scale.normalX(20),map.Scale.normalY(y+i+15),map.Scale.tStyle.Note.szStyle+";text-anchor:left;",map.Dictionary.getLocalText("min / max size-values"))}e.fu.scale(1,1)}if(this.szFlag.match(/CHART/)&&this.szFlag.match(/BUFFER/)){var V=map.Scale.normalX(i/2),P=map.Dom.getBox(e.parentNode),E=P.width>0?P.width/map.Scale.normalX(1)+10:10;R=map.Dom.newGroup(e.parentNode);map.Dom.newShape("circle",R,0,0,V,"fill:none;stroke:black;");O="fill:none;stroke:black;stroke-width:"+map.Scale.normalX(1)+";";map.Dom.newShape("line",R,0,0,V,0,O),map.Dom.newShape("line",R,0,map.Scale.normalY(-2),0,map.Scale.normalY(2.5),O),map.Dom.newShape("line",R,V,0,V+map.Scale.normalX(-3),map.Scale.normalY(-3),O),map.Dom.newShape("line",R,V,0,V+map.Scale.normalX(-3),map.Scale.normalY(3),O),map.Dom.newText(R,1.1*V+map.Scale.normalX(2),map.Scale.normalX(-10),"font-family:arial;font-size:"+map.Scale.normalX(10)+"px;text-anchor:left;baseline-shift:-10%;fill:black;stroke:none;pointer-events:none",ixMap.Scale.prototype.formatDistanceString(this.nBufferSize*this.nScale)),R.fu.setPosition(map.Scale.normalX(i/2+E),map.Scale.normalY(i/2));var v=new Button(e.parentNode,t+":bufferselectbutton","BUTTON","#bufferselect_button","map.Selections.newSelection('activeLayer','activeBuffer','type:BUFFER;buffersize:200','test');","","select active layer with this buffer");v.setPosition(map.Scale.normalX(i+E+10),map.Scale.normalY(i)),v.scale(1.4,1.4),v=null,_activeTheme&&map.Dom.newText(e.parentNode,map.Scale.normalX(i+E+20),map.Scale.normalY(i+6),"font-family:arial;font-size:"+map.Scale.normalX(8)+"px;text-anchor:left;baseline-shift:-10%;fill:gray;stroke:none;pointer-events:none","... "+_activeTheme)}if(this.szFlag.match(/CHART/)&&!this.szFlag.match(/BUBBLE/)&&!this.szFlag.match(/SQUARE/)&&!this.szFlag.match(/CATEGORICAL/)&&!this.szFlag.match(/BUFFER/)&&!this.szFlag.match(/SYMBOL/)){_TRACE("showInfo - drawChart =====>");var _=map.Dom.getBox(e.parentNode);_.width<0&&(_=new box(0,0,0,0));i=30;this.szFlag.match(/BAR/)&&this.nOrigSumA.length>5&&!this.szFlag.match(/STACKED/)&&(i=15*this.nOrigSumA.length/Math.log(this.nOrigSumA.length));this.drawChart(e,null,i,"VALUES|NORMSIZE"+(this.szFlag.match(/STACKED/)?"|EXPANDMAX":""));var D,L=map.Dom.getBox(e);D=Math.min(2.5,Math.max(_.height/L.height,map.Scale.normalX(100)/L.height)),e.fu=new Methods(e),e.fu.scale(D,D);var G=map.Dom.newGroup(e,"textGroup");G.fu.scale(1/D,1/D),L=e.fu.getBox(),this.szFlag.match(/BAR/)?e.fu.setPosition(_.width-L.x+map.Scale.normalX(10),-L.y+Math.max(10,.95*_.height-L.height)):e.fu.setPosition(_.width-L.x+map.Scale.normalX(10),-L.y+Math.max(10,_.height/2-L.height/2));g=" * overall sum";if(this.szAggregation&&this.szAggregation.match(/mean/))g=" * arithmetic mean";var k="middle";(this.szFlag.match(/RIGHT/)||this.szFlag.match(/STACKED/)||this.szFlag.match(/CENTER/)||this.szFlag.match(/POINTER/)||this.partsA.length<=2)&&(k="start"),map.Dom.newText(G,0,L.height+L.y+map.Scale.normalY(5),map.Scale.tStyle.Note.szStyle+"baseline-shift:-100%;text-anchor:"+k+";",g)}}},MapTheme.prototype.drawColorSchemeLegend=function(e,t){_TRACE("== colorlegend ==>");var i=null,a=map.Scale.nButtonSize?.66*map.Scale.nButtonSize:12,s=map.Scale.nButtonSize||12,n=map.Scale.nButtonSize?1.2*map.Scale.nButtonSize:18,l=n,h="font-family:arial;font-size:"+map.Scale.normalY(a)+"px;fill:#666666;pointer-events:none;",o=1.2*s;this.szFlag.match(/BAR/)&&this.szFlag.match(/\bUP\b/)&&(o=s);var r=1.15*a,m=0*o,p=0;this.szFlag.match(/BAR/)&&(this.szFlag.match(/\bUP\b/)||this.szFlag.match(/STACKED/))&&(p=this.partsA.length-1),this.showInfoMore||this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/\bUP\b/)||this.szFlag.match(/SYMBOL/)||this.szLabelA&&!this.szFlag.match(/\bCLIP\b/)||this.partsA.length<=2?this.szLegendStyle="large":this.szLegendStyle="compact";var c=new ScrollArea(null,e,null,10,10,10);c?(c.reformat(),i=c.workspaceNode):i=map.Dom.newGroup(e,t+":legend");var u=1;_TRACE("colorlegend: "+this.partsA.length+" parts ---\x3e");for(var d=0;d<this.partsA.length;d++)this.partsA[d].min&&(this.partsA[d].min.toFixed(0)!=this.partsA[d].min&&(u=Math.min(u,.1)),this.partsA[d].min.toFixed(1)!=this.partsA[d].min&&(u=Math.min(u,.01)));var A=[];for(d=0;d<this.partsA.length;d++)A[d]={},A[d].i=d,A[d].value=this.partsA[d].nCount;this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/SORTDOWN/)&&A.sort(this.sortIndexDown),!this.szFlag.match(/POINTER/)&&!this.szFlag.match(/INVERT/)||this.szLegendStyle.match(/compact/)||A.reverse();var S=1;!this.szLabelA&&A.length>15&&(S=Math.floor(A.length/10),s*=1.5);var g=this.showInfoMore&&this.isMarkable?18:10,z=!1;if(this.szFlag.match(/CHART/)&&this.szFieldsA.length>1&&!this.szFlag.match(/OFFSET/)&&!this.szFlag.match(/DEVIATION/)){for(var f=0,T=0;T<this.nOrigSumA.length;T++)this.partsA[T]&&void 0!==this.partsA[T].nSum&&f++;z=f==this.nOrigSumA.length}for(var x=0;x<A.length;x+=S){d=A[x].i;var y=Math.min(Math.abs(p-d),this.partsA.length-S),b=null,M=null;if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/))n=0===this.nSkipCount?3*this.partsA[d].nCount/this.nCount*100:30/this.nCount*10*this.partsA[d].nCount;else if(z){var F=0,C=0;if(this.szFlag.match(/MORPH/)){for(T=0;T<this.nOrigSumA.length/2;T++){var w=this.nOrigSumA[T]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[T+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1);F=Math.max(F,w)}C=(this.nOrigSumA[y]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[y+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1))/F}else{for(T=0;T<this.nOrigSumA.length;T++)F=Math.max(F,this.partsA[T].nSum);C=this.partsA[y].nSum/F}n=60*C}if(n=isNaN(n)?l:n,this.szFlag.match(/BUBBLE/)){var N=this.szFlag.match(/CATEGORICAL/)||this.szSizeField?s/2:s/4+s/4*(d+1)/this.partsA.length;M=map.Dom.newShape("circle",i,map.Scale.normalX(g+s/2),map.Scale.normalY(m+s/2),map.Scale.normalY(N),"fill:"+this.colorScheme[y]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";")}else if(S>1){M=map.Dom.newGroup(i,"");for(var O=0;O<S;O++)map.Dom.newShape("rect",M,map.Scale.normalX(g),map.Scale.normalY(m+s/S*O),map.Scale.normalX(n),map.Scale.normalY(s/S),"fill:"+this.colorScheme[y+O]+";stroke:none;")}else M=map.Dom.newShape("rect",i,map.Scale.normalX(g),map.Scale.normalY(m),map.Scale.normalX(n),map.Scale.normalY(s),"fill:"+this.colorScheme[y]+";stroke:#eeeeee;stroke-width:"+map.Scale.normalX(.1)+";");if(M){var R=this.partsA[y].nCount;for(O=1;O<S;O++)R+=this.partsA[y+O].nCount;if(this.isMarkable&&this.showInfoMore){map.Dom.newShape("rect",i,map.Scale.normalX(-5),map.Scale.normalY(m-2),map.Scale.normalX(n),map.Scale.normalY(s+4),"fill:white;stroke:none;opacity:0;").setAttributeNS(null,"id",this.szId+":widget:background:"+y);var I=new Button(i,this.szId+":class:"+y,"CHECKBOX|SELECTED","","map.Themes.showClass(evt,'"+this.szId+"','"+y+"','"+S+"')","map.Themes.hideClass(evt,'"+this.szId+"','"+y+"','"+S+"')","show/hide class");I.setPosition(map.Scale.normalX(map.Scale.nButtonSize/2-1),map.Scale.normalY(m+map.Scale.nButtonSize/2-1)),I.scale(.75,.75)}var V=this.partsA[y].min+(x?u:0),P=this.partsA[y+S-1].max,E=P-V>100?0:2,v=this.formatValue(V,E),_=this.formatValue(P,E),D="";this.szFlag.match(/SHOWMEMBERS/)&&(D="  ["+R+"]");var L="";if(L=v!=_?v+"..."+_+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+D:v+(this.szLegendUnits?this.szLegendUnits:"")+this.szUnit+D,this.szFlag.match(/\bCLIP\b/)&&!this.szFlag.match(/MORPH/)||this.szLabelA&&this.szLabelA[y]&&(L=this.szLabelA[y]),this.szLegendLabelA[y]=L,this.szLegendStyle.match(/compact/)){if(this.fGrayNoMember&&0===R&&this.szFlag.match(/CHOROPLETH/)&&this.szFlag.match(/DOMINANT/)){M.style.setProperty("fill-opacity","0.03","");M.style.getPropertyValue("fill");M.style.setProperty("stroke-opacity","0.2",""),M.style.setProperty("stroke","black",""),M.style.setProperty("stroke-width",map.Scale.normalX(.3),"")}if(!(this.szFlag.match(/CATEGORICAL/)||this.szFlag.match(/DOMINANT/)&&L.length>15)){var G=";font-size:"+map.Scale.normalX(.9*a)+"px;";0===x?(L=L.length>0?v+this.szUnit:L,b=map.Dom.newText(i,map.Scale.normalX(g+2),map.Scale.normalY(m+r*(S+1.5)),h+G,L)):x==A.length-S&&(L=L.length>0?_+this.szUnit:L,b=map.Dom.newText(i,map.Scale.normalX(g+2),map.Scale.normalY(m+r*(S+1.5)),h+G,L))}}else if(this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)){var k=n+2,j=String(this.partsA[d].nCount);0===this.nSkipCount&&(j=String(Math.round(100/this.nCount*this.partsA[d].nCount))+"%");var X=5*j.length/7*a;if("dynamic"==this.szTextPlacement&&X<n&&(k-=5*String(this.partsA[d].nCount).length/7*a),b=map.Dom.newText(i,map.Scale.normalX(g+k),map.Scale.normalY(m+r+1),h,j),k+=X,this.szSymbolsA[d]&&this.szSymbolsA[d].match(/symbol/)){var U=map.Dom.constructNode("use",i,{"xlink:href":"#"+this.szSymbolsA[d]+":antizoomandpan"});U.setAttributeNS(null,"style","fill:"+this.colorScheme[y]),U.fu.scale(.5,.5),U.fu.setPosition(map.Scale.normalX(g+k+10),map.Scale.normalY(m+r-3)),k+=20}(b=map.Dom.newText(i,map.Scale.normalX(g+k),map.Scale.normalY(m+r),h,"("+L+")")).style.setProperty("fill","#bbbbdd","")}else{k=n+4;if(z){var B=this.partsA[y].nSum;this.szFlag.match(/MORPH/)&&(B=this.nOrigSumA[y]*(this.nClipFrames-1-this.nActualFrame)/(this.nClipFrames-1)+this.nOrigSumA[y+this.nOrigSumA.length/2]*this.nActualFrame/(this.nClipFrames-1)),(this.szField100&&!this.szFlag.match(/SUM/)||this.szAggregation&&!this.szAggregation.match(/sum/))&&(B/=this.partsA[y].nCount),L=L+"  ("+this.formatValue(B,1)+this.szUnit+")"}b=map.Dom.newText(i,map.Scale.normalX(g+k),map.Scale.normalY(m+r),h,L),this.fGrayNoMember&&0===R&&this.szFlag.match(/CHOROPLETH/)&&(b.style.setProperty("fill","#bbbbdd",""),M.style.setProperty("opacity","0.1",""))}if(this.szFlag.match(/BUFFER/)&&M.style.setProperty("fill-opacity",this.fillOpacity?this.fillOpacity:this.nOpacity?this.nOpacity:0,""),1==this.szFieldsA.length||!this.szFlag.match(/CHART/)||this.szFlag.match(/SYMBOL/)&&this.szFlag.match(/CATEGORICAL/)){this.szLegendStyle.match(/compact/)?M.setAttributeNS(szMapNs,"tooltip",L+" ("+R+" member(s))"):M.setAttributeNS(szMapNs,"tooltip",R+" member(s)");var W=M.getAttributeNS(null,"style");M.setAttributeNS(szMapNs,"onoverstyle",W+";stroke:black;stroke-width:"+map.Scale.normalX(.5)+";"),M.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+y+"','"+S+"')"),M.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),M.setAttributeNS(null,"onclick","map.Themes.zoomToClass(evt,'"+this.szId+"','"+y+"','"+S+"')"),M.setAttributeNS(null,"id",t+":widget:classrect:"+y)}else this.szFlag.match(/SYMBOL/)?this.szFlag.match(/CATEGORICAL/)?M.setAttributeNS(szMapNs,"tooltip",this.partsA[d].nCount+" ("+this.formatValue(this.partsA[d].nCount/this.nCount*100,1)+" %)"):this.szFlag.match(/SEQUENCE/)&&M.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[d]+" ("+this.formatValue(this.nOrigSumA[d]/this.nSum*100,1)+" %)"):this.szFieldsA.length>1&&!this.szFlag.match(/SEQUENCE/)&&(this.nSum100?M.setAttributeNS(szMapNs,"tooltip",this.formatValue(100/this.nSum100*this.nOrigSumA[y],1)+" %"):this.nSum&&M.setAttributeNS(szMapNs,"tooltip",this.nOrigSumA[y]+" ("+this.formatValue(100/this.nSum*this.nOrigSumA[y],1)+" %)"),M.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+y+"','"+S+"')"),M.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"))}this.szLegendStyle.match(/compact/)?g+=n:m+=9*o/10}return this.szLegendStyle.match(/compact/)?m+=o*S*2:this.nNoData&&(m+=1.5*o/10,(M=map.Dom.newShape("rect",i,0,map.Scale.normalY(m),map.Scale.normalX(n),map.Scale.normalY(s),"fill:"+(this.szNoDataColor?this.szNoDataColor:"#ffffff")+";stroke:#000000;stroke-width:"+map.Scale.normalX(.1)+";")).setAttributeNS(szMapNs,"tooltip",this.nNoData+" member(s)"),M.setAttributeNS(null,"onmouseover","map.Themes.markClass(evt,'"+this.szId+"','"+y+"')"),M.setAttributeNS(null,"onmouseout","map.Themes.unmarkClass(evt,'"+this.szId+"')"),b=map.Dom.newText(i,map.Scale.normalX(22),map.Scale.normalY(m+r),h,map.Dictionary.getLocalText("no data")),m+=9*o/10),c&&(c.setWidth(-1),c.setHeight(Math.min(m+o,map.Scale.bBox.height/map.Scale.normalY(2.2))),this.nClipColorLegend&&c.setHeight(this.nClipColorLegend),c.reformat(),c.hasScrollBars()&&(i.style.setProperty("display","none",""),map.Dom.newShape("rect",e,0,0,map.Scale.normalX(c.getWidth()),map.Scale.normalY(c.getHeight()),"fill:none;stroke:none;"))),i},MapTheme.prototype.showInfo=function(){},MapTheme.prototype.chartButton=function(e,t,i){e=map.Dom.newGroup(e,"chartvari"+String(Math.random()));var a=this.szFlag;"2D"==i&&this.removeDefinitionFromFlag("3D"),this.szFlag+="|NORMSIZE|SILENT|MENUSIZE|"+i;this.drawChart(e,null,t);this.szFlag=a;var s=map.Dom.getBox(e);this.addChartTypeSign(e,i);var n=Math.min(map.Scale.normalX(t)/s.width,map.Scale.normalY(t)/s.height);return e.fu.scale(n,n),e.fu.setPosition(map.Scale.normalX(t+10),map.Scale.normalY(t)*n),e},MapTheme.prototype.addDefinitionToFlag=function(e){return this.szFlag=this.szFlag+"|"+e},MapTheme.prototype.removeDefinitionFromFlag=function(e){for(var t="",i=this.szFlag.split("|"),a=0;a<i.length;a++)i[a]!=e&&(t+=(t.length?"|":"")+i[a]);return this.szFlag=t},MapTheme.prototype.removeDefinition=function(e,t){for(var i="",a=e.split("|"),s=0;s<a.length;s++)a[s]!=t&&(i+=(i.length?"|":"")+a[s]);return i},MapTheme.prototype.addChartTypeSign=function(e,t){var i="M0,0 l"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" -"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" M"+map.Scale.normalX(2.5)+",0 l"+map.Scale.normalX(17.5)+",0 M"+map.Scale.normalX(22.5)+",0 l-"+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5)+" 0,"+map.Scale.normalX(3)+" "+map.Scale.normalX(1.5)+",-"+map.Scale.normalX(1.5);if(t.match(/SIZE/)){var a=map.Dom.newGroup(e,"");map.Dom.newShape("path",a,i,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;"),map.Dom.newShape("path",a,i,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;"),a.fu.setPosition(-map.Scale.normalX(10),map.Scale.normalX(-5))}if(t.match(/HEIGHT/)){a=map.Dom.newGroup(e,"");map.Dom.newShape("path",a,i,"stroke:white;stroke-width:"+map.Scale.normalX(4)+";stroke-opacity:0.5;stroke-linejoin:miter;stroke-linecap:square;"),map.Dom.newShape("path",a,i,"stroke:#666666;stroke-width:"+map.Scale.normalX(1.5)+";stroke-linejoin:miter;stroke-linecap:square;"),a.setAttributeNS(null,"transform","translate(0,"+-map.Scale.normalX(25)+") rotate(90)")}},MapTheme.prototype.getChartTypeMenu=function(e,t,i){if(void 0===a)var a=new Array("CHART|BAR","CHART|BAR|3D","CHART|BAR|3D|SORT","CHART|BAR|HORZ|LEFT|UP","CHART|BAR|HORZ|RIGHT|UP","CHART|BAR|HORZ|LEFT|UP|COMPRESS","CHART|BAR|HORZ|RIGHT|UP|COMPRESS","CHART|BAR|HORZ|LEFT|UP|3D","CHART|BAR|HORZ|RIGHT|UP|3D","CHART|BAR|HORZ|LEFT|UP|COMPRESS|3D","CHART|BAR|HORZ|RIGHT|UP|COMPRESS|3D","CHART|BAR|HORZ|CENTER|UP","CHART|BAR|STACKED","CHART|BAR|STACKED|3D","CHART|BAR|SORT|3D|COLUMNS|STACKED","CHART|BAR|SORT|3D|COLUMNS|STACKED|SIZE","CHART|PIE","CHART|PIE|SIZE","CHART|PIE|3D","CHART|PIE|3D|SIZE","CHART|PIE|3D|HEIGHT","CHART|PIE|3D|VOLUME","CHART|PIE|DONUT","CHART|PIE|DONUT|SIZE","CHART|PIE|DONUT|3D","CHART|PIE|DONUT|3D|SIZE","CHART|PIE|DONUT|3D|HEIGHT","CHART|PIE|DONUT|3D|VOLUME","CHART|PIE|STARBURST","CHART|PIE|STARBURST|SIZE","CHART|PIE|STARBURST|3D","CHART|PIE|STARBURST|3D|SIZE","CHART|PIE|STARBURST|3D|HEIGHT","CHART|PIE|STARBURST|3D|VOLUME","CHART|PIE|DONUT|STARBURST","CHART|PIE|DONUT|STARBURST|SIZE","CHART|PIE|DONUT|STARBURST|3D","CHART|PIE|DONUT|STARBURST|3D|SIZE","CHART|PIE|DONUT|STARBURST|3D|HEIGHT","CHART|PIE|DONUT|STARBURST|3D|VOLUME");if(void 0===s)var s=new Array("CHART|BAR","CHART|BAR|VALUES","CHART|BAR|3D","CHART|BAR|3D|VALUES","CHART|BAR|3D|VOLUME","CHART|BAR|3D|VOLUME|VALUES","CHART|BAR|HORZ|RIGHT|UP","CHART|BAR|HORZ|RIGHT|UP|VALUES","CHART|BAR|HORZ|RIGHT|UP|3D","CHART|BAR|HORZ|RIGHT|UP|VALUES|3D","CHART|BAR|POINTER","CHART|BAR|POINTER|VALUES","CHART|BUBBLE|SURFACE","CHART|BUBBLE|SURFACE|VALUES","CHART|SQUARE|SURFACE","CHART|SQUARE|SURFACE|VALUES");if(void 0===n)var n=new Array("CHOROPLETH","CHART|BUBBLE","CHART|SQUARE","CHART|PIE|3D|SIZE","CHART|PIE|3D|HEIGHT","CHART|PIE|3D|SIZE|HEIGHT","CHART|BAR|3D|VOLUME","CHART|BAR","CHART|BAR|3D","CHART|BAR|3D|SIZE","CHART|BAR|HORZ|RIGHT|UP","CHART|BAR|HORZ|RIGHT|UP|3D","CHART|BAR|POINTER","CHART|BAR|POINTER|SIZE","CHART|BAR|HORZ|RIGHT|UP|POINTER","CHART|LABEL");var l=this.szOrigFlag,h=n;(this.szFieldsA.length>1||this.szFlag.match(/CATEGORICAL/)&&this.szFlag.match(/AGGREGATE/))&&(h=a);for(var o=60,r=i?i/o:3,m=0;m<h.length;m++){var p=this.szFlag,c=map.Dom.constructNode("a",e,{});map.Dom.newShape("rect",c,map.Scale.normalX(o*(m%r)),map.Scale.normalY(o*Math.floor(m/r)),map.Scale.normalX(o),map.Scale.normalY(o),"fill:#f8f8ff;stroke:lightgray;stroke-dasharray:50 50;stroke-width:"+map.Scale.normalX(1)+";");var u=map.Dom.newGroup(c,"szDisplayId:chart:"+String(Math.random()));map.Dom.setClipRect(u,new box(-map.Scale.normalX(25),-map.Scale.normalX(o),map.Scale.normalX(o),map.Scale.normalX(o))),this.szFlag=h[m]+"|NORMSIZE|SILENT|MENUSIZE",p.match(/CATEGORICAL/)&&(this.szFlag+="|CATEGORICAL"),p.match(/GROUP/)&&(this.szFlag+="|GROUP"),p.match(/AGGREGATE/)&&(this.szFlag+="|AGGREGATE"),p.match(/COMPATIBLE/)&&(this.szFlag+="|COMPATIBLE"),p.match(/FAST/)&&(this.szFlag+="|FAST"),p.match(/RELOCATE/)&&(this.szFlag+="|RELOCATE"),p.match(/DIFFERENCE/)&&(this.szFlag+="|DIFFERENCE"),p.match(/FRACTION/)&&(this.szFlag+="|FRACTION"),p.match(/INVERT/)&&(this.szFlag+="|INVERT"),p.match(/INVERTSIZE/)&&(this.szFlag+="|INVERTSIZE"),p.match(/RELATIVE/)&&(this.szFlag+="|RELATIVE"),p.match(/DENSITY/)&&(this.szFlag+="|DENSITY"),p.match(/DOPACITYMAX/)?this.szFlag+="|DOPACITYMAX":p.match(/DOPACITYLOGMAX/)?this.szFlag+="|DOPACITYLOGMAX":p.match(/DOPACITYPOWMAX/)?this.szFlag+="|DOPACITYPOWMAX":p.match(/DOPACITYMEAN/)?this.szFlag+="|DOPACITYMEAN":p.match(/DOPACITYLOGMEAN/)?this.szFlag+="|DOPACITYLOGMEAN":p.match(/DOPACITYPOWMEAN/)?this.szFlag+="|DOPACITYPOWMEAN":p.match(/DOPACITYLOG/)?this.szFlag+="|DOPACITYLOG":p.match(/DOPACITY/)&&(this.szFlag+="|DOPACITY"),p.match(/AUTO100/)&&(this.szFlag+="|AUTO100"),p.match(/AUTOCOMPLETE/)&&(this.szFlag+="|AUTOCOMPLETE");var d=this.szAggregation,A=this.nClipParts;this.nClipParts=10;var S=this.drawChart(u,null,40);if(void 0===A?delete this.nClipParts:this.nClipParts=A,this.szAggregation=d,S){this.szFlag=p;var g=map.Scale.normalX(10);S.x-=map.Scale.normalX(o/r),u.fu.setPosition(g-S.x+m%r*map.Scale.normalX(o),map.Scale.normalY(40)+g+S.y+Math.floor(m/r)*map.Scale.normalY(o)),u.setAttributeNS(null,"clip-path","");var z=900/Math.max(u.fu.getBox().width,u.fu.getBox().height);z<1&&u.fu.scale(z,z);var f="";l.match(/UNDEFINEDISVALUE/)&&(f+="|UNDEFINEDISVALUE"),l.match(/ZEROISVALUE/)&&(f+="|ZEROISVALUE"),l.match(/NEGATIVEISVALUE/)&&(f+="|NEGATIVEISVALUE"),l.match(/NONEGATIVE/)&&(f+="|NEGATIVEISVALUE"),l.match(/GROUP/)&&(f+="|GROUP"),l.match(/AGGREGATE/)&&(f+="|AGGREGATE"),l.match(/COMPATIBLE/)&&(f+="|COMPATIBLE"),l.match(/FAST/)&&(f+="|FAST"),l.match(/\bRECT\b/)&&(f+="|RECT"),l.match(/HEX/)&&(f+="|HEX"),l.match(/RELOCATE/)&&(f+="|RELOCATE"),l.match(/CATEGORICAL/)&&(f+="|CATEGORICAL"),l.match(/SUM/)&&(f+="|SUM"),l.match(/MEAN/)&&(f+="|MEAN"),l.match(/DIFFERENCE/)&&(f+="|DIFFERENCE"),l.match(/RELATIVE/)&&(f+="|RELATIVE"),l.match(/INVERT/)&&(f+="|INVERT"),l.match(/INVERTSIZE/)&&(f+="|INVERTSIZE"),l.match(/CALCMEAN/)&&(f+="|CALCMEAN"),l.match(/CALC100/)&&(f+="|CALC100"),l.match(/PRODUCT/)&&(f+="|PRODUCT"),l.match(/AUTOCOMPLETE/)&&(f+="|AUTOCOMPLETE"),l.match(/AUTO100/)&&(f+="|AUTO100"),l.match(/QUANTILE/)&&(f+="|QUANTILE"),l.match(/DENSITY/)&&(f+="|DENSITY"),l.match(/DOPACITY/)&&(f+="|DOPACITY"),(l.match(/VALUES/)||p.match(/VALUES/))&&(f+="|VALUES"),l.match(/VALUEBACKGROUND/)&&(f+="|VALUEBACKGROUND"),h[m].match(/SIZE/)&&(p.match(/SIZELOG/)?f+="|SIZELOG":p.match(/SIZEP4/)?f+="|SIZEP4":p.match(/SIZEP3/)?f+="|SIZEP3":p.match(/SIZE/)&&(f+="|SIZE")),p.match(/SPACED/)&&(f+="|SPACED"),c.setAttributeNS(null,"onclick","map.Themes.changeThemeStyle(evt,'"+this.szId+"','type:"+h[m]+f+"')"),this.addChartTypeSign(u,h[m])}}var T=[];for(var x in h)T.push(h[x]+f);return T},MapTheme.prototype.formatValue=function(e,t,i){return isNaN(e)?e:this.nMin>999&&this.nMax<3e3?__formatValue(e,t,i+"|NOBREAKS"):__formatValue(e,t,i)},MapTheme.prototype.remove=function(e){this.parent.removeTheme(e,this.szId)},MapTheme.prototype.removeElements=function(evt){if(this.szFlag.match(/FEATURE/)&&this.chartGroup&&this.parent.removeFromThemeNodesCache(this.chartGroup),this.widgetNode&&(widgetList.removeWidget(this.widgetNode),this.widgetNode.parentNode.removeChild(this.widgetNode),this.widgetNode=null),this.clipTimeout&&clearTimeout(this.clipTimeout),this.unpaintMap(),this.clearWMS(),this.szFlag.match(/FEATURE/)&&this.chartGroup){var labelGroup=SVGDocument.getElementById(this.chartGroup.getAttributeNS(null,"id")+":label");this.chartGroup.parentNode.removeChild(labelGroup),this.chartGroup.parentNode.removeChild(this.chartGroup),this.parent.removeFromThemeNodesCache(this.chartGroup)}if(this.onremove)try{eval(this.onremove)}catch(e){}try{HTMLWindow.ixmaps.htmlgui_onRemoveTheme(this.szId)}catch(e){}},MapTheme.prototype.removeMapThemeStyles=function(e){for(var t=e.split("|"),i=SVGRootElement.getElementsByTagName("path"),a=0;a<i.length;a++)if(1==i.item(a).nodeType){var s=i.item(a).parentNode.getAttributeNS(null,"id"),n=!1;if(s&&0!==s.length)for(var l=map.Tiles.getMasterId(s).split(":")[0],h=0;h<t.length;h++)l==t[h]&&(n=!0);n&&i.item(a).parentNode.removeAttributeNS(null,"style")}},MapTheme.prototype.disable=function(){if(!this.szFlag.match(/CHART/)&&this.widgetNode)for(var e=this.widgetNode.getElementsByTagName("g"),t=0;t<e.length;t++)e.item(t).setAttributeNS(null,"opacity","0.9")},MapTheme.prototype.enable=function(){if(this.widgetNode){for(var e=this.widgetNode.getElementsByTagName("g"),t=0;t<e.length;t++)e.item(t).setAttributeNS(null,"opacity","1.0");this.widgetNode.parentNode.appendChild(this.widgetNode)}map.Themes.setActive(this)},MapTheme.prototype.makeVisible=function(){for(var e=0;e<this.szThemesA.length;e++)map.Layer.isLayerOn(this.szThemesA[e])||map.Layer.isScaleDependentLayer(this.szThemesA[e])||(map.Themes.switchedLayerA[this.szThemesA[e]]=!0,map.Api.switchMapTheme(this.szThemesA[e],"on")),map.Tiles.switchScaleDependentTiles()},MapTheme.prototype.checkVisible=function(){for(var e=0;e<this.szThemesA.length;e++)map.Themes.isThemeLayerUsed(this.szThemesA[e])&&this.isVisible||!map.Themes.switchedLayerA[this.szThemesA[e]]||(map.Api.switchMapTheme(this.szThemesA[e],"off"),map.Themes.switchedLayerA[this.szThemesA[e]]=null)},MapTheme.prototype.resize=function(e){if(999!=e&&(this.nScale*=e),this.szFlag.match(/BUFFER/)&&this.szShapeType.match(/line/))this.fRedraw=!0,this.fRedrawInfo=!0,this.nSkipCount=1,map.Themes.execute();else{if(map.Layer.changeObjectScaling(null,e,this.chartGroup),this.szFlag.match(/DECLUTTER/)&&this.declutterCharts(),this.szFlag.match(/BUFFER/))for(var t=this.chartGroup.getElementsByTagName("circle"),i=0;i<t.length;i++){var a=t.item(i).getAttributeNS(null,"style");if(a&&a.length){var s=__scaleStyleString(a,1/e);t.item(i).setAttributeNS(null,"style",s)}}this.f=!0,this.showInfo()}},MapTheme.prototype.offset=function(e){var t=this.chartGroup.fu.getPosition();this.chartGroup.fu.setPosition(t.x+e.x,t.y+e.y)},MapTheme.prototype.opacity=function(e){if(this.fillOpacity=(this.fillOpacity?this.fillOpacity:1)*e,this.fillOpacity=Math.min(1,this.fillOpacity),this.fillOpacity=Math.max(0,this.fillOpacity),this.nOpacity=(this.nOpacity?this.nOpacity:1)*e,this.nOpacity=Math.min(1,this.nOpacity),this.nOpacity=Math.max(0,this.nOpacity),this.chartGroup)for(var t=this.chartGroup.childNodes,i=0;i<t.length;i++)map.Layer.changeNodeOpacity(t.item(i),e);else if(this.szShapeType.match(/line/))for(i=0;i<this.szThemesA.length;i++)map.Layer.changeLayerOpacity(this.szThemesA[i],e);else for(var a in this.itemA)for(var s=this.getItemNodes(a),n=0;n<s.length;n++)map.Layer.changeNodeOpacity(s[n],e,"fill-opacity")},MapTheme.prototype.blur=function(e){if(this.chartGroup)if(this.nBlur){var t="blur-3";if(s=SVGDocument.getElementById(t))s.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e));else{(s=map.Dom.newNode("filter",this.chartGroup.parentNode)).setAttributeNS(null,"id",t);var i=map.Dom.newNode("feGaussianBlur",s);i.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e))}this.chartGroup.style.setProperty("filter","url(#"+t+")","")}else this.chartGroup.style.removeProperty("filter");else if(this.szThemesA[0]){var a=SVGDocument.getElementById("maplayer");if(a)if(this.nBlur){var s;if(t="blur-map",s=SVGDocument.getElementById(t))s.firstChild.setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)/map.Zoom.nZoom);else(s=map.Dom.newNode("filter",a.parentNode)).setAttributeNS(null,"id",t),s.setAttributeNS(null,"x",0),s.setAttributeNS(null,"y",0),s.setAttributeNS(null,"width","100%"),s.setAttributeNS(null,"height","100%"),(i=map.Dom.newNode("feGaussianBlur",s)).setAttributeNS(null,"stdDeviation",map.Scale.normalX(e)/map.Zoom.nZoom);a.style.setProperty("filter","url(#"+t+")","")}else a.style.removeProperty("filter")}},MapTheme.prototype.toggle=function(e){_TRACE("-----\x3e>>>>> toggle:"+this.szId+" --------\x3e>>>>>"),this.chartGroup?!0===e||void 0===e&&"none"==this.chartGroup.style.getPropertyValue("display")?(this.chartGroup.style.setProperty("display","inline",""),this.chartGroup.display="inline",this.isChecked=!0):(this.chartGroup.style.setProperty("display","none",""),this.chartGroup.display="none",this.isChecked=!1):this.isChecked?(this.unpaintMap(),this.isChecked=!1,map.Themes.activateNextPaint(this)&&(this.fToggle=!1,map.Themes.execute(),this.widgetNode&&(this.widgetNode.setAttributeNS(null,"opacity","1.0"),this.widgetNode.parentNode.appendChild(this.widgetNode)))):(this.isChecked=!0,this.fRedraw=!0,this.fToggle=!1,map.Themes.execute())},MapTheme.prototype.getHistogram=function(e,t,i){map.Themes.getHistogram(e,t,i,this)};var __maptheme_chartcolors=[];function __maptheme_getChartColors(e){return __maptheme_chartcolors[e]||(__maptheme_chartcolors[e]=new ChartColors(e)),__maptheme_chartcolors[e]}function ChartColors(e){"string"!=typeof e&&(e="#ffffff"),this.mainColor=e,this.lowColor=ColorScheme.getDerivateColor(e,.7),this.highColor=ColorScheme.getDerivateColor(e,1.3),this.borderColor=ColorScheme.getBorderColor(e),this.textColor=ColorScheme.getTextColor(e)}function __mpap_hex2dec(e){return parseInt(e,16)}function __mpap_decode_utf8(e){if("string"==typeof e&&e.match(/&#x/)){var t="",i=e.split("&#x");t=i[0];for(var a=1;a<i.length;a++)t+=String.fromCharCode(__mpap_hex2dec(i[a].substr(0,2))),t+=i[a].substr(3,i[a].length-3);return t}return e}