<!DOCTYPE HTML>
<html>

<head>
	<meta charset="UTF-8">
    <title>iXmaps Theme Editor</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> 

	<meta http-equiv="X-UA-Compatible" content="IE=9"/>

	<style type="text/css" media="screen">
		body {
	overflow: hidden;
	}
	button {
		border-radius: 0.5em;
	}
	</style>
</head>

<body id="theme-editor" >

	<div id="editor-div" style="width:100%;height:100px;">
		<pre id="editor" style="width:100%;border:#eee solid 1px;" >loading ...</pre>
	</div>

	<div id="editor-apply" style="margin-top:0.5em;margin-left:0em">
		<a href='javascript:ixmaps.applyEditorTheme();'>
			<button type="button" class="btn btn-default btn-md">
			apply changes
			</button>
		</a>
	</div>

	<div id="editor-footer">
		<span style="font-size:0.6em;color:#ddd">powered by ACE Code Editor, Copyright (c) 2010, Ajax.org B.V.</span>
	<div>

 
	<script type = "text/javascript">

	ixmaps = window.ixmaps || null;
	if ( window.opener ){
		ixmaps = window.opener.ixmaps;
	}else
	if ( parent ){
		ixmaps = parent.window.ixmaps;
	}
	else{
		alert("error: missing parent window for themes !");
	}
     
	console.log("---------->>>>>")
	console.log("initialize theme editor");
	console.log(ixmaps);
	console.log("---------->>>>>")

   	/**************************************************************** 
	 *
	 * apply new theme definition after editing
	 *
	 ****************************************************************/
 
	ixmaps.applyEditorTheme = function(){

		console.log("applyEditorTheme");

		if ( !ixmaps.editor ){
			ixmaps.parentApi.error("no theme defined!");
			return;
		}
		var szThemeDef = ixmaps.editor.getValue();

		console.log(szThemeDef);

		var theme = new Config(szThemeDef);
		var themeDefObj = theme.obj;
        
        console.log(ixmaps);

		// remove previous theme representation from map
		ixmaps.embeddedSVG.window.map.Api.removeTheme(ixmaps.editorThemeId);
 
        // keep theme id
		theme.obj.style.id = ixmaps.editorThemeId;

		// make new theme representation
		ixmaps.embeddedSVG.window.map.Api.newMapThemeByObj(theme.obj);

		return;

	}

   	/**************************************************************** 
	 *
	 * handle the ACE editor
	 *
	 ****************************************************************/
	
	ixmaps.loadEditor = function(){

		console.log("loadEditor");

		if ( typeof(ace) === 'undefined' ){
			setTimeout("ixmaps.loadEditor();",500);
			return;
		};
		$("#editor-div").css("height","600px");
        ixmaps.editor = ace.edit("editor-div");
 
		// enable autocompletion and snippets
		ixmaps.editor.setOptions({
			enableBasicAutocompletion: true,
			enableSnippets: true,
			enableLiveAutocompletion: true,
			fontFamily: "ConsolasÃŸ, monospace",
			fontSize: "13px"
		});

		var ixmapsCompleter = {
			getCompletions: function(editor, session, pos, prefix, callback) {
				if (prefix.length === 0) { callback(null, []); return }
				$.getJSON(
					ixmaps.szResourceBase+"ui/js/tools/ixmaps.completer.js",
					function(wordList) {
						// wordList like [{"word":"flow","freq":24,"score":300,"flags":"bc","syllables":"1"}]
						callback(null, wordList.map(function(ea) {
							return {name: ea.word, value: ea.word, score: ea.score, meta: (ea.help||"ixmaps") }
						}));
					})
			}
		}
		var langTools = ace.require("ace/ext/language_tools");
		langTools.addCompleter(ixmapsCompleter);

		ixmaps.editor.getSession().setMode("ace/mode/json");
		ixmaps.editor.setTheme("ace/theme/dawn");

		console.log("ready to load the theme");

		if ( ixmaps.getThemeObj(ixmaps.editorThemeId) ){
			var themeObj =	ixmaps.getThemeDefinitionObj(ixmaps.editorThemeId);
			ixmaps.editor.setValue(new Config(themeObj).getPrettyString());
			ixmaps.editor.gotoLine(1);
			$("#editor-div").fadeIn();

		}else{
			ixmaps.editor.setValue("");
		}

		//$("#editor-apply-button").button();
		$("#editor-div").height("600px");
		$("#editor-div").show();

	};

	var resize = function(resizeData){
		$("#editor-div").css("height",(resizeData.height-120)+"px");
		$("#editor-div").css("width",(resizeData.width-50)+"px");
		// set dialog iframe height
		if ( ixmaps && ixmaps.editor && ixmaps.editor.resize ){
			ixmaps.editor.resize();
		}
	}; 
	
	// Setup dialog resize handling
	var setupDialogResizeHandler = function(){
		// Try to find the dialog instance and set up resize callback
		if (window.parent && window.parent.dialogManager) {
			// Find the current dialog (assuming it's the most recently created one)
			var openDialogs = window.parent.dialogManager.getOpenDialogs();
			if (openDialogs.length > 0) {
				var currentDialog = openDialogs[openDialogs.length - 1];
				currentDialog.setOnResize(function(resizeData) {
					console.log('Dialog resized:', resizeData);
					resize(resizeData); // Call your existing resize function
				});
				console.log("Dialog resize handler activated");
			}
		}
	};
	
	// Setup dialog resize handler after DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', setupDialogResizeHandler);
	} else {
		setupDialogResizeHandler();
	}

   	/**************************************************************** 
	 *
	 * get theme definition string and open editor
	 * if theme definition found,
	 * load editor resources and init editor
	 *
	 ****************************************************************/

	var themes = ixmaps.getThemes();
        
	for ( i in themes ){
		if ( !themes[i].szFlag.match(/FEATURE/) ){
			ixmaps.editor.szThemeId = themes[i].szId;
		}
	}
        
    // GR 17.10.2019 new: get active legend theme
    var themeObj = ixmaps.getThemeObj(ixmaps.editor.szThemeId);

	if(themeObj){

		$("#editor-div").hide();

		ixmaps.editorThemeId = themeObj.szId;

		// we must define the resources for this html page here because it is not loaded as iframe
		// so we must await the loading of all necessary resources before initializing the editor
		//  
		const editor_fileUrls = [
			{
				url: 'ui/libs/jquery/ui/css/ixmaps/jquery-ui-1.8.16.custom.css',
				type: 'css'
			},
			{
				url: 'ui/css/jquery-ui.css',
				type: 'css'
			},
			{
				url: 'ui/libs/jquery/jquery-1.7.1.min.js',
				type: 'js'
			},
			{
				url: 'ui/js/tools/json_config.js',
				type: 'js'
			},
			{
				url: 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/ace.min.js',
				type: 'js'
			},
			{
				url: 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/ext-language_tools.min.js',
				type: 'js'
			},
			{
				url: 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/mode-json.min.js',
				type: 'js'
			},
			{
				url: 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/theme-dawn.min.js',
				type: 'js'
			},
			{
				url: 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/theme-github.min.js',
				type: 'js'
			},
			{
				url: 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/theme-cloud9_day.min.js',
				type: 'js'
			},
			{
				url: 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/theme-dreamweaver.min.js',
				type: 'js'
			}
						
		];
		// this loads the resources and calls ixmaps.loadEditor as callback
		ixmaps.loadResources(editor_fileUrls, null, ixmaps.loadEditor);
	}
    
    </script>

 </body> 
 </html> 

	