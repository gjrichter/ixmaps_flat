<!DOCTYPE HTML>
<html>

<head>
    <title>IXMAPS embed</title>
    <meta name="Author" content="Guenter Richter" />
    <meta name="Keywords" content="map SVG HTML5 Javascript maps interactive charts ixmaps" />
    <meta name="Description"
        content="core html page for ixmaps SVG interactive map applications in overlay on leaflet basemaps" />

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- IE Fix for HTML5 Tags -->
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!--========================================================================= 
	  we need scripting
	<!--========================================================================= -->

    <noscript>
        <div style="position:absolute;top:100px;left:100px;width:500px">
            <b>JavaScript must be enabled in order for you to use iXMaps.</b>
            <br>
            <br> However, it seems JavaScript is either disabled or not supported by your browser. To view the map
            application, enable
            JavaScript by changing your browser options, and then try again.
        </div>
    </noscript>

</head>

<body style="margin:0px;padding:0px;overflow:hidden;">

    <div id="map-target">
    </div>

</body>

<!--========================================================================= -->

<script type="text/javascript">
    (function () {

        //ixmaps.fLegendVisible = true;

        var szControls = "small";
        var szSvgLegendFlag = "nolegend";
        var szHTMLLegendFlag = "1";

        // GR 12.02.2015 define fallback default map, used if parameter SVGGIS is empty  
        var szDefaultMap = "../../maps/svg/maps/generic/mercator.svg";

        const __eventi = {
            "layer": "Concessioni",
            "field": "grouped_target_group",
            "field100": "",
            "style": {
                "type": "CHART|SYMBOL|CATEGORICAL|SIZE|SEQUENCE|STAR|SORT|DOWN|AGGREGATE|RELOCATE|VALUES|SIMPLELEGEND",
                "colorscheme": [
                    "6",
                    "tableau10"
                ],
                "fillopacity": "0.9",
                "shadow": "true",
                "visible": "true",
                "dbtable": "processed_data",
                "dbtableUrl": "../../data/2023-rtv-1990-2022_without-sources.csv",
                "dbtableType": "csv",
                "dbtableProcess": "data => { data.column(\"n_killed\").map(value => { return isNaN(value)?0:value; }); data.column(\"n_wounded\").map(value => { return (isNaN(value))?0:value; }); var killed = data.column(\"n_killed\").index; var wounded = data.column(\"n_wounded\").index; data.addColumn({ destination: \"n_victims\" }, (row) => { return (Number(row[killed])+Number(row[wounded])); }); }",
                "datacache": "true",
                "lookupfield": "location_latitude|location_longitude",
                "showdata": "true",
                "symbols": [
                    "circle"
                ],
                "units": "victims",
                "refreshtimeout": "0",
                "normalsizevalue": "100",
                "scale": "1",
                "sizepow": "2",
                "sizefield": "n_victims",
                "linewidth": "0.5",
                "glowlower": "1:10000",
                "rangescale": "1.1",
                "valuescale": "1",
                "gridwidth": "3px",
                "name": "symbol",
                "title": "Violence - RTV ",
                "splash": "scaricando dati ...",
                "tooltip": "<h2>{{case_id}}<br>{{location}}<br>{{affilation}}</h2>actor: {{organizational_affiliation}}, {{organizational_affiliation_2}}<br><br><b>weapon:</b> {{weapon_description}}<br><b>target:</b> {{grouped_target_group}}, {{grouped_target_group_2}}<br><br> killed: {{n_killed}} wounded: {{n_wounded}}<br><br>{{description}}{{theme.item.data}}"
            }
        };

        // List of file URLs and their expected types
        const fileUrls = [
            
            { url: '../css/ixmaps.css', type: 'css' },
            
            { url: 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', type: 'js' },
            { url: 'https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.js', type: 'js' },
            { url: 'https://cdn.maptiler.com/leaflet-maptilersdk/v1.0.0/leaflet-maptilersdk.js', type: 'js' },
            { url: 'https://code.jquery.com/jquery-3.7.1.min.js', type: 'js' },
            
            { url: '../js/htmlgui.js', type: 'js' },
            { url: '../js/htmlgui_dialog.js', type: 'js' },
            { url: '../js/htmlgui_story.js', type: 'js' },
            { url: '../js/htmlgui_sync.js', type: 'js' },
            { url: '../js/htmlgui_sync_Leaflet_VT.js', type: 'js' },
            { url: '../js/tools/legend.js', type: 'js' },
            { url: '../js/tools/layer_legend.js', type: 'js' },
            
            { url: '../../../data.min.js/data.js', type: 'js' },
            { url: '../../ui/libs/leaflet-gesture-handling/leaflet-gesture-handling.min.js', type: 'js' },
            
            { url: './mappage.html', type: 'html' },
            { url: '../resources/images/ixmaps_logo.png', type: 'shortcut' }
        ]; 


        // --- Utility Functions ---

        /**
         * Loads a resource (file) from a given URL.
         *
         * @async
         * @param {string} url - The URL of the resource to load.
         * @param {string} type - The type of the resource (e.g., 'json', 'text', 'js', 'css', 'html', 'blob', 'shortcut').
         * @returns {Promise<any>} A promise that resolves with the loaded resource data or void.
         * @throws {Error} Throws an error if the HTTP request fails or if an unsupported file type is provided.
         */
        async function loadResource(url, type) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} for ${url}`);
            }

            switch (type) {
                case 'json': return response.json();
                case 'text': return response.text();
                case 'blob': return response.blob();
                case 'js': return response.text(); // no need to eval here
                case 'css':
                    const css = await response.text();
                    const style = document.createElement('style');
                    style.innerHTML = css;
                    document.head.appendChild(style);
                    return; // no need to return css content
                case 'html':
                    const html = await response.text();
                    document.getElementById('map-target').innerHTML = html;
                    return;
                case 'shortcut':
                    const blob = await response.blob();
                    const iconUrl = URL.createObjectURL(blob);
                    let link = document.querySelector("link[rel='shortcut icon']");
                    if (!link) {
                        link = document.createElement('link');
                        link.rel = 'shortcut icon';
                        document.head.appendChild(link);
                    }
                    link.href = iconUrl;
                    return;
                default:
                    throw new Error('Unsupported file type');
            }
        }

        /**
         * Loads multiple resources from a list of URLs.
         *
         * @async
         * @param {Array<{url: string, type: string}>} urls - An array of objects, each containing a 'url' and a 'type'.
         * @param {function} [callback] - An optional callback function to be executed after all resources are loaded successfully.
         * @returns {Promise<void>} A promise that resolves when all resources are loaded and processed.
         * @throws {Error} Throws an error if any resource fails to load.
         */        
        async function loadResources(urls, callback) {
            try {
                const fetchPromises = urls.map(({ url, type }) => loadResource(url, type));
                const files = await Promise.all(fetchPromises);

                for (const file of files) {
                   if (typeof file === 'string') {
                       eval(file); // Execute only JavaScript code.
                    }
                }

                console.log('All resources loaded successfully');
                if (callback) {
                    callback();
                }
            } catch (error) {
                console.error('Error loading resources:', error);
            }
        }

        /**
         * Initializes and loads the ixmaps map application.
         *
         * This function sets up the map configuration, including the map service, type, SVG map,
         * map size, controls, and initial view. It also defines event handlers and themes for the map.
         */     
        const __load_map = function(){  

            ixmaps.legendState = 1;
      
            var szMap = null;
            szMap = (szMap && (szMap != "null")) ? szMap : szDefaultMap;
            map = new ixmaps.map("ixmap", {
                mapService: "leaflet",
                maptype: "ArcGIS - Topo", //decodeURIComponent($(document).getUrlParam('maptype')),
                svg: szMap,
                mapsize: "fullscreen",
                footer: ixmaps.footer || 0,
                mode: szSvgLegendFlag,
                controls: szControls,
                silent: true
            });
            var oldReady = ixmaps.onMapReady;
            ixmaps.onMapReady = function () {

                if (oldReady) {
                    oldReady();
                }
                ixmaps.map().setOptions({
                    featurescaling: "true",
                    objectscaling: "dynamic",
                    normalSizeScale: "50000000",
                    dynamicScalePow: "3",
                    flushChartDraw: "1000000",
                    basemapopacity: "0.8",
                    hideOnPan: "false",
                    freezeOnPan: "false"
                });
                ixmaps.map().setView({
                    center: {
                        lat: "49.2560066833692",
                        lng: "12.379353078373342"
                    },
                    zoom: "4.5"
                });
                //ixmaps.newTheme("test",theme);
                ixmaps.newTheme("test", __eventi);
            };


            // set attribution (bottom left on map space)

            var attribution = "test of ixmaps-mono";
            //document.getElementById("attribution").innerHTML((attribution && (attribution != "null")) ?
            //    attribution : "");

            ixmaps.attribution = attribution;
            ixmaps.date = null;
            ixmaps.parent = null;

            // set sync mode ?

            ixmaps.fSyncMap = true;

            ixmaps.setAutoSwitchInfo(true);

            // show/hide toolsbar elements
            //__switchBannerElements();
            setTimeout("__switchBannerElements()", 5000);

            htmlMap_enableScrollWheelZoom();

        };

        /**
        document.addEventListener("contextmenu", function (e) {
            e.preventDefault();
            e.stopPropagation();
            $("#contextmenu")[0].style.left = e.pageX - 20 + 'px';
            $("#contextmenu")[0].style.top = e.pageY - 20 + 'px';
            $("#contextmenu").show();
            return true;
        });
        **/
        
        var __contextMenuTrigger = null;
        __contextmenuOver = function (el) {
            clearTimeout(__contextMenuTrigger);
            __contextMenuTrigger = true;
        }

        __contextmenuOut = function (el) {
            __contextMenuTrigger = setTimeout("$('#contextmenu').hide()", 100);
        }

        // ------------------------------------------- 
        // END search tool 
        // ------------------------------------------- 

        // try to get a ixmaps API from opener or parent
        // --------------------------
        try {
            if (window.opener) {
                ixmaps.parentApi = window.opener.ixmaps;
                ixmaps.szName = window.opener.name;
            } else
            if (parent) {
                ixmaps.parentApi = parent.window.ixmaps;
                ixmaps.szName = parent.window.name;
            }
        } catch (e) {}

        // register the embedded map
        // --------------------------
        // in case the parent page holds more than one embedded map,
        // we can sync them if parameter name is given
        /***
        ixmaps.szPath = $(location).attr('pathname');
        if (ixmaps.parentApi) {
            try {
                ixmaps.parentApi.registerMap(ixmaps, ixmaps.szName || "map", window);
            } catch (e) {}
        }
        ***/
        // ====================
        // create the map app
        // ====================

        // Call the function with the list of file URLs and types
        loadResources(fileUrls,__load_map);

 
        
        

    }());
</script>

</html>