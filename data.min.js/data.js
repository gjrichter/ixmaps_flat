/*
 CC BY SA
 @license MIT
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,l,k){d!=Array.prototype&&d!=Object.prototype&&(d[l]=k.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var d=0;return function(l){return $jscomp.SYMBOL_PREFIX+(l||"")+d++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var l=0;return $jscomp.iteratorPrototype(function(){return l<d.length?{done:!1,value:d[l++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.makeIterator=function(d){$jscomp.initSymbolIterator();var l=d[Symbol.iterator];return l?l.call(d):$jscomp.arrayIterator(d)};$jscomp.arrayFromIterator=function(d){for(var l,k=[];!(l=d.next()).done;)k.push(l.value);return k};$jscomp.arrayFromIterable=function(d){return d instanceof Array?d:$jscomp.arrayFromIterator($jscomp.makeIterator(d))};
$jscomp.findInternal=function(d,l,k){d instanceof String&&(d=String(d));for(var r=d.length,v=0;v<r;v++){var w=d[v];if(l.call(k,w,v,d))return{i:v,v:w}}return{i:-1,v:void 0}};$jscomp.polyfill=function(d,l,k,r){if(l){k=$jscomp.global;d=d.split(".");for(r=0;r<d.length-1;r++){var v=d[r];v in k||(k[v]={});k=k[v]}d=d[d.length-1];r=k[d];l=l(r);l!=r&&null!=l&&$jscomp.defineProperty(k,d,{configurable:!0,writable:!0,value:l})}};
$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(d,k){return $jscomp.findInternal(this,d,k).v}},"es6","es3");$jscomp.iteratorFromArray=function(d,l){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var k=0,r={next:function(){if(k<d.length){var v=k++;return{value:l(v,d[v]),done:!1}}r.next=function(){return{done:!0,value:void 0}};return r.next()}};r[Symbol.iterator]=function(){return r};return r};
$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6","es3");$jscomp.polyfill("Array.prototype.entries",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d,k){return[d,k]})}},"es6","es3");
$jscomp.polyfill("Array.from",function(d){return d?d:function(d,k,r){$jscomp.initSymbolIterator();k=null!=k?k:function(d){return d};var l=[],w=d[Symbol.iterator];if("function"==typeof w)for(d=w.call(d);!(w=d.next()).done;)l.push(k.call(r,w.value));else{w=d.length;for(var z=0;z<w;z++)l.push(k.call(r,d[z]))}return l}},"es6","es3");
$jscomp.checkStringArgs=function(d,l,k){if(null==d)throw new TypeError("The 'this' value for String.prototype."+k+" must not be null or undefined");if(l instanceof RegExp)throw new TypeError("First argument to String.prototype."+k+" must not be a regular expression");return d+""};
$jscomp.polyfill("String.prototype.repeat",function(d){return d?d:function(d){var k=$jscomp.checkStringArgs(this,null,"repeat");if(0>d||1342177279<d)throw new RangeError("Invalid count value");d|=0;for(var l="";d;)if(d&1&&(l+=k),d>>>=1)k+=k;return l}},"es6","es3");$jscomp.stringPadding=function(d,l){d=void 0!==d?String(d):" ";return 0<l&&d?d.repeat(Math.ceil(l/d.length)).substring(0,l):""};
$jscomp.polyfill("String.prototype.padStart",function(d){return d?d:function(d,k){var l=$jscomp.checkStringArgs(this,null,"padStart");return $jscomp.stringPadding(k,d-l.length)+l}},"es8","es3");$jscomp.polyfill("Object.is",function(d){return d?d:function(d,k){return d===k?0!==d||1/d===1/k:d!==d&&k!==k}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(d){return d?d:function(d,k){var l=this;l instanceof String&&(l=String(l));var v=l.length;for(k=k||0;k<v;k++)if(l[k]==d||Object.is(l[k],d))return!0;return!1}},"es7","es3");$jscomp.polyfill("String.prototype.includes",function(d){return d?d:function(d,k){return-1!==$jscomp.checkStringArgs(this,d,"includes").indexOf(d,k||0)}},"es6","es3");
$jscomp.polyfill("Array.prototype.values",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d,k){return k})}},"es6","es3");
(function(d,l,k){function r(){var a=d.Data;h.noConflict=function(){d.Data=a;return this};d.Data=h}var v=new Date;_LOG=function(a){console.log("_LOG: time[sec.ms] "+(new Date-v)/1E3+"\n"+a)};var w=function(a){return a&&"undefined"!=typeof a?"[object Array]"===Object.prototype.toString.call(a)?a:String(a).match(/\|/)?String(a).split("|"):String(a).split(","):[]},z=function(a,b,c){return c.indexOf(a)===b},h={version:"1.54",errors:[]};"object"===typeof module&&"object"===typeof module.exports?module.exports=
h:"function"===typeof define&&define.amd&&define(h);"undefined"!==typeof d&&r();h.Object=function(a){this.options=a;this.debug=!1};h.Object.prototype={import:function(a){this.options.success=this.options.success||a;console.log("xxxxxxxxxxxxxxxxxxxxxxxx");console.log(this.options.success);console.log("xxxxxxxxxxxxxxxxxxxxxxxx");this.feed=h.feed({});this.feed.options=this.options;"csv"==this.options.type||"CSV"==this.options.type?this.feed.__processCSVData(this.options.source,this.options):"rss"==this.options.type||
"RSS"==this.options.type?(this.options.format="xml",this.feed.__processRSSData(this.options.source,this.options)):"kml"==this.options.type||"KML"==this.options.type?(this.options.format="xml",this.feed.__processKMLData(this.options.source,this.options)):"gml"==this.options.type||"GML"==this.options.type?(this.options.format="xml",this.feed.__processGMLData(this.options.source,this.options)):"json"==this.options.type||"JSON"==this.options.type||"Json"==this.options.type?this.feed.__processJsonData(this.options.source,
this.options):"geojson"==this.options.type||"GEOJSON"==this.options.type||"GeoJson"==this.options.type?this.feed.__processGeoJsonData(this.options.source,this.options):"topojson"==this.options.type||"TOPOJSON"==this.options.type||"TopoJson"==this.options.type?this.feed.__processTopoJsonData(this.options.source,this.options):"jsonDB"==this.options.type||"JSONDB"==this.options.type||"JsonDB"==this.options.type||"jsondb"==this.options.type?this.feed.__processJsonDBData(this.options.source,this.options):
"parquet"==this.options.type||"PARQUET"==this.options.type?this.options.source instanceof ArrayBuffer&&(_LOG("Processing parquet ArrayBuffer directly: "+this.options.source.byteLength+" bytes"),this.feed.__processParquetData(this.options.source,this.options)):("geoparquet"==this.options.type||"GEOPARQUET"==this.options.type)&&this.options.source instanceof ArrayBuffer&&(_LOG("Processing geoparquet ArrayBuffer directly: "+this.options.source.byteLength+" bytes"),this.feed.__processGeoParquetData(this.options.source,
this.options));return this},error:function(a){this.options.error=a;return this}};h.Import=function(a){this.options=a;this.debug=!1};h.Feed=function(a){this.options=a||{};this.debug=!1;this.options.error=function(a){h.errors.push(a)}};h.Feed.prototype={load:function(a){this.options.success=a;var b=this.options,c=b.source||b.src||b.url||b.ext;"undefined"===typeof b.cache&&(b.cache=!0,b.options&&"undefined"!==typeof b.options.cache&&(b.cache=b.options.cache));var e=this;c||q("Data.feed(...).load(): no source defined !",
2E3);"csv"==b.type||"CSV"==b.type?this.__doCSVImport(c,b):"rss"==b.type||"RSS"==b.type?this.__doRSSImport(c,b):"kml"==b.type||"KML"==b.type?this.__doKMLImport(c,b):"gml"==b.type||"GML"==b.type?this.__doGMLImport(c,b):"json"==b.type||"JSON"==b.type||"Json"==b.type?this.__doJSONImport(c,b):"geojson"==b.type||"GEOJSON"==b.type||"GeoJson"==b.type?this.__doGeoJSONImport(c,b):"topojson"==b.type||"TOPOJSON"==b.type||"TopoJson"==b.type?this.__doTopoJSONImport(c,b):"jsonDB"==b.type||"JSONDB"==b.type||"JsonDB"==
b.type||"jsondb"==b.type?this.__doJsonDBImport(c,b):"jsonstat"==b.type||"jsonStat"==b.type||"JSONSTAT"==b.type?$.getScript("http://json-stat.org/lib/json-stat.js").done(function(a,f){e.__doLoadJSONstat(c,b)}).fail(function(a,c,e){q("'"+b.type+"' unknown format !")}):"parquet"==b.type||"PARQUET"==b.type?this.__doParquetImport(c,b):q("'"+b.type+"' unknown format !");return this},error:function(a){this.options.error=a;return this}};h.feed=function(a){return new h.Feed(a)};h.object=function(a){return new h.Object(a)};
h.import=function(a){return(new h.Object(a)).import().feed.dbtable};h.Feed.prototype.__doLoadJSONstat=function(a,b){var c=this;JSONstat(a,function(){for(var a=[],m=[this.Dataset(0).Dimension(0).label],f=this.Dataset(0).Dimension(1).id,g=0;g<f.length;g++)m.push(this.Dataset(0).Dimension(1).Category(f[g]).label);a.push(m);for(f=0;f<this.Dataset(0).Dimension(0).length;f++){m=[];m.push(this.Dataset(0).Dimension(0).Category(this.Dataset(0).Dimension(0).id[f]).label);for(g=0;g<this.Dataset(0).Dimension(1).length;g++)m.push(this.Dataset(0).Data([f,
g]).value);a.push(m)}b.callback?b.callback(a,b):c.__createDataTableObject(a,b.type,b)})};h.Feed.prototype.__doJsonDBImport=function(a,b){_LOG("__doJsonDBImport: "+a);var c=this;b.url=a;$.getScript(a+".gz").done(function(a,m){c.__processJsonDBData(a,b)}).fail(function(e,m,f){$.getScript(a).done(function(a,e){c.__processJsonDBData(a,b)}).fail(function(b,e,m){c.options.error&&c.options.error('"'+a+'" '+m)})})};h.Feed.prototype.__processJsonDBData=function(a,b){_LOG("__processJsonDBData:");this.dbtable=
new h.Table;"string"==typeof a?(a=b.source.split(/\//).pop().split(/\./)[0],a="undefined"!==typeof d?d[a]:global[a]):a=b.source;this.dbtable.table=a.table;this.dbtable.fields=a.fields;this.dbtable.records=a.records;b.callback?b.callback(newData,b):"undefined"!=typeof b&&b.success&&b.success(this.dbtable)};h.Feed.prototype.__doCSVImport=function(a,b){_LOG("__doCSVImport: "+a);var c=this;$.ajax({type:"GET",url:a,cache:b.cache,dataType:"text",success:function(a){c.__processCSVData(a,b)},error:function(c,
m,f){"undefined"!=typeof b&&b.error&&b.error('"'+a+'" '+f)}})};h.Feed.prototype.__processCSVData=function(a,b){_LOG("__processCSVData - start");if("undefined"===typeof Papa){_LOG("__processCSVData:load csv parser!");var c=this;$.getScript("https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js").done(function(e,m){c.__processCSVData(a,b)}).fail(function(a,c,e){q("'"+b.type+"' parser not loaded !");b.error&&b.error("'"+b.type+"' parser not loaded !")});return!1}var e=Papa.parse(a,
b.parser);if(e.errors.length)return q("csv parsing error: "+e.errors.map(function(a){return a.message}).join(";")),b.error&&b.error("csv parsing error: "+e.errors.map(function(a){return a.message}).join(";")),!1;e=e.data;if(2>e.length||"undefined"===typeof e[0]||"undefined"===typeof e[1])return q("csv parsing error: insufficient rows in data !"),b.error&&b.error("csv parsing error: insufficient rows in data !"),!1;if(!(b.parser&&b.parser.delimiter||e[0].length===e[1].length)){_LOG("csv parser: autodetect failed");
for(var m=!1,f=$jscomp.makeIterator([";",","]),g=f.next();!g.done;g=f.next()){g=g.value;_LOG("csv parser: delimiter = "+g);e=Papa.parse(a,{delimiter:g}).data;if(e[0].length===e[1].length){m=!0;break}_LOG("csv parser: delimiter = "+g+" failed")}if(!m)return q("csv parsing error: unable to auto detect delimiter!"),b.error&&b.error("csv parsing error: unable to auto detect delimiter!"),!1}e[e.length-1].length!==e[0].length&&1<e.length&&e.pop();1===e[0].length-e[1].length&&""===e[0][e[0].length-1].trim()&&
e[0].pop();if(b.callback)return b.callback(e,b),!1;_LOG("__createDataTableObject: "+(b.options?" -> "+b.options.name:""));this.__createDataTableObject(e,b.type,b);return!1};h.Feed.prototype.__doRSSImport=function(a,b){_LOG("__doRSSImport: "+a);var c=this;b.format="xml";$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){c.__processRSSData(a,b)},error:function(a,c,f){"undefined"!=typeof b&&b.error&&b.error(a,c,f)}})};h.Feed.prototype.__processRSSData=function(a,b){"xml"==b.format&&($(a).find("rss").length?
this.__parseRSSData(a,b):$(a).find("feed").length?q("feed not yet supported"):$(a).find("atom").length&&q("atom not yet supported"))};h.Feed.prototype.__parseRSSData=function(a,b){var c=this;"xml"==b.format&&$(a).find("channel").each(function(){var e=[],m=null;$(a).find("item").each(function(){if(!m){var a=[];m=[];for(var b=$(this).children(),c=0;c<b.length;c++){for(var d=$(this).children()[c].nodeName;a[d];)d+="*";a[d]=d;m[c]=d}e.push(m)}a=[];for(b=0;b<m.length;b++)"enclosure"==m[b]?a.push($(this).find(m[b]+
":first").attr("url")||""):a.push($(this).find(m[b]+":first").text()||"");e.push(a)});c.__createDataTableObject(e,"rss",b)})};h.Feed.prototype.__doKMLImport=function(a,b){_LOG("__doKMLImport: "+a);var c=this;b.format="xml";$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){c.__processKMLData(a,b)},error:function(a,c,f){"undefined"!=typeof b&&b.error&&b.error(a,c,f)}})};h.Feed.prototype.__doGMLImport=function(a,b){_LOG("__doGMLImport: "+a);var c=this;b.format="xml";$.ajax({type:"GET",url:a,
dataType:"xml",success:function(a){c.__processGMLData(a,b)},error:function(a,c,f){"undefined"!=typeof b&&b.error&&b.error(a,c,f)}})};h.Feed.prototype.__processKMLData=function(a,b){"xml"==b.format&&($(a).find("kml").length?this.__parseKMLData(a,b):q("feed not kml"))};h.Feed.prototype.__parseKMLData=function(a,b){if("xml"==b.format){var c=[],e=null;$(a).find("Document").find("Placemark").each(function(){var a=$(this).find("ExtendedData")||$(this);e||(e=[],a.find("Data").each(function(){e.push($(this).attr("name"))}),
$(this).find("Point").find("coordinates")&&e.push("KML.Point"),c.push(e));var b=[];a.find("Data").each(function(){b.push($(this).find("value").text())});$(this).find("Point").find("coordinates")&&b.push($(this).find("Point").find("coordinates").text());c.push(b)});this.__createDataTableObject(c,"kml",b)}};h.Feed.prototype.__processGMLData=function(a,b){"xml"==b.format&&("string"===typeof a&&(parser=new DOMParser,a=parser.parseFromString(a,"text/xml")),console.log(a),console.log($(a).find("wfs\\:FeatureCollection, gml\\:FeatureCollection, FeatureCollection")),
$(a).find("wfs\\:FeatureCollection, gml\\:FeatureCollection, FeatureCollection").length?this.__parseGMLData(a,b):q("feed not gml"))};h.Feed.prototype.__parseGMLData=function(a,b){if("xml"==b.format)if(a=$(a).find("wfs\\:FeatureCollection, FeatureCollection").first(),0===a.length)q("No FeatureCollection found in GML data");else{var c=[],e=null;a.find("wfs\\:member, gml\\:featureMember, featureMember, gml\\:featureMembers, featureMembers").each(function(){var a=$(this).find("gml\\:*, *").first();if(0!==
a.length){e||(e=[],a.find("gml\\:*, *").each(function(){var a=$(this).prop("tagName");a&&!a.match(/^(gml:)?(boundedBy|location|pos|coordinates|geometry|geometryProperty)$/i)&&e.push(a.replace(/^gml:/,""))}),e.push("GML.Geometry"),c.push(e));var b=[];a.find("gml\\:*, *").each(function(){var a=$(this).prop("tagName");a&&!a.match(/^(gml:)?(boundedBy|location|pos|coordinates|geometry|geometryProperty)$/i)&&b.push($(this).text())});var g=a.find("gml\\:Polygon").first();if(0<g.length){a='{"type":"Polygon","coordinates":[[';
g=g.text().split(" ");for(var d=0,h=0;h<g.length;h++)if(Number(g[h])&&!isNaN(Number(g[h]))){d=h;break}console.log("coords:",g);console.log("start:",d);console.log("coords length:",g.length);if(d<g.length-1)for(console.log("coords[start]:",g[d]),console.log("coords[start+1]:",g[d+1]),h=d;h<g.length-1;h+=2)g[h]&&g[h+1]&&!isNaN(Number(g[h]))&&!isNaN(Number(g[h+1]))&&(a+=(h>d?",":"")+"["+g[h+1]+","+g[h]+"]");a+="]]}";console.log("final value:",a);b.push(a)}else b.push("");c.push(b)}});this.__createDataTableObject(c,
"gml",b)}};h.Feed.prototype.__doJSONImport=function(a,b){var c=this;$.get(a,function(a){c.__processJsonData(a,b)}).fail(function(a){"undefined"!=typeof b&&b.error&&b.error(a)})};__getNestedPaths=function(a,b){b=b===k?"":b;var c=[];if("object"!==typeof a||null===a||Array.isArray(a))Array.isArray(a)?a.forEach(function(a,e){c.push.apply(c,[].concat($jscomp.arrayFromIterable(__getNestedPaths(a,b?b+"."+e:String(e)))))}):c.push(b);else for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&c.push.apply(c,
[].concat($jscomp.arrayFromIterable(__getNestedPaths(a[e],b?b+"."+e:e))));return c};__extractValuesRecursive=function(a,b){var c=[];if(null===a||"undefined"===typeof a)c.push("null");else if("object"!==typeof b||null===b||Array.isArray(b))if(Array.isArray(b))for(var e=0;e<b.length;e++)c=c.concat(__extractValuesRecursive(e<a.length?a[e]:k,b[e]));else c.push(a);else for(e in b)if(Object.prototype.hasOwnProperty.call(b,e)){var m=Object.prototype.hasOwnProperty.call(a,e)?a[e]:k;c=c.concat(__extractValuesRecursive(m,
b[e]))}return c};h.Feed.prototype.__processJsonData=function(a,b){var c=null;if("string"==typeof a)try{c=JSON.parse(a)}catch(x){this.__createDataTableObject([],"json",b)}else c=a;this.data=c;var e=[],m=[];if(c&&c.data&&c.data.columns&&c.data.rows){var d=c.data.columns;a=c.data.rows;var g=0;for(c=d.length;g<c;g++)m.push(d[g]);e.push(m);d=0;for(c=a.length;d<c;d++){m=[];g=0;for(var h=a[0].length;g<h;g++)m.push(a[d][g]);e.push(m)}}else{c&&c.data&&(c=c.data);Array.isArray(c)||(__findAllArraysInJson=function(a){function b(a){if(Array.isArray(a))c.push(a);
else if("object"===typeof a&&null!==a)for(var e in a)a.hasOwnProperty(e)&&b(a[e])}var c=[];b(a);return c},c=__findAllArraysInJson(c)[0]);if(!c){e=[];e.push(["unknown type"]);m=a.split("\n");a=0;for(c=m.length;a<c;a++)e.push([m[a]]);this.__createDataTableObject(e,"json",b);return}e.push(__getNestedPaths(c[0]));for(m=0;m<c.length;m++)e.push(__extractValuesRecursive(c[m],c[0]))}this.__createDataTableObject(e,"json",b)};h.Feed.prototype.__doGeoJSONImport=function(a,b){var c=this;$.get(a,function(a){c.__processGeoJsonData(a,
b)}).fail(function(a){"undefined"!=typeof b&&b.error&&b.error(a)})};h.Feed.prototype.__processGeoJsonData=function(a,b){var c=null;if("string"===typeof a)try{c=JSON.parse(a)}catch(p){this.__createDataTableObject([],"json",b);return}else c=a;this.data=c;a=[];var e={};if(c&&c.features&&c.features.length){for(var d=$jscomp.makeIterator(c.features),f=d.next();!f.done;f=d.next())if(f=f.value,f.properties)for(var g in f.properties)e[g]=!0;g=Object.keys(e);g.push("geometry");a.push(g);c=$jscomp.makeIterator(c.features);
for(f=c.next();!f.done;f=c.next()){f=f.value;e=[];d=f.properties||{};for(var h=0;h<g.length-1;h++){var x=d[g[h]];"object"===typeof x?e.push(JSON.stringify(x)):e.push(x!==k?x:"")}e.push(JSON.stringify(f.geometry));a.push(e)}}this.__createDataTableObject(a,"json",b)};h.Feed.prototype.__processGeoJsonData_expandProperty=function(a,b){var c=null;if("string"==typeof a)try{c=JSON.parse(a)}catch(p){this.__createDataTableObject([],"json",b)}else c=a;this.data=c;a=[];var e=[],d=[];if(c&&c.features&&c.features.length){for(var f=
0;f<c.features.length;f++)for(var g in c.features[f].properties)if("string"===typeof c.features[f].properties[g]||"number"===typeof c.features[f].properties[g])d[g]=!0;else for(var h in c.features[f].properties[g])d[g+"."+h]=!0;for(var k in d)e.push(k);e.push("geometry");a.push(e);for(g=0;g<c.features.length;g++){e=[];for(h=0;h<a[0].length-1;h++)k=a[0][h].split("."),2<=k.length?e.push(c.features[g].properties[k[0]][k[1]]||""):e.push(c.features[g].properties[a[0][h]]||"");e.push(JSON.stringify(c.features[g].geometry));
a.push(e)}}this.__createDataTableObject(a,"json",b)};h.Feed.prototype.__doTopoJSONImport=function(a,b){var c=this;$.get(a,function(a){c.__processTopoJsonData(a,b)}).fail(function(a){"undefined"!=typeof b&&b.error&&b.error(a)})};h.Feed.prototype.__processTopoJsonData=function(a,b){if("undefined"==typeof topojson)q("'"+b.type+"' parser not loaded !");else{var c=null;if("string"==typeof a)try{c=JSON.parse(a)}catch(f){this.__createDataTableObject([],"json",b)}else c=a;this.data=c;a=null;if(b.options&&
b.options.name&&c.objects[b.options.name])a=topojson.feature(c,c.objects[b.options.name]);else for(var e in c.objects){a=topojson.feature(c,c.objects[e]);break}for(var d in a.features)a.features[d].properties.id=a.features[d].id;this.__processGeoJsonData(a,b)}};h.Feed.prototype.__doParquetImport=function(a,b){_LOG("__doParquetImport: "+a);var c=this;_LOG("Attempting to load parquet file using Fetch API...");fetch(a,{method:"GET",cache:b.cache?"default":"no-cache"}).then(function(a){_LOG("Fetch response received, status: "+
a.status);_LOG("Response headers: "+JSON.stringify([].concat($jscomp.arrayFromIterable(a.headers.entries()))));if(!a.ok)throw Error("HTTP "+a.status+": "+a.statusText);return a.arrayBuffer()}).then(function(a){_LOG("Successfully loaded parquet as ArrayBuffer: "+a.byteLength+" bytes");var e=new Uint8Array(a);if(4<=e.length){var d=String.fromCharCode.apply(String,[].concat($jscomp.arrayFromIterable(e.slice(0,4))));_LOG("Magic number: "+d);"PAR1"===d?_LOG("\u2705 SUCCESS: Valid parquet file detected!"):
(_LOG("\u26a0\ufe0f Warning: Magic number is not PAR1: "+d),_LOG("First 16 bytes: "+Array.from(e.slice(0,16)).map(function(a){return a.toString(16).padStart(2,"0")}).join(" ")),_LOG("Attempting to process anyway..."))}else _LOG("\u26a0\ufe0f Warning: Response too short to check magic number");c.__processParquetData(a,b)}).catch(function(e){_LOG("Fetch failed: "+e.message);_LOG("Falling back to XMLHttpRequest...");c.__loadParquetWithXHR(a,b)})};h.Feed.prototype.__loadParquetWithXHR=function(a,b){var c=
this;_LOG("Loading parquet with XMLHttpRequest...");var e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){if(200===e.status){var a=e.response;_LOG("XHR successful: "+a.byteLength+" bytes");var d=new Uint8Array(a);if(4<=d.length){var g=String.fromCharCode.apply(String,[].concat($jscomp.arrayFromIterable(d.slice(0,4))));_LOG("XHR magic number: "+g);"PAR1"===g?_LOG("\u2705 SUCCESS: Valid parquet file via XHR!"):(_LOG("\u26a0\ufe0f Warning: XHR magic number is not PAR1: "+
g),_LOG("First 16 bytes: "+Array.from(d.slice(0,16)).map(function(a){return a.toString(16).padStart(2,"0")}).join(" ")),_LOG("Attempting to process anyway..."))}else _LOG("\u26a0\ufe0f Warning: XHR response too short to check magic number");c.__processParquetData(a,b)}else _LOG("XHR failed with status: "+e.status+" "+e.statusText),"undefined"!==typeof b&&b.error?b.error("XHR failed: "+e.status+" "+e.statusText):q("XHR failed: "+e.status+" "+e.statusText)};e.onerror=function(){_LOG("XHR network error");
"undefined"!==typeof b&&b.error?b.error("XHR network error"):q("XHR network error")};e.send()};h.Feed.prototype.__checkGeoParquetMetadata=function(a,b,c,e){try{if(console.log("\ud83d\udd0d Checking GeoParquet metadata with existing hyparquet..."),"function"===typeof b.parquetMetadataAsync)console.log("\ud83d\udcca Using parquetMetadataAsync method"),b.parquetMetadataAsync(a).then(function(a){console.log("\ud83d\udcca Metadata received:",a);var b=!1;a&&a.key_value_metadata&&(console.log("\ud83d\udcca Schema metadata found:",
a.key_value_metadata),a.key_value_metadata.some(function(a){return"geo"===a.key||a.key.toLowerCase().includes("geo")})&&(console.log("\u2705 GeoParquet detected via metadata geo key"),b=!0));!b&&a&&a.schema&&a.schema.fields&&(console.log("\ud83d\udcca Schema fields found:",a.schema.fields),a.schema.fields.some(function(a){return a.type&&(a.type.toLowerCase().includes("geometry")||a.type.toLowerCase().includes("geography")||a.type.toLowerCase().includes("point")||a.type.toLowerCase().includes("polygon")||
a.type.toLowerCase().includes("linestring"))})&&(console.log("\u2705 GeoParquet detected via field types"),b=!0));if(!b&&a&&a.schema&&a.schema.fields){var e=["geometry","geom","the_geom","wkb_geometry","shape"];a.schema.fields.some(function(a){return e.some(function(b){return a.name&&a.name.toLowerCase().includes(b.toLowerCase())})})&&(console.log("\u2705 GeoParquet detected via column names"),b=!0)}console.log("\ud83c\udfaf GeoParquet detection result:",b);c(b)}).catch(function(a){console.warn("Error reading parquet metadata:",
a);c(!1)});else{console.log("\ud83d\udcca parquetMetadataAsync not available, trying fallback methods");try{var d=b.parquetReadObjects({file:a,rowStart:0,rowEnd:1,compressors:b.compressors});if(d&&0<d.length){var f=d[0];console.log("\ud83d\udcca Sample row columns:",Object.keys(f));["geometry","geom","the_geom","wkb_geometry","shape"].some(function(a){return f.hasOwnProperty(a)})?(console.log("\u2705 GeoParquet detected via column names"),c(!0)):c(!1)}else c(!1)}catch(g){console.warn("Error in fallback detection:",
g),c(!1)}}}catch(g){console.warn("Error detecting GeoParquet metadata:",g),c(!1)}};h.Feed.prototype.__processParquetData=function(a,b){console.log("\ud83d\ude80 Starting parquet processing...");_LOG("Processing parquet data...");"undefined"!==typeof d.hyparquet?(console.log("\ud83d\udce6 Using existing hyparquet module"),this.__processParquetWithHyparquet(a,b,d.hyparquet)):(console.log("\ud83d\udce6 Loading hyparquet module..."),this.__loadHyparquetAndProcess(a,b))};h.Feed.prototype.__processParquetWithHyparquet=
function(a,b,c){var e=this;console.log("\ud83d\udd0d Starting GeoParquet detection with loaded hyparquet...");_LOG("Detecting if parquet file is GeoParquet...");e.__checkGeoParquetMetadata(a,c,function(d){console.log("\ud83c\udfaf GeoParquet detection result:",d);d?(_LOG("\u2705 GeoParquet detected! Switching to GeoParquet processing..."),console.log("\ud83c\udfaf Branching to GeoParquet processing"),"function"===typeof e.__processGeoParquetData?e.__processGeoParquetData(a,b):(_LOG("\u26a0\ufe0f GeoParquet processing function not found, falling back to regular parquet processing"),
console.log("\u26a0\ufe0f GeoParquet function not found, using regular processing"),e.__processWithHyparquet(a,b,c))):(_LOG("\u2705 Regular parquet file detected, proceeding with standard processing..."),console.log("\ud83c\udfaf Branching to regular parquet processing"),e.__processWithHyparquet(a,b,c))},function(d){_LOG("\u26a0\ufe0f Error detecting GeoParquet, falling back to regular parquet processing: "+d);console.error("\u274c Detection error:",d);e.__processWithHyparquet(a,b,c)})};h.Feed.prototype.__loadHyparquetAndProcess=
function(a,b){var c=this;_LOG("Loading hyparquet module dynamically...");var e=l.createElement("script");e.type="module";e.textContent='\n            import * as hyparquet from "https://cdn.jsdelivr.net/npm/hyparquet@1.8.0/src/hyparquet.min.js";\n            import * as compressors from "https://cdn.jsdelivr.net/npm/hyparquet-compressors@1.1.1/+esm";\n            \n            console.log("Hyparquet module imported:", hyparquet);\n            console.log("Available hyparquet methods:", Object.keys(hyparquet));\n            \n            console.log("Compressor module imported:", compressors);\n            console.log("Available compressors methods:", Object.keys(compressors));\n            console.log("Full compressors object:", compressors);\n            \n            \n            // Create a wrapper object that includes both hyparquet and compressors\n            const hyparquetWithCompressors = {\n                ...hyparquet,\n                compressors: null\n            };\n            \n            // Try to attach compressors to the wrapper\n            if (compressors && compressors.compressors) {\n                hyparquetWithCompressors.compressors = compressors.compressors;\n                console.log("\u2705 ZSTD compressors attached to wrapper");\n                console.log("Available compressors:", Object.keys(compressors.compressors));\n            } else if (compressors && compressors.default && compressors.default.compressors) {\n                hyparquetWithCompressors.compressors = compressors.default.compressors;\n                console.log("\u2705 ZSTD compressors attached to wrapper (default export)");\n                console.log("Available compressors:", Object.keys(compressors.default.compressors));\n            } else {\n                console.log("\u26a0\ufe0f Compressors structure:", Object.keys(compressors));\n                // Try to find compressors in the module\n                for (const key in compressors) {\n                    if (compressors[key] && typeof compressors[key] === \'object\' && compressors[key].zstd) {\n                        hyparquetWithCompressors.compressors = compressors[key];\n                        console.log("\u2705 Found compressors in:", key);\n                        break;\n                    }\n                }\n            }\n           \n            window.hyparquet = hyparquetWithCompressors;\n            window.compressors = compressors;\n            window.hyparquetLoaded = true;\n            console.log("Hyparquet wrapper with compressors loaded and set to window.hyparquet");\n        ';
var m=setInterval(function(){d.hyparquetLoaded&&d.hyparquet&&(clearInterval(m),_LOG("Hyparquet module loaded successfully"),c.__processParquetWithHyparquet(a,b,d.hyparquet))},100);setTimeout(function(){d.hyparquetLoaded||(clearInterval(m),_LOG("Failed to load hyparquet module"),"undefined"!==typeof b&&b.error?b.error("Failed to load hyparquet module"):q("Failed to load hyparquet module"))},1E4);l.head.appendChild(e)};h.Feed.prototype.__processWithHyparquet=function(a,b,c){try{_LOG("Processing parquet data with hyparquet, buffer size: "+
a.byteLength+" bytes");_LOG("Hyparquet object: "+JSON.stringify(c));_LOG("Available hyparquet methods: "+Object.keys(c).join(", "));if(4>a.byteLength)throw Error("File too small to be a valid parquet file");var e=new Uint8Array(a),m=String.fromCharCode.apply(String,[].concat($jscomp.arrayFromIterable(e.slice(0,4))));_LOG("Parquet file magic number: "+m);_LOG("Parquet file size: "+a.byteLength+" bytes");_LOG("First 16 bytes: "+Array.from(e.slice(0,16)).map(function(a){return a.toString(16).padStart(2,
"0")}).join(" "));_LOG("Buffer analysis:");_LOG("  - Total bytes: "+a.byteLength);_LOG("  - Last 16 bytes: "+Array.from(e.slice(-16)).map(function(a){return a.toString(16).padStart(2,"0")}).join(" "));_LOG("  - Buffer constructor: "+a.constructor.name);_LOG("  - Is ArrayBuffer: "+(a instanceof ArrayBuffer));if("PAR1"!==m)throw Error("File does not appear to be a valid parquet file (missing PAR1 magic number). Magic: "+m);_LOG("Valid parquet file detected, processing with hyparquet...");if("function"!==
typeof c.parquetReadObjects)throw Error("parquetReadObjects method not found in hyparquet. Available methods: "+Object.keys(c).join(", "));_LOG("Calling hyparquet.parquetReadObjects...");_LOG("Available hyparquet methods: "+Object.keys(c).join(", "));try{_LOG("Using original ArrayBuffer, size: "+a.byteLength+" bytes");_LOG("ArrayBuffer constructor: "+a.constructor.name);_LOG("ArrayBuffer isView: "+ArrayBuffer.isView(a));_LOG("ArrayBuffer byteLength: "+a.byteLength);if(!(a instanceof ArrayBuffer))throw Error("parquetBuffer is not an ArrayBuffer: "+
typeof a);if("function"===typeof c.parquetReadObjects){_LOG("Using parquetReadObjects method with ArrayBuffer...");c.compressors?(_LOG("\u2705 Compressors available: "+Object.keys(c.compressors).join(", ")),c.compressors.zstd&&(_LOG("\u2705 ZSTD compression supported!"),_LOG("ZSTD compressor details:",c.compressors.zstd)),_LOG("Full compressors object:",c.compressors)):(_LOG("\u26a0\ufe0f No compressors available - ZSTD files may not work"),_LOG("Hyparquet object keys:",Object.keys(c)),_LOG("Window compressors available:",
d.compressors?Object.keys(d.compressors):"None"));var f=null;c.compressors?(f=c.compressors,_LOG("Using compressors from hyparquet.compressors")):d.compressors&&d.compressors.compressors?(f=d.compressors.compressors,_LOG("Using compressors from window.compressors.compressors")):d.compressors&&d.compressors.default&&d.compressors.default.compressors?(f=d.compressors.default.compressors,_LOG("Using compressors from window.compressors.default.compressors")):_LOG("\u26a0\ufe0f No compressors found anywhere - ZSTD files will fail");
var g=c.parquetReadObjects({file:a,rowStart:0,rowEnd:1E5,compressors:f})}else if("function"===typeof c.read)_LOG("Using read method with ArrayBuffer..."),g=c.read(a);else if("function"===typeof c.parse)_LOG("Using parse method with ArrayBuffer..."),g=c.parse(a);else{e=!1;f=$jscomp.makeIterator(["readParquet","parseParquet","load","fromBuffer"]);for(var h=f.next();!h.done;h=f.next()){var l=h.value;if("function"===typeof c[l]){_LOG("Using "+l+" method with ArrayBuffer...");g=c[l](a);e=!0;break}}if(!e)throw Error("No suitable hyparquet method found. Available: "+
Object.keys(c).join(", "));}_LOG("Method result type: "+typeof g);_LOG("Method result: "+JSON.stringify(g));_LOG("Method result constructor: "+(g?g.constructor.name:"null/undefined"));if(null===g||g===k)throw Error("Method returned null or undefined");}catch(t){throw _LOG("Error calling hyparquet method: "+t),Error("Failed to call hyparquet method: "+t);}if(g&&"function"===typeof g.then){_LOG("Result is a Promise, waiting for resolution...");var p=this;g.then(function(a){try{if(!Array.isArray(a))throw Error("Expected rows to be an array, got: "+
typeof a);if(0===a.length)throw Error("No rows found in parquet file");if(!a[0]||"object"!==typeof a[0])throw Error("First row is not a valid object: "+JSON.stringify(a[0]));var c=Object.keys(a[0]);_LOG("Extracted columns: "+c.join(", "));if(0===c.length)throw Error("No columns found in first row");for(var e=[],d=0;d<a.length;d++){for(var f=[],g=0;g<c.length;g++){var m=a[d][c[g]];null===m||m===k?f.push(""):"object"===typeof m&&m.toDate?f.push(m.toDate().toISOString()):"object"===typeof m?f.push(JSON.stringify(m)):
f.push(String(m))}e.push(f)}_LOG("Converted "+e.length+" rows with "+c.length+" columns");a=[c];a.push.apply(a,[].concat($jscomp.arrayFromIterable(e)));console.log(b);p.__createDataTableObject(a,"parquet",b)}catch(B){throw _LOG("Error in rows processing: "+B),Error("Error processing parquet rows: "+B);}}).catch(function(a){_LOG("Error in hyparquet method: "+a);_LOG("Error stack: "+a.stack);_LOG("Error message: "+a.message);throw Error("Error reading parquet data: "+a);})}else{_LOG("Result is not a Promise, treating as direct return");
c=g;_LOG("Direct return rows type: "+typeof c);_LOG("Direct return rows value: "+JSON.stringify(c));_LOG("Direct return rows constructor: "+(c?c.constructor.name:"null/undefined"));_LOG("Direct return rows length: "+(c?c.length:"N/A"));try{_LOG("Parquet data read successfully (direct return), rows type: "+typeof c);_LOG("Rows value: "+JSON.stringify(c));if(!Array.isArray(c))throw Error("Expected rows to be an array, got: "+typeof c);if(0===c.length)throw Error("No rows found in parquet file");_LOG("Number of rows: "+
c.length);_LOG("First row: "+JSON.stringify(c[0]));if(!c[0]||"object"!==typeof c[0])throw Error("First row is not a valid object: "+JSON.stringify(c[0]));var n=Object.keys(c[0]);_LOG("Extracted columns: "+n.join(", "));if(0===n.length)throw Error("No columns found in first row");a=[];for(g=0;g<c.length;g++){f=[];for(h=0;h<n.length;h++){var u=c[g][n[h]];null===u||u===k?f.push(""):"object"===typeof u&&u.toDate?f.push(u.toDate().toISOString()):"object"===typeof u?f.push(JSON.stringify(u)):f.push(String(u))}a.push(f)}_LOG("Converted "+
a.length+" rows with "+n.length+" columns");n=[n];n.push.apply(n,[].concat($jscomp.arrayFromIterable(a)));this.__createDataTableObject(n,"parquet",b)}catch(t){throw _LOG("Error in rows processing: "+t),Error("Error processing parquet rows: "+t);}}}catch(t){_LOG("Error processing parquet data: "+t),"undefined"!==typeof b&&b.error?b.error("Error processing parquet data: "+t):q("Error processing parquet data: "+t)}};h.Feed.prototype.__processGeoParquetData=function(a,b){var c=this;if("undefined"!==typeof d.geoparquet)_LOG("GeoParquet library already loaded, processing data..."),
c.__processWithGeoParquet(a,b,d.geoparquet);else{_LOG("Loading GeoParquet library dynamically...");var e=l.createElement("script");e.type="module";e.textContent='\n                import { asyncBufferFromUrl, toGeoJson } from \'https://cdn.jsdelivr.net/npm/geoparquet@0.5.0/+esm\';\n                \n                console.log("GeoParquet module imported");\n                console.log("Available geoparquet methods:", Object.keys({ asyncBufferFromUrl, toGeoJson }));\n                \n                // Make geoparquet available globally\n                window.geoparquet = { asyncBufferFromUrl, toGeoJson };\n                window.geoparquetLoaded = true;\n            ';
var m=setInterval(function(){d.geoparquetLoaded&&d.geoparquet&&(clearInterval(m),_LOG("GeoParquet module loaded successfully"),c.__processWithGeoParquet(a,b,d.geoparquet))},100);setTimeout(function(){d.geoparquetLoaded||(clearInterval(m),_LOG("Failed to load GeoParquet module"),"undefined"!==typeof b&&b.error?b.error("Failed to load GeoParquet module"):q("Failed to load GeoParquet module"))},1E4);l.head.appendChild(e)}};h.Feed.prototype.__processWithGeoParquet=function(a,b,c){try{_LOG("Processing GeoParquet data, buffer size: "+
a.byteLength+" bytes");_LOG("GeoParquet object: "+JSON.stringify(c));_LOG("Available geoparquet methods: "+Object.keys(c).join(", "));if(4>a.byteLength)throw Error("File too small to be a valid parquet file");var e=new Uint8Array(a),d=String.fromCharCode.apply(String,[].concat($jscomp.arrayFromIterable(e.slice(0,4))));_LOG("Parquet file magic number: "+d);if("PAR1"!==d)throw Error("File does not appear to be a valid parquet file (missing PAR1 magic number). Magic: "+d);_LOG("Valid parquet file detected, processing with geoparquet...");
if("function"!==typeof c.toGeoJson)throw Error("toGeoJson method not found in geoparquet. Available methods: "+Object.keys(c).join(", "));_LOG("Calling geoparquet.toGeoJson...");var f=c.toGeoJson({file:a});_LOG("GeoJSON conversion result type: "+typeof f);_LOG("GeoJSON conversion result: "+JSON.stringify(f));if(f&&"function"===typeof f.then){_LOG("GeoJSON conversion is a Promise, waiting for resolution...");var g=this;f.then(function(a){try{_LOG("GeoJSON conversion completed successfully"),_LOG("GeoJSON type: "+
a.type),_LOG("Number of features: "+(a.features?a.features.length:"unknown")),g.__processGeoJsonData(a,b)}catch(x){throw _LOG("Error processing GeoJSON data: "+x),Error("Error processing GeoJSON data: "+x);}}).catch(function(a){_LOG("Error in GeoJSON conversion: "+a);_LOG("Error stack: "+a.stack);_LOG("Error message: "+a.message);"undefined"!==typeof b&&b.error?b.error("Error converting GeoParquet to GeoJSON: "+a):q("Error converting GeoParquet to GeoJSON: "+a)})}else{_LOG("GeoJSON conversion returned directly");
if(!f)throw Error("GeoJSON conversion returned null or undefined");_LOG("GeoJSON type: "+f.type);_LOG("Number of features: "+(f.features?f.features.length:"unknown"));this.__processGeoJsonData(f,b)}}catch(A){_LOG("Error processing GeoParquet data: "+A),"undefined"!==typeof b&&b.error?b.error("Error processing GeoParquet data: "+A):q("Error processing GeoParquet data: "+A)}};h.Feed.prototype.__createDataTableObject=function(a,b,c){a&&(console.log(a),this.dbtable=(new h.Table).setArray(a),console.log(this.dbtable),
"undefined"!=typeof c&&c.success?c.success(this.dbtable):_LOG("callback to call on succes is 'undefined'!"))};h.Table=function(a){a?(this.table=a.table,this.fields=a.fields,this.records=a.records):(this.table={records:0,fields:0},this.fields=[],this.records=[])};h.Table.prototype={getArray:function(){for(var a=[[]],b=0,c=this.fields.length;b<c;b++)a[0].push(this.fields[b].id);b=0;for(c=this.records.length;b<c;b++)a.push(this.records[b]);return a},setArray:function(a){this.fields=[];for(var b=0,c=
a[0].length;b<c;b++)this.fields.push({id:(a[0][b]||" ").trim(),typ:0,width:60,decimals:0});a.shift();this.records=[];b=0;for(c=a.length;b<c;b++)a[b].length==this.fields.length&&this.records.push(a[b]);this.table={records:this.records.length,fields:this.fields.length};return this},revert:function(){for(var a=[],b=this.records.length-1;0<=b;b--)a.push(this.records[b]);this.records=a;return this},reverse:function(){for(var a=[],b=this.records.length-1;0<=b;b--)a.push(this.records[b]);this.records=a;
return this},columnNames:function(){for(var a=[],b=0,c=this.fields.length;b<c;b++)a.push(this.fields[b].id);return a},columnIndex:function(a){for(var b in this.fields)if(this.fields[b].id==a)return b;return null},column:function(a){for(var b in this.fields)if(this.fields[b].id==a)return a=new h.Column,a.index=b,a.table=this,a;return null},lookupArray:function(a,b){var c="overwrite";a&&a.key&&(c=a.calc||c,b=a.key,a=a.value);var e=[];this.column(b)||alert("'"+b+"' column not found!");this.column(a)||
alert("'"+a+"' column not found!");b=this.column(b).values();a=this.column(a).values();if("sum"==c){var d=0;for(c=b.length;d<c;d++)e[String(b[d])]=(e[String(b[d])]||0)+a[d]}else if("max"==c)for(d=0,c=b.length;d<c;d++)e[String(b[d])]=Math.max(e[String(b[d])]||0,a[d]);else for(d=0,c=b.length;d<c;d++)e[String(b[d])]=a[d];return e},lookupStringArray:function(a,b){a&&a.key&&(b=a.key,a=a.value);var c=[];this.column(b)||alert("'"+b+"' column not found!");this.column(a)||alert("'"+a+"' column not found!");
b=this.column(b).values();a=this.column(a).values();for(var e=0,d=b.length;e<d;e++)c[String(b[e])]=c[String(b[e])]?c[String(b[e])]+", "+a[e]:a[e];return c},lookup:function(a,b){var c=b.value;b=b.lookup;var e=c+"_"+b;this.lookupsA&&this.lookupsA[e]||(this.lookupsA=this.lookupsA||[],this.lookupsA[e]=this.lookupArray(c,b));return this.lookupsA[e][a]||"-"},toKeyValue:function(a){return this.lookupArray(a.value,a.key)},addColumn:function(a,b){if(!a.destination)return alert("'data.addColumn' no destination defined!"),
null;var c=null;if(a.source){for(var e=0,d=this.fields.length;e<d;e++)this.fields[e].id==a.source&&(c=e);if(null==c)return alert("'data.addColumn' source column '"+a.source+"' not found!"),null}this.fields.push({id:String(a.destination),created:!0});this.table.fields++;if(b&&"function"==typeof b)for(a=0,d=this.records.length;a<d;a++)this.records[a].push(null!=c?b(this.records[a][c],this.records[a]):b(this.records[a]));else if(b&&"object"==typeof b)for(a=0,d=this.records.length;a<d;a++)this.records[a].push(b[a]||
0);else if(a.values&&"object"==typeof a.values)for(b=0,d=this.records.length;b<d;b++)this.records[b].push(a.values[b]||0);else for(b=0,d=this.records.length;b<d;b++)this.records[b].push(0);return this},addRow:function(a){if(!a||"object"!==typeof a)return alert("'data.addRow' no options defined!"),null;for(var b=[],c=0,e=this.fields.length;c<e;c++)b.push("");for(var d in a)this.column(d)?b[this.column(d).index]=a[d]:alert("'data.addRow' column '"+d+"' not found!");this.records.push(b);this.table.records++;
return this},filter:function(a){this.selection=new h.Table;for(var b in this.records)a&&a(this.records[b])&&(this.selection.records.push(this.records[b]),this.selection.table.records++);this.selection.fields=this.fields.slice();this.selection.table.fields=this.table.fields;return this.selection},select:function(a){if(a.match(/WHERE/)){for(var b=a.split("WHERE")[1].trim().split(" "),c=0;c<b.length;c++)if(b[c].length){if('"'==b[c][0]&&'"'!=b[c][b[c].length-1]){do b[c]=b[c]+" "+b[c+1],b.splice(c+1,1);
while('"'!=b[c][b[c].length-1])}if("("==b[c][0]&&")"!=b[c][b[c].length-1]){do b[c]=b[c]+" "+b[c+1],b.splice(c+1,1);while(")"!=b[c][b[c].length-1])}}else b.splice(c,1),c--;this.filterQueryA=[];c={};var e="";do{var d=0;3<=b.length&&(c={},c.szSelectionField=b[0].replace(/("|)/g,""),c.szSelectionOp=b[1],c.szSelectionValue=b[2].replace(/("|)/g,""),d=3);"BETWEEN"==c.szSelectionOp&&5<=b.length&&"AND"==b[3]&&(c.szSelectionValue2=b[4],d=5);if(d){for(var f=0;f<this.fields.length;f++)this.fields[f].id==c.szSelectionField&&
(c.nFilterFieldIndex=f),"$"+this.fields[f].id+"$"==c.szSelectionValue&&(c.nFilterValueIndex=f);c.szCombineOp=e;this.filterQueryA.push(c);b.splice(0,d)}else{q("data.js - selection error - incomplete query!\nquery: "+a);break}if(b.length&&"AND"==b[0])e="AND",b.splice(0,1);else if(b.length&&"OR"==b[0])e="OR",b.splice(0,1);else break}while(b.length);this.selection=new h.Table;for(b=0;b<this.filterQueryA.length;b++)if("undefined"===typeof this.filterQueryA[b].nFilterFieldIndex)return this.selection.fields=
this.fields.slice(),this.selection.table.fields=this.table.fields,_LOG("Selection: invalid query: "+a),this.selection;a=0;for(b=this.records.length;a<b;a++){c=null;e=0;for(d=this.filterQueryA.length;e<d;e++)f=!0,this.__szValue=String(this.records[a][this.filterQueryA[e].nFilterFieldIndex]),this.__szSelectionOp=this.filterQueryA[e].szSelectionOp.toUpperCase(),this.__szSelectionValue=this.filterQueryA[e].szSelectionValue,this.__szSelectionValue2=this.filterQueryA[e].szSelectionValue2,this.__szCombineOp=
this.filterQueryA[e].szCombineOp,null!=this.filterQueryA[e].nFilterValueIndex&&(this.__szSelectionValue=String(this.records[a][this.filterQueryA[e].nFilterValueIndex])),f=__scanValue(this.__szValue),"="==this.__szSelectionOp?f="*"==this.__szSelectionValue?""!=this.__szValue.replace(/ /g,""):this.__szValue==this.__szSelectionValue||f==Number(this.__szSelectionValue):"<>"==this.__szSelectionOp?f=!(this.__szValue==this.__szSelectionValue||f==Number(this.__szSelectionValue)):">"==this.__szSelectionOp?
f=f>Number(this.__szSelectionValue):"<"==this.__szSelectionOp?f=f<Number(this.__szSelectionValue):">="==this.__szSelectionOp?f=f>=Number(this.__szSelectionValue):"<="==this.__szSelectionOp?f=f<=Number(this.__szSelectionValue):"LIKE"==this.__szSelectionOp?"*"==this.__szSelectionValue?f=this.__szValue.length:(f=this.__szSelectionValue.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=(new RegExp(f,"i")).test(this.__szValue)):"NOT"==this.__szSelectionOp?(f=this.__szSelectionValue.replace(/[.*+?^${}()|[\]\\]/g,
"\\$&"),f=!(new RegExp(f,"i")).test(this.__szValue)):"IN"==this.__szSelectionOp?f=this.__szSelectionValue.split(",").map(function(a){return a.trim()}).includes(this.__szValue):"BETWEEN"==this.__szSelectionOp?f=f>=Number(this.__szSelectionValue)&&f<=Number(this.__szSelectionValue2):(f=this.__szSelectionValue.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=(new RegExp(f,"i")).test(this.__szValue)),c="AND"==this.__szCombineOp?c&&f:c||f;c&&(this.selection.records.push(this.records[a].slice()),this.selection.table.records++)}}this.selection.fields=
this.fields.slice();this.selection.table.fields=this.table.fields;return this.selection},aggregate:function(a,b){var c=!1;a.lead&&(c=a.calc&&"mean"==a.calc,b=a.lead,a=a.column||a.value);b=b.split("|");for(var e=[],d=null,f=0;f<b.length;f++)for(var g=0;g<this.fields.length;g++)this.fields[g].id==b[f]&&(e[f]=g),this.fields[g].id==a&&(d=g);this.aggregation=new h.Table;xRecords=[];xCount=[];g=0;for(f=this.records.length;g<f;g++){for(var k=[],l=0,p=e.length;l<p;l++)k.push(this.records[g][e[l]]);k=k.join("");
if(xRecords[k])xRecords[k][e.length]+=__scanValue(this.records[g][d]),xCount[k][e.length]++;else{xRecords[k]=[];xRecords[k][e.length]=__scanValue(this.records[g][d]);for(l=0;l<e.length;l++)xRecords[k][l]=this.records[g][e[l]];xCount[k]=[];xCount[k][e.length]=1}}d=0;for(f=xRecords.length;d<f;d++)c&&(xRecords[d][e.length]/=xCount[d][e.length]),this.aggregation.records.push(xRecords[d]),this.aggregation.table.records++;c=[];for(e=0;e<b.length;e++)c[e]={id:b[e]};c[b.length]={id:a};this.aggregation.fields=
c;this.aggregation.table.fields=c;return this.aggregation},condense:function(a,b){var c={},d=[];a&&a.lead&&(b=a,a=b.lead);a=this.columnIndex(a);if(b&&b.keep)if("string"==typeof b.keep)d[this.columnIndex(b.keep)]=!0;else for(i=0;i<b.keep.length;i++)d[this.columnIndex(b.keep[i])]=!0;for(var m=[],f=0;f<this.records.length;f++){var g=String(this.records[f][a]);if(null!=c[g]){g=c[g];for(var k=0,l=this.records[f].length;k<l;k++)if(!d[k])if(!isNaN(this.records[f][k]))m[g][k]=b&&"max"==b.calc?Math.max(Number(m[g][k]),
Number(this.records[f][k])):Number(m[g][k])+Number(this.records[f][k]);else if(isNaN(this.records[f][k])&&m[g][k]!=this.records[f][k]){var p=parseFloat(String(m[g][k]).split(" (+")[1])||0;m[g][k]=String(m[g][k]).split(" (+")[0]+" (+"+ ++p+") "}}else m.push(this.records[f].slice()),c[g]=m.length-1}this.__condense=new h.Table;this.__condense.fields=this.fields;this.__condense.table.fields=this.fields;this.__condense.records=m.slice();this.__condense.table.records=this.__condense.records.length;return this.__condense},
groupColumns:function(a){for(var b=a.source,c=[],d=0,h=b.length;d<h;d++)c[d]=this.column(b[d]).index;this.addColumn({destination:a.destination},function(a){for(var b=0,d=0,e=c.length;d<e;d++)b+=Number(a[c[d]]);return b});return this},pivot:function(a){a.lead=a.lead||a.rows;a.cols=a.cols||a.columns;a.keep=a.keep||[];a.sum=a.sum||[];a.lead=w(a.lead);a.cols=w(a.cols);a.keep=w(a.keep);a.sum=w(a.sum);a.value=w(a.value);a.forced=w(a.forced);for(var b=[],c=0;c<this.fields.length;c++)b[String(this.fields[c].id)]=
c;c=0;for(var d=a.lead.length;c<d;c++)"undefined"==typeof b[a.lead[c]]&&q("data.pivot - pivot keep column '"+a.lead[c]+"' not found");c=0;for(d=a.cols.length;c<d;c++)a.cols&&"undefined"==typeof b[a.cols[c]]&&q("data.pivot - pivot columns source column '"+a.cols[c]+"' not found");c=0;for(d=a.keep.length;c<d;c++)"undefined"==typeof b[a.keep[c]]&&q("data.pivot - pivot keep column '"+a.keep[c]+"' not found");c=0;for(d=a.sum.length;c<d;c++)"undefined"==typeof b[a.sum[c]]&&q("data.pivot - pivot sum column '"+
a.sum[c]+"' not found");c=0;for(d=a.value.length;c<d;c++)"undefined"==typeof b[a.value[c]]&&q("data.pivot - pivot value column '"+a.value[c]+"' not found");c=[];var m=[],f=this.records;if(a.forced)for(d=0;d<a.forced.length;d++)m[String(a.forced[d])]=0;var g=0;for(d=f.length;g<d;g++){for(var k=[f[g][b[a.lead[0]]]],l=1;l<a.lead.length;l++)k.push(f[g][b[a.lead[l]]]);k=k.join("|");l=String(f[g][b[a.cols[0]]]);if("string"==a.calc)var p=f[g][b[a.value[0]]];else if(p=1,a.value&&a.value.length)for(var n=
p=0;n<a.value.length;n++)p+=a.value[n]?__scanValue(f[g][b[a.value[n]]]):1;if(!l||1>l.length)l="undefined";"undefined"==typeof m[l]&&(m[l]=0);if(c[k]){for(n=0;n<a.keep.length;n++)f[g][b[a.keep[n]]]&&f[g][b[a.keep[n]]].length&&c[k][a.keep[n]]!=f[g][b[a.keep[n]]]&&(c[k][a.keep[n]]=f[g][b[a.keep[n]]]);for(n=0;n<a.sum.length;n++)c[k][a.sum[n]]+=Number(f[g][b[a.sum[n]]])}else{c[k]={Total:0};for(n=0;n<a.keep.length;n++)c[k][a.keep[n]]=f[g][b[a.keep[n]]];for(n=0;n<a.sum.length;n++)c[k][a.sum[n]]=Number(f[g][b[a.sum[n]]])}c[k].Total+=
p;c[k][l]?"max"==a.calc?c[k][l]=Math.max(p,c[k][l]):(c[k][l]+=p,c[k][l+"count"]++):(c[k][l]=p,c[k][l+"count"]=1)}this.__pivot=new h.Table;for(b=0;b<a.lead.length;b++)this.__pivot.fields.push({id:a.lead[b]});for(b=0;b<a.keep.length;b++)this.__pivot.fields.push({id:a.keep[b]});for(b=0;b<a.sum.length;b++)this.__pivot.fields.push({id:a.sum[b]});if(a.cols&&a.cols.length)for(var u in m)Object.prototype.hasOwnProperty.call(m,u)&&this.__pivot.fields.push({id:u});this.__pivot.fields.push({id:"Total"});for(var t in c)if(Object.prototype.hasOwnProperty.call(c,
t)){u=[];b=t.split("|");if(a.lead&&a.lead.length)for(d=0;d<b.length;d++)u.push(b[d]);for(b=0;b<a.keep.length;b++)u.push(c[t][a.keep[b]]);for(b=0;b<a.sum.length;b++)u.push(c[t][a.sum[b]]);if(a.cols&&a.cols.length)for(var r in m)Object.prototype.hasOwnProperty.call(m,r)&&("mean"==a.calc?u.push((c[t][r]||0)/(c[t][r+"count"]||1)):u.push(c[t][r]||0));u.push(c[t].Total);this.__pivot.records.push(u);this.__pivot.table.records++}return this.__pivot},subtable:function(a){this.__subt=new h.Table;if(a.fields){a.columns=
[];for(var b=0;b<a.fields.length;b++)for(var c=0;c<this.fields.length;c++)this.fields[c].id==a.fields[b]&&a.columns.push(c)}for(b=0;b<a.columns.length;b++)this.__subt.fields.push({id:String(this.fields[a.columns[b]].id)}),this.__subt.table.fields++;for(var d in this.records){b=[];for(c=0;c<a.columns.length;c++)b.push(this.records[d][a.columns[c]]);this.__subt.records.push(b);this.__subt.table.records++}return this.__subt},sort:function(a,b){var c=this.column(a).values(),d=0;for(a=0;a<Math.min(c.length,
10);a++)isNaN(parseFloat(String(c[a]).replace(",",".")))||d++;a=[];if(d)for(d=0;d<c.length;d++)a.push({index:d,value:Number(String(c[d]).replace(",","."))});else for(d=0;d<c.length;d++)a.push({index:d,value:c[d]});b&&"DOWN"==b?a.sort(function(a,b){return a.value>b.value?-1:1}):a.sort(function(a,b){return a.value<b.value?-1:1});b=[];for(c=0;c<a.length;c++)b.push(this.records[a[c].index]);this.records=b;return this},append:function(a){if(this.table.fields.length!=a.table.fields.length)return null;for(var b=
0;b<this.table.fields.length;b++)if(this.table.fields[b].id!=a.table.fields[b].id)return null;a=a.records;for(b=0;b<a.length;b++)this.records.push(a[b]);this.table.records=this.records.length;return this},json:function(){this.__json=[];for(var a in this.records){var b={},c;for(c in this.fields)b[String(this.fields[c].id)]=this.records[a][c];this.__json.push(b)}return this.__json}};__myNumber=function(a){a=parseFloat(a.replace(/\./g,"").replace(/\,/g,"."));return isNaN(a)?0:a};__scanValue=function(a){a=
String(a).match(/,/)?parseFloat(String(a).replace(/\./gi,"").replace(/,/gi,".")):parseFloat(String(a).replace(/ /gi,""));return isNaN(a)?0:a};h.Table.prototype.addTimeColumns=function(a){if(!a.source)return null;for(var b in this.fields)if(this.fields[b].id==a.source){for(var c=a.create||["date","year","month","day","hour"],d=0;d<c.length;d++)this.fields.push({id:String(c[d])}),this.table.fields++;d=this.records.length;var h;for(h=0;h<d;h++)for(var f=new Date(this.records[h][b]),g=0;g<c.length;g++)switch(c[g]){case "date":var k=
String(f.getDate())+"."+String(f.getMonth()+1)+"."+String(f.getFullYear());this.records[h].push(k);break;case "year":this.records[h].push(f.getFullYear());break;case "month":this.records[h].push(f.getMonth()+1);break;case "day":this.records[h].push(f.getDay());break;case "hour":this.records[h].push(f.getHours())}}return this};h.Column=function(){this.valueA=this.index=this.table=null};h.Column.prototype={values:function(){this.valueA=[];for(var a in this.table.records)this.valueA.push(this.table.records[a][this.index]);
return this.valueA},uniqueValues:function(){this.valueA=[];for(var a in this.table.records)this.valueA.push(this.table.records[a][this.index]);return this.valueA.filter(z)},map:function(a){for(var b in this.table.records)this.table.records[b][this.index]=a(this.table.records[b][this.index],this.table.records[b],this.index);return this},rename:function(a){this.table.fields[this.index].id=a;return this},remove:function(){this.table.fields.splice(this.index,1);for(var a in this.table.records)this.table.records[a].splice(this.index,
1);this.table.table.fields--;return this}};h.Feed.prototype.column=function(a){return this.dbtable.column(a)};h.Feed.prototype.select=function(a){return this.dbtable.select(a)};h.Feed.prototype.aggregate=function(a,b){return this.dbtable.aggregate(a,b)};h.Feed.prototype.revert=function(){return this.dbtable.revert()};h.Feed.prototype.reverse=function(){return this.dbtable.reverse()};h.Feed.prototype.pivot=function(a){return this.dbtable.pivot(a)};h.Feed.prototype.subtable=function(a){return this.dbtable.subtable(a)};
h.Feed.prototype.addTimeColumns=function(a){return this.dbtable.addTimeColumns(a)};h.Broker=function(a){this.souceQueryA=[];this.options=a||{};a&&this.parseDefinition(a);this.onNotify=function(){};this.onError=function(){}};h.Broker.prototype=new h.Feed;h.Broker.prototype={addSource:function(a,b){_LOG("Data.Broker.addSource: "+a);this.souceQueryA.push({url:a,type:b,data:null,result:null,next:this});return this},setCallback:function(a){this.callback=a;return this},realize:function(a){this.callback=
a||this.callback;for(var b in this.souceQueryA)if(this.souceQueryA[b].url&&!this.souceQueryA[b].result)return this.getData(this.souceQueryA[b]),this;this.data=[];for(var c in this.souceQueryA)this.data.push(this.souceQueryA[c].data);this.callback(this.data);return this},error:function(a){this.onError=a||this.onError;return this},notify:function(a){this.onNotify=a||this.onNotify;return this}};h.Broker.prototype.parseDefinition=function(a){this.callback=a.callback||null};h.Broker.prototype.getData=
function(a){this.onNotify(a);a.feed=h.feed({source:a.url,type:a.type,options:a.next.options,parent:this}).load(function(b){a.data=b;a.data.raw=a.feed.data;this.parent.onNotify(a);a.result="success";a.next.realize()}).error(function(b){a.data=null;a.result="error";a.next.realize()})};h.Broker.prototype.setData=function(a){this.parent.__doCreateTableDataObject(a,null,this.parent.options)};h.Feed.prototype.broker=function(a){a=new h.Broker(a);a.parent=this;return a};h.broker=function(){return new h.Broker};
h.Merger=function(a){this.sourceA=[];this.options=a||{};a&&this.parseDefinition(a)};h.Merger.prototype={addSource:function(a,b){this.sourceA.push({data:a,opt:b});return this},setOutputColumns:function(a){this.outColumnsA=a;return this},realize:function(a){this.callback=a||this.callback;_LOG("DataMerger: >>>");a=[];for(var b in this.sourceA){var c=this.sourceA[b];c.opt.columns=c.opt.columns||c.data.columnNames();c.opt.label=c.opt.label||[];c.opt.columns=w(c.opt.columns);c.opt.label=w(c.opt.label);
this.sourceA[b].data||q("DataMerger: source '"+b+"' not found");this.sourceA[b].data[0]||(this.sourceA[b].data=this.sourceA[b].data.getArray());this.sourceA[b].data[0]||q("DataMerger: source '"+b+"' not found or not of type Array");c=[];for(var d in this.sourceA[b].data[0]){this.sourceA[b].data[0][d]==this.sourceA[b].opt.lookup&&(c[this.sourceA[b].opt.lookup]=d);for(var k in this.sourceA[b].opt.columns)this.sourceA[b].opt.label[k]||(this.sourceA[b].opt.label[k]=this.sourceA[b].opt.columns[k]+"."+
(Number(b)+1)+""),this.sourceA[b].data[0][d]==this.sourceA[b].opt.columns[k]&&(c[this.sourceA[b].opt.label[k]]=d)}for(var f in this.sourceA[b].opt.columns)c[this.sourceA[b].opt.label[f]]||_LOG("DataMerger: '"+this.sourceA[b].opt.label[f]+"' not found");a.push(c)}b=[];for(var g in this.sourceA)for(var l in this.sourceA[g].opt.label)b.push(this.sourceA[g].opt.label[l]);if(!this.outColumnsA){this.outColumnsA=[];for(var r in b)this.outColumnsA.push(b[r])}g=[];for(var p in this.outColumnsA)for(var n in a)for(var u in a[n])u==
this.outColumnsA[p]&&(g[u]={input:n,index:a[n][u]});for(var t in this.outColumnsA)if(!g[this.outColumnsA[t]])for(var v in this.sourceA[0].data[0])this.sourceA[0].data[0][v]==this.outColumnsA[t]&&(g[this.outColumnsA[t]]={input:0,index:v});this.namedSourceA=[];for(p=1;p<this.sourceA.length;p++)for(this.namedSourceA[p]=[],n=1;n<this.sourceA[p].data.length;n++)this.namedSourceA[p][String(this.sourceA[p].data[n][a[p][this.sourceA[p].opt.lookup]])]=this.sourceA[p].data[n];p=[];p.push(this.outColumnsA);
for(n=1;n<this.sourceA[0].data.length;n++){u=String(this.sourceA[0].data[n][[a[0][this.sourceA[0].opt.lookup]]]);t=[];for(var y in this.outColumnsA)if(v=g[this.outColumnsA[y]])0==v.input?t.push(this.sourceA[0].data[n][v.index]):this.namedSourceA[v.input][u]?t.push(this.namedSourceA[v.input][u][v.index]):t.push(" ");else return q('DataMerger - missing "'+this.outColumnsA[y]+'" in label:[...]'),null;p.push(t)}_LOG("DataMerger: done");y=new h.Table;y.setArray(p);this.callback&&this.callback(y);return y},
error:function(a){this.onError=a||this.onError;return this}};h.merger=function(){return new h.Merger};console.log("*** data.js "+h.version+" ***");var q=function(a){console.log("data.js v"+h.version+": "+a)}})(window,document);
