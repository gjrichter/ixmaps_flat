<!DOCTYPE html>
<html>
  
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="ixmaps embed example">
	<meta name="author" content="guenter richter">
	<link rel="shortcut icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png">
 
	<title>Created by Composer</title>
</head>
 
<body style="margin:0;padding:0;">
 
	<!-- here goes the map -->
	<div id="map-div"></div>
 
	<!-- include the ixmaps API -->
	<script src="../../ui/js/htmlgui_flat.js"></script>
 
	<script type="text/javascript" charset="utf-8">
        
         query_data = function(theme, options) {
             
            var date = new Date();
            var uTime = date.getTime();

            /* 2 hours to the past */
            uTime -= 1000 * 60 * 60 * 3;

            var sdate = new Date(uTime);

            var year = sdate.getFullYear();
            var month = sdate.getMonth() + 1;
            var day = sdate.getDate();
            var szStartDate = year + "-" + String("0" + month).slice(-2) + "-" + String("0" + day).slice(-2);
            var hours = sdate.getHours();
            var minutes = sdate.getMinutes();
            var szStartTime = hours + ":00";
             
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
            var szEndDate = year + "-" + String("0" + month).slice(-2) + "-" + String("0" + day).slice(-2);
            hours = date.getHours();
            minutes = date.getMinutes();
            var szEndTime = hours + ":" + minutes;
             
            var broker = new Data.Broker()

                .addSource("https://meteohub.mistralportal.it/api/observations?q=reftime:%20%3E="+szStartDate+"%20"+szStartTime+",%3C="+szEndDate+"%20"+szEndTime+";product:B12101;license:CCBY_COMPLIANT;timerange:254,0,0;level:103,2000,0,0&reliabilityCheck=true&last=true&ts=1751462143620", "json")

                .realize(
                    function(dataA) {

                        var data = dataA[0];
                        data.column("prod.0.val.0.val").map(function(value){
                            return value - 273.15;
                        })   

                         ixmaps.setExternalData(data, {
                            type: "dbtable",
                            name: options.name
                        });
                    });
        };
        
		// create and embed the map
		// ! reference to "map-div", the hosting html div

		ixmaps.embed("map-div", {
			mapService: "leaflet_vt",
			mapType: "white",
			map: "../../maps/svg/maps/generic/mercator.svg",
			name: "map_1",
			mode: "pan",
			legend: "true",
			tools: "true",
			search: "Europe",
			about: "test"
		},
		map => map
		.options({
			featurescaling: "true",
			objectscaling: "dynamic",
			normalSizeScale: "100000",
			dynamicSizePow: "0.1",
			flushChartDraw: "1000000",
			flushPaintShape: "1000000",
			basemapopacity: "0.5",
			worksilent: "false",
			loadsilent: "false",
			hideOnPan:  "false",
			freezeOnPan:"false",
		})
        .require("https://d3js.org/d3.v3.min.js")
        .require("../../usercharts/d3/chart.js")
        .require("../../usercharts/d3/arrow_chart.js")
        .require("../../ui/js/tools/tooltip_mustache.js")
		.attribution("powered by <a href=\"http://ixmaps.com\" target=\"_blank\">iXMaps</a>")
		.view({
			center: {
				lat: "41.97018746617801",
				lng: "13.367701027046254"
				},
			zoom: "6.3"
			})
        .layer(ixmaps.layer("nuts2", layer => layer
            .type("FEATURES|SILENT|LOCKED|NOLEGEND")
            .data({
                url: "https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_10M_2021_4326_LEVL_2.geojson",
                type: "geojson"
            })
            .binding({
                id: "NUTS_ID"
            })
            .filter("WHERE CNTR_CODE = IT")
            .style({
                colorscheme: [
                    "white"
                ],
                fillopacity: "1",
                linecolor: "#F7F6EF",
                linewidth: "2",
                shadow: true,
                showdata: true,
                featurelower: "1:3000000",
                titlefield: "NUTS_NAME",
                name: "nuts2"
            })
 		))
		.layer(ixmaps.layer("World Mercator", layer => layer
			.data({
				query: query_data.toString(),
				name: "data_1751459866345_623",
				cache: "true"
				})
			.binding({
				geo: "stat.lat|stat.lon",
				value: "prod.0.val.0.val",
                title: "stat.details.0.val"
				})
			.type("CHART|USER|3D|SHADOW|SIZE|HEADTAIL|VALUES|AGGREGATE|MAX")
			.style({
                userdraw: "pinnacleChart",
				colorscheme: [
					"7",
					"#A3C0A9",
					"#D53E4F",
					"3colors",
					"#d4b898"],
				fillopacity: "0.7",
				shadow: "false",
				visible: "true",
				showdata: "true",
				units: "Â°",
				scale: "2.2",
                rangescale: "0.5",
				sizepow: "0.1",
				valuescale: "1",
				valuedecimals: "1",
                minvaluesize: "20",
                valuesupper: "1:1000000"
				})
			.meta({
				title: "[title]",
				snippet: "",
				description: "",
				name: "data_1751459866345_623",
				tooltip: "{{theme.item.chart}}{{theme.item.data}}"
				})
		))
	);
	</script>
</body>
</html>
