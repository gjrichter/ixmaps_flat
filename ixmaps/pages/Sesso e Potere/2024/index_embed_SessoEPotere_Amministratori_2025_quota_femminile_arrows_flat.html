<!DOCTYPE html>
<html>

<!-- **********************************************************************

index_only_map_embed.html

$Comment: ixmaps map template; embedded version
$Source : index_only_map_embed.html,v $

$InitialAuthor: guenter richter $
$InitialDate: 2017/06/22 $
$Author: guenter richter $
$Id:index_only_map_embed.html 1 2021-10-17 00:00:00Z Guenter Richter $

licensed under CC-BY
$Log:index_only_map_embed.html,v $

********************************************************************** -->

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ixmaps embed example">
    <meta name="author" content="guenter richter">
    <link rel="shortcut icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png">

    <title>iXMaps - embeded map</title>

</head>

<body>

    <!-- here goes the map -->
    <div id="map-div"></div>

    <!--========================================================================= -->

    <script src="../../../ui/js/htmlgui_flat.js"></script>

    <!--========================================================================= -->

    <script type="text/javascript" charset="utf-8">
        const attribution = "dati: <a href='https://dait.interno.gov.it/elezioni/open-data/amministratori-locali-e-regionali-in-carica' target='_blank'>Ministero dell'Interno</a>, 	licenza: <a href='https://creativecommons.org/licenses/by/4.0/deed.it target='_blank'>CC-BY-4.0</a>"

        const legend = "<span style='color:#888888'><h1>Sindaci in carica al<br> 17 Novembre 2024</h1><h4>fonte: <a href='https://github.com/ondata/sesso-e-potere/tree/main/dati/amministazioni-italiane' target='blank'>onData</a>, <a href='https://dait.interno.gov.it/elezioni/open-data/amministratori-locali-e-regionali-in-carica' target='_blank'>Ministero dell'Interno</a> licenza: <a href='https://www.dati.gov.it/content/italian-open-data-license-v20' target='blank'>IODL v2.0</h4></span>";

        const query = function(data, options) {
            Data.feed({
                source: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/Amministrazioni/sesso_e%20_potere/ammcom_24_11_17.csv.gz",
                type: "csv"
            }).load(function(newData) {
                var pivot = newData.pivot({
                    lead: "CODICE_ISTAT",
                    columns: "sesso",
                    keep: [
                        "CODICE_ISTAT",
                        "codice_regione",
                        "codice_provincia",
                        "denominazione_comune",
                        "popolazione_censita_alla_data_elezione"
                    ]
                });
                var iTotal = pivot.column("Total").index;
                var iF = pivot.column("F").index;
                pivot.addColumn({
                    destination: "quota_femminile"
                }, function(row) {
                    return Math.round((row[iF] / row[iTotal]) * 10000) / 100;
                });
                (options.type = "jsonDB"), ixmaps.setExternalData(pivot, options);
            });
        };

        const query_diff = function(data, options) {
            var broker = new Data.Broker()
                .addSource(
                    "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/Amministrazioni/sesso_e%20_potere/ammcom_22_10_22.csv.gz",
                    "csv"
                )
                .addSource(
                    "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/Amministrazioni/sesso_e%20_potere/ammcom_24_11_17.csv.gz",
                    "csv"
                )
                .realize(function(dataA) {
                    dataA[0] = dataA[0].select("WHERE descrizione_carica like \"Sindac|Assess|Consigl\"")
                    dataA[1] = dataA[1].select("WHERE descrizione_carica like \"Sindac|Assess|Consigl\"")
                    var pivot_1 = dataA[0].pivot({
                        lead: "CODICE_ISTAT",
                        columns: "sesso",
                        keep: [
                            "CODICE_ISTAT",
                            "codice_regione",
                            "codice_provincia",
                            "denominazione_comune",
                            "data_elezione",
                            "popolazione_censita"
                        ]
                    });
                    var pivot_2 = dataA[1].pivot({
                        lead: "CODICE_ISTAT",
                        columns: "sesso",
                        keep: [
                            "CODICE_ISTAT",
                            "codice_regione",
                            "codice_provincia",
                            "denominazione_comune",
                            "data_elezione",
                            "popolazione_censita_alla_data_elezione"
                        ]
                    });
                    
                    var iTotal = pivot_1.column("Total").index;
                    var iF = pivot_1.column("F").index;
                    pivot_1.addColumn({
                        destination: "quota_femminile"
                    }, function(row) {
                        return Math.round((row[iF] / row[iTotal]) * 10000) / 100;
                    });
                    
                        iTotal = pivot_2.column("Total").index;
                        iF = pivot_2.column("F").index;
                    pivot_2.addColumn({
                        destination: "quota_femminile"
                    }, function(row) {
                        return Math.round((row[iF] / row[iTotal]) * 10000) / 100;
                    });
                    
                    var merger = new Data.Merger();
                    var final = merger
                        .addSource(pivot_1, {
                            lookup: "CODICE_ISTAT",
                            columns: pivot_1.columnNames()
                        })
                        .addSource(pivot_2, {
                            lookup: "CODICE_ISTAT",
                            columns: pivot_2.columnNames()
                        })
                        .realize();
                    
                    final.column("data_elezione.1").rename("data_elezione_1");
                    final.column("data_elezione.2").rename("data_elezione_2");

                    var iQ1 = final.column("quota_femminile.1").index;
                    var iQ2 = final.column("quota_femminile.2").index;
                    final.addColumn({
                        destination: "quota_femminile_diff"
                    }, function(row) {
                        return (row[iQ2] - row[iQ1]);
                    });

                    final = final.select("WHERE \"data_elezione_1\" NOT \"$data_elezione_2$\"");
                    final = final.select("WHERE \"Total.1\" = \"$Total.2$\"");


                    (options.type = "jsonDB"), ixmaps.setExternalData(final, options);
                });
        };

        const query_extended_age = function(data, options) {
            var broker = new Data.Broker()
                .addSource(
                    "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/Amministrazioni/sesso_e%20_potere/ammcom_24_11_17.csv.gz",
                    "csv"
                )
                .realize(function(dataA) {
                    ixmaps.showLoadingArrayStop();
                    ixmaps.hideLoading();

                    var ammcom = dataA[0];

                    var pivot = ammcom.pivot({
                        lead: "denominazione_comune",
                        columns: "sesso",
                        keep: [
                            "CODICE_ISTAT",
                            "codice_regione",
                            "codice_provincia",
                            "popolazione_censita_alla_data_elezione"
                        ]
                    });

                    var iTotal = pivot.column("Total").index;
                    var iF = pivot.column("F").index;
                    pivot.addColumn({
                            destination: "quota"
                        },
                        function(row) {
                            return (row[iF] / row[iTotal]) * 100;
                        }
                    );
                    var lookup = pivot.lookupArray("quota", "denominazione_comune");

                    ammcom.addColumn({
                            source: "denominazione_comune",
                            destination: "quota"
                        },
                        function(value) {
                            return lookup[value];
                        }
                    );

                    var iProv = ammcom.column("codice_provincia").index;
                    var iCom = ammcom.column("codice_comune").index;
                    ammcom.addColumn({
                        destination: "PROCOM"
                    }, function(row) {
                        return row[iProv] + ("000" + String(row[iCom])).slice(-3);
                    });

                    var iNat = ammcom.column("data_nascita").index;
                    ammcom.addColumn({
                        destination: "eta"
                    }, function(row) {
                        var dA = row[iNat].split("/");
                        return (
                            (new Date().getTime() -
                                new Date(dA[2] + "/" + dA[1] + "/" + dA[0]).getTime()) /
                            (1000 * 60 * 60 * 24 * 356)
                        ).toFixed(0);
                    });

                    ammcom.addColumn({
                            source: "eta",
                            destination: "eta_10"
                        },
                        function(value) {
                            return Math.floor(value / 10) * 10;
                        }
                    );

                    ammcom.addColumn({
                            source: "eta",
                            destination: "eta_5"
                        },
                        function(value) {
                            return Math.floor(value / 5) * 5;
                        }
                    );

                    ammcom.addColumn({
                            source: "popolazione_censita_alla_data_elezione",
                            destination: "popolazione_log"
                        },
                        function(value) {
                            return Math.log10(value);
                        }
                    );

                    var ammcomF = ammcom.select("WHERE sesso = F");
                    var ammcomM = ammcom.select("WHERE sesso = M");

                    var pivotF = ammcomF.pivot({
                        lead: "denominazione_comune",
                        columns: "eta_10",
                        keep: [
                            "CODICE_ISTAT",
                            "PROCOM",
                            "codice_regione",
                            "codice_provincia",
                            "sigla_provincia",
                            "popolazione_censita_alla_data_elezione"
                        ]
                    });

                    var pivotM = ammcomM.pivot({
                        lead: "denominazione_comune",
                        columns: "eta_10",
                        keep: [
                            "CODICE_ISTAT",
                            "PROCOM",
                            "codice_regione",
                            "codice_provincia",
                            "sigla_provincia",
                            "popolazione_censita_alla_data_elezione"
                        ]
                    });

                    var merger1 = new Data.Merger();
                    var final = merger1
                        .addSource(pivotM, {
                            lookup: "denominazione_comune",
                            columns: pivotM.columnNames()
                        })
                        .addSource(pivotF, {
                            lookup: "denominazione_comune",
                            columns: pivotF.columnNames()
                        })
                        .realize();

                    var iTotal1 = final.column("Total.1").index;
                    var iTotal2 = final.column("Total.2").index;
                    final.addColumn({
                            destination: "Total"
                        },
                        function(row) {
                            return row[iTotal1] + row[iTotal2];
                        }
                    );

                    ixmaps.setExternalData(final, {
                        type: "dbtable",
                        name: options.name
                    });
                });
        };


        const georef =
            ixmaps.layer("ITALIA_Comuni_2022")
            .data({
                url: "https://s3.eu-central-1.amazonaws.com/maps.ixmaps.com/Istat/comuni_2022/Com01012022_s_WGS84.topojson.gz",
                type: "topojson"
            })
            .binding({
                id: "PRO_COM_T",
                position: "geometry"
            })
            .type("FEATURES|NOLEGEND")
            .style({
                colorscheme: ["#eeeeee"],
                fillopacity: "0",
                linecolor: "none",
                linewidth: "0.1",
                sizefield: "Shape_Area"
            })
            .define();

        const choropleth =
            ixmaps.layer("ITALIA_Comuni_2022")
            .data({
                query: query.toString(),
                type: "ext"
            })
            .binding({
                value: "quota_femminile",
                position: "CODICE_ISTAT"
            })
            .type("CHOROPLETH|RANGES|DOPACITYMIN|COMPACTLEGEND")
            .style({
                colorscheme: [
                    "#666666",
                    "#666666",
                    "#666666",
                    "#666666"
                ],
                fillopacity: "1",
                shadow: "false",
                ranges: [
                    "0",
                    "25",
                    "40",
                    "48",
                    "100"
                ],
                units: "%",
                scale: "1",
                titlefield: "denominazione_comune",
                alphafield: "popolazione_censita_alla_data_elezione",
                alphafield100: "$density$",
                dopacitypow: "2",
                dopacityscale: "1",
                valuescale: "1",
            })
            .meta({
                title: "Quota femminile - Amministrazioni comunali al 5 ottobre 2022",
                tooltip: "<div style='white-space:nowrap'>{{theme.item.title}}<h2 style='margin:0'>{{theme.item.value}} %</h2></div>"
            })
            .define();

        const chart =
            ixmaps.layer("ITALIA_Comuni_2022")
            .data({
                query: query_diff.toString(),
                type: "ext"
            })
            .binding({
                value: "F.1|F.2",
                position: "CODICE_ISTAT.1"
            })
            .type("CHART|BAR|POINTER|SMALLARROW|NONEGATIVE|DIFFERENCE|SIZE|SIMPLELEGEND")
            .style({
                userdraw: "arrowChart",
                colorscheme: [
                    "red"
                ],
                fillopacity: "0.4",
                shadow: "false",
                units: "",
                normalsizevalue: "20",
                valuefield: "$title$",
                //sizefield: "popolazione_censita_alla_data_elezione",
                minvalue: "1",
                textcolor: "#666666",
                textscale: "3",
                fadenegative: 0.2,
                linewidth: "0.5",
                rotation: "25",
                titlefield: "denominazione_comune.1",
                valuescale: "2",
                valuedecimals: "0",
                sizepow: "1",
                showdata: "true",
                datafields: ["data_elezione_2"],
                chartupper: "1:10000000"
            })
            .meta({
                title: "Amministratori femminili",
                tooltip: "<h2 style='margin:0'>{{theme.title}}</h2>{{theme.item.chart}}con l'elezione del <b><big>{{data_elezione_2}}</big><b>"
            })
            .define();

        const chart2 =
            ixmaps.layer("ITALIA_Comuni_2022")
            .data({
                query: query_diff.toString(),
                type: "ext"
            })
            .binding({
                value: "M.1|M.2",
                position: "CODICE_ISTAT.1"
            })
            .type("CHART|BAR|POINTER|SMALLARROW|NONEGATIVE|DIFFERENCE|SIZE|SIMPLELEGEND")
            .style({
                userdraw: "arrowChart",
                colorscheme: [
                    "black"
                ],
                fillopacity: "0.4",
                shadow: "false",
                units: "",
                normalsizevalue: "20",
                valuefield: "$title$",
                //sizefield: "popolazione_censita_alla_data_elezione",
                minvalue: "1",
                textcolor: "#666666",
                textscale: "3",
                fadenegative: 0.2,
                linewidth: "0.5",
                rotation: "335",
                titlefield: "denominazione_comune.1",
                valuescale: "2",
                valuedecimals: "0",
                sizepow: "1",
                showdata: "true",
                datafields: ["data_elezione_2"],
                chartupper: "1:10000000"
            })
            .meta({
                title: "Amministratori maschili",
                tooltip: "<h2 style='margin:0'>{{theme.title}}</h2>{{theme.item.chart}}con l'elezione del <b><big>{{data_elezione_2}}</big><b>"
            })
            .define();


        const grid =
            ixmaps.layer("ITALIA_Comuni_2022")
            .data({
                query: query.toString(),
                type: "ext"
            })
            .binding({
                value: "quota_femminile",
                position: "CODICE_ISTAT"
            })
            .type("RECT|CHART|SYMBOLS|GRIDSIZE|AGGREGATE|MEAN")
            .style({
                colorscheme: [
                    "none"
                ],
                fillopacity: "0.05",
                shadow: "false",
                symbols: [
                    "square"
                ],
                units: "",
                scale: "1",
                linecolor: "#884444",
                linewidth: "0.2",
                aggregationscale: [
                    "1:1", "250px",
                    "1:100000", "150px",
                    "1:200000", "100px"
                ],
                gridoffsety: "70",
                title: "Quota femminile - griglia rettangolare"
            })
            .meta({
                title: "Quota femminile - Amministrazioni comunali al 5 ottobre 2022"
            })
            .define();

        const curves =
            ixmaps.layer("ITALIA_Comuni_2022")
            .data({
                query: query_extended_age.toString(),
                type: "ext"
            })
            .binding({
                value: "20.1|20.2|30.1|30.2|40.1|40.2|50.1|50.2|60.1|60.2|70.1|70.2|80.1|80.1|90.1|90.2",
                position: "CODICE_ISTAT.1"
            })
            .type("CHART|SYMBOL|SEQUENCE|PLOT|AREA|LINES|GRID|BOX|BOTTOMTITLE|GRIDSIZE|AGGREGATE|RECT|RELOCATE|SUM|ZEROISVALUE|UNDEFINEDISVALUE")
            .style({
                colorscheme: [
                    "#0044dd",
                    "#dd4400"
                ],
                fillopacity: "0.1",
                shadow: "false",
                symbols: [
                    "none"
                ],
                xaxis: [
                    "20",
                    "30",
                    "40",
                    "50",
                    "60",
                    "70",
                    "80",
                    "90"
                ],
                units: "",
                units100: "",
                refreshtimeout: "0",
                scale: "1.25",
                rangescale: "2.5",
                maxvalue: "auto",
                textcolor: "#444444",
                textscale: "1",
                linewidth: "3",
                bordercolor: "none",
                boxopacity: "0.05",
                titlefield: "denominazione_comune.1",
                valuescale: "1",
                valuedecimals: "0",
                fadenegative: "1",
                gridx: "2",
                aggregationscale: [
                    "1:1", "250px",
                    "1:100000", "150px",
                    "1:200000", "100px"
                ],
                gridoffsety: "70",
                align: "left",
            })
            .meta({
                title: "Amministrazioni locali per sesso ed età"
             })
            .define();

        document.activeElement.appendChild(

            ixmaps.embed(
                "map-div", {
                    maptype: "Stamen - toner-lite",
                    width: "100%",
                    height: "1400px",
                    scrollsafesilent: "true",
                    legend: 1,
                    align: "center",
                    mode: "info",
                    tools: "true",
                    name: "map"
                },
                (map) =>
                map
                .view([42.12824901518532, 13.040283203125002], 7)
                .attribution(attribution)
                .require("../../../ui/js/tools/tooltip_mustache.js")
                .require("https://d3js.org/d3.v3.min.js")
                .require("../../../pages/Sesso e Potere/2024/arrow_chart.js")

                .options({
                    scrollSafeSilent: "true",
                    objectscaling: "dynamic",
                    normalsizescale: "10000000",
                    basemapopacity: "0.3",
                    panhidden: "false"
                })
                .layer(georef)
                //.layer(choropleth)
                .layer(chart)
                .layer(chart2)
            )
        );

    </script>
</body>

</html>
