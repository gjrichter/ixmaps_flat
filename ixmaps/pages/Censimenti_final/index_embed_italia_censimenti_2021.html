<!DOCTYPE html>
<html>

<!-- **********************************************************************

ixmaps map embed html

$Comment: ixmaps map template; embedded version
$Source : index_only_map_embed.html,v $

$InitialAuthor: guenter richter $
$InitialDate: 2023/04/22 $
$Author: guenter richter $
$Id:index_embed_Open_Data_PNRR_Dati_Universo_REGIS_III.html 1 2023-04-22 00:00:00Z Guenter Richter $

licensed under CC-BY
$Log:index_only_map_embed.html,v $

********************************************************************** -->

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="ixmaps embed example">
    <meta name="author" content="guenter richter">
    <link rel="shortcut icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png">

    <title>Data VizI</title>
    <meta name="description" content="Le mappe con dati italiani">

    <style>
        a {
            text-decoration: none;
            color: #444444;
        }

        a:hover {
            color: cornflowerblue;
        }

        ul {
            font-family: Raleway;
            padding-inline-start: 1.5em;
        }

        li.active a {
            color: white;
            background-color: #24A2AF;
            xxpadding: 0.2em;
        }

        a.active {
            color: white;
            background-color: #24A2AF;
            xxpadding: 0.2em;
        }

        .sidebar {
            position: absolute;
            right: 5%;
            top: 110px;
            text-align: left;
            font-family: Helvetica;
            font-size: 1.1em;
            line-height: 1.2em;
            max-width: 28%;
            background-color: rgba(247, 246, 239, 0.8)
        }

    </style>

</head>

<body style='text-align:center;background:#F7F6EF;margin:0;padding:0'>

    <div id="logo" style="position:absolute;top:25px;right:6%">
        <a href="javascript:__dataTheme()">
            <div style="font-family:helvetica;font-size:48px;line-height:0.8em;font-weight:bold;color:burlywood ;text-align:left">Data<br><span style="font-size:48px;padding-left:2px">Viz</span><em> i</em></div>
        </a>
    </div>
    <div style="margin:auto">

        <div id="map_div"></div>

        <div id="sidebar_div" class="sidebar">
            <p style="font-family:helvetica;font-size:2em;line-height:0.73em;margin:0.5em">
                <b>Censimento 2021</b>
                <br>
                <small style='font-size:0.75em;color:#888888'>Visualizzazione di dati pubblicati dall'ISTAT in <a href="" target="_blank" style="color:cadetblue">Basi territoriali e variabili censuarie</a></small>
            </p>
            <ul>
                <li>
                    <a class="select" href="javascript:ixmaps.map().replace('chart_procom_all',__pop_procom(),'silent')">Popolazione</a>
                    <ul>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__pop_procom_5(),'replace|silent')"> - < 5 anni </a>
                            <a class="select" href="javascript:ixmaps.map().remove('chart_procom_all').add(__pop_procom_75(),'silent')"> - > 75 anni </a>
                           <a class="select" href="javascript:ixmaps.map().remove('chart_procom_all').add(__pop_procom_stranieri(),'silent')"> - stranieri </a>
                           <a class="select" href="javascript:ixmaps.map().remove('chart_procom_all').add(__pop_procom_stranieri_p(),'silent')"> - % </a>
                        </li>
                        <li>
                            <a class="select active" href="javascript:ixmaps.map().add(__sez2021_pop_choropleth(),'clear')"> - densità delle popolazione per sezioni</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_pop_peaks(),'clear')"> - densità della popolazione (picchi)</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_pop_aggregate_peaks(),'clear')"> - la popolazione (picchi)</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_pop_100_circle(),'clear')"> - la popolazione / 100 m2</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_pop_1000_square(),'clear')"> - la popolazione / 1 km2</a>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_pop_500_square(),'clear')"> / 500 m2</a>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_pop_250_square(),'clear')"> / 250 m2</a>
                        </li>

                    </ul>
                </li>
                <li>
                    <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth)">Istruzione</a>
                    <ul>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth)"> - istruzione dominante per sezione</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth).changeThemeStyle('choropleth','dopacityscale:1').add(__sez2021_edu_aggregate_peaks)"> - piu grafici per l'istruzione sopra alla media</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth).changeThemeStyle('choropleth','dopacityscale:1').add(__sez2021_edu_aggregate_pies,'clear')"> - popolazione per istruzione</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth)">Eta</a>
                    <ul>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_eta_choropleth)"> - fascia età sopra alla media</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth).changeThemeStyle('choropleth','dopacityscale:1').add(__sez2021_edu_aggregate_peaks)"> - piu grafici per l'istruzione sopra alla media</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth).changeThemeStyle('choropleth','dopacityscale:1').add(__sez2021_edu_aggregate_pies,'clear')"> - popolazione per istruzione</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_stranieri_choropleth)">Stranieri</a>
                    <ul>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_stranieri_choropleth)"> - provenienza dominante</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2011,'clear').add(__sez2011_stranieri_choropleth)"> - provenienza dominante 2011</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth).changeThemeStyle('choropleth','dopacityscale:1').add(__sez2021_edu_aggregate_peaks)"> - piu grafici per l'istruzione sopra alla media</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021,'clear').add(__sez2021_edu_choropleth).changeThemeStyle('choropleth','dopacityscale:1').add(__sez2021_edu_aggregate_pies,'clear')"> - popolazione per istruzione</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

        <div id="map_code_div-project" style="position:absolute;top:10px;left:10px;text-align:left;width:50%;height:800px;overflow:auto;display:none;xxbox-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);"></div>
    </div>

    <!-- ------------------------------------- -->
    <!--                                       -->
    <!-- c o d e                         -->
    <!--                                       -->
    <!-- ------------------------------------- -->

    <!--========================================================================= -->

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
    <script src="../../../ui/js/htmlgui_api.js"></script>


    <!--========================================================================= -->

    <script type="text/javascript" charset="utf-8">
        /** 
         ** change background color on select
         **/

        __select = (el) => {
            $(".select").removeClass("active");
            el.addClass("active");
        };
        $(".select").attr("onclick", "__select($(this))");

        // ---------------------------------------------------
        // ---------------------------------------------------
        //
        // t h e   m a p 
        //
        // ---------------------------------------------------
        // ---------------------------------------------------

        /**
         ** ************************************
         ** define the ixmaps themes and project
         ** ************************************
         **/

        var __filter = "";
        var __lat = null;
        var __lon = null;
        var __zoom = null;
        var __scale_chart = 1;
        var __legend = true;

        /**
         ** strings used by the map 	
         **/

        attribution =
            "powered by <a href=\"http://ixmaps.com\" target=\"_blank\">iXMaps</a>";

        /**
         ** get query params and adapt theme and project definitions 	
         **/

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });

        if (params.filter) {
            __filter = params.filter;
        }

        if (params.view) {
            var latlonA = params.view.split('[')[1].split(']')[0].split(',');
            __lat = latlonA[0];
            __lon = latlonA[1];
            __zoom = parseFloat(params.view.split(',')[2]);
            //setTimeout("ixmaps.setView(null,"+params.view+")",1000);
        };

        if (params.scale) {
            __scale_chart = params.scale;
        };

        if (params.legend) {
            __legend = params.legend;
        };

        
        ixmaps.regione = "03";
        ixmaps.procom = "*";
        
        $.getScript("./layer.js");
        
        const nuts2 =
            ixmaps.layer("nuts2", layer => layer
                .type("FEATURES|SILENT|NOLEGEND")
                .data({
                    url: "https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_10M_2021_4326_LEVL_2.geojson",
                    type: "geojson"
                })
                .binding({
                    id: "NUTS_NAME"
                 })
                .filter("WHERE CNTR_CODE = IT")
                .style({
                    colorscheme: [
                        "white"
                    ],
                    fillopacity: "1",
                    linecolor: "#E7E6DF",
                    linewidth: "2",
                    shadow: true,
                    showdata: true,
                    featurelower: "1:1000000",
                    titlefield: "NUTS_NAME",
                    name: "nuts2"
                })
            );

        // ---------------------------------------------------
        // e m b e d   t h e   m a p  
        // ---------------------------------------------------

        /**
         **
         ** create the interactive map an append it to the document 
         **
         **/

        ixmaps.embed("map_div", {
                mapService: "leaflet_vt",
                mapType: "VT_TONER_LITE",
                map: "../../maps/svg/maps/generic/mercator.svg",
                legend: ((__legend == true) ? "true" : 0),
                align: "left",
                mode: "pan",
                about: "test",
                search: "Italy"
            },
            map => map

            .view({
                "center": {
                    "lat": "42.30234655149951",
                    "lng": "13.987399620595363"
                    },
                "zoom": "6.27681771091248"
            })
            .options({
                featurescaling: "true",
                objectscaling: "dynamic",
                normalSizeScale: "50000",
                dynamicScalePow: "1.7",
                flushChartDraw: "1000000",
                flushPaintShape: "1000000",
                basemapopacity: "0.5",
                hideOnPan: "false",
                freezeOnPan: "true"
            })
            .local("aggregated", "")
            .local("... creating theme ...", "...")
            .local("loading data ...", "scaricando dati ...")
            .local("working ...", "... &#9881; ...")
            .require("../../ui/js/tools/tooltip_mustache.js")
            .require("https://d3js.org/d3.v3.min.js")
            .require("../../usercharts/d3/chart.js")
            .require("../../usercharts/d3/arrow_chart.js")
            .attribution(attribution)
            //.legend("<h1 style='padding:0.2em 0.5em;border-radius:0.5em;background:RGBA(255,255,255,0.5)'>Variazione della <span style='color:#884488'>fascia d'età 65+  (%)</span> dal 2003 al 2023 </h1>")		 

            // -----------------------------		 
            // the data visualization layer 
            // -----------------------------
                     
            .layer(nuts2)
            //.layer(__georef_urban())
            .layer(__georef())
            .layer(__georef_sez2021())
            //.layer(__sez2021_pop_choropleth())
            //.layer(__georef_sez2011)
            .layer(__pop_procom())
            //.layer(__sez2011_pop_100_circle)
            //.layer(__sez2021_pop_100_circle)
            //.layer(__sez_2011_2021_pop_arrow_user_procom_all_grid())
            //.layer(__sez_2011_2021_pop_arrow_user_procom_all())
            //.layer(__sez_2011_2021_pop_arrow_user())
            //.layer(__sez_2011_2021_pop_arrow_user_grid())
        );

        /**
         **
         ** window size handling
         **
         **/

        $(window).resize(function() {
            $("#regis_map").css("height", (window.innerHeight - 5) + "px");
        });
        
        // ----------------------------------------------
        // things to do on zoom and pan
        // ----------------------------------------------
        
		// define map lookup table; name -> svg file
		// -----------------------------------------
		var regionLookup = [{
				name_en: "Piedmont",
				name_it: "Piemonte",
				name_s: "PIE",
				map: "piemonte/istat_bt2011_01_piemonte.svgz",
				data: "R01_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Aosta Valley",
				name_it: "Valle d'Aosta",
				name_s: "VAL",
				map: "valle_aosta/istat_bt2011_02_valle_aosta.svgz",
				data: "R02_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Lombardy",
				name_it: "Lombardia",
				name_s: "LOM",
				map: "lombardia/istat_bt2011_03_lombardia.svgz",
				data: "R03_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Trentino-Alto Adige",
				name_it: "Trentino-Alto Adige",
				name_s: "TRE",
				map: "trentino-alto_adige/istat_bt2011_04_trentino-alto_adige.svgz",
				data: "R04_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Veneto",
				name_it: "Veneto",
				name_s: "VEN",
				map: "veneto/istat_bt2011_05_veneto.svgz",
				data: "R05_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Friuli Venezia Giulia",
				name_it: "Friuli Venezia Giulia",
				name_s: "FRI",
				map: "friuli-venezia_giulia/istat_bt2011_06_friuli-venezia_giulia.svgz",
				data: "R06_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Liguria",
				name_it: "Liguria",
				name_s: "LIG",
				map: "liguria/istat_bt2011_07_liguria.svgz",
				data: "R07_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Emilia-Romagna",
				name_it: "Emilia-Romagna",
				name_s: "EMI",
				map: "emilia-romagna/istat_bt2011_08_emilia-romagna.svgz",
				data: "R08_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Tuscany",
				name_it: "Tuscany",
				name_s: "TOS",
				map: "toscana/istat_bt2011_09_toscana.svgz",
				data: "R09_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Umbria",
				name_it: "Umbria",
				name_s: "UMB",
				map: "umbria/istat_bt2011_10_umbria.svgz",
				data: "R10_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "The Marches",
				name_it: "Marche",
				name_s: "MAR",
				map: "marche/istat_bt2011_11_marche.svgz",
				data: "R11_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Latium",
				name_it: "Lazio",
				name_s: "LAZ",
				map: "lazio/istat_bt2011_12_lazio.svgz",
				data: "R12_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Abruzzo",
				name_it: "Abruzzo",
				name_s: "ABR",
				map: "abruzzo/istat_bt2011_13_abruzzo.svgz",
				data: "R13_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Molise",
				name_it: "Molise",
				name_s: "MOL",
				map: "molise/istat_bt2011_14_molise.svgz",
				data: "R14_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Campania",
				name_it: "Campania",
				name_s: "CAM",
				map: "campania/istat_bt2011_15_campania.svgz",
				data: "R15_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Apulia",
				name_it: "Puglia",
				name_s: "PUG",
				map: "puglia/istat_bt2011_16_puglia.svgz",
				data: "R16_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Basilicate",
				name_it: "Basilicata",
				name_s: "BAS",
				map: "basilicata/istat_bt2011_17_basilicata.svgz",
				data: "R17_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Calabria",
				name_it: "Calabria",
				name_s: "CAL",
				map: "calabria/istat_bt2011_18_calabria.svgz",
				data: "R18_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Sicily",
				name_it: "Sicilia",
				name_s: "SIC",
				map: "sicilia/istat_bt2011_19_sicilia.svgz",
				data: "R19_indicatori_2021_sezioni.csv.gz"
			},
			{
				name_en: "Sardinia",
				name_it: "Sardegna",
				name_s: "SAR",
				map: "sardegna/istat_bt2011_20_sardegna.svgz",
				data: "R20_indicatori_2021_sezioni.csv.gz"
			}
		];
        
        ixmaps.htmlgui_onZoomAndPan = function () {
            
 			var nOpacity = (ixmaps.getZoom() - 7) / 10;
			ixmaps.setBasemapOpacity(null, nOpacity, "absolute");
            
            let center = ixmaps.getCenter();
            console.log(center);
            
             $.getJSON( "http://api.geonames.org/findNearbyPlaceNameJSON?lat="+center.lat+"&lng="+center.lng+"&username=ixmaps", function( data ) {
                 
                let szRegion = data.geonames[0].adminName1;
 
                for (var i = 0; i < regionLookup.length; i++) {
                    if ((szRegion == regionLookup[i].name_en) || (szRegion == regionLookup[i].name_it) || (szRegion == (regionLookup[i].name_s || ""))) {
                        
                        let szRegione = ("0"+String(i+1)).slice(-2);
                        if ( szRegione != ixmaps.lastRegione ){
                            ixmaps.lastRegione = ixmaps.regione = szRegione;
                            ixmaps.map().replace("sezioni",__georef_sez2021());
                            ixmaps.map().replace("choropleth",__sez2021_pop_choropleth());
                            //ixmaps.map().replace("chart",__sez2021_pop_choropleth());
                            //ixmaps.map().replace("chart_grid",__sez_2011_2021_pop_arrow_user_grid());
                        }
                        break;
                    }
                }
			});

        }

        // ----------------------------------------------
        // show actual map HTML page
        // ----------------------------------------------

        var fCode = false;
        const __openSidebar = (url) => {
            const $sidebar = $("#map_code_div-project");
            $sidebar.load(url, (response, status, xhr) => {
                if (status === "error") {
                    alert(`Sorry but there was an error: ${xhr.status}\n${xhr.statusText}`);
                }
            });
        };

        __dataTheme = function() {
            if (fCode) {
                $("#map_code_div-project").html("");
                $("#map_code_div-project").hide();
            } else {
                __openSidebar('../../../pages/ISPRA/show_map_HTML.html');
                $("#map_code_div-project").show();
            }
            fCode = !fCode;
        }

    </script>

</body>

</html>
