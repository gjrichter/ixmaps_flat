<!DOCTYPE HTML>
<html>

<head>
    <title>IXMAPS embed</title>
    <meta name="Author" content="Guenter Richter" />
    <meta name="Keywords" content="map SVG HTML5 Javascript maps interactive charts ixmaps" />
    <meta name="Description" content="core html page for ixmaps SVG interactive map applications in overlay on leaflet basemaps" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="shortcut icon" href="../resources/images/ixmaps_logo.png" />
    <link rel="stylesheet" type="text/css" href="../css/ixmaps.css" />
</head>

<body style="margin:0px;padding:0px;overflow:hidden;">
    <div id="map-target"></div>

    <!-- Scripts moved to end of body -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.js" defer></script>
    <script src="https://cdn.maptiler.com/leaflet-maptilersdk/v1.0.0/leaflet-maptilersdk.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
    <script src="../js/htmlgui.js" defer></script>

    <script>
        const ixmaps = window.ixmaps || {};

        // Configuration
        const CONFIG = {
            defaultMap: "../../maps/svg/maps/generic/mercator.svg",
            controls: "small",
            svgLegendFlag: "nolegend",
            htmlLegendFlag: "1"
        };

        // Event handlers
        const handleContextMenu = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const contextMenu = document.getElementById('contextmenu');
            contextMenu.style.left = `${e.pageX - 20}px`;
            contextMenu.style.top = `${e.pageY - 20}px`;
            contextMenu.style.display = 'block';
        };

        // Map initialization
        const initializeMap = () => {
            try {
                ixmaps.parentApi = window.opener?.ixmaps || parent?.window.ixmaps;
                ixmaps.szName = window.opener?.name || parent?.window.name;
            } catch (e) {
                console.error('Error accessing parent window:', e);
            }

            // Register embedded map
            if (ixmaps.parentApi) {
                try {
                    ixmaps.parentApi.registerMap(ixmaps, ixmaps.szName || "map", window);
                } catch (e) {
                    console.error('Error registering map:', e);
                }
            }
        };

        // Main initialization
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            document.addEventListener('contextmenu', handleContextMenu);

            const $target = document.getElementById('map-target');
            // Load map page and initialize components
            fetch('./mappage.html')
                .then(response => response.text())
                .then(html => {
                    $target.innerHTML = html;
                    // Initialize map with error handling
                    try {
                        const map = new ixmaps.map("ixmap", {
                            mapService: "leaflet",
                            maptype: "ArcGIS - Topo",
                            svg: CONFIG.defaultMap,
                            mapsize: "fullscreen",
                            footer: ixmaps.footer || 0,
                            mode: CONFIG.svgLegendFlag,
                            controls: CONFIG.controls,
                            silent: true
                        });

                        // Set map options and view
                        map.setOptions({
                            featurescaling: "true",
                            objectscaling: "dynamic",
                            normalSizeScale: "50000000",
                            dynamicScalePow: "3",
                            flushChartDraw: "1000000",
                            basemapopacity: "0.8",
                            hideOnPan: "false",
                            freezeOnPan: "false"
                        });

                        map.setView({
                            center: {
                                lat: "46.2560066833692",
                                lng: "12.379353078373342"
                            },
                            zoom: "5.872529739982796"
                        });
                    } catch (e) {
                        console.error('Error initializing map:', e);
                    }
                })
                .catch(error => console.error('Error loading map page:', error));
        });


    </script>
</body>

</html>
