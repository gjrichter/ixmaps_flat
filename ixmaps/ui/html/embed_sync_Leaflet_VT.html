<!DOCTYPE HTML>
<html>

<head>
    <title>IXMAPS embed</title>
    <meta name="Author" content="Guenter Richter" />
    <meta name="Keywords" content="map SVG HTML5 Javascript maps interactive charts ixmaps" />
    <meta name="Description" content="core html page for ixmaps SVG interactive map applications in overlay on leaflet basemaps" />

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- IE Fix for HTML5 Tags -->
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!--========================================================================= 
	  we need scripting
	<!--========================================================================= -->

    <noscript>
        <div style="position:absolute;top:100px;left:100px;width:500px">
            <b>JavaScript must be enabled in order for you to use iXMaps.</b>
            <br>
            <br> However, it seems JavaScript is either disabled or not supported by your browser. To view the map application, enable
            JavaScript by changing your browser options, and then try again.
        </div>
    </noscript>

    <!--========================================================================= -->

    <link rel="shortcut icon" href="../resources/images/ixmaps_logo.png" />

    <link rel="stylesheet" type="text/css" href="../../ui/html/assets/css/icomoon.css" />
    <link rel="stylesheet" type="text/css" href="../../ui/html/assets/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../../ui/libs/jquery/ui/css/smoothness/jquery-ui-1.8.16.custom.css" />
    <link rel="stylesheet" type="text/css" href="../css/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="../css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../css/messagebox.css" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../css/legend.css" />
    <link rel="stylesheet" type="text/css" href="../css/main.css" />
    <!--========================================================================= -->
    <link rel="stylesheet" href="../../ui/libs/leaflet-gesture-handling/leaflet-gesture-handling.min.css" type="text/css">

    <style>
        .disable-select {
            user-select: none;
            /* supported by Chrome and Opera */
            -webkit-user-select: none;
            /* Safari */
            -khtml-user-select: none;
            /* Konqueror HTML */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
        }

    </style>
    <style>
        @-webkit-keyframes leaflet-gestures-fadein {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }

        @keyframes leaflet-gestures-fadein {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }

        .leaflet-container:after {
            -webkit-animation: leaflet-gestures-fadein .1s backwards;
            animation: leaflet-gestures-fadein .1s backwards;
            color: #aaa;
            font-family: Roboto, Arial, sans-serif;
            font-size: 22px;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            padding: 15px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, .2);
            z-index: 99999;
            pointer-events: none
        }

        .leaflet-gesture-handling-scroll-warning:after,
        .leaflet-gesture-handling-touch-warning:after {
            -webkit-animation: leaflet-gestures-fadein .1s forwards;
            animation: leaflet-gestures-fadein .1s forwards
        }

        .leaflet-gesture-handling-touch-warning:after {
            content: attr(data-gesture-handling-touch-content)
        }

        .leaflet-gesture-handling-scroll-warning:after {
            content: attr(data-gesture-handling-scroll-content)
        }

    </style>

    <!--========================================================================= -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.css" rel="stylesheet" />
    <script src="https://cdn.maptiler.com/leaflet-maptilersdk/v1.0.0/leaflet-maptilersdk.js"></script>

    <!--========================================================================= -->

</head>

<body style="margin:0px;padding:0px;overflow:hidden;">


    <div id="map-target">
    </div>


    <!--========================================================================= -->
</body>

<!--========================================================================= -->

<script src="../../ui/libs/jquery/jquery-1.7.1.min.js"></script>
<script src="../../ui/libs/jquery/ui/js/jquery-ui-1.8.16.custom.min.js"></script>

<script src="../libs/getUrlParam/js/jquery.getUrlParam.js"></script>
<script src="../libs/modernizr/js/testsvg.js"></script>
<script src="../libs/messagebox.js"></script>


<script type="text/javascript" src="../js/htmlgui.js">
</script>

<!--========================================================================= -->

<!--========================================================================= -->

<script type="text/javascript">
    (function(ixmaps, $, undefined) {
        
        ixmaps.fLegendVisible = true;

        var szControls = "small";
        var szSvgLegendFlag = "nolegend";
        var szHTMLLegendFlag = "1";

        // GR 12.02.2015 define fallback default map, used if parameter SVGGIS is empty  
        var szDefaultMap = "../../maps/svg/maps/generic/mercator.svg";

        $(document).ready(function() {

            // check browser SVG capability

            if (!Modernizr.svg) {
                alert("sorry ! your browser has no native SVG support;\n\nPlease try:   Chrome, Firefox, Safari, Opera or IE9");
            }

            // try to get a ixmaps API from opener or parent
            // --------------------------
            try {
                if (window.opener) {
                    ixmaps.parentApi = window.opener.ixmaps;
                    ixmaps.szName = window.opener.name;
                } else
                if (parent) {
                    ixmaps.parentApi = parent.window.ixmaps;
                    ixmaps.szName = parent.window.name;
                }
            } catch (e) {}

            // register the embedded map
            // --------------------------
            // in case the parent page holds more than one embedded map,
            // we can sync them if parameter name is given

            if ($(document).getUrlParam('name')) {
                ixmaps.szName = $(document).getUrlParam('name');
            }
            ixmaps.szPath = $(location).attr('pathname');
            if (ixmaps.parentApi) {
                try {
                    ixmaps.parentApi.registerMap(ixmaps, ixmaps.szName || "map", window);
                } catch (e) {}
            }

            // get application id
            // --------------------------
            // used to create app specific bookmark store

            if ($(document).getUrlParam('appid')) {
                ixmaps.szAppId = $(document).getUrlParam('appid');
                try {
                    ixmaps.setAppId($(document).getUrlParam('appid'));
                } catch (e) {}
            }

            // --------------------------
            // configure ui by URL params  
            // --------------------------

            // title

            if (!$(document).getUrlParam('title')) {
                //$("#title").remove();
            }

            // big legend

            if ($(document).getUrlParam('legend') ||
                $(document).getUrlParam('child')) {
                $("#switchlegendbutton").remove();
                $.getScript("../js/tools/legend.js", function() {
                    var state = $(document).getUrlParam('legend');
                    switch (state) {
                        case '1':
                        case 'true':
                        case 'open':
                        case 'expanded':
                            state = '1';
                            break;
                        case '0':
                        case 'false':
                        case 'closed':
                        case 'collapsed':
                            state = '0';
                            break;
                        default:
                            ixmaps.legend.url = state;
                            state = '1';
                            break;
                    }
                    ixmaps.legendState = state;
                    $.getScript("../js/tools/layer_legend.js", function() {});
                });
            }

            // small legend

            if ($(document).getUrlParam('themelegend')) {
                $.getScript("../js/tools/theme_legend.js", function() {
                    szHTMLLegendFlag = $(document).getUrlParam('themelegend');
                    ixmaps.fLegendVisible = (szHTMLLegendFlag != "0");
                });
            } else {
                $("#switchlegendbutton").remove();
                ixmaps.fLegendVisible = false;
            }

            // tool buttons

            if ($(document).getUrlParam('toolbutton') ||
                $(document).getUrlParam('tools') ||
                $(document).getUrlParam('options')) {
                $("#switchmodebutton").show();
                setTimeout('$("#onmapbuttondiv").show();', 1000);
                $("#switchtoolsbutton").show();
                $("#switchmodebutton").button().click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    __switchInputMode("button");
                });
                $("#switchinfobutton").button().click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    __switchInfoMode("button");
                });
                $("#switchlegendbutton").button().click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    __switchLegendMode();
                });
                $("#switchtoolsbutton").button().click(function(e) {

                    e.preventDefault();
                    e.stopPropagation();

                    htmlMap_showMapTypeControl();

                    if (0) {
                        ixmaps.openDialog(e, 'dialog', './tools/popuptools_jquery.html', '', 'auto', 350, 800);
                    } else {
                        if ($(document).getUrlParam('bigtools')) {
                            ixmaps.openDialog(e, 'dialog', './tools/popuptools_jquery.html', '', 'auto', 380, 350);
                        } else {
                            var szPos = String(parseInt($(ixmaps.gmapDiv).css('left')) + 10) + ',55';
                            ixmaps.openDialog(e, 'dialog', './tools/popuptools_line_v2.html', '', szPos, 700, 100);
                            $("#dialog").css("height", "100%");
                            $("#dialog").css("width", "90%");
                            $("#dialog").css("position", "absolute");
                            $("#dialog").css("top", "10px");
                            $("#dialog").css("overflow", "hidden");
                        }
                    }
                });
            } else {
                $("#switchtoolsbutton").remove();
                if ($(document).getUrlParam('modebutton') && ($(document).getUrlParam('modebutton') == "1")) {
                    $("#switchmodebutton").show();
                }
                $("#switchinfobutton").button().click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    __switchInfoMode();
                });
            }

            // geonames search

            if ($(document).getUrlParam('search')) {

                ixmaps.search.szSearchSuffix = $(document).getUrlParam('search');

                $("#switchsearchbutton").show();
                $("#switchsearchbutton").button().click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $(".search-container").css('top', $("#switchsearchbutton").offset().top);
                    $(".search-container").css('left', $("#switchsearchbutton").offset().left);
                    $("#switchsearchbutton").hide();
                    $(".search-container").show().animate({
                        width: "400px"
                    }, 500);
                    $(".search-box").show();
                });
                $(".search-container").click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $(".search-container").animate({
                        width: "0px"
                    }, 500);
                    $(".search-container").hide();
                    $(".search-box").val("");
                    $("#switchsearchbutton").show();
                });
                $(".search-box").click(function(e) {
                    e.stopPropagation();
                });
                setTimeout('$("#onmapbuttondiv").show();', 1000);
            }

            // embed footer 

            if ($(document).getUrlParam('footer')) {
                $("#map-footer").show();
                $("#map-popout-button").show();
                ixmaps.footer = 20;
            }
            if ($(document).getUrlParam('item')) {
                ixmaps.item = $(document).getUrlParam('item');
            }

            // ----------------------
            // align user interface
            // ----------------------
            // needed for relative ui element positioning
            $("#map-overlay").css("width", window.innerWidth + "px");
            $("#map-overlay").css("height", window.innerHeight + "px");
            $("#map-overlay").css("pointer-events", "none");

            if ($(document).getUrlParam('align')) {
                if ($(document).getUrlParam('align').match(/left/)) {
                    ixmaps.legendAlign = "left";
                    $(".map-legend").attr("data-align", "left");
                    var szLeft = $(document).getUrlParam('align').split("left")[0] || "4%";
                    $(".map-legend").css("left", szLeft);
                    $(".map-legend").css("top", "12px");
                    $(".title-field").css("left", "100px");
                } else
                if ($(document).getUrlParam('align').match(/right/)) {
                    ixmaps.legendAlign = "right";
                    $(".map-legend").attr("data-align", "right");
                    var szRight = $(document).getUrlParam('align').split("right")[0] || "25px";
                    $(".map-legend").css("right", szRight);
                    $(".title-field").css("right", "100px");
                } else
                if (($(document).getUrlParam('align') == "center") ||
                    ($(document).getUrlParam('align') == "top")) {
                    $("#map-legend").appendTo("#map-header");
                    $("#map-header").show();
                    $("#ixmap").css("top", "75px");
                    ixmaps.legendAlign = "center";
                    $(".map-legend").attr("data-align", "right");
                    $(".map-legend").css("text-align", "center");
                    $(".map-legend").css("font-size", "0.7em");
                    $(".map-legend").css("margin-top", "-15px");
                    $(".map-legend").css("min-height", "77px");
                    $(".map-legend").css("width", "100%");
                    $(".map-legend").css("max-width", "100%");
                    $(".map-legend").css("left", "0px");
                    $(".map-legend").css("opacity", "1");
                } else
                if ($(document).getUrlParam('align') == "bottom") {
                    $("#map-legend").appendTo("#map-header");
                    $("#map-header").show();
                    $("#ixmap").css("top", "0px");
                    ixmaps.legendAlign = "center";
                    $(".map-legend").attr("data-align", "right");
                    $(".map-legend").css("text-align", "center");
                    $(".map-legend").css("font-size", "0.7em");
                    $(".map-legend").css("width", "100%");
                    $(".map-legend").css("max-width", "100%");
                    $(".map-legend").css("position", "absolute");
                    $(".map-legend").css("left", "0px");
                    $(".map-legend").css("top", "720px");

                    // GR 13/12/2023 HTML color maptype -> map background color 
                    //$(".map-legend").css("background", "rgba(255,255,255,0.5)");
                    var szBackgroundcolor = decodeURIComponent($(document).getUrlParam('maptype'));
                    if (szBackgroundcolor && (szBackgroundcolor.charAt(0) == '#')) {
                        $("body").css("background", decodeURIComponent($(document).getUrlParam('maptype')));
                    }

                    $("#onmapbuttondiv").css("left", "");
                    $("#onmapbuttondiv").css("right", "60px");
                    $(".title-field").css("right", "100px");
                }
            } else {
                $(".map-legend").css("right", "25px");
                $(".title-field").css("left", "100px");
            }

            if ($(document).getUrlParam('toolmargintop')) {
                $("#onmapbuttondiv").css("top", String(Number($(document).getUrlParam('toolmargintop'))) + "px");
            }
            if ($(document).getUrlParam('toolmarginleft')) {
                $("#onmapbuttondiv").css("left", String(Number($(document).getUrlParam('toolmarginleft'))) + "px");
            }
            if ($(document).getUrlParam('scrollsafe')) {
                ixmaps.scrollsafe = true;
            }

            if ($(document).getUrlParam('scrollsafesilent')) {
                ixmaps.scrollsafesilent = true;
            }

            ixmaps.fMapControls = true;
            if ($(document).getUrlParam('ui')) {
                if ($(document).getUrlParam('ui') == "hidden") {
                    ixmaps.switchUi(false);
                    ixmaps.fMapControls = false;
                    $("#onmapbuttondivzoom").hide();
                }
            }
            if ($(document).getUrlParam('layout')) {
                if ($(document).getUrlParam('layout') == "minimal") {
                    ixmaps.switchUi(false);
                    ixmaps.fMapControls = false;
                    $("#onmapbuttondivzoom").hide();
                }
            }

            // ====================
            // create the map app
            // ====================
            
            $("#switchlegendbutton").remove();
            $.getScript("../js/tools/legend.js", function() {
                var state = $(document).getUrlParam('legend');
                switch (state) {
                    case '1':
                    case 'true':
                    case 'open':
                    case 'expanded':
                        state = '1';
                        break;
                    case '0':
                    case 'false':
                    case 'closed':
                    case 'collapsed':
                        state = '0';
                        break;
                    default:
                        ixmaps.legend.url = state;
                        state = '1';
                        break;
                }
                ixmaps.legendState = state;
                $.getScript("../js/tools/layer_legend.js", function() {});
            });

            $.when(
                $.getScript("../js/htmlgui_sync.js"),
                $.getScript("../js/htmlgui_sync_Leaflet_VT.js"),
                $.getScript("../js/htmlgui_dialog.js"),
                $.getScript("../js/htmlgui_story.js"),
                
                $.getScript("../../../data.min.js/data.js"),
                
                $.getScript("../../ui/libs/leaflet-gesture-handling/leaflet-gesture-handling.min.js"),

                
                
                $.Deferred(function(deferred) {
                    $(deferred.resolve);
                })
            ).done(function() {
                
                const $target = $("#map-target");
                $target.load("./mappage.html", (response, status, xhr) => {

                    if (status === "error") {
                        alert(`Sorry but there was an error: ${xhr.status}\n${xhr.statusText}`);
                    }
                    var szMap = decodeURIComponent($(document).getUrlParam('svggis'));
                    szMap = (szMap && (szMap != "null")) ? szMap : szDefaultMap;
                    map = new ixmaps.map("ixmap", {
                        mapService: "leaflet",
                        maptype: "ArcGIS - Topo", //decodeURIComponent($(document).getUrlParam('maptype')),
                        svg: szMap,
                        mapsize: "fullscreen",
                        footer: ixmaps.footer || 0,
                        mode: szSvgLegendFlag,
                        controls: szControls,
                        silent: decodeURIComponent($(document).getUrlParam('silent'))
                    });
                    var oldReady = ixmaps.onMapReady;
                    ixmaps.onMapReady = function() {

                        if ($(document).getUrlParam('map')) {
                            szMapUrl = $(document).getUrlParam('map');
                            ixmaps.loadMap(szMapUrl);
                            ixmaps.onMapReady = null;
                        }
                        if ($(document).getUrlParam('project')) {
                            szProjectUrl = $(document).getUrlParam('project');
                            ixmaps.loadProject(szProjectUrl, false);
                            ixmaps.onMapReady = null;
                        }
                        if ($(document).getUrlParam('view')) {
                            szView = $(document).getUrlParam('view');
                            setTimeout("ixmaps.setView(" + szView + ")", 1000);
                        }
                        if ($(document).getUrlParam('data')) {
                            szDataUrl = $(document).getUrlParam('data');
                            ixmaps.loadData(szDataUrl, false);
                            ixmaps.onMapReady = null;
                        }
                        const theme = {
                            "layer": "nuts3",
                            "field": "$item$",
                            "field100": "",
                            "style": {
                                "type": "FEATURES|NOLEGEND",
                                "colorscheme": [
                                    "rgba(255,255,255,0.5)"
                                ],
                                "fillopacity": "0.9",
                                "shadow": "false",
                                "visible": "true",
                                "dbtable": "DBTABLE33053494",
                                "dbtableUrl": "https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_10M_2021_4326_LEVL_3.geojson",
                                "dbtableType": "geojson",
                                "datacache": "true",
                                "itemfield": "NUTS_ID",
                                "lookupfield": "geometry",
                                "showdata": "true",
                                "units": "",
                                "refreshtimeout": "0",
                                "scale": "1",
                                "sizepow": "2",
                                "linecolor": [
                                    "green"
                                ],
                                "linewidth": "0.1",
                                "valuescale": "1",
                                "name": "nuts3",
                                "title": "layer"
                            }
                        };
                        //ixmaps.setProjectJSON(project);
                        const __eventi = {
                            "layer": "Concessioni",
                            "field": "grouped_target_group",
                            "field100": "",
                            "style": {
                                "type": "CHART|SYMBOL|SIZE|VALUES|SEQUENCE|STAR|SORT|UP|EXPAND|AGGREGATE|RELOCATE|CATEGORICAL|SIMPLELEGEND",
                                "colorscheme": [
                                    "6",
                                    "tableau10"
                                ],
                                "fillopacity": "0.9",
                                "shadow": "true",
                                "visible": "true",
                                "dbtable": "processed_data",
                                "dbtableUrl": "../../data/2023-rtv-1990-2022_without-sources.csv",
                                "dbtableType": "csv",
                                "dbtableProcess": "data => { data.column(\"n_killed\").map(value => { return isNaN(value)?0:value; }); data.column(\"n_wounded\").map(value => { return (isNaN(value))?0:value; }); var killed = data.column(\"n_killed\").index; var wounded = data.column(\"n_wounded\").index; data.addColumn({ destination: \"n_victims\" }, (row) => { return (Number(row[killed])+Number(row[wounded])); }); }",
                                "datacache": "true",
                                "lookupfield": "location_latitude|location_longitude",
                                "showdata": "true",
                                "symbols": [
                                    "circle"
                                ],
                                "units": "victims",
                                "refreshtimeout": "0",
                                "normalsizevalue": "100",
                                "scale": "1",
                                "sizepow": "2",
                                "sizefield": "n_victims",
                                "linewidth": "0.5",
                                "glowlower": "1:10000",
                                "valuescale": "1",
                                "gridwidthpx": "3",
                                "name": "symbol",
                                "title": "Violence - RTV ",
                                "splash": "scaricando dati ...",
                                "tooltip": "<h2>{{case_id}}<br>{{location}}<br>{{affilation}}</h2>actor: {{organizational_affiliation}}, {{organizational_affiliation_2}}<br><br><b>weapon:</b> {{weapon_description}}<br><b>target:</b> {{grouped_target_group}}, {{grouped_target_group_2}}<br><br> killed: {{n_killed}} wounded: {{n_wounded}}<br><br>{{description}}{{theme.item.data}}"
                            }
                        };

                        if (oldReady) {
                            oldReady();
                        }
                        ixmaps.map().setOptions({
                            featurescaling: "true",
                            objectscaling: "dynamic",
                            normalSizeScale: "50000000",
                            dynamicScalePow: "3",
                            flushChartDraw: "1000000",
                            basemapopacity: "0.8",
                            hideOnPan: "false",
                            freezeOnPan: "false"
                        });
                        ixmaps.map().setView({
                            center: {
                                lat: "46.2560066833692",
                                lng: "12.379353078373342"
                            },
                            zoom: "5.872529739982796"
                        });

                        //ixmaps.newTheme("test",theme);
                        ixmaps.newTheme("test", __eventi);
                    };
                    

             // set attribution (bottom left on map space)

            var attribution = decodeURIComponent(unescape($(document).getUrlParam('attribution')));
            $("#attribution").html((attribution && (attribution != "null")) ? attribution : "");

            ixmaps.attribution = attribution;
            ixmaps.date = decodeURIComponent(unescape($(document).getUrlParam('date')));
            ixmaps.parent = decodeURIComponent(unescape($(document).getUrlParam('parent')));

            // change input mode ?

            if ($(document).getUrlParam('mode')) {
                var mode = $(document).getUrlParam('mode');
                ixmaps.execBookmark("map.Api.setMapTool('" + mode + "')", false);
                __setInputMode(mode);
                if (mode == "info") {
                    $("#onmapbuttondivzoom").show();
                }
            }

            // set sync mode ?

            ixmaps.fSyncMap = $(document).getUrlParam('sync') ? ($(document).getUrlParam('sync') == "true") : true;

            ixmaps.setAutoSwitchInfo(true);

            // is there a bookmark to execute at load ? 

            if ($(document).getUrlParam('bookmark')) {
                x = $(document).getUrlParam('bookmark');
                szBookmark = decodeURIComponent(((typeof(x) != "string") ? x.join("") : x));
                ixmaps.execBookmark(szBookmark, false);
            }

            // is there a project to load at load ? 

            if ($(document).getUrlParam('project')) {
                szProjectUrl = $(document).getUrlParam('project');
                ixmaps.loadProject(szProjectUrl, false);
            }
            // show/hide toolsbar elements
            __switchBannerElements();
            setTimeout("__switchBannerElements()", 5000);

            htmlMap_enableScrollWheelZoom();
               
                
                    
                    
                    
                    
                });
                
                
            });

        });

        // =======================
        // $(document).ready done
        // =======================

        // on windiow resize

        $(window).resize(function(e) {
            $("#banner").css('width', window.innerWidth + 'px');
            __switchBannerElements();
            if (e.target.nodeName != 'DIV') {
                var height = $("#legend").parent().height();
                var width = $("#legend").parent().width();
                $("#legend").parent().css("left", (window.innerWidth - width - 20) + "px");
                $("#legend").parent().css("top", (window.innerHeight - height - 40) + "px");
            }
            $("#map-overlay").css("width", window.innerWidth + "px");
            $("#map-overlay").css("height", window.innerHeight + "px");
            $("#map-overlay").css("pointer-events", "none");
        });

        // ----------------------
        // button executer
        // ----------------------

        __switchBannerElements = function() {

            var toolsWidth = parseInt($("#tools").css('width'));
            var visiToolWidth = parseInt($("#visiswitch").css('width'));
            var chartToolWidth = parseInt($("#chartsdiv").css('width'));
            if (window.innerWidth > (toolsWidth + visiToolWidth + chartToolWidth + 10)) {
                $("#visiswitch").show();
                $("#chartsdiv").show();
            } else
            if (window.innerWidth > (toolsWidth + chartToolWidth + 30)) {
                $("#visiswitch").hide();
                $("#chartsdiv").show();
            } else {
                $("#visiswitch").hide();
                $("#chartsdiv").hide();
            }

            if (!$(document).getUrlParam('align') == "right") {
                $("#onmapbuttondiv").css('left', String(parseInt($(ixmaps.gmapDiv).css('left')) + 10) + "px");
            }

            if ($(document).getUrlParam('child')) {
                if ((window.innerWidth < 650) || !ixmaps.embedlogo) {
                    $("#embedlogo").hide();
                } else {
                    $("#embedlogo").show();
                }
                if (window.innerWidth < 500) {
                    $("#onmapbuttondiv").hide();
                } else {
                    $("#onmapbuttondiv").show();
                }
            }
        };

        __switchInputMode = function(szSource) {

            switch (ixmaps.getMapTool()) {
                case 'info':
                    ixmaps.mapTool((szSource && (szSource == "button")) ? 'pan' : 'idle');
                    ixmaps.switchAndroidEventPane(true);
                    $("#switchmodebuttonicon").attr("src", "../resources/images/mano.png");
                    $("#switchmodebuttonicon").css("opacity", "1");
                    $("#switchmodebutton").css("background", "#ffffff url(../resources/images/info.png) no-repeat 95% 55%");
                    $("#switchmodebutton").css("background-size", "13px");
                    $("#switchinfobutton").hide();
                    //$("#onmapbuttondivzoom").hide();
                    break;
                case 'pan':
                default:
                    ixmaps.mapTool('info');
                    ixmaps.switchAndroidEventPane(false);
                    $("#switchmodebuttonicon").attr("src", "../resources/images/info.png");
                    $("#switchmodebutton").css("background", "#ffffff url(../resources/images/mano.png) no-repeat 98% 55%");
                    $("#switchmodebutton").css("background-size", "13px");
                    $("#switchmodebuttonicon").css("opacity", "1");
                    $("#onmapbuttondivzoom").show();
                    break;
            }
        };

        __setInputMode = function(szMode) {
            try {
                switch (szMode) {
                    case 'info':
                        $("#switchmodebuttonicon").attr("src", "../resources/images/info.png");
                        $("#switchmodebutton").css("background", "#ffffff url(../resources/images/mano.png) no-repeat 98% 55%");
                        $("#switchmodebutton").css("background-size", "13px");
                        $("#switchmodebuttonicon").css("opacity", "1");
                        break;
                    case 'pan':
                    default:
                        $("#switchmodebuttonicon").attr("src", "../resources/images/mano.png");
                        $("#switchmodebuttonicon").css("opacity", "1");
                        $("#switchmodebutton").css("background", "#ffffff url(../resources/images/info.png) no-repeat 95% 55%");
                        $("#switchmodebutton").css("background-size", "13px");
                        break;
                }
            } catch (e) {}
            try {
                $("#" + mode)[0].checked = true;
                $("#tools").buttonset('refresh');
            } catch (e) {}
        };

        __switchInfoMode = function() {
            $("#switchinfobutton").hide();
            ixmaps.mapTool('pan');
            //ixmaps.mapTool( 'info');
        };

        // ------------------------------------------- 
        // start function in case: autoplay==false 
        // -------------------------------------------

        __startMap = function() {

            $("#divstart").hide();
            var szMap = decodeURIComponent($(document).getUrlParam('svggis'));
            szMap = (szMap && (szMap != "null")) ? szMap : szDefaultMap;

            map = new ixmaps.map("ixmap", {
                mapService: decodeURIComponent($(document).getUrlParam('mapservice')),
                maptype: decodeURIComponent($(document).getUrlParam('maptype')),
                svg: szMap,
                mapsize: "fix",
                mode: szSvgLegendFlag,
                controls: szControls
            });

            // is there a bookmark to execute at load ?
            ixmaps.onMapReady = function() {
                if ($(document).getUrlParam('bookmark')) {
                    x = $(document).getUrlParam('bookmark');
                    szBookmark = decodeURIComponent(((typeof(x) != "string") ? x.join("") : x));
                    ixmaps.execBookmark(szBookmark, false);
                }
                ixmaps.toggleThemeLegends(false);
            };
        };

        // -------------------------------------------
        // other helper
        // -------------------------------------------

        ixmaps.setMapTool = function(szId) {
            console.log("kill");
            ixmaps.mapTool(szId);
            $("#" + szId).click();
        };

        ixmaps.setColorScheme = function(index) {
            ixmaps.changeThemeStyle(null, "colorscheme:" + index, "set");
            $("#colorList").dialog("close");
        };

        ixmaps.switchUi = function(fFlag) {
            if (fFlag) {
                $("#onmapbuttondiv").show();
                $("#onmapbuttondivbottom").show();
                htmlMap_showMapControl();
                ixmaps.fMapControls = true;
            } else {
                $("#onmapbuttondiv").hide();
                $("#onmapbuttondivbottom").hide();
                htmlMap_hideMapControl();
                ixmaps.fMapControls = false;
            }
        };

        var __olditemclick = ixmaps.htmlgui_onItemClick;
        ixmaps.htmlgui_onItemClick = function(evt, szId) {

            ixmaps.fOnItemClicked = true;

            // check __olditemclick when parent Api has no map; magick - tested 
            if ((ixmaps.parentApi.isMap == false) && __olditemclick(evt, szId)) {
                return true;
            } else {
                if (szId.match(/mapbackground:eventrect/)) {
                    $("#switchinfobutton").hide();
                    $("#item").dialog("destroy");
                    ixmaps.embeddedSVG.window.map.Api.clearHighlight();
                    ixmaps.embeddedSVG.window.map.Api.clearAllOverlays();
                } else {
                    var szItemUrl = "./tools/item.html";
                    if (ixmaps.item &&
                        (ixmaps.item != "html")) {
                        szItemUrl = ixmaps.item;
                        szItemUrl = szItemUrl.replace("../../../..", "../..");
                    }
                    if (ixmaps.loadedProject &&
                        ixmaps.loadedProject.map.item &&
                        (ixmaps.loadedProject.map.item != "html")) {
                        szItemUrl = ixmaps.loadedProject.map.item;
                        szItemUrl = szItemUrl.replace("../../../..", "../..");
                    }
                    if (ixmaps.item || ixmaps.loadedProject.map.item) {
                        ixmaps.szMapItemId = ixmaps.parentApi.szMapItemId = szId;
                        if ($("#item")[0]) {
                            $("#item")[0].innerHTML = "";
                        }

                        window.idialog = this.openDialog(null, 'item', szItemUrl, '', '70,100');
                        ixmaps.onDialogClose = function() {
                            ixmaps.embeddedSVG.window.map.Api.clearHighlight();
                            ixmaps.embeddedSVG.window.map.Api.clearAllOverlays();
                        };
                        $("#item").css("height", "100%");
                        $("#item").css("width", "90%");
                        $("#item").css("position", "absolute");
                        $("#item").css("top", "10px");
                        $("#item").css("overflow", "hidden");
                        // avoid dialog size flashing
                        $("#item").parent().css("display", "none");
                        setTimeout('ixmaps._fadeInItem()', 200);

                        //ixmaps.loadPopUp(ixmaps.loadedProject.map.item||'./item.html',{frame:true});
                        return true;
                    }
                    $("#onmapbuttondiv").show();
                    $("#switchinfobutton").show();
                }
                if (__olditemclick && __olditemclick(szId, evt)) {
                    return true;
                }
                return false;
            }
        }
        ixmaps._fadeInItem = function() {
            $("#item").parent().fadeIn("slow");
        }
        var __oldSelection = ixmaps.htmlgui_onSelection;
        ixmaps.htmlgui_onSelection = function(szId) {
            if (__oldSelection(szId)) {
                return true;
            }
            return false;
        }

        // -------------------------------------------
        // search tool 
        // ------------------------------------------- 

        ixmaps.search = ixmaps.search || {};

        ixmaps.search.show = function(fFlag) {
            $("#switchsearchbutton").show();
            $("#switchsearchbutton").button().click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(".search-container").css('top', $("#switchsearchbutton").offset().top);
                $(".search-container").css('left', $("#switchsearchbutton").offset().left);
                $("#switchsearchbutton").hide();
                $(".search-container").show().animate({
                    width: "400px"
                }, 500);
                $(".search-box").show();
            });
            $(".search-container").click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(".search-container").animate({
                    width: "0px"
                }, 500);
                $(".search-container").hide();
                $(".search-box").val("");
                $("#switchsearchbutton").show();
            });
            $(".search-box").click(function(e) {
                e.stopPropagation();
            });
            setTimeout('$("#onmapbuttondiv").show();', 1000);
        };

        ixmaps.search.positionResultList = function(input) {
            $('.result-list').css({
                width: input.outerWidth(),
                top: input.offset().top + input.outerHeight(),
                left: input.offset().left
            });
        };

        ixmaps.search.showQueryMessage = function() {
            $('.result-list').empty();
            this.positionResultList($('.search-box'));
            var itemObject = $('<div class="result-item" title="searching"><em>searching ...</em></div>');
            $('.result-list').append(itemObject);
            $('.result-list').show();
        };

        ixmaps.search.renderResults = function(result) {
            $('.result-list').empty();
            this.positionResultList($('.search-box'));
            if (!result) {
                var itemObject = $('<div class="result-item" title="not found"><em>' + $('.search-box').val() +
                    '</em> not found!</div>');
                $('.result-list').append(itemObject);
                $('.result-list').show();
                return;
            }
            var i = 0;
            result.forEach(function(item) {
                if (++i < 10) {
                    var itemStr = '<div class="result-item" title="' + item.display_name + '">' + item.display_name + '</div>';
                    var itemObject = $(itemStr);
                    itemObject.data(item);
                    $('.result-list').append(itemObject);
                }
            });
            $('.result-list').show();
        };

        ixmaps.search.renderMap = function(data) {

            ixmaps.search.result = data;

            var x = (Number(data.boundingbox[0]) + Number(data.boundingbox[1])) / 2;
            var y = (Number(data.boundingbox[2]) + Number(data.boundingbox[3])) / 2;

            if (data.class == "place") {
                ixmaps.setView([x, y], 13);
            } else {
                ixmaps.setBounds([Number(data.boundingbox[0]), Number(data.boundingbox[2]), Number(data.boundingbox[1]), Number(
                    data.boundingbox[3])]);
            }

            var __szBookmark = "map.Api.doZoomMapToGeoBounds(" + data.boundingbox[0] + "," + data.boundingbox[2] + "," + data.boundingbox[
                1] + "," + data.boundingbox[3] + ");";
            setTimeout("ixmaps.execBookmark('" + __szBookmark + "')", 100);

            $('.search-box').val(data.display_name.replace(data.address.hamlet + ', ', ''));
        };

        ixmaps.search.szSearchSuffix = "";
        ixmaps.search.queryNominatim = function() {
            ixmaps.search.lastSearch = $('.search-box').val();
            // GR 15.11.2022 nominatim URL changed, suffix not any longer possible
            //var query = encodeURIComponent($('.search-box').val() + ((this.szSearchSuffix.length > 1) ? ("," + this.szSearchSuffix) :
            //	""));
            var query = encodeURIComponent($('.search-box').val());
            $('.error').hide();
            $('.result-list').empty().hide();

            this.showQueryMessage();

            $.ajax({
                url: "https://nominatim.openstreetmap.org/search?key=9VpTwb1ib382pomWexOxmr2J67UtDJKN&q=" + query +
                    "&format=json&addressdetails=1",
                success: function(result) {
                    if (result.length) {
                        ixmaps.search.renderResults(result);
                    } else {
                        ixmaps.search.renderResults(null);
                        $('.error').show();
                    }
                }
            });
        };

        ixmaps.search.selectResult = function(item) {
            $('.result-item').removeClass('selected');
            item.addClass('selected');
        };

        ixmaps.search.renderMapFromResult = function() {
            var target = $('.result-item.selected');
            ixmaps.search.renderMap(target.data());
            $('.result-list').empty().hide();
        };

        $('.result-list')
            .on('click', '.result-item', ixmaps.search.renderMapFromResult)
            .on('mouseenter', '.result-item', function(e) {
                $(e.currentTarget).addClass('selected');
            })
            .on('mouseleave', '.result-item', function(e) {
                $(e.currentTarget).removeClass('selected');
            });

        $(document).on('keydown', '.search-box', function(e) {
            var pressed = e.which;
            var keys = {
                enter: 13,
                up: 38,
                down: 40
            };
            if (pressed === keys.enter) {
                $('.result-item.selected').length ? ixmaps.search.renderMapFromResult() : ixmaps.search.queryNominatim();
            } else if (pressed === keys.up) {
                if (!$('.result-item.selected').length || $('.result-item.selected').is(':first-child')) {
                    // Choose last
                    ixmaps.search.selectResult($('.result-item:last-child'));
                } else {
                    // Choose prev item
                    ixmaps.search.selectResult($('.result-item.selected').prev());
                }
            } else if (pressed === keys.down) {
                if (!$('.result-item.selected').length || $('.result-item.selected').is(':last-child')) {
                    // Choose first 
                    ixmaps.search.selectResult($('.result-item:first-child'));
                } else {
                    // Choose next item
                    ixmaps.search.selectResult($('.result-item.selected').next());
                }
            } else {
                if ($('.result-item').length) {
                    $('.result-list').empty().hide();
                }
            }
        });

        var __queryNominatimTimeout = null;

        $(document).on('keyup', '.search-box', function(e) {
            var pressed = e.which;
            var keys = {
                enter: 13,
                up: 38,
                down: 40
            };
            if (pressed !== keys.enter) {
                if (__queryNominatimTimeout) {
                    clearTimeout(__queryNominatimTimeout);
                }
                __queryNominatimTimeout = setTimeout("ixmaps.search.queryNominatim()", 500);
            }
        });

        $(document).on('blur', '.search-box', function() {
            if ($('.result-item').length) {
                setTimeout("$('.result-list').empty().hide();", 500);
            }
        });


        document.addEventListener("contextmenu", function(e) {
            e.preventDefault();
            e.stopPropagation();
            $("#contextmenu")[0].style.left = e.pageX - 20 + 'px';
            $("#contextmenu")[0].style.top = e.pageY - 20 + 'px';
            $("#contextmenu").show();
            return true;
        });

        var __contextMenuTrigger = null;
        __contextmenuOver = function(el) {
            clearTimeout(__contextMenuTrigger);
            __contextMenuTrigger = true;
        }

        __contextmenuOut = function(el) {
            __contextMenuTrigger = setTimeout("$('#contextmenu').hide()", 100);
        }

        $(document).on('click', '.search-btn', ixmaps.search.queryNominatim);


        // ------------------------------------------- 
        // END search tool 
        // ------------------------------------------- 


    }(window.ixmaps = window.ixmaps || {}, jQuery));

</script>

</html>
